=== ESTRUCTURA BD ===

-- Tabla articulo

-- Tabla categoria

-- Tabla impuesto

=== CAPA DE DATOS (REPOSITORIOS) ===

----- capa_datos/articulo_repo.py -----
"""
Repositorio para la gesti√≥n de art√≠culos en la base de datos
"""
from loguru import logger

class ArticuloRepositorio:
    """Clase que maneja las operaciones de base de datos para art√≠culos"""
    
    def __init__(self, conn):
        """
        Inicializa el repositorio con una conexi√≥n a la base de datos
        
        Args:
            conn: Conexi√≥n a la base de datos
        """
        self.conn = conn
        logger.info("‚úÖ ArticuloRepositorio inicializado")
    
    def listar(self):
        """
        Lista todos los art√≠culos con sus precios
        """
        try:
            cursor = self.conn.cursor()
            query = """
            SELECT a.idarticulo, a.codigo, a.nombre, a.descripcion, a.imagen,
                   a.idcategoria, c.nombre as categoria,
                   a.idpresentacion, p.nombre as presentacion,
                   a.precio_venta, a.precio_referencia, a.stock_minimo,
                   a.codigo_barras_original, a.id_impuesto,
                   i.letra_fiscal, i.nombre as tipo_impuesto
            FROM articulo a
            LEFT JOIN categoria c ON a.idcategoria = c.idcategoria
            LEFT JOIN presentacion p ON a.idpresentacion = p.idpresentacion
            LEFT JOIN impuesto i ON a.id_impuesto = i.id_impuesto
            ORDER BY a.idarticulo DESC
            """
            cursor.execute(query)
            
            columns = [column[0] for column in cursor.description]
            rows = cursor.fetchall()
            result = []
            
            for row in rows:
                item = dict(zip(columns, row))
                result.append(item)
            
            logger.info(f"‚úÖ {len(result)} art√≠culos listados")
            return result
        except Exception as e:
            logger.error(f"Error al listar art√≠culos: {e}")
            return []
    
    def obtener_por_id(self, idarticulo):
        """
        Obtiene un art√≠culo por su ID
        """
        try:
            cursor = self.conn.cursor()
            query = """
            SELECT a.idarticulo, a.codigo, a.nombre, a.descripcion, a.imagen,
                   a.idcategoria, c.nombre as categoria,
                   a.idpresentacion, p.nombre as presentacion,
                   a.precio_venta, a.precio_referencia, a.stock_minimo,
                   a.codigo_barras_original, a.id_impuesto,
                   i.letra_fiscal, i.nombre as tipo_impuesto
            FROM articulo a
            LEFT JOIN categoria c ON a.idcategoria = c.idcategoria
            LEFT JOIN presentacion p ON a.idpresentacion = p.idpresentacion
            LEFT JOIN impuesto i ON a.id_impuesto = i.id_impuesto
            WHERE a.idarticulo = ?
            """
            cursor.execute(query, (idarticulo,))
            row = cursor.fetchone()
            
            if row:
                columns = [column[0] for column in cursor.description]
                return dict(zip(columns, row))
            return None
            
        except Exception as e:
            logger.error(f"Error al obtener art√≠culo por ID {idarticulo}: {e}")
            return None

    def buscar_por_codigo(self, codigo):
        """
        Busca un art√≠culo por su c√≥digo de barras o c√≥digo interno
        """
        try:
            cursor = self.conn.cursor()
            query = """
            SELECT a.idarticulo, a.codigo, a.nombre, a.descripcion, a.imagen,
                   a.idcategoria, c.nombre as categoria,
                   a.idpresentacion, p.nombre as presentacion,
                   a.precio_venta, a.precio_referencia, a.stock_minimo,
                   a.codigo_barras_original, a.id_impuesto,
                   i.letra_fiscal, i.nombre as tipo_impuesto
            FROM articulo a
            LEFT JOIN categoria c ON a.idcategoria = c.idcategoria
            LEFT JOIN presentacion p ON a.idpresentacion = p.idpresentacion
            LEFT JOIN impuesto i ON a.id_impuesto = i.id_impuesto
            WHERE a.codigo = ? OR a.codigo_barras_original = ?
            """
            cursor.execute(query, (codigo, codigo))
            row = cursor.fetchone()
            
            if row:
                columns = [column[0] for column in cursor.description]
                return dict(zip(columns, row))
            return None
            
        except Exception as e:
            logger.error(f"Error al buscar art√≠culo por c√≥digo {codigo}: {e}")
            return None
    
    def buscar_por_plu(self, plu):
        """
        Busca un art√≠culo por su PLU
        """
        try:
            cursor = self.conn.cursor()
            query = """
            SELECT a.idarticulo, a.codigo, a.nombre, a.descripcion, a.imagen,
                   a.idcategoria, c.nombre as categoria,
                   a.idpresentacion, p.nombre as presentacion,
                   a.precio_venta, a.precio_referencia
            FROM articulo a
            LEFT JOIN categoria c ON a.idcategoria = c.idcategoria
            LEFT JOIN presentacion p ON a.idpresentacion = p.idpresentacion
            WHERE a.plu = ?
            """
            cursor.execute(query, (plu,))
            row = cursor.fetchone()
            
            if row:
                columns = [column[0] for column in cursor.description]
                return dict(zip(columns, row))
            return None
            
        except Exception as e:
            logger.error(f"Error al buscar art√≠culo por PLU {plu}: {e}")
            return None
    
    def crear(self, codigo, nombre, idcategoria, idpresentacion, 
              codigo_barras_original=None, descripcion=None, 
              imagen=None, precio_venta=0, precio_referencia=None, 
              stock_minimo=5, id_impuesto=2):  # ‚Üê NUEVO PAR√ÅMETRO
        """
        Crea un nuevo art√≠culo en la base de datos
        """
        try:
            cursor = self.conn.cursor()
            query = """
            INSERT INTO articulo 
            (codigo, nombre, idcategoria, idpresentacion, codigo_barras_original,
             descripcion, imagen, precio_venta, precio_referencia, stock_minimo,
             id_impuesto)  -- ‚Üê NUEVA COLUMNA
            VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
            """
            cursor.execute(query, (
                codigo, nombre, idcategoria, idpresentacion, codigo_barras_original,
                descripcion, imagen, precio_venta, precio_referencia, stock_minimo,
                id_impuesto  # ‚Üê NUEVO VALOR
            ))
            
            cursor.execute("SELECT @@IDENTITY AS id")
            row = cursor.fetchone()
            idarticulo = row[0] if row else None
            self.conn.commit()
            
            logger.info(f"‚úÖ Art√≠culo creado con ID: {idarticulo} - C√≥digo: {codigo}")
            return idarticulo
            
        except Exception as e:
            logger.error(f"‚ùå Error al crear art√≠culo: {e}")
            self.conn.rollback()
            return None
    
    def actualizar_precio(self, idarticulo, nuevo_precio):
        """
        Actualiza el precio de venta de un art√≠culo
        """
        try:
            cursor = self.conn.cursor()
            
            # Verificar que el art√≠culo existe
            cursor.execute("SELECT idarticulo FROM articulo WHERE idarticulo = ?", (idarticulo,))
            if not cursor.fetchone():
                logger.warning(f"‚ö†Ô∏è Art√≠culo {idarticulo} no encontrado")
                return False
            
            # Actualizar precio
            query = "UPDATE articulo SET precio_venta = ? WHERE idarticulo = ?"
            cursor.execute(query, (nuevo_precio, idarticulo))
            
            self.conn.commit()
            
            if cursor.rowcount > 0:
                logger.info(f"‚úÖ Precio actualizado en BD para art√≠culo {idarticulo}: {nuevo_precio}")
                return True
            else:
                logger.warning(f"‚ö†Ô∏è No se actualiz√≥ ning√∫n registro para art√≠culo {idarticulo}")
                return False
                
        except Exception as e:
            logger.error(f"‚ùå Error actualizando precio en BD: {e}")
            self.conn.rollback()
            return False
    
    def actualizar_stock_minimo(self, idarticulo, stock_minimo):
        """
        Actualiza el stock m√≠nimo de un art√≠culo
        """
        try:
            cursor = self.conn.cursor()
            
            # Verificar que el art√≠culo existe
            cursor.execute("SELECT idarticulo FROM articulo WHERE idarticulo = ?", (idarticulo,))
            if not cursor.fetchone():
                logger.warning(f"‚ö†Ô∏è Art√≠culo {idarticulo} no encontrado")
                return False
            
            # Actualizar stock m√≠nimo
            query = "UPDATE articulo SET stock_minimo = ? WHERE idarticulo = ?"
            cursor.execute(query, (stock_minimo, idarticulo))
            
            self.conn.commit()
            
            if cursor.rowcount > 0:
                logger.info(f"‚úÖ Stock m√≠nimo actualizado en BD para art√≠culo {idarticulo}: {stock_minimo}")
                return True
            else:
                logger.warning(f"‚ö†Ô∏è No se actualiz√≥ ning√∫n registro para art√≠culo {idarticulo}")
                return False
                
        except Exception as e:
            logger.error(f"‚ùå Error actualizando stock m√≠nimo en BD: {e}")
            self.conn.rollback()
            return False
    
    def actualizar_nombre(self, idarticulo, nuevo_nombre):
        """
        Actualiza el nombre de un art√≠culo
        """
        try:
            cursor = self.conn.cursor()
            
            # Verificar que el art√≠culo existe
            cursor.execute("SELECT idarticulo FROM articulo WHERE idarticulo = ?", (idarticulo,))
            if not cursor.fetchone():
                logger.warning(f"‚ö†Ô∏è Art√≠culo {idarticulo} no encontrado")
                return False
            
            # Actualizar nombre
            query = "UPDATE articulo SET nombre = ? WHERE idarticulo = ?"
            cursor.execute(query, (nuevo_nombre, idarticulo))
            
            self.conn.commit()
            
            if cursor.rowcount > 0:
                logger.info(f"‚úÖ Nombre actualizado en BD para art√≠culo {idarticulo}: {nuevo_nombre}")
                return True
            else:
                logger.warning(f"‚ö†Ô∏è No se actualiz√≥ ning√∫n registro para art√≠culo {idarticulo}")
                return False
                
        except Exception as e:
            logger.error(f"‚ùå Error actualizando nombre en BD: {e}")
            self.conn.rollback()
            return False
    
    def actualizar_categoria(self, idarticulo, nueva_categoria):
        """
        Actualiza la categor√≠a de un art√≠culo
        
        Args:
            idarticulo: ID del art√≠culo
            nueva_categoria: ID de la nueva categor√≠a
            
        Returns:
            bool: True si se actualiz√≥ correctamente
        """
        try:
            cursor = self.conn.cursor()
            
            # Verificar que el art√≠culo existe
            cursor.execute("SELECT idarticulo FROM articulo WHERE idarticulo = ?", (idarticulo,))
            if not cursor.fetchone():
                logger.warning(f"‚ö†Ô∏è Art√≠culo {idarticulo} no encontrado")
                return False
            
            # Verificar que la categor√≠a existe
            cursor.execute("SELECT idcategoria FROM categoria WHERE idcategoria = ?", (nueva_categoria,))
            if not cursor.fetchone():
                logger.warning(f"‚ö†Ô∏è Categor√≠a {nueva_categoria} no encontrada")
                return False
            
            # Actualizar categor√≠a
            query = "UPDATE articulo SET idcategoria = ? WHERE idarticulo = ?"
            cursor.execute(query, (nueva_categoria, idarticulo))
            
            self.conn.commit()
            
            if cursor.rowcount > 0:
                logger.info(f"‚úÖ Categor√≠a actualizada en BD para art√≠culo {idarticulo}: {nueva_categoria}")
                return True
            else:
                logger.warning(f"‚ö†Ô∏è No se actualiz√≥ ning√∫n registro para art√≠culo {idarticulo}")
                return False
                
        except Exception as e:
            logger.error(f"‚ùå Error actualizando categor√≠a en BD: {e}")
            self.conn.rollback()
            return False

----- capa_datos/auditoria_repo.py -----
"""
Repositorio para log de auditor√≠a
"""
from loguru import logger

class AuditoriaRepositorio:
    """Maneja las operaciones de BD para auditor√≠a"""
    
    def __init__(self, conn):
        """
        Inicializa el repositorio con una conexi√≥n a la BD
        
        Args:
            conn: Conexi√≥n a la base de datos
        """
        self.conn = conn
    
    def insertar(self, usuario, accion, tabla, registro_id, 
                 datos_anteriores, datos_nuevos, ip_address):
        """
        Inserta un registro en el log de auditor√≠a
        
        Returns:
            bool: True si se insert√≥ correctamente
        """
        try:
            cursor = self.conn.cursor()
            query = """
            INSERT INTO log_auditoria 
            (usuario, accion, tabla_afectada, registro_id, 
             datos_anteriores, datos_nuevos, ip_address, fecha_hora)
            VALUES (?, ?, ?, ?, ?, ?, ?, GETDATE())
            """
            cursor.execute(query, (
                usuario, accion, tabla, registro_id,
                datos_anteriores, datos_nuevos, ip_address
            ))
            self.conn.commit()
            return True
            
        except Exception as e:
            logger.error(f"Error insertando auditor√≠a: {e}")
            self.conn.rollback()
            return False
    
    def consultar_por_fecha(self, fecha_inicio, fecha_fin):
        """
        Consulta registros de auditor√≠a por rango de fechas
        """
        try:
            cursor = self.conn.cursor()
            query = """
            SELECT * FROM log_auditoria 
            WHERE fecha_hora BETWEEN ? AND ?
            ORDER BY fecha_hora DESC
            """
            cursor.execute(query, (fecha_inicio, fecha_fin))
            
            # Convertir a diccionario
            columns = [column[0] for column in cursor.description]
            rows = cursor.fetchall()
            result = [dict(zip(columns, row)) for row in rows]
            
            return result
            
        except Exception as e:
            logger.error(f"Error consultando auditor√≠a: {e}")
            return []
    
    def consultar_por_usuario(self, usuario):
        """
        Consulta registros de un usuario espec√≠fico
        """
        try:
            cursor = self.conn.cursor()
            query = """
            SELECT * FROM log_auditoria 
            WHERE usuario = ?
            ORDER BY fecha_hora DESC
            """
            cursor.execute(query, (usuario,))
            
            # Convertir a diccionario
            columns = [column[0] for column in cursor.description]
            rows = cursor.fetchall()
            result = [dict(zip(columns, row)) for row in rows]
            
            return result
            
        except Exception as e:
            logger.error(f"Error consultando auditor√≠a: {e}")
            return []
    
    def consultar_por_tabla(self, tabla, registro_id):
        """
        Consulta historial de cambios en un registro espec√≠fico
        """
        try:
            cursor = self.conn.cursor()
            query = """
            SELECT * FROM log_auditoria 
            WHERE tabla_afectada = ? AND registro_id = ?
            ORDER BY fecha_hora DESC
            """
            cursor.execute(query, (tabla, registro_id))
            
            # Convertir a diccionario
            columns = [column[0] for column in cursor.description]
            rows = cursor.fetchall()
            result = [dict(zip(columns, row)) for row in rows]
            
            return result
            
        except Exception as e:
            logger.error(f"Error consultando auditor√≠a: {e}")
            return []

----- capa_datos/categoria_repo.py -----
from typing import List, Dict, Optional
from loguru import logger

class CategoriaRepositorio:
    """Repositorio para operaciones CRUD de categor√≠a"""
    
    def __init__(self, conexion):
        self.conexion = conexion
        self.cursor = conexion.cursor()
    
    def listar(self) -> List[Dict]:
        """Lista todas las categor√≠as"""
        try:
            self.cursor.execute("SELECT idcategoria, nombre, descripcion FROM categoria ORDER BY nombre")
            columnas = [column[0] for column in self.cursor.description]
            resultados = []
            for row in self.cursor.fetchall():
                resultados.append(dict(zip(columnas, row)))
            logger.info(f"‚úÖ {len(resultados)} categor√≠as listadas")
            return resultados
        except Exception as e:
            logger.error(f"‚ùå Error al listar categor√≠as: {e}")
            return []
    
    def obtener_por_id(self, idcategoria: int) -> Optional[Dict]:
        """Obtiene una categor√≠a por su ID"""
        try:
            self.cursor.execute(
                "SELECT idcategoria, nombre, descripcion FROM categoria WHERE idcategoria = ?",
                (idcategoria,)
            )
            row = self.cursor.fetchone()
            if row:
                return {
                    'idcategoria': row[0],
                    'nombre': row[1],
                    'descripcion': row[2]
                }
            return None
        except Exception as e:
            logger.error(f"‚ùå Error al obtener categor√≠a {idcategoria}: {e}")
            return None
    
    def insertar(self, nombre: str, descripcion: str = None) -> bool:
        """Inserta una nueva categor√≠a"""
        try:
            self.cursor.execute(
                "INSERT INTO categoria (nombre, descripcion) VALUES (?, ?)",
                (nombre, descripcion)
            )
            self.cursor.commit()
            logger.success(f"‚úÖ Categor√≠a '{nombre}' insertada")
            return True
        except Exception as e:
            logger.error(f"‚ùå Error al insertar categor√≠a: {e}")
            return False
    
    def actualizar(self, idcategoria: int, nombre: str, descripcion: str = None) -> bool:
        """Actualiza una categor√≠a existente"""
        try:
            self.cursor.execute(
                "UPDATE categoria SET nombre = ?, descripcion = ? WHERE idcategoria = ?",
                (nombre, descripcion, idcategoria)
            )
            self.cursor.commit()
            logger.success(f"‚úÖ Categor√≠a ID {idcategoria} actualizada")
            return True
        except Exception as e:
            logger.error(f"‚ùå Error al actualizar categor√≠a: {e}")
            return False
    
    def eliminar(self, idcategoria: int) -> bool:
        """Elimina una categor√≠a"""
        try:
            self.cursor.execute("DELETE FROM categoria WHERE idcategoria = ?", (idcategoria,))
            self.cursor.commit()
            logger.success(f"‚úÖ Categor√≠a ID {idcategoria} eliminada")
            return True
        except Exception as e:
            logger.error(f"‚ùå Error al eliminar categor√≠a: {e}")
            return False

----- capa_datos/cliente_repo.py -----
"""
Repositorio para la gesti√≥n de clientes en la base de datos
"""
from loguru import logger

class ClienteRepositorio:
    """Clase que maneja las operaciones de base de datos para clientes"""
    
    def __init__(self, conn):
        """
        Inicializa el repositorio con una conexi√≥n a la base de datos
        
        Args:
            conn: Conexi√≥n a la base de datos
        """
        self.conn = conn
    
    def _row_to_dict(self, row, description):
        """
        Convierte una fila de pyodbc a diccionario
        """
        if not row:
            return None
        return {desc[0]: value for desc, value in zip(description, row)}
    
    def _rows_to_dicts(self, rows, description):
        """
        Convierte m√∫ltiples filas de pyodbc a lista de diccionarios
        """
        if not rows:
            return []
        return [self._row_to_dict(row, description) for row in rows]
    
    def listar(self):
        """
        Lista todos los clientes activos
        
        Returns:
            list: Lista de clientes o lista vac√≠a si hay error
        """
        try:
            cursor = self.conn.cursor()
            query = """
            SELECT idcliente, nombre, apellidos, fecha_nacimiento, 
                   tipo_documento, num_documento, sexo, direccion, telefono, email
            FROM cliente 
            ORDER BY idcliente DESC
            """
            cursor.execute(query)
            rows = cursor.fetchall()
            description = cursor.description
            return self._rows_to_dicts(rows, description)
        except Exception as e:
            logger.error(f"Error al listar clientes: {e}")
            return []
    
    def obtener_por_id(self, idcliente):
        """
        Obtiene un cliente por su ID
        
        Args:
            idcliente (int): ID del cliente
            
        Returns:
            dict: Datos del cliente o None si no existe
        """
        try:
            cursor = self.conn.cursor()
            query = """
            SELECT idcliente, nombre, apellidos, fecha_nacimiento, 
                   tipo_documento, num_documento, sexo, direccion, telefono, email
            FROM cliente 
            WHERE idcliente = ?
            """
            cursor.execute(query, (idcliente,))
            row = cursor.fetchone()
            description = cursor.description
            return self._row_to_dict(row, description)
        except Exception as e:
            logger.error(f"Error al obtener cliente {idcliente}: {e}")
            return None
    
    def buscar_por_documento(self, tipo_documento, num_documento):
        """
        Busca un cliente por tipo y n√∫mero de documento
        
        Args:
            tipo_documento (str): Tipo de documento (V, E, J, G, C)
            num_documento (str): N√∫mero de documento
            
        Returns:
            dict: Datos del cliente o None si no existe
        """
        try:
            cursor = self.conn.cursor()
            query = """
            SELECT idcliente, nombre, apellidos, fecha_nacimiento, 
                   tipo_documento, num_documento
            FROM cliente 
            WHERE tipo_documento = ? AND num_documento = ?
            """
            cursor.execute(query, (tipo_documento, num_documento))
            row = cursor.fetchone()
            description = cursor.description
            return self._row_to_dict(row, description)
        except Exception as e:
            logger.error(f"Error al buscar cliente por documento {tipo_documento}-{num_documento}: {e}")
            return None
    
    def crear(self, nombre, apellidos, fecha_nacimiento, tipo_documento, 
              num_documento, sexo=None, direccion=None, telefono=None, email=None):
        """
        Inserta un nuevo cliente (fecha_nacimiento puede ser NULL)
        """
        try:
            cursor = self.conn.cursor()
            
            query = """
            INSERT INTO cliente 
            (nombre, apellidos, fecha_nacimiento, tipo_documento, num_documento, 
             sexo, direccion, telefono, email)
            OUTPUT INSERTED.idcliente
            VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
            """
            
            cursor.execute(query, (
                nombre, apellidos, fecha_nacimiento, tipo_documento, num_documento,
                sexo, direccion, telefono, email
            ))
            
            row = cursor.fetchone()
            idcliente = row[0] if row else None
            self.conn.commit()
            
            if idcliente:
                logger.info(f"‚úÖ Cliente creado con ID: {idcliente}")
                return idcliente
            return None
                
        except Exception as e:
            logger.error(f"‚ùå Error al crear cliente: {e}")
            self.conn.rollback()
            return None
    
    def actualizar(self, idcliente, nombre, apellidos, fecha_nacimiento, tipo_documento,
                   num_documento, sexo=None, direccion=None, telefono=None, email=None):
        """
        Actualiza un cliente existente
        
        Returns:
            bool: True si se actualiz√≥ correctamente, False en caso contrario
        """
        try:
            cursor = self.conn.cursor()
            query = """
            UPDATE cliente 
            SET nombre = ?, apellidos = ?, fecha_nacimiento = ?,
                tipo_documento = ?, num_documento = ?, sexo = ?,
                direccion = ?, telefono = ?, email = ?
            WHERE idcliente = ?
            """
            cursor.execute(query, (
                nombre, apellidos, fecha_nacimiento, tipo_documento, num_documento,
                sexo, direccion, telefono, email, idcliente
            ))
            self.conn.commit()
            afectadas = cursor.rowcount
            if afectadas > 0:
                logger.info(f"‚úÖ Cliente {idcliente} actualizado correctamente")
                return True
            else:
                logger.warning(f"‚ö†Ô∏è No se encontr√≥ el cliente {idcliente} para actualizar")
                return False
        except Exception as e:
            logger.error(f"‚ùå Error al actualizar cliente {idcliente}: {e}")
            self.conn.rollback()
            return False
    
    def eliminar(self, idcliente):
        """
        Elimina un cliente (f√≠sicamente de la BD)
        
        Returns:
            bool: True si se elimin√≥ correctamente, False en caso contrario
        """
        try:
            cursor = self.conn.cursor()
            
            # Verificar si el cliente tiene ventas asociadas
            check_query = "SELECT COUNT(*) as total FROM venta WHERE idcliente = ?"
            cursor.execute(check_query, (idcliente,))
            row = cursor.fetchone()
            total = row[0] if row else 0
            
            if total > 0:
                logger.warning(f"‚ö†Ô∏è Cliente {idcliente} tiene ventas asociadas. No se puede eliminar")
                return False
            
            # Eliminaci√≥n f√≠sica
            query = "DELETE FROM cliente WHERE idcliente = ?"
            cursor.execute(query, (idcliente,))
            self.conn.commit()
            
            if cursor.rowcount > 0:
                logger.info(f"‚úÖ Cliente {idcliente} eliminado correctamente")
                return True
            else:
                logger.warning(f"‚ö†Ô∏è No se encontr√≥ el cliente {idcliente} para eliminar")
                return False
                
        except Exception as e:
            logger.error(f"‚ùå Error al eliminar cliente {idcliente}: {e}")
            self.conn.rollback()
            return False
    
    def buscar_por_nombre(self, termino):
        """
        Busca clientes por nombre o apellido (b√∫squeda parcial)
        """
        try:
            cursor = self.conn.cursor()
            query = """
            SELECT idcliente, nombre, apellidos, fecha_nacimiento, 
                   tipo_documento, num_documento, telefono, email
            FROM cliente 
            WHERE nombre LIKE ? OR apellidos LIKE ?
            ORDER BY nombre, apellidos
            """
            busqueda = f"%{termino}%"
            cursor.execute(query, (busqueda, busqueda))
            rows = cursor.fetchall()
            description = cursor.description
            return self._rows_to_dicts(rows, description)
        except Exception as e:
            logger.error(f"Error al buscar clientes por nombre '{termino}': {e}")
            return []
    
    def contar_clientes(self):
        """
        Cuenta el n√∫mero total de clientes
        """
        try:
            cursor = self.conn.cursor()
            query = "SELECT COUNT(*) as total FROM cliente"
            cursor.execute(query)
            row = cursor.fetchone()
            return row[0] if row else 0
        except Exception as e:
            logger.error(f"Error al contar clientes: {e}")
            return 0
    
    def clientes_recientes(self, limite=10):
        """
        Obtiene los clientes m√°s recientes
        """
        try:
            cursor = self.conn.cursor()
            query = """
            SELECT TOP (?) idcliente, nombre, apellidos, fecha_nacimiento, 
                   tipo_documento, num_documento, telefono, email
            FROM cliente 
            ORDER BY idcliente DESC
            """
            cursor.execute(query, (limite,))
            rows = cursor.fetchall()
            description = cursor.description
            return self._rows_to_dicts(rows, description)
        except Exception as e:
            logger.error(f"Error al obtener clientes recientes: {e}")
            return []

----- capa_datos/compra_repo.py -----
"""
Repositorio para gesti√≥n de compras
"""
from loguru import logger
from capa_datos.conexion import ConexionDB

class CompraRepositorio:
    def __init__(self):
        self.db = ConexionDB()
        self.conn = self.db.conectar()
    
    def crear(self, idproveedor, idtrabajador, tipo_comprobante, serie, numero,
              subtotal, iva, total, observaciones=None):
        """Crea una nueva compra"""
        try:
            cursor = self.conn.cursor()
            query = """
            INSERT INTO compra 
            (idproveedor, idtrabajador, fecha_hora, tipo_comprobante, serie, 
             numero_comprobante, subtotal, iva, total, estado, observaciones)
            OUTPUT INSERTED.idcompra
            VALUES (?, ?, GETDATE(), ?, ?, ?, ?, ?, ?, 'REGISTRADA', ?)
            """
            cursor.execute(query, (idproveedor, idtrabajador, tipo_comprobante, 
                                  serie, numero, subtotal, iva, total, observaciones))
            idcompra = cursor.fetchone()[0]
            self.conn.commit()
            logger.info(f"Compra #{idcompra} creada")
            return idcompra
        except Exception as e:
            logger.error(f"Error creando compra: {e}")
            self.conn.rollback()
            return None
    
    def agregar_detalle(self, idcompra, idarticulo, cantidad, precio_compra, subtotal):
        """Agrega un detalle a la compra"""
        try:
            cursor = self.conn.cursor()
            query = """
            INSERT INTO detalle_compra (idcompra, idarticulo, cantidad, precio_compra, subtotal)
            OUTPUT INSERTED.iddetalle_compra
            VALUES (?, ?, ?, ?, ?)
            """
            cursor.execute(query, (idcompra, idarticulo, cantidad, precio_compra, subtotal))
            iddetalle = cursor.fetchone()[0]
            self.conn.commit()
            return iddetalle
        except Exception as e:
            logger.error(f"Error agregando detalle: {e}")
            self.conn.rollback()
            return None
    
    def listar(self):
        """Lista todas las compras"""
        try:
            cursor = self.conn.cursor()
            query = """
            SELECT c.idcompra, c.fecha_hora, c.tipo_comprobante, c.serie, c.numero_comprobante,
                   c.subtotal, c.iva, c.total, c.estado,
                   p.razon_social as proveedor,
                   t.nombre + ' ' + t.apellidos as trabajador
            FROM compra c
            JOIN proveedor p ON c.idproveedor = p.idproveedor
            JOIN trabajador t ON c.idtrabajador = t.idtrabajador
            ORDER BY c.fecha_hora DESC
            """
            cursor.execute(query)
            columns = [col[0] for col in cursor.description]
            return [dict(zip(columns, row)) for row in cursor.fetchall()]
        except Exception as e:
            logger.error(f"Error listando compras: {e}")
            return []
    
    def buscar_por_id(self, idcompra):
        """Busca una compra por ID con sus detalles"""
        try:
            cursor = self.conn.cursor()
            
            # Cabecera
            query = """
            SELECT c.*, p.razon_social as proveedor, p.rif,
                   t.nombre + ' ' + t.apellidos as trabajador
            FROM compra c
            JOIN proveedor p ON c.idproveedor = p.idproveedor
            JOIN trabajador t ON c.idtrabajador = t.idtrabajador
            WHERE c.idcompra = ?
            """
            cursor.execute(query, (idcompra,))
            cabecera = cursor.fetchone()
            
            if not cabecera:
                return None
            
            columns = [col[0] for col in cursor.description]
            resultado = dict(zip(columns, cabecera))
            
            # Detalles
            query = """
            SELECT d.*, a.nombre as articulo, a.codigo_barras
            FROM detalle_compra d
            JOIN articulo a ON d.idarticulo = a.idarticulo
            WHERE d.idcompra = ?
            """
            cursor.execute(query, (idcompra,))
            detalles = cursor.fetchall()
            
            det_columns = [col[0] for col in cursor.description]
            resultado['detalles'] = [dict(zip(det_columns, row)) for row in detalles]
            
            return resultado
        except Exception as e:
            logger.error(f"Error buscando compra {idcompra}: {e}")
            return None
    
    def anular(self, idcompra):
        """Anula una compra"""
        try:
            cursor = self.conn.cursor()
            query = "UPDATE compra SET estado = 'ANULADA' WHERE idcompra = ?"
            cursor.execute(query, (idcompra,))
            self.conn.commit()
            logger.info(f"Compra #{idcompra} anulada")
            return True
        except Exception as e:
            logger.error(f"Error anulando compra: {e}")
            self.conn.rollback()
            return False

----- capa_datos/conexion.py -----
import pyodbc
import os
from dotenv import load_dotenv
from loguru import logger

# Cargar variables de entorno
load_dotenv()

class ConexionDB:
    """Singleton para manejar la conexi√≥n a SQL Server"""
    
    _instance = None
    
    def __new__(cls):
        if cls._instance is None:
            cls._instance = super().__new__(cls)
            cls._instance._inicializar()
        return cls._instance
    
    def _inicializar(self):
        self.server = os.getenv('DB_SERVER', 'localhost,1433')
        self.database = os.getenv('DB_NAME', 'SistemaVentas')
        self.username = os.getenv('DB_USER', 'sa')
        self.password = os.getenv('DB_PASSWORD', 'Santi07.')
        self.driver = os.getenv('DB_DRIVER', '{ODBC Driver 18 for SQL Server}')
        self.conn = None
    
    def conectar(self):
        """Establece conexi√≥n con la base de datos"""
        try:
            conn_str = (
                f"DRIVER={self.driver};"
                f"SERVER={self.server};"
                f"DATABASE={self.database};"
                f"UID={self.username};"
                f"PWD={self.password};"
                f"TrustServerCertificate=yes;"
            )
            self.conn = pyodbc.connect(conn_str)
            logger.success("‚úÖ Conexi√≥n exitosa a SQL Server")
            return self.conn
        except Exception as e:
            logger.error(f"‚ùå Error de conexi√≥n: {e}")
            return None
    
    def cerrar(self):
        if self.conn:
            self.conn.close()
            logger.info("üîí Conexi√≥n cerrada")

----- capa_datos/ingreso_repo.py -----
from typing import List, Dict, Optional
from datetime import datetime
from loguru import logger

class IngresoRepositorio:
    """Repositorio para operaciones CRUD de ingresos"""
    
    def __init__(self, conexion):
        self.conexion = conexion
        self.cursor = conexion.cursor()
    
    def listar(self) -> List[Dict]:
        """Lista todos los ingresos"""
        try:
            query = """
                SELECT i.idingreso, i.fecha, i.tipo_comprobante, i.serie, i.numero_comprobante,
                       i.igv, i.estado,
                       p.razon_social as proveedor,
                       t.nombre + ' ' + t.apellidos as trabajador
                FROM ingreso i
                INNER JOIN proveedor p ON i.idproveedor = p.idproveedor
                INNER JOIN trabajador t ON i.idtrabajador = t.idtrabajador
                ORDER BY i.fecha DESC
            """
            self.cursor.execute(query)
            columnas = [column[0] for column in self.cursor.description]
            resultados = []
            for row in self.cursor.fetchall():
                resultados.append(dict(zip(columnas, row)))
            logger.info(f"‚úÖ {len(resultados)} ingresos listados")
            return resultados
        except Exception as e:
            logger.error(f"‚ùå Error al listar ingresos: {e}")
            return []
    
    def obtener_por_id(self, idingreso: int) -> Optional[Dict]:
        """Obtiene un ingreso por su ID con su detalle"""
        try:
            # Obtener cabecera
            self.cursor.execute("""
                SELECT i.*, p.razon_social as proveedor,
                       t.nombre + ' ' + t.apellidos as trabajador
                FROM ingreso i
                INNER JOIN proveedor p ON i.idproveedor = p.idproveedor
                INNER JOIN trabajador t ON i.idtrabajador = t.idtrabajador
                WHERE i.idingreso = ?
            """, (idingreso,))
            row = self.cursor.fetchone()
            
            if not row:
                return None
            
            columnas = [column[0] for column in self.cursor.description]
            ingreso = dict(zip(columnas, row))
            
            # Obtener detalle
            ingreso['detalle'] = self.obtener_detalle(idingreso)
            
            return ingreso
        except Exception as e:
            logger.error(f"‚ùå Error al obtener ingreso {idingreso}: {e}")
            return None
    
    def obtener_detalle(self, idingreso: int) -> List[Dict]:
        """Obtiene el detalle de un ingreso"""
        try:
            self.cursor.execute("""
                SELECT di.iddetalle_ingreso, di.cantidad, di.precio_compra,
                       a.idarticulo, a.codigo, a.nombre as articulo
                FROM detalle_ingreso di
                INNER JOIN articulo a ON di.idarticulo = a.idarticulo
                WHERE di.idingreso = ?
            """, (idingreso,))
            columnas = [column[0] for column in self.cursor.description]
            resultados = []
            for row in self.cursor.fetchall():
                resultados.append(dict(zip(columnas, row)))
            return resultados
        except Exception as e:
            logger.error(f"‚ùå Error al obtener detalle del ingreso: {e}")
            return []
    
    def insertar(self, idtrabajador: int, idproveedor: int,
                 tipo_comprobante: str, serie: str, numero_comprobante: str,
                 igv: float, fecha: datetime = None,
                 detalle: List[Dict] = None) -> Optional[int]:
        """Inserta un nuevo ingreso con su detalle"""
        try:
            # Iniciar transacci√≥n
            self.cursor.execute("BEGIN TRANSACTION")
            
            if not fecha:
                fecha = datetime.now()
            
            # Insertar cabecera
            self.cursor.execute("""
                INSERT INTO ingreso 
                (idtrabajador, idproveedor, fecha, tipo_comprobante, 
                 serie, numero_comprobante, igv, estado)
                OUTPUT INSERTED.idingreso
                VALUES (?, ?, ?, ?, ?, ?, ?, 'REGISTRADO')
            """, (idtrabajador, idproveedor, fecha, tipo_comprobante,
                  serie, numero_comprobante, igv))
            
            idingreso = self.cursor.fetchone()[0]
            
            # Insertar detalle
            if detalle:
                for item in detalle:
                    self.cursor.execute("""
                        INSERT INTO detalle_ingreso 
                        (idingreso, idarticulo, cantidad, precio_compra)
                        VALUES (?, ?, ?, ?)
                    """, (idingreso, item['idarticulo'], item['cantidad'], 
                          item['precio_compra']))
            
            self.cursor.execute("COMMIT TRANSACTION")
            logger.success(f"‚úÖ Ingreso ID {idingreso} insertado")
            return idingreso
            
        except Exception as e:
            self.cursor.execute("ROLLBACK TRANSACTION")
            logger.error(f"‚ùå Error al insertar ingreso: {e}")
            return None
    
    def anular(self, idingreso: int) -> bool:
        """Anula un ingreso"""
        try:
            self.cursor.execute("""
                UPDATE ingreso SET estado = 'ANULADO'
                WHERE idingreso = ?
            """, (idingreso,))
            self.cursor.commit()
            logger.success(f"‚úÖ Ingreso ID {idingreso} anulado")
            return True
        except Exception as e:
            logger.error(f"‚ùå Error al anular ingreso: {e}")
            return False

----- capa_datos/inventario_repo.py -----
"""
Repositorio para gesti√≥n de inventario (Kardex)
"""
from loguru import logger
from capa_datos.conexion import ConexionDB

class InventarioRepositorio:
    def __init__(self):
        """Inicializa el repositorio de inventario"""
        self.db = ConexionDB()
        self.conn = self.db.conectar()
    
    def obtener_stock_actual(self, idarticulo):
        """
        Obtiene el stock actual de un art√≠culo desde kardex
        
        Args:
            idarticulo: ID del art√≠culo
            
        Returns:
            int: Stock actual, 0 si no hay registros
        """
        try:
            cursor = self.conn.cursor()
            query = """
            SELECT TOP 1 stock_nuevo 
            FROM kardex 
            WHERE idarticulo = ? 
            ORDER BY fecha_movimiento DESC
            """
            cursor.execute(query, (idarticulo,))
            resultado = cursor.fetchone()
            
            if resultado:
                return resultado[0]
            return 0
            
        except Exception as e:
            logger.error(f"Error obteniendo stock actual para art√≠culo {idarticulo}: {e}")
            return 0
    
    def registrar_movimiento(self, idarticulo, tipo_movimiento, cantidad,
                            referencia, precio_compra=None, lote=None,
                            fecha_vencimiento=None):
        """
        Registra un movimiento en la tabla kardex
        
        Args:
            idarticulo: ID del art√≠culo
            tipo_movimiento: 'INGRESO' o 'SALIDA' (valores permitidos por la BD)
            cantidad: Cantidad
            referencia: Documento de referencia
            precio_compra: Precio unitario (opcional)
            lote: N√∫mero de lote (no se usa en esta estructura)
            fecha_vencimiento: Fecha de vencimiento (no se usa en esta estructura)
            
        Returns:
            bool: True si se registr√≥ correctamente
        """
        try:
            cursor = self.conn.cursor()
            
            # Obtener stock actual
            stock_actual = self.obtener_stock_actual(idarticulo)
            
            # Validar y convertir tipo_movimiento a valores permitidos
            tipo_valido = tipo_movimiento
            if tipo_movimiento == 'ENTRADA':
                tipo_valido = 'INGRESO'  # Asumimos que acepta 'INGRESO'
            
            # Calcular stock nuevo
            if tipo_movimiento == 'ENTRADA':
                stock_nuevo = stock_actual + cantidad
            else:  # SALIDA
                stock_nuevo = stock_actual - cantidad
            
            # Calcular valor total
            valor_total = cantidad * precio_compra if precio_compra else 0
            
            query = """
            INSERT INTO kardex 
            (idarticulo, fecha_movimiento, tipo_movimiento, documento_referencia,
             cantidad, precio_unitario, valor_total, stock_anterior, stock_nuevo)
            VALUES (?, GETDATE(), ?, ?, ?, ?, ?, ?, ?)
            """
            
            cursor.execute(query, (
                idarticulo, tipo_valido, referencia,
                cantidad, precio_compra, valor_total,
                stock_actual, stock_nuevo
            ))
            
            self.conn.commit()
            logger.info(f"‚úÖ Movimiento registrado en kardex: {tipo_valido} {cantidad} und - Art {idarticulo}")
            return True
            
        except Exception as e:
            logger.error(f"‚ùå Error registrando movimiento en kardex: {e}")
            self.conn.rollback()
            return False
    
    def obtener_movimientos_articulo(self, idarticulo, limite=100):
        """
        Obtiene los √∫ltimos movimientos de un art√≠culo
        
        Args:
            idarticulo: ID del art√≠culo
            limite: N√∫mero m√°ximo de registros
            
        Returns:
            list: Lista de movimientos
        """
        try:
            cursor = self.conn.cursor()
            query = """
            SELECT * FROM kardex 
            WHERE idarticulo = ? 
            ORDER BY fecha_movimiento DESC
            """
            cursor.execute(query, (idarticulo,))
            
            columns = [col[0] for col in cursor.description]
            return [dict(zip(columns, row)) for row in cursor.fetchall()][:limite]
            
        except Exception as e:
            logger.error(f"Error obteniendo movimientos para art√≠culo {idarticulo}: {e}")
            return []
    
    def cerrar_conexion(self):
        """Cierra la conexi√≥n a la base de datos"""
        try:
            if hasattr(self, 'db'):
                self.db.cerrar()
        except:
            pass

----- capa_datos/lote_repo.py -----
from typing import List, Dict, Optional
from datetime import datetime
from loguru import logger

class LoteRepositorio:
    """Repositorio para operaciones CRUD de lotes"""
    
    def __init__(self, conexion):
        self.conexion = conexion
        self.cursor = conexion.cursor()
    
    def listar_por_articulo(self, idarticulo: int) -> List[Dict]:
        """Lista los lotes de un art√≠culo espec√≠fico"""
        try:
            self.cursor.execute("""
                SELECT l.idlote, l.codigo_lote, l.fecha_produccion,
                       l.fecha_vencimiento, l.stock_actual,
                       i.fecha as fecha_ingreso
                FROM lote l
                INNER JOIN ingreso i ON l.idingreso = i.idingreso
                WHERE l.idarticulo = ?
                ORDER BY l.fecha_vencimiento ASC
            """, (idarticulo,))
            columnas = [column[0] for column in self.cursor.description]
            resultados = []
            for row in self.cursor.fetchall():
                resultados.append(dict(zip(columnas, row)))
            logger.info(f"‚úÖ {len(resultados)} lotes listados para art√≠culo {idarticulo}")
            return resultados
        except Exception as e:
            logger.error(f"‚ùå Error al listar lotes: {e}")
            return []
    
    def obtener_por_id(self, idlote: int) -> Optional[Dict]:
        """Obtiene un lote por su ID"""
        try:
            self.cursor.execute("""
                SELECT l.*, a.nombre as articulo, a.codigo
                FROM lote l
                INNER JOIN articulo a ON l.idarticulo = a.idarticulo
                WHERE l.idlote = ?
            """, (idlote,))
            row = self.cursor.fetchone()
            if row:
                columnas = [column[0] for column in self.cursor.description]
                return dict(zip(columnas, row))
            return None
        except Exception as e:
            logger.error(f"‚ùå Error al obtener lote {idlote}: {e}")
            return None
    
    def obtener_stock_articulo(self, idarticulo: int) -> int:
        """Obtiene el stock total de un art√≠culo sumando todos sus lotes"""
        try:
            self.cursor.execute("""
                SELECT SUM(stock_actual) as stock_total
                FROM lote
                WHERE idarticulo = ?
            """, (idarticulo,))
            row = self.cursor.fetchone()
            return row[0] if row[0] else 0
        except Exception as e:
            logger.error(f"‚ùå Error al obtener stock del art√≠culo {idarticulo}: {e}")
            return 0
    
    def insertar(self, idarticulo: int, idingreso: int,
                 codigo_lote: str = None,
                 fecha_produccion: datetime = None,
                 fecha_vencimiento: datetime = None,
                 stock_actual: int = 0) -> bool:
        """Inserta un nuevo lote"""
        try:
            self.cursor.execute("""
                INSERT INTO lote 
                (idarticulo, idingreso, codigo_lote, fecha_produccion, 
                 fecha_vencimiento, stock_actual) 
                VALUES (?, ?, ?, ?, ?, ?)
            """, (idarticulo, idingreso, codigo_lote, fecha_produccion,
                  fecha_vencimiento, stock_actual))
            self.cursor.commit()
            logger.success(f"‚úÖ Lote insertado para art√≠culo {idarticulo}")
            return True
        except Exception as e:
            logger.error(f"‚ùå Error al insertar lote: {e}")
            return False
    
    def actualizar_stock(self, idlote: int, nuevo_stock: int) -> bool:
        """Actualiza el stock de un lote espec√≠fico"""
        try:
            self.cursor.execute("""
                UPDATE lote SET stock_actual = ?
                WHERE idlote = ?
            """, (nuevo_stock, idlote))
            self.cursor.commit()
            logger.success(f"‚úÖ Stock del lote {idlote} actualizado a {nuevo_stock}")
            return True
        except Exception as e:
            logger.error(f"‚ùå Error al actualizar stock del lote: {e}")
            return False
    
    def eliminar(self, idlote: int) -> bool:
        """Elimina un lote"""
        try:
            self.cursor.execute("DELETE FROM lote WHERE idlote = ?", (idlote,))
            self.cursor.commit()
            logger.success(f"‚úÖ Lote ID {idlote} eliminado")
            return True
        except Exception as e:
            logger.error(f"‚ùå Error al eliminar lote: {e}")
            return False
    
    def lotes_proximos_vencer(self, dias: int = 30) -> List[Dict]:
        """Lista los lotes que vencen en los pr√≥ximos 'dias' d√≠as"""
        try:
            from datetime import datetime, timedelta
            fecha_limite = datetime.now() + timedelta(days=dias)
            
            self.cursor.execute("""
                SELECT l.idlote, l.codigo_lote, l.fecha_vencimiento, 
                       l.stock_actual, a.nombre as articulo, a.codigo
                FROM lote l
                INNER JOIN articulo a ON l.idarticulo = a.idarticulo
                WHERE l.fecha_vencimiento <= ? 
                  AND l.fecha_vencimiento >= GETDATE()
                  AND l.stock_actual > 0
                ORDER BY l.fecha_vencimiento ASC
            """, (fecha_limite,))
            columnas = [column[0] for column in self.cursor.description]
            resultados = []
            for row in self.cursor.fetchall():
                resultados.append(dict(zip(columnas, row)))
            logger.info(f"‚úÖ {len(resultados)} lotes pr√≥ximos a vencer")
            return resultados
        except Exception as e:
            logger.error(f"‚ùå Error al listar lotes pr√≥ximos a vencer: {e}")
            return []
    
    def lotes_vencidos(self) -> List[Dict]:
        """Lista los lotes ya vencidos"""
        try:
            self.cursor.execute("""
                SELECT l.idlote, l.codigo_lote, l.fecha_vencimiento, 
                       l.stock_actual, a.nombre as articulo, a.codigo
                FROM lote l
                INNER JOIN articulo a ON l.idarticulo = a.idarticulo
                WHERE l.fecha_vencimiento < GETDATE()
                  AND l.stock_actual > 0
                ORDER BY l.fecha_vencimiento ASC
            """)
            columnas = [column[0] for column in self.cursor.description]
            resultados = []
            for row in self.cursor.fetchall():
                resultados.append(dict(zip(columnas, row)))
            logger.info(f"‚úÖ {len(resultados)} lotes vencidos")
            return resultados
        except Exception as e:
            logger.error(f"‚ùå Error al listar lotes vencidos: {e}")
            return []

----- capa_datos/orden_compra_repo.py -----
"""
Repositorio para gesti√≥n de √≥rdenes de compra
"""
from loguru import logger
from capa_datos.conexion import ConexionDB

class OrdenCompraRepositorio:
    def __init__(self):
        self.db = ConexionDB()
        self.conn = self.db.conectar()
    
    def crear(self, codigo_factura, idproveedor, idtrabajador, fecha_compra,
              monto_total_usd, monto_total_bs, tasa_bcv, fecha_estimada_llegada,
              archivo_adjunto, estatus, observaciones):
        """Crea una nueva orden de compra"""
        try:
            cursor = self.conn.cursor()
            query = """
            INSERT INTO orden_compra 
            (codigo_factura, idproveedor, idtrabajador, fecha_orden, fecha_compra,
             fecha_estimada_llegada, monto_total_usd, monto_total_bs, tasa_bcv,
             archivo_adjunto, estatus, observaciones)
            OUTPUT INSERTED.idorden
            VALUES (?, ?, ?, GETDATE(), ?, ?, ?, ?, ?, ?, ?, ?)
            """
            cursor.execute(query, (
                codigo_factura, idproveedor, idtrabajador, fecha_compra,
                fecha_estimada_llegada, monto_total_usd, monto_total_bs, tasa_bcv,
                archivo_adjunto, estatus, observaciones
            ))
            idorden = cursor.fetchone()[0]
            self.conn.commit()
            return idorden
        except Exception as e:
            logger.error(f"Error creando orden: {e}")
            self.conn.rollback()
            return None
    
    def buscar_por_codigo_factura(self, codigo_factura):
        """Busca orden por c√≥digo de factura"""
        try:
            cursor = self.conn.cursor()
            query = """
            SELECT o.*, p.razon_social as proveedor, p.num_documento as rif,
                   t.nombre + ' ' + t.apellidos as trabajador
            FROM orden_compra o
            JOIN proveedor p ON o.idproveedor = p.idproveedor
            JOIN trabajador t ON o.idtrabajador = t.idtrabajador
            WHERE o.codigo_factura = ?
            """
            cursor.execute(query, (codigo_factura,))
            row = cursor.fetchone()
            if row:
                columns = [col[0] for col in cursor.description]
                return dict(zip(columns, row))
            return None
        except Exception as e:
            logger.error(f"Error buscando orden: {e}")
            return None
    
    def listar_por_estatus(self, estatus):
        """Lista √≥rdenes por estatus"""
        try:
            cursor = self.conn.cursor()
            query = """
            SELECT o.*, p.razon_social as proveedor
            FROM orden_compra o
            JOIN proveedor p ON o.idproveedor = p.idproveedor
            WHERE o.estatus = ?
            ORDER BY o.fecha_orden DESC
            """
            cursor.execute(query, (estatus,))
            columns = [col[0] for col in cursor.description]
            return [dict(zip(columns, row)) for row in cursor.fetchall()]
        except Exception as e:
            logger.error(f"Error listando √≥rdenes: {e}")
            return []
    
    def actualizar_estatus(self, idorden, estatus):
        """Actualiza estatus de la orden"""
        try:
            cursor = self.conn.cursor()
            query = "UPDATE orden_compra SET estatus = ? WHERE idorden = ?"
            cursor.execute(query, (estatus, idorden))
            self.conn.commit()
            return True
        except Exception as e:
            logger.error(f"Error actualizando estatus: {e}")
            self.conn.rollback()
            return False
    
    def __del__(self):
        try:
            if hasattr(self, 'db'):
                self.db.cerrar()
        except:
            pass

----- capa_datos/proveedor_archivo_repo.py -----
from typing import List, Dict, Optional
from datetime import datetime
from loguru import logger

class ProveedorArchivoRepositorio:
    """Repositorio para gesti√≥n de archivos de proveedores"""
    
    def __init__(self, conexion):
        self.conexion = conexion
        self.cursor = conexion.cursor()
    
    def listar_por_proveedor(self, idproveedor: int) -> List[Dict]:
        """Lista todos los archivos de un proveedor (sin contenido)"""
        try:
            self.cursor.execute("""
                SELECT idarchivo, nombre_archivo, tipo_archivo, tamano, fecha_subida, descripcion
                FROM proveedor_archivos
                WHERE idproveedor = ?
                ORDER BY fecha_subida DESC
            """, (idproveedor,))
            columnas = [column[0] for column in self.cursor.description]
            resultados = []
            for row in self.cursor.fetchall():
                resultados.append(dict(zip(columnas, row)))
            return resultados
        except Exception as e:
            logger.error(f"‚ùå Error al listar archivos del proveedor {idproveedor}: {e}")
            return []
    
    def obtener_archivo(self, idarchivo: int) -> Optional[Dict]:
        """Obtiene un archivo por su ID (incluyendo el contenido)"""
        try:
            self.cursor.execute("""
                SELECT pv.*, p.razon_social as proveedor
                FROM proveedor_archivos pv
                INNER JOIN proveedor p ON pv.idproveedor = p.idproveedor
                WHERE pv.idarchivo = ?
            """, (idarchivo,))
            row = self.cursor.fetchone()
            if row:
                columnas = [column[0] for column in self.cursor.description]
                return dict(zip(columnas, row))
            return None
        except Exception as e:
            logger.error(f"‚ùå Error al obtener archivo {idarchivo}: {e}")
            return None
    
    def insertar(self, idproveedor: int, nombre_archivo: str, 
                 tipo_archivo: str, contenido: bytes, 
                 descripcion: str = None) -> Optional[int]:
        """Inserta un nuevo archivo"""
        try:
            tamano = len(contenido)
            self.cursor.execute("""
                INSERT INTO proveedor_archivos 
                (idproveedor, nombre_archivo, tipo_archivo, tamano, contenido, descripcion)
                OUTPUT INSERTED.idarchivo
                VALUES (?, ?, ?, ?, ?, ?)
            """, (idproveedor, nombre_archivo, tipo_archivo, tamano, contenido, descripcion))
            idarchivo = self.cursor.fetchone()[0]
            self.cursor.commit()
            logger.success(f"‚úÖ Archivo '{nombre_archivo}' subido para proveedor {idproveedor}")
            return idarchivo
        except Exception as e:
            logger.error(f"‚ùå Error al insertar archivo: {e}")
            return None
    
    def eliminar(self, idarchivo: int) -> bool:
        """Elimina un archivo"""
        try:
            self.cursor.execute("DELETE FROM proveedor_archivos WHERE idarchivo = ?", (idarchivo,))
            self.cursor.commit()
            logger.success(f"‚úÖ Archivo ID {idarchivo} eliminado")
            return True
        except Exception as e:
            logger.error(f"‚ùå Error al eliminar archivo: {e}")
            return False

----- capa_datos/proveedor_repo.py -----
from typing import List, Dict, Optional
from loguru import logger

class ProveedorRepositorio:
    """Repositorio para operaciones CRUD de proveedores"""
    
    def __init__(self, conexion):
        self.conexion = conexion
        self.cursor = conexion.cursor()
    
    def listar(self) -> List[Dict]:
        """Lista todos los proveedores"""
        try:
            self.cursor.execute("""
                SELECT idproveedor, razon_social, sector_comercial,
                       tipo_documento, num_documento, direccion,
                       telefono, email, url
                FROM proveedor ORDER BY razon_social
            """)
            columnas = [column[0] for column in self.cursor.description]
            resultados = []
            for row in self.cursor.fetchall():
                resultados.append(dict(zip(columnas, row)))
            logger.info(f"‚úÖ {len(resultados)} proveedores listados")
            return resultados
        except Exception as e:
            logger.error(f"‚ùå Error al listar proveedores: {e}")
            return []
    
    def obtener_por_id(self, idproveedor: int) -> Optional[Dict]:
        """Obtiene un proveedor por su ID"""
        try:
            self.cursor.execute(
                "SELECT * FROM proveedor WHERE idproveedor = ?",
                (idproveedor,)
            )
            row = self.cursor.fetchone()
            if row:
                columnas = [column[0] for column in self.cursor.description]
                return dict(zip(columnas, row))
            return None
        except Exception as e:
            logger.error(f"‚ùå Error al obtener proveedor {idproveedor}: {e}")
            return None
    
    def insertar(self, razon_social: str, sector_comercial: str,
                 tipo_documento: str, num_documento: str,
                 direccion: str = None, telefono: str = None,
                 email: str = None, url: str = None) -> bool:
        """Inserta un nuevo proveedor"""
        try:
            self.cursor.execute(
                """INSERT INTO proveedor 
                   (razon_social, sector_comercial, tipo_documento, num_documento,
                    direccion, telefono, email, url) 
                   VALUES (?, ?, ?, ?, ?, ?, ?, ?)""",
                (razon_social, sector_comercial, tipo_documento, num_documento,
                 direccion, telefono, email, url)
            )
            self.cursor.commit()
            logger.success(f"‚úÖ Proveedor '{razon_social}' insertado")
            return True
        except Exception as e:
            logger.error(f"‚ùå Error al insertar proveedor: {e}")
            return False
    
    def actualizar(self, idproveedor: int, razon_social: str, sector_comercial: str,
                   tipo_documento: str, num_documento: str,
                   direccion: str = None, telefono: str = None,
                   email: str = None, url: str = None) -> bool:
        """Actualiza un proveedor existente"""
        try:
            self.cursor.execute(
                """UPDATE proveedor 
                   SET razon_social = ?, sector_comercial = ?,
                       tipo_documento = ?, num_documento = ?,
                       direccion = ?, telefono = ?, email = ?, url = ?
                   WHERE idproveedor = ?""",
                (razon_social, sector_comercial, tipo_documento, num_documento,
                 direccion, telefono, email, url, idproveedor)
            )
            self.cursor.commit()
            logger.success(f"‚úÖ Proveedor ID {idproveedor} actualizado")
            return True
        except Exception as e:
            logger.error(f"‚ùå Error al actualizar proveedor: {e}")
            return False
    
    def eliminar(self, idproveedor: int) -> bool:
        """Elimina un proveedor"""
        try:
            self.cursor.execute("DELETE FROM proveedor WHERE idproveedor = ?", (idproveedor,))
            self.cursor.commit()
            logger.success(f"‚úÖ Proveedor ID {idproveedor} eliminado")
            return True
        except Exception as e:
            logger.error(f"‚ùå Error al eliminar proveedor: {e}")
            return False

----- capa_datos/recepcion_repo.py -----
"""
Repositorio para gesti√≥n de recepciones de mercanc√≠a
"""
from loguru import logger
from capa_datos.conexion import obtener_conexion

class RecepcionRepositorio:
    def __init__(self):
        self.conn = obtener_conexion()
    
    def crear_recepcion(self, idproveedor, idtrabajador, idcompra_original=None, observaciones=None):
        """Crea una nueva recepci√≥n"""
        try:
            cursor = self.conn.cursor()
            query = """
            INSERT INTO recepcion (idcompra_original, idproveedor, idtrabajador, 
                                   fecha_recepcion, observaciones, estatus)
            OUTPUT INSERTED.idrecepcion
            VALUES (?, ?, ?, GETDATE(), ?, 'RECIBIDA')
            """
            cursor.execute(query, (idcompra_original, idproveedor, idtrabajador, observaciones))
            idrecepcion = cursor.fetchone()[0]
            self.conn.commit()
            logger.info(f"‚úÖ Recepci√≥n #{idrecepcion} creada")
            return idrecepcion
        except Exception as e:
            logger.error(f"‚ùå Error creando recepci√≥n: {e}")
            self.conn.rollback()
            return None
    
    def agregar_detalle(self, idrecepcion, idarticulo, cantidad_recibida, costo_unitario_usd, 
                        tasa_bcv, iddetalle_compra_original=None, cantidad_pedida=None, 
                        lote=None, fecha_vencimiento=None):
        """Agrega un detalle a la recepci√≥n"""
        try:
            subtotal_usd = cantidad_recibida * costo_unitario_usd
            subtotal_bs = subtotal_usd * tasa_bcv
            
            cursor = self.conn.cursor()
            query = """
            INSERT INTO detalle_recepcion 
            (idrecepcion, idarticulo, iddetalle_compra_original, cantidad_pedida, 
             cantidad_recibida, costo_unitario_usd, tasa_bcv, subtotal_usd, subtotal_bs,
             lote, fecha_vencimiento)
            OUTPUT INSERTED.iddetalle
            VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
            """
            cursor.execute(query, (idrecepcion, idarticulo, iddetalle_compra_original, 
                                  cantidad_pedida, cantidad_recibida, costo_unitario_usd, 
                                  tasa_bcv, subtotal_usd, subtotal_bs, lote, fecha_vencimiento))
            iddetalle = cursor.fetchone()[0]
            self.conn.commit()
            return iddetalle
        except Exception as e:
            logger.error(f"‚ùå Error agregando detalle a recepci√≥n: {e}")
            self.conn.rollback()
            return None
    
    def buscar_recepciones_pendientes(self, idcompra=None):
        """Busca recepciones pendientes (para completar √≥rdenes)"""
        try:
            cursor = self.conn.cursor()
            if idcompra:
                query = """
                SELECT r.*, p.razon_social as proveedor
                FROM recepcion r
                JOIN proveedor p ON r.idproveedor = p.idproveedor
                WHERE r.idcompra_original = ? AND r.estatus = 'RECIBIDA'
                ORDER BY r.fecha_recepcion DESC
                """
                cursor.execute(query, (idcompra,))
            else:
                query = """
                SELECT r.*, p.razon_social as proveedor
                FROM recepcion r
                JOIN proveedor p ON r.idproveedor = p.idproveedor
                WHERE r.estatus = 'RECIBIDA'
                ORDER BY r.fecha_recepcion DESC
                """
                cursor.execute(query)
            
            columns = [col[0] for col in cursor.description]
            return [dict(zip(columns, row)) for row in cursor.fetchall()]
        except Exception as e:
            logger.error(f"‚ùå Error buscando recepciones: {e}")
            return []
    
    def obtener_detalles_recepcion(self, idrecepcion):
        """Obtiene los detalles de una recepci√≥n"""
        try:
            cursor = self.conn.cursor()
            query = """
            SELECT d.*, a.nombre as articulo, a.codigo_barras
            FROM detalle_recepcion d
            JOIN articulo a ON d.idarticulo = a.idarticulo
            WHERE d.idrecepcion = ?
            """
            cursor.execute(query, (idrecepcion,))
            columns = [col[0] for col in cursor.description]
            return [dict(zip(columns, row)) for row in cursor.fetchall()]
        except Exception as e:
            logger.error(f"‚ùå Error obteniendo detalles: {e}")
            return []

----- capa_datos/rol_repo.py -----
from typing import List, Dict, Optional
from loguru import logger

class RolRepositorio:
    """Repositorio para gesti√≥n de roles y permisos"""
    
    def __init__(self, conexion):
        self.conexion = conexion
        self.cursor = conexion.cursor()
    
    def listar_roles(self) -> List[Dict]:
        """Lista todos los roles"""
        try:
            self.cursor.execute("""
                SELECT idrol, nombre, descripcion, nivel, activo
                FROM rol
                ORDER BY nivel DESC
            """)
            columnas = [column[0] for column in self.cursor.description]
            return [dict(zip(columnas, row)) for row in self.cursor.fetchall()]
        except Exception as e:
            logger.error(f"‚ùå Error al listar roles: {e}")
            return []
    
    def obtener_rol(self, idrol: int) -> Optional[Dict]:
        """Obtiene un rol por su ID"""
        try:
            self.cursor.execute("""
                SELECT idrol, nombre, descripcion, nivel, activo
                FROM rol WHERE idrol = ?
            """, (idrol,))
            row = self.cursor.fetchone()
            if row:
                columnas = [column[0] for column in self.cursor.description]
                return dict(zip(columnas, row))
            return None
        except Exception as e:
            logger.error(f"‚ùå Error al obtener rol {idrol}: {e}")
            return None
    
    def listar_permisos(self, modulo: str = None) -> List[Dict]:
        """Lista todos los permisos, opcionalmente filtrados por m√≥dulo"""
        try:
            query = "SELECT idpermiso, nombre, descripcion, modulo FROM permiso"
            params = []
            if modulo:
                query += " WHERE modulo = ?"
                params.append(modulo)
            query += " ORDER BY modulo, nombre"
            
            self.cursor.execute(query, params)
            columnas = [column[0] for column in self.cursor.description]
            return [dict(zip(columnas, row)) for row in self.cursor.fetchall()]
        except Exception as e:
            logger.error(f"‚ùå Error al listar permisos: {e}")
            return []
    
    def obtener_permisos_rol(self, idrol: int) -> List[str]:
        """Obtiene los nombres de permisos de un rol"""
        try:
            self.cursor.execute("""
                SELECT p.nombre
                FROM permiso p
                INNER JOIN rol_permiso rp ON p.idpermiso = rp.idpermiso
                WHERE rp.idrol = ?
            """, (idrol,))
            return [row[0] for row in self.cursor.fetchall()]
        except Exception as e:
            logger.error(f"‚ùå Error al obtener permisos del rol {idrol}: {e}")
            return []
    
    def asignar_permisos_rol(self, idrol: int, permisos: List[int]) -> bool:
        """Asigna permisos a un rol (reemplaza los existentes)"""
        try:
            self.cursor.execute("BEGIN TRANSACTION")
            
            # Eliminar permisos actuales
            self.cursor.execute("DELETE FROM rol_permiso WHERE idrol = ?", (idrol,))
            
            # Insertar nuevos permisos
            for idpermiso in permisos:
                self.cursor.execute("""
                    INSERT INTO rol_permiso (idrol, idpermiso)
                    VALUES (?, ?)
                """, (idrol, idpermiso))
            
            self.cursor.execute("COMMIT TRANSACTION")
            logger.success(f"‚úÖ Permisos asignados al rol {idrol}")
            return True
        except Exception as e:
            self.cursor.execute("ROLLBACK TRANSACTION")
            logger.error(f"‚ùå Error al asignar permisos: {e}")
            return False
    
    def asignar_rol_trabajador(self, idtrabajador: int, idrol: int) -> bool:
        """Asigna un rol a un trabajador"""
        try:
            self.cursor.execute("""
                UPDATE trabajador SET idrol = ? WHERE idtrabajador = ?
            """, (idrol, idtrabajador))
            self.cursor.commit()
            logger.success(f"‚úÖ Rol {idrol} asignado al trabajador {idtrabajador}")
            return True
        except Exception as e:
            logger.error(f"‚ùå Error al asignar rol: {e}")
            return False
    
    def crear_rol(self, nombre: str, descripcion: str = None, nivel: int = 1) -> Optional[int]:
        """Crea un nuevo rol"""
        try:
            self.cursor.execute("""
                INSERT INTO rol (nombre, descripcion, nivel, activo)
                OUTPUT INSERTED.idrol
                VALUES (?, ?, ?, 1)
            """, (nombre, descripcion, nivel))
            idrol = self.cursor.fetchone()[0]
            self.cursor.commit()
            logger.success(f"‚úÖ Rol '{nombre}' creado")
            return idrol
        except Exception as e:
            logger.error(f"‚ùå Error al crear rol: {e}")
            return None

----- capa_datos/tasa_repo.py -----
"""
Repositorio para gesti√≥n de tasas de cambio
"""
from loguru import logger

class TasaRepositorio:
    """Maneja operaciones de BD para tasas de cambio"""
    
    def __init__(self, conn):
        """
        Inicializa el repositorio con una conexi√≥n a la BD
        
        Args:
            conn: Conexi√≥n a la base de datos
        """
        self.conn = conn
        logger.info("‚úÖ TasaRepositorio inicializado")
    
    def obtener_ultima_tasa(self, moneda='USD'):
        """
        Obtiene la √∫ltima tasa registrada para una moneda
        
        Args:
            moneda (str): USD, EUR
            
        Returns:
            float: Tasa o None si no existe
        """
        try:
            cursor = self.conn.cursor()
            query = """
            SELECT TOP 1 tasa 
            FROM tasa_cambio 
            WHERE moneda_origen = ? 
            ORDER BY fecha_hora_registro DESC
            """
            cursor.execute(query, (moneda,))
            row = cursor.fetchone()
            
            if row and row[0] is not None:
                tasa = float(row[0])
                logger.info(f"‚úÖ √öltima tasa {moneda}: {tasa:.2f}")
                return tasa
            else:
                logger.warning(f"‚ö†Ô∏è No hay tasa registrada para {moneda}")
                return None
            
        except Exception as e:
            logger.error(f"Error obteniendo √∫ltima tasa: {e}")
            return None
    
    def insertar_tasa(self, idfuente, moneda_origen, tasa, 
                      usuario=None, observaciones=None):
        """
        Inserta una nueva tasa en el hist√≥rico
        
        Args:
            idfuente (int): ID de la fuente (1 = MANUAL)
            moneda_origen (str): USD, EUR
            tasa (float): Valor de la tasa
            usuario (str): Nombre del usuario que registra
            observaciones (str): Observaciones adicionales
            
        Returns:
            bool: True si se insert√≥ correctamente
        """
        try:
            cursor = self.conn.cursor()
            query = """
            INSERT INTO tasa_cambio 
            (idfuente, moneda_origen, moneda_destino, tasa, 
             fecha, fecha_hora_registro, usuario_registro, observaciones)
            VALUES (?, ?, 'VES', ?, CAST(GETDATE() AS DATE), GETDATE(), ?, ?)
            """
            cursor.execute(query, (idfuente, moneda_origen, tasa, usuario, observaciones))
            self.conn.commit()
            logger.info(f"‚úÖ Tasa {moneda_origen} registrada: {tasa:.2f}")
            return True
            
        except Exception as e:
            logger.error(f"Error insertando tasa: {e}")
            self.conn.rollback()
            return False
    
    def obtener_historial(self, moneda='USD', dias=30):
        """
        Obtiene historial de tasas para una moneda
        
        Args:
            moneda (str): USD, EUR
            dias (int): N√∫mero de d√≠as hacia atr√°s
            
        Returns:
            list: Lista de tasas hist√≥ricas
        """
        try:
            cursor = self.conn.cursor()
            query = """
            SELECT 
                t.idtasa,
                t.fecha,
                t.tasa,
                f.nombre as fuente,
                t.usuario_registro,
                t.fecha_hora_registro
            FROM tasa_cambio t
            INNER JOIN fuente_tasa f ON t.idfuente = f.idfuente
            WHERE t.moneda_origen = ? 
              AND t.fecha >= DATEADD(day, -?, GETDATE())
            ORDER BY t.fecha DESC, t.fecha_hora_registro DESC
            """
            cursor.execute(query, (moneda, dias))
            
            # Convertir a diccionarios
            columns = [column[0] for column in cursor.description]
            rows = cursor.fetchall()
            result = []
            for row in rows:
                row_dict = {}
                for i, col in enumerate(columns):
                    row_dict[col] = row[i]
                result.append(row_dict)
            
            return result
            
        except Exception as e:
            logger.error(f"Error obteniendo historial: {e}")
            return []
    
    def obtener_tasas_del_dia(self):
        """
        Obtiene todas las tasas registradas hoy
        
        Returns:
            list: Lista de tasas del d√≠a
        """
        try:
            cursor = self.conn.cursor()
            query = """
            SELECT 
                moneda_origen,
                tasa,
                usuario_registro,
                fecha_hora_registro
            FROM tasa_cambio 
            WHERE CAST(fecha_hora_registro AS DATE) = CAST(GETDATE() AS DATE)
            ORDER BY moneda_origen, fecha_hora_registro DESC
            """
            cursor.execute(query)
            
            columns = [column[0] for column in cursor.description]
            rows = cursor.fetchall()
            result = []
            for row in rows:
                row_dict = {}
                for i, col in enumerate(columns):
                    row_dict[col] = row[i]
                result.append(row_dict)
            
            return result
            
        except Exception as e:
            logger.error(f"Error obteniendo tasas del d√≠a: {e}")
            return []

----- capa_datos/trabajador_repo.py -----
from typing import List, Dict, Optional
from loguru import logger
import hashlib

class TrabajadorRepositorio:
    """Repositorio para operaciones CRUD de trabajadores"""
    
    def __init__(self, conexion):
        self.conexion = conexion
        self.cursor = conexion.cursor()
    
    def _hash_password(self, password: str) -> str:
        """Genera hash de contrase√±a"""
        return hashlib.sha256(password.encode()).hexdigest()
    
    def listar(self) -> List[Dict]:
        """Lista todos los trabajadores"""
        try:
            self.cursor.execute("""
                SELECT idtrabajador, nombre, apellidos, sexo,
                       fecha_nacimiento, num_documento, direccion,
                       telefono, email, usuario, idrol
                FROM trabajador ORDER BY apellidos, nombre
            """)
            columnas = [column[0] for column in self.cursor.description]
            resultados = []
            for row in self.cursor.fetchall():
                resultados.append(dict(zip(columnas, row)))
            logger.info(f"‚úÖ {len(resultados)} trabajadores listados")
            return resultados
        except Exception as e:
            logger.error(f"‚ùå Error al listar trabajadores: {e}")
            return []
    
    def obtener_por_id(self, idtrabajador: int) -> Optional[Dict]:
        """Obtiene un trabajador por su ID"""
        try:
            self.cursor.execute(
                "SELECT * FROM trabajador WHERE idtrabajador = ?",
                (idtrabajador,)
            )
            row = self.cursor.fetchone()
            if row:
                columnas = [column[0] for column in self.cursor.description]
                return dict(zip(columnas, row))
            return None
        except Exception as e:
            logger.error(f"‚ùå Error al obtener trabajador {idtrabajador}: {e}")
            return None
    
    def autenticar(self, usuario: str, password: str) -> Optional[Dict]:
        """Autentica un trabajador por usuario y contrase√±a"""
        try:
            password_hash = self._hash_password(password)
            self.cursor.execute("""
                SELECT idtrabajador, nombre, apellidos, usuario, email, idrol
                FROM trabajador 
                WHERE usuario = ? AND password_hash = ?
            """, (usuario, password_hash))
            row = self.cursor.fetchone()
            if row:
                return {
                    'idtrabajador': row[0],
                    'nombre': row[1],
                    'apellidos': row[2],
                    'usuario': row[3],
                    'email': row[4],
                    'idrol': row[5]
                }
            return None
        except Exception as e:
            logger.error(f"‚ùå Error en autenticaci√≥n: {e}")
            return None
    
    def buscar_por_email(self, email: str) -> Optional[Dict]:
        """Busca un trabajador por su email"""
        try:
            self.cursor.execute("""
                SELECT idtrabajador, nombre, apellidos, usuario, email, idrol
                FROM trabajador 
                WHERE email = ?
            """, (email,))
            row = self.cursor.fetchone()
            if row:
                return {
                    'idtrabajador': row[0],
                    'nombre': row[1],
                    'apellidos': row[2],
                    'usuario': row[3],
                    'email': row[4],
                    'idrol': row[5]
                }
            return None
        except Exception as e:
            logger.error(f"‚ùå Error al buscar por email: {e}")
            return None
    
    def autenticar_por_email(self, email: str, password: str) -> Optional[Dict]:
        """Autentica un trabajador por email y contrase√±a"""
        try:
            password_hash = self._hash_password(password)
            self.cursor.execute("""
                SELECT idtrabajador, nombre, apellidos, usuario, email, idrol
                FROM trabajador 
                WHERE email = ? AND password_hash = ?
            """, (email, password_hash))
            row = self.cursor.fetchone()
            if row:
                return {
                    'idtrabajador': row[0],
                    'nombre': row[1],
                    'apellidos': row[2],
                    'usuario': row[3],
                    'email': row[4],
                    'idrol': row[5]
                }
            return None
        except Exception as e:
            logger.error(f"‚ùå Error en autenticaci√≥n por email: {e}")
            return None
    
    def insertar(self, nombre: str, apellidos: str, sexo: str,
                 fecha_nacimiento, num_documento: str,
                 usuario: str, password: str,
                 direccion: str = None, telefono: str = None,
                 email: str = None) -> bool:
        """Inserta un nuevo trabajador"""
        try:
            password_hash = self._hash_password(password)
            self.cursor.execute("""
                INSERT INTO trabajador 
                (nombre, apellidos, sexo, fecha_nacimiento, num_documento,
                 direccion, telefono, email, usuario, password_hash) 
                VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
            """, (nombre, apellidos, sexo, fecha_nacimiento, num_documento,
                 direccion, telefono, email, usuario, password_hash))
            self.cursor.commit()
            logger.success(f"‚úÖ Trabajador '{nombre} {apellidos}' insertado")
            return True
        except Exception as e:
            logger.error(f"‚ùå Error al insertar trabajador: {e}")
            return False
    
    def actualizar(self, idtrabajador: int, nombre: str, apellidos: str, sexo: str,
                   fecha_nacimiento, num_documento: str, usuario: str,
                   password: str = None, direccion: str = None,
                   telefono: str = None, email: str = None) -> bool:
        """Actualiza un trabajador existente"""
        try:
            if password:
                password_hash = self._hash_password(password)
                self.cursor.execute("""
                    UPDATE trabajador 
                    SET nombre = ?, apellidos = ?, sexo = ?, fecha_nacimiento = ?,
                        num_documento = ?, direccion = ?, telefono = ?,
                        email = ?, usuario = ?, password_hash = ?
                    WHERE idtrabajador = ?
                """, (nombre, apellidos, sexo, fecha_nacimiento, num_documento,
                     direccion, telefono, email, usuario, password_hash, idtrabajador))
            else:
                self.cursor.execute("""
                    UPDATE trabajador 
                    SET nombre = ?, apellidos = ?, sexo = ?, fecha_nacimiento = ?,
                        num_documento = ?, direccion = ?, telefono = ?,
                        email = ?, usuario = ?
                    WHERE idtrabajador = ?
                """, (nombre, apellidos, sexo, fecha_nacimiento, num_documento,
                     direccion, telefono, email, usuario, idtrabajador))
            self.cursor.commit()
            logger.success(f"‚úÖ Trabajador ID {idtrabajador} actualizado")
            return True
        except Exception as e:
            logger.error(f"‚ùå Error al actualizar trabajador: {e}")
            return False
    
    def eliminar(self, idtrabajador: int) -> bool:
        """Elimina un trabajador"""
        try:
            self.cursor.execute("DELETE FROM trabajador WHERE idtrabajador = ?", (idtrabajador,))
            self.cursor.commit()
            logger.success(f"‚úÖ Trabajador ID {idtrabajador} eliminado")
            return True
        except Exception as e:
            logger.error(f"‚ùå Error al eliminar trabajador: {e}")
            return False

----- capa_datos/usuario_admin_repo.py -----
from typing import List, Dict, Optional
from loguru import logger
import hashlib

class UsuarioAdminRepositorio:
    """Repositorio para administraci√≥n de usuarios (solo para admin)"""
    
    def __init__(self, conexion):
        self.conexion = conexion
        self.cursor = conexion.cursor()
    
    def listar_usuarios(self) -> List[Dict]:
        """Lista todos los usuarios con su informaci√≥n de rol"""
        try:
            self.cursor.execute("""
                SELECT t.idtrabajador, t.nombre, t.apellidos, t.usuario, 
                       t.email, t.telefono, t.idrol, r.nombre as rol_nombre
                FROM trabajador t
                LEFT JOIN rol r ON t.idrol = r.idrol
                ORDER BY t.idtrabajador
            """)
            columnas = [column[0] for column in self.cursor.description]
            return [dict(zip(columnas, row)) for row in self.cursor.fetchall()]
        except Exception as e:
            logger.error(f"‚ùå Error al listar usuarios: {e}")
            return []
    
    def obtener_usuario(self, idtrabajador: int) -> Optional[Dict]:
        """Obtiene un usuario por su ID"""
        try:
            self.cursor.execute("""
                SELECT t.*, r.nombre as rol_nombre
                FROM trabajador t
                LEFT JOIN rol r ON t.idrol = r.idrol
                WHERE t.idtrabajador = ?
            """, (idtrabajador,))
            row = self.cursor.fetchone()
            if row:
                columnas = [column[0] for column in self.cursor.description]
                return dict(zip(columnas, row))
            return None
        except Exception as e:
            logger.error(f"‚ùå Error al obtener usuario: {e}")
            return None
    
    def _hash_password(self, password: str) -> str:
        """Genera hash SHA256 de la contrase√±a"""
        return hashlib.sha256(password.encode()).hexdigest()
    
    def crear_usuario(self, nombre: str, apellidos: str, sexo: str,
                      fecha_nacimiento, num_documento: str,
                      usuario: str, password: str,
                      email: str, idrol: int,
                      direccion: str = None, telefono: str = None) -> bool:
        """Crea un nuevo usuario"""
        try:
            password_hash = self._hash_password(password)
            self.cursor.execute("""
                INSERT INTO trabajador 
                (nombre, apellidos, sexo, fecha_nacimiento, num_documento,
                 usuario, password_hash, email, idrol, direccion, telefono)
                VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
            """, (nombre, apellidos, sexo, fecha_nacimiento, num_documento,
                  usuario, password_hash, email, idrol, direccion, telefono))
            self.cursor.commit()
            logger.success(f"‚úÖ Usuario '{usuario}' creado")
            return True
        except Exception as e:
            logger.error(f"‚ùå Error al crear usuario: {e}")
            return False
    
    def actualizar_usuario(self, idtrabajador: int, nombre: str, apellidos: str,
                           sexo: str, fecha_nacimiento, num_documento: str,
                           usuario: str, email: str, idrol: int,
                           direccion: str = None, telefono: str = None,
                           nueva_password: str = None) -> bool:
        """Actualiza un usuario existente"""
        try:
            if nueva_password:
                password_hash = self._hash_password(nueva_password)
                self.cursor.execute("""
                    UPDATE trabajador 
                    SET nombre = ?, apellidos = ?, sexo = ?, fecha_nacimiento = ?,
                        num_documento = ?, usuario = ?, email = ?, idrol = ?,
                        direccion = ?, telefono = ?, password_hash = ?
                    WHERE idtrabajador = ?
                """, (nombre, apellidos, sexo, fecha_nacimiento, num_documento,
                      usuario, email, idrol, direccion, telefono, 
                      password_hash, idtrabajador))
            else:
                self.cursor.execute("""
                    UPDATE trabajador 
                    SET nombre = ?, apellidos = ?, sexo = ?, fecha_nacimiento = ?,
                        num_documento = ?, usuario = ?, email = ?, idrol = ?,
                        direccion = ?, telefono = ?
                    WHERE idtrabajador = ?
                """, (nombre, apellidos, sexo, fecha_nacimiento, num_documento,
                      usuario, email, idrol, direccion, telefono, idtrabajador))
            self.cursor.commit()
            logger.success(f"‚úÖ Usuario ID {idtrabajador} actualizado")
            return True
        except Exception as e:
            logger.error(f"‚ùå Error al actualizar usuario: {e}")
            return False
    
    def eliminar_usuario(self, idtrabajador: int) -> bool:
        """Elimina un usuario"""
        try:
            self.cursor.execute("DELETE FROM trabajador WHERE idtrabajador = ?", (idtrabajador,))
            self.cursor.commit()
            logger.success(f"‚úÖ Usuario ID {idtrabajador} eliminado")
            return True
        except Exception as e:
            logger.error(f"‚ùå Error al eliminar usuario: {e}")
            return False
    
    def verificar_usuario_existe(self, usuario: str, email: str) -> bool:
        """Verifica si ya existe un usuario con ese nombre o email"""
        try:
            self.cursor.execute("""
                SELECT COUNT(*) FROM trabajador 
                WHERE usuario = ? OR email = ?
            """, (usuario, email))
            count = self.cursor.fetchone()[0]
            return count > 0
        except Exception as e:
            logger.error(f"‚ùå Error al verificar usuario: {e}")
            return True  # Por seguridad, asumir que existe si hay error

----- capa_datos/venta_repo.py -----
"""
Repositorio para la gesti√≥n de ventas en la base de datos
"""
from loguru import logger

class VentaRepositorio:
    """Clase que maneja las operaciones de base de datos para ventas"""
    
    def __init__(self, conn):
        """
        Inicializa el repositorio con una conexi√≥n a la base de datos
        
        Args:
            conn: Conexi√≥n a la base de datos
        """
        self.conn = conn
    
    def listar(self):
        """
        Lista todas las ventas con todos los campos incluyendo multimoneda
        """
        try:
            cursor = self.conn.cursor()
            query = """
            SELECT 
                v.idventa, 
                CONVERT(varchar, v.fecha_hora, 103) + ' ' + CONVERT(varchar, v.fecha_hora, 108) as fecha,
                v.fecha_hora,
                v.tipo_comprobante, 
                v.serie, 
                v.numero_comprobante, 
                v.igv, 
                v.estado,
                v.moneda,
                v.tasa_cambio,
                v.monto_bs,
                v.monto_divisa,
                ISNULL(c.nombre + ' ' + c.apellidos, 'CONSUMIDOR FINAL') as cliente,
                t.nombre + ' ' + t.apellidos as trabajador
            FROM venta v
            LEFT JOIN cliente c ON v.idcliente = c.idcliente
            LEFT JOIN trabajador t ON v.idtrabajador = t.idtrabajador
            ORDER BY v.fecha_hora DESC
            """
            cursor.execute(query)
            
            columns = [column[0] for column in cursor.description]
            rows = cursor.fetchall()
            result = []
            for row in rows:
                row_dict = {}
                for i, col in enumerate(columns):
                    row_dict[col] = row[i]
                result.append(row_dict)
            
            logger.info(f"‚úÖ {len(result)} ventas listadas")
            return result
            
        except Exception as e:
            logger.error(f"Error al listar ventas: {e}")
            return []
    
    def obtener_por_id(self, idventa):
        """
        Obtiene una venta por su ID
        
        Args:
            idventa (int): ID de la venta
            
        Returns:
            dict: Datos de la venta o None si no existe
        """
        try:
            cursor = self.conn.cursor()
            query = """
            SELECT v.idventa, 
                   CONVERT(varchar, v.fecha_hora, 103) + ' ' + CONVERT(varchar, v.fecha_hora, 108) as fecha,
                   v.fecha_hora,
                   v.tipo_comprobante, 
                   v.serie, v.numero_comprobante, v.igv, v.estado,
                   v.moneda,
                   v.tasa_cambio,
                   v.monto_bs,
                   v.monto_divisa,
                   c.nombre + ' ' + c.apellidos as cliente,
                   c.idcliente,
                   t.nombre + ' ' + t.apellidos as trabajador,
                   t.idtrabajador
            FROM venta v
            LEFT JOIN cliente c ON v.idcliente = c.idcliente
            LEFT JOIN trabajador t ON v.idtrabajador = t.idtrabajador
            WHERE v.idventa = ?
            """
            cursor.execute(query, (idventa,))
            
            columns = [column[0] for column in cursor.description]
            row = cursor.fetchone()
            
            if row:
                row_dict = {}
                for i, col in enumerate(columns):
                    row_dict[col] = row[i]
                return row_dict
            return None
            
        except Exception as e:
            logger.error(f"Error al obtener venta {idventa}: {e}")
            return None
    
    def crear(self, idtrabajador, idcliente, tipo_comprobante, 
              serie, numero_comprobante, igv, estado='REGISTRADO',
              moneda='VES', tasa_cambio=1.0, monto_bs=None, monto_divisa=None):
        """
        Inserta una nueva venta con soporte multimoneda
        """
        try:
            cursor = self.conn.cursor()
            
            query = """
            INSERT INTO venta 
            (idtrabajador, idcliente, fecha_hora, tipo_comprobante, 
             serie, numero_comprobante, igv, estado,
             moneda, tasa_cambio, monto_bs, monto_divisa)
            OUTPUT INSERTED.idventa
            VALUES (?, ?, GETDATE(), ?, ?, ?, ?, ?, ?, ?, ?, ?)
            """
            
            cursor.execute(query, (
                idtrabajador, 
                idcliente,
                tipo_comprobante,
                serie, 
                numero_comprobante, 
                igv, 
                estado,
                moneda,
                tasa_cambio,
                monto_bs,
                monto_divisa
            ))
            
            row = cursor.fetchone()
            idventa = row[0] if row else None
            self.conn.commit()
            
            logger.info(f"‚úÖ Venta #{idventa} creada - Moneda: {moneda} - Tasa: {tasa_cambio}")
            return idventa
            
        except Exception as e:
            logger.error(f"‚ùå Error al crear venta: {e}")
            self.conn.rollback()
            return None
    
    def agregar_detalle(self, idventa, idarticulo, cantidad, precio_venta):
        """
        Agrega un detalle a una venta
        """
        try:
            cursor = self.conn.cursor()
            
            query = """
            INSERT INTO detalle_venta 
            (idventa, idarticulo, cantidad, precio_venta)
            OUTPUT INSERTED.iddetalle_venta
            VALUES (?, ?, ?, ?)
            """
            
            cursor.execute(query, (idventa, idarticulo, cantidad, precio_venta))
            
            row = cursor.fetchone()
            iddetalle = row[0] if row else None
            self.conn.commit()
            
            logger.info(f"‚úÖ Detalle de venta agregado: {cantidad} x {precio_venta}")
            return iddetalle
            
        except Exception as e:
            logger.error(f"‚ùå Error al agregar detalle: {e}")
            self.conn.rollback()
            return None
    
    def obtener_detalles(self, idventa):
        """
        Obtiene los detalles de una venta
        """
        try:
            cursor = self.conn.cursor()
            query = """
            SELECT dv.iddetalle_venta, dv.cantidad, dv.precio_venta,
                   a.idarticulo, a.nombre as articulo, a.codigo
            FROM detalle_venta dv
            JOIN articulo a ON dv.idarticulo = a.idarticulo
            WHERE dv.idventa = ?
            """
            cursor.execute(query, (idventa,))
            
            columns = [column[0] for column in cursor.description]
            rows = cursor.fetchall()
            result = []
            for row in rows:
                row_dict = {}
                for i, col in enumerate(columns):
                    row_dict[col] = row[i]
                result.append(row_dict)
            
            return result
            
        except Exception as e:
            logger.error(f"Error al obtener detalles de venta {idventa}: {e}")
            return []
    
    def anular(self, idventa):
        """
        Anula una venta (cambia estado a ANULADO)
        """
        try:
            cursor = self.conn.cursor()
            query = "UPDATE venta SET estado = 'ANULADO' WHERE idventa = ?"
            cursor.execute(query, (idventa,))
            self.conn.commit()
            
            if cursor.rowcount > 0:
                logger.info(f"‚úÖ Venta {idventa} anulada")
                return True
            return False
            
        except Exception as e:
            logger.error(f"Error al anular venta {idventa}: {e}")
            self.conn.rollback()
            return False
    
    def ventas_por_cliente(self, idcliente):
        """
        Obtiene todas las ventas de un cliente
        """
        try:
            cursor = self.conn.cursor()
            query = """
            SELECT v.idventa, v.fecha_hora, v.tipo_comprobante, 
                   v.serie, v.numero_comprobante, v.igv, v.estado,
                   v.moneda, v.monto_bs, v.monto_divisa
            FROM venta v
            WHERE v.idcliente = ?
            ORDER BY v.fecha_hora DESC
            """
            cursor.execute(query, (idcliente,))
            
            columns = [column[0] for column in cursor.description]
            rows = cursor.fetchall()
            result = []
            for row in rows:
                row_dict = {}
                for i, col in enumerate(columns):
                    row_dict[col] = row[i]
                result.append(row_dict)
            
            return result
            
        except Exception as e:
            logger.error(f"Error al obtener ventas del cliente {idcliente}: {e}")
            return []
    
    def ventas_por_fecha(self, fecha_inicio, fecha_fin):
        """
        Obtiene ventas en un rango de fechas
        """
        try:
            cursor = self.conn.cursor()
            query = """
            SELECT 
                v.idventa, 
                CONVERT(varchar, v.fecha_hora, 103) + ' ' + CONVERT(varchar, v.fecha_hora, 108) as fecha,
                v.fecha_hora,
                v.tipo_comprobante, 
                v.serie, 
                v.numero_comprobante, 
                v.igv, 
                v.estado,
                v.moneda,
                v.tasa_cambio,
                v.monto_bs,
                v.monto_divisa,
                ISNULL(c.nombre + ' ' + c.apellidos, 'CONSUMIDOR FINAL') as cliente,
                t.nombre + ' ' + t.apellidos as trabajador
            FROM venta v
            LEFT JOIN cliente c ON v.idcliente = c.idcliente
            LEFT JOIN trabajador t ON v.idtrabajador = t.idtrabajador
            WHERE CAST(v.fecha_hora AS DATE) BETWEEN ? AND ?
            ORDER BY v.fecha_hora DESC
            """
            cursor.execute(query, (fecha_inicio, fecha_fin))
            
            columns = [column[0] for column in cursor.description]
            rows = cursor.fetchall()
            result = []
            for row in rows:
                row_dict = {}
                for i, col in enumerate(columns):
                    row_dict[col] = row[i]
                result.append(row_dict)
            
            return result
            
        except Exception as e:
            logger.error(f"Error al obtener ventas por fecha: {e}")
            return []

=== CAPA DE NEGOCIO (SERVICIOS) ===

----- capa_negocio/articulo_service.py -----
"""
Servicio para gesti√≥n de art√≠culos
"""
from loguru import logger
from typing import List, Dict, Optional
from capa_negocio.base_service import BaseService
from capa_datos.articulo_repo import ArticuloRepositorio
from capa_datos.categoria_repo import CategoriaRepositorio

class ArticuloService(BaseService):
    def __init__(self, repositorio: ArticuloRepositorio, categoria_service=None):
        """
        Inicializa el servicio de art√≠culos
        
        Args:
            repositorio: Repositorio de art√≠culos
            categoria_service: Servicio de categor√≠as (opcional)
        """
        super().__init__()
        self.repositorio = repositorio
        self.categoria_service = categoria_service
        
    def listar_articulos(self) -> List[Dict]:
        """
        Lista todos los art√≠culos
        
        Returns:
            List[Dict]: Lista de art√≠culos
        """
        try:
            articulos = self.repositorio.listar()
            logger.info(f"‚úÖ {len(articulos)} art√≠culos listados")
            return articulos
        except Exception as e:
            logger.error(f"‚ùå Error listando art√≠culos: {e}")
            return []
    
    def buscar_por_id(self, idarticulo: int) -> Optional[Dict]:
        """
        Busca un art√≠culo por su ID
        
        Args:
            idarticulo: ID del art√≠culo
            
        Returns:
            Optional[Dict]: Art√≠culo encontrado o None
        """
        try:
            if not self.validar_entero_positivo(idarticulo, "ID del art√≠culo"):
                return None
                
            articulo = self.repositorio.obtener_por_id(idarticulo)
            if articulo:
                logger.info(f"‚úÖ Art√≠culo ID {idarticulo} encontrado: {articulo['nombre']}")
            else:
                logger.warning(f"‚ö†Ô∏è Art√≠culo ID {idarticulo} no encontrado")
            return articulo
        except Exception as e:
            logger.error(f"‚ùå Error buscando art√≠culo {idarticulo}: {e}")
            return None
    
    def buscar_por_codigo(self, codigo: str) -> Optional[Dict]:
        """
        Busca un art√≠culo por su c√≥digo de barras o PLU
        
        Args:
            codigo: C√≥digo de barras o PLU
            
        Returns:
            Optional[Dict]: Art√≠culo encontrado o None
        """
        try:
            if not codigo:
                logger.warning("‚ö†Ô∏è C√≥digo vac√≠o")
                return None
                
            articulo = self.repositorio.buscar_por_codigo(codigo)
            if articulo:
                logger.info(f"‚úÖ Art√≠culo encontrado: {articulo['nombre']} (c√≥digo: {codigo})")
            else:
                logger.debug(f"Art√≠culo con c√≥digo {codigo} no encontrado")
            return articulo
        except Exception as e:
            logger.error(f"‚ùå Error buscando por c√≥digo {codigo}: {e}")
            return None
    
    def buscar_por_nombre(self, nombre):
        """
        Busca art√≠culos por nombre (b√∫squeda parcial)
        
        Args:
            nombre: Nombre o parte del nombre a buscar
            
        Returns:
            list: Lista de art√≠culos que coinciden con el nombre
        """
        try:
            if not nombre:
                logger.warning("‚ö†Ô∏è Nombre de b√∫squeda vac√≠o")
                return []
            
            # Obtener todos los art√≠culos
            articulos = self.listar_articulos()
            resultados = []
            
            # Filtrar por nombre (b√∫squeda case-insensitive)
            nombre_busqueda = nombre.lower()
            for a in articulos:
                if nombre_busqueda in a.get('nombre', '').lower():
                    resultados.append(a)
            
            logger.info(f"‚úÖ {len(resultados)} art√≠culos encontrados para '{nombre}'")
            return resultados
            
        except Exception as e:
            logger.error(f"‚ùå Error buscando por nombre '{nombre}': {e}")
            return []

    def crear_articulo(self, codigo_barras_original: str, nombre: str, 
                       idcategoria: int = 2, precio_venta: float = 0,
                       stock_minimo: int = 5, precio_compra: float = 0, 
                       id_impuesto: int = None) -> Optional[int]:
        """
        Crea un nuevo art√≠culo con c√≥digo profesional autom√°tico
        
        Args:
            codigo_barras_original: C√≥digo de barras real del producto
            nombre: Nombre del art√≠culo
            idcategoria: ID de la categor√≠a (por defecto 2 = Alimentos)
            precio_venta: Precio de venta en USD
            stock_minimo: Stock m√≠nimo para alertas
            precio_compra: Precio de compra (opcional)
            id_impuesto: ID del impuesto (opcional, se puede detectar con IA)
            
        Returns:
            Optional[int]: ID del art√≠culo creado o None
        """
        try:
            # Validaciones
            if not codigo_barras_original:
                logger.warning("‚ö†Ô∏è C√≥digo de barras obligatorio")
                return None
                
            if not nombre:
                logger.warning("‚ö†Ô∏è Nombre obligatorio")
                return None
                
            if precio_venta <= 0:
                logger.warning(f"‚ö†Ô∏è Precio de venta inv√°lido: {precio_venta}")
                return None
            
            # GENERAR C√ìDIGO PROFESIONAL AUTOM√ÅTICO
            from capa_negocio.utils import generar_codigo_profesional
            codigo = generar_codigo_profesional()
            
            logger.info(f"üîë C√≥digo profesional generado: {codigo}")
            
            # Verificar que el c√≥digo generado no exista ya
            intentos = 0
            while self.repositorio.buscar_por_codigo(codigo) and intentos < 10:
                codigo = generar_codigo_profesional()
                intentos += 1
            
            if intentos >= 10:
                logger.error("‚ùå No se pudo generar un c√≥digo √∫nico despu√©s de 10 intentos")
                return None
            
            # ===== DETECCI√ìN DE IMPUESTO CON IA =====
            if id_impuesto is None:
                from capa_negocio.ia_productos_service import IAProductosService
                ia_service = IAProductosService()
                sugerencia = ia_service.analizar_producto(nombre)
                
                if sugerencia:
                    id_impuesto = sugerencia['id_impuesto']
                    nombre_impuesto = ia_service.obtener_nombre_impuesto(id_impuesto)
                    letra = ia_service.obtener_letra_fiscal(id_impuesto)
                    
                    print(f"\n{'='*50}")
                    print(f"ü§ñ IA DETECT√ì:")
                    print(f"   Producto: {nombre}")
                    print(f"   Impuesto: {nombre_impuesto} ({letra})")
                    print(f"   Confianza: {sugerencia['confianza']:.0%}")
                    print('='*50)
                    
                    if sugerencia['confianza'] < 0.9:
                        respuesta = input("¬øAceptar? (Enter=S√≠, N=No): ").upper()
                        if respuesta == 'N':
                            id_impuesto = self._preguntar_impuesto_manual()
                else:
                    id_impuesto = self._preguntar_impuesto_manual()
            # ===== FIN DETECCI√ìN =====
            
            # Crear art√≠culo en BD
            idarticulo = self.repositorio.crear(
                codigo=codigo,
                codigo_barras_original=codigo_barras_original,
                nombre=nombre,
                idcategoria=idcategoria,
                idpresentacion=1,
                precio_venta=precio_venta,
                precio_referencia=precio_venta,
                stock_minimo=stock_minimo,
                id_impuesto=id_impuesto
            )
            
            if idarticulo:
                logger.info(f"‚úÖ Art√≠culo creado: {nombre} (ID: {idarticulo}, C√≥digo: {codigo})")
                self.registrar_auditoria(
                    accion='CREAR',
                    tabla='articulo',
                    registro_id=idarticulo,
                    datos_nuevos=f"C√≥digo: {codigo}, C√≥digo barras: {codigo_barras_original}, Nombre: {nombre}, Impuesto: {id_impuesto}"
                )
                
            return idarticulo
            
        except Exception as e:
            logger.error(f"‚ùå Error creando art√≠culo: {e}")
            return None

    def _preguntar_impuesto_manual(self) -> int:
        """Pregunta al usuario qu√© impuesto asignar"""
        print("\nSeleccione impuesto manualmente:")
        print("1. Exento (E) - 0%")
        print("2. General (G) - 16%")
        print("3. Reducida (R) - 8%")
        print("4. Adicional (A) - 31%")
        try:
            opcion = int(input("Opci√≥n: "))
            if 1 <= opcion <= 4:
                return opcion
        except:
            pass
        print("‚ö†Ô∏è Opci√≥n inv√°lida, usando General (2)")
        return 2
    
    def actualizar_articulo(self, idarticulo: int, codigo_barras: str, nombre: str,
                            idcategoria: int, precio_venta: float, stock_minimo: int = 5,
                            precio_compra: float = 0, igtf: bool = False) -> bool:
        """
        Actualiza un art√≠culo existente
        
        Args:
            idarticulo: ID del art√≠culo a actualizar
            codigo_barras: Nuevo c√≥digo de barras
            nombre: Nuevo nombre
            idcategoria: Nueva categor√≠a
            precio_venta: Nuevo precio de venta
            stock_minimo: Nuevo stock m√≠nimo
            precio_compra: Nuevo precio de compra
            igtf: Nuevo estado de IGTF
            
        Returns:
            bool: True si se actualiz√≥ correctamente
        """
        try:
            # Validaciones
            if not self.validar_entero_positivo(idarticulo, "ID del art√≠culo"):
                return False
                
            if not codigo_barras:
                logger.warning("‚ö†Ô∏è C√≥digo de barras obligatorio")
                return False
                
            if not nombre:
                logger.warning("‚ö†Ô∏è Nombre obligatorio")
                return False
                
            if not self.validar_entero_positivo(idcategoria, "ID de categor√≠a"):
                return False
                
            if precio_venta <= 0:
                logger.warning(f"‚ö†Ô∏è Precio de venta inv√°lido: {precio_venta}")
                return False
            
            # Obtener datos anteriores para auditor√≠a
            datos_anteriores = self.repositorio.obtener_por_id(idarticulo)
            
            # Actualizar art√≠culo
            resultado = self.repositorio.actualizar(
                idarticulo=idarticulo,
                codigo_barras_original=codigo_barras,
                nombre=nombre,
                idcategoria=idcategoria,
                precio_venta=precio_venta,
                stock_minimo=stock_minimo,
                precio_compra=precio_compra,
                igtf=igtf
            )
            
            if resultado:
                logger.info(f"‚úÖ Art√≠culo {idarticulo} actualizado")
                
                # Registrar en auditor√≠a
                self.registrar_auditoria(
                    accion='ACTUALIZAR',
                    tabla='articulo',
                    registro_id=idarticulo,
                    datos_anteriores=str(datos_anteriores) if datos_anteriores else None,
                    datos_nuevos=f"C√≥digo: {codigo_barras}, Nombre: {nombre}, Precio: ${precio_venta:.2f}"
                )
                
            return resultado
            
        except Exception as e:
            logger.error(f"‚ùå Error actualizando art√≠culo {idarticulo}: {e}")
            return False
    
    def eliminar_articulo(self, idarticulo: int) -> bool:
        """
        Elimina un art√≠culo (marca como inactivo)
        
        Args:
            idarticulo: ID del art√≠culo a eliminar
            
        Returns:
            bool: True si se elimin√≥ correctamente
        """
        try:
            if not self.validar_entero_positivo(idarticulo, "ID del art√≠culo"):
                return False
            
            # Obtener datos para auditor√≠a
            datos_anteriores = self.repositorio.obtener_por_id(idarticulo)
            
            resultado = self.repositorio.eliminar(idarticulo)
            
            if resultado:
                logger.info(f"‚úÖ Art√≠culo {idarticulo} eliminado")
                
                # Registrar en auditor√≠a
                self.registrar_auditoria(
                    accion='ELIMINAR',
                    tabla='articulo',
                    registro_id=idarticulo,
                    datos_anteriores=str(datos_anteriores) if datos_anteriores else None
                )
                
            return resultado
            
        except Exception as e:
            logger.error(f"‚ùå Error eliminando art√≠culo {idarticulo}: {e}")
            return False
    
    def actualizar_precio(self, idarticulo: int, nuevo_precio: float) -> bool:
        """
        Actualiza el precio de venta de un art√≠culo
        
        Args:
            idarticulo (int): ID del art√≠culo a actualizar
            nuevo_precio (float): Nuevo precio en USD
            
        Returns:
            bool: True si se actualiz√≥ correctamente, False en caso contrario
        """
        try:
            # Validar ID
            if not idarticulo or idarticulo <= 0:
                logger.warning(f"‚ö†Ô∏è ID de art√≠culo inv√°lido: {idarticulo}")
                return False
            
            # Validar precio
            if nuevo_precio <= 0:
                logger.warning(f"‚ö†Ô∏è Precio inv√°lido: {nuevo_precio}")
                return False
            
            # Obtener datos anteriores para auditor√≠a
            datos_anteriores = self.repositorio.obtener_por_id(idarticulo)
            
            # Llamar al repositorio para actualizar
            resultado = self.repositorio.actualizar_precio(idarticulo, nuevo_precio)
            
            if resultado:
                logger.info(f"‚úÖ Precio actualizado para art√≠culo {idarticulo}: ${nuevo_precio:.2f}")
                
                # Registrar en auditor√≠a si existe el m√©todo
                if hasattr(self, 'registrar_auditoria'):
                    self.registrar_auditoria(
                        accion='ACTUALIZAR_PRECIO',
                        tabla='articulo',
                        registro_id=idarticulo,
                        datos_anteriores=f"Precio anterior: ${datos_anteriores.get('precio_venta', 0):.2f}" if datos_anteriores else None,
                        datos_nuevos=f"Precio nuevo: ${nuevo_precio:.2f}"
                    )
                
                return True
            else:
                logger.error(f"‚ùå Error actualizando precio del art√≠culo {idarticulo} en repositorio")
                return False
                
        except Exception as e:
            logger.error(f"‚ùå Error en actualizar_precio: {e}")
            return False
    
    def actualizar_stock_minimo(self, idarticulo, stock_minimo):
        """
        Actualiza el stock m√≠nimo de un art√≠culo
        
        Args:
            idarticulo: ID del art√≠culo
            stock_minimo: Nuevo stock m√≠nimo
            
        Returns:
            bool: True si se actualiz√≥ correctamente
        """
        try:
            if not self.validar_entero_positivo(idarticulo, "ID del art√≠culo"):
                return False
            
            if stock_minimo < 0:
                logger.warning(f"‚ö†Ô∏è Stock m√≠nimo inv√°lido: {stock_minimo}")
                return False
            
            resultado = self.repositorio.actualizar_stock_minimo(idarticulo, stock_minimo)
            
            if resultado:
                logger.info(f"‚úÖ Stock m√≠nimo actualizado para art√≠culo {idarticulo}: {stock_minimo}")
            else:
                logger.error(f"‚ùå Error actualizando stock m√≠nimo en repositorio")
            
            return resultado
            
        except Exception as e:
            logger.error(f"‚ùå Error actualizando stock m√≠nimo: {e}")
            return False

    def actualizar_nombre(self, idarticulo: int, nuevo_nombre: str) -> bool:
        """
        Actualiza el nombre de un art√≠culo
        
        Args:
            idarticulo: ID del art√≠culo
            nuevo_nombre: Nuevo nombre
            
        Returns:
            bool: True si se actualiz√≥ correctamente
        """
        try:
            if not self.validar_entero_positivo(idarticulo, "ID del art√≠culo"):
                return False
            
            if not nuevo_nombre or nuevo_nombre.strip() == "":
                logger.warning(f"‚ö†Ô∏è Nombre inv√°lido: {nuevo_nombre}")
                return False
            
            # Obtener datos anteriores para auditor√≠a
            datos_anteriores = self.repositorio.obtener_por_id(idarticulo)
            
            # Actualizar en repositorio
            resultado = self.repositorio.actualizar_nombre(idarticulo, nuevo_nombre.strip())
            
            if resultado:
                logger.info(f"‚úÖ Nombre actualizado para art√≠culo {idarticulo}: {nuevo_nombre}")
                
                # Registrar en auditor√≠a
                if hasattr(self, 'registrar_auditoria'):
                    self.registrar_auditoria(
                        accion='ACTUALIZAR_NOMBRE',
                        tabla='articulo',
                        registro_id=idarticulo,
                        datos_anteriores=f"Nombre anterior: {datos_anteriores.get('nombre')}" if datos_anteriores else None,
                        datos_nuevos=f"Nombre nuevo: {nuevo_nombre}"
                    )
                
                return True
            else:
                logger.error(f"‚ùå Error actualizando nombre del art√≠culo {idarticulo}")
                return False
                
        except Exception as e:
            logger.error(f"‚ùå Error en actualizar_nombre: {e}")
            return False

    def actualizar_categoria(self, idarticulo: int, nueva_categoria: int) -> bool:
        """
        Actualiza la categor√≠a de un art√≠culo
        
        Args:
            idarticulo: ID del art√≠culo
            nueva_categoria: ID de la nueva categor√≠a
            
        Returns:
            bool: True si se actualiz√≥ correctamente
        """
        try:
            if not self.validar_entero_positivo(idarticulo, "ID del art√≠culo"):
                return False
            
            if not self.validar_entero_positivo(nueva_categoria, "ID de categor√≠a"):
                return False
            
            # Obtener datos anteriores para auditor√≠a
            datos_anteriores = self.repositorio.obtener_por_id(idarticulo)
            
            # Actualizar en repositorio
            resultado = self.repositorio.actualizar_categoria(idarticulo, nueva_categoria)
            
            if resultado:
                logger.info(f"‚úÖ Categor√≠a actualizada para art√≠culo {idarticulo}: {nueva_categoria}")
                
                # Registrar en auditor√≠a
                if hasattr(self, 'registrar_auditoria'):
                    self.registrar_auditoria(
                        accion='ACTUALIZAR_CATEGORIA',
                        tabla='articulo',
                        registro_id=idarticulo,
                        datos_anteriores=f"Categor√≠a anterior: {datos_anteriores.get('idcategoria')}" if datos_anteriores else None,
                        datos_nuevos=f"Categor√≠a nueva: {nueva_categoria}"
                    )
                
                return True
            else:
                logger.error(f"‚ùå Error actualizando categor√≠a del art√≠culo {idarticulo}")
                return False
                
        except Exception as e:
            logger.error(f"‚ùå Error en actualizar_categoria: {e}")
            return False

    def obtener_categorias(self) -> List[Dict]:
        """
        Obtiene la lista de categor√≠as
        
        Returns:
            List[Dict]: Lista de categor√≠as
        """
        try:
            if self.categoria_service:
                return self.categoria_service.listar_categorias()
            else:
                logger.warning("‚ö†Ô∏è Servicio de categor√≠as no disponible")
                return []
        except Exception as e:
            logger.error(f"‚ùå Error obteniendo categor√≠as: {e}")
            return []

    def registrar_auditoria(self, accion, tabla, registro_id, datos_nuevos=None, datos_anteriores=None):
        """
        Registra una acci√≥n en la tabla de auditor√≠a
        
        Args:
            accion: CREAR, ACTUALIZAR, ELIMINAR, etc.
            tabla: Nombre de la tabla afectada
            registro_id: ID del registro afectado
            datos_nuevos: Nuevos valores (opcional)
            datos_anteriores: Valores anteriores (opcional)
        """
        try:
            # Por ahora, solo registramos en el log
            logger.info(f"AUDITOR√çA - {accion} en {tabla} ID {registro_id}")
            if datos_nuevos:
                logger.debug(f"  Nuevos datos: {datos_nuevos}")
            if datos_anteriores:
                logger.debug(f"  Datos anteriores: {datos_anteriores}")
            
            # Aqu√≠ puedes implementar el guardado en BD m√°s adelante
            # from capa_datos.auditoria_repo import AuditoriaRepositorio
            # repo_auditoria = AuditoriaRepositorio()
            # repo_auditoria.registrar(
            #     usuario=obtener_usuario_actual(),
            #     accion=accion,
            #     tabla=tabla,
            #     registro_id=registro_id,
            #     datos_anteriores=datos_anteriores,
            #     datos_nuevos=datos_nuevos
            # )
            
        except Exception as e:
            logger.error(f"Error registrando auditor√≠a: {e}")
            # No interrumpimos el flujo principal por un error de auditor√≠a
    
    def __del__(self):
        """Cierra conexiones al destruir el objeto"""
        try:
            if hasattr(self, 'repositorio') and self.repositorio:
                if hasattr(self.repositorio, 'cerrar_conexion'):
                    self.repositorio.cerrar_conexion()
        except:
            pass

----- capa_negocio/auditoria_service.py -----
"""
Servicio de auditor√≠a para cumplimiento SENIAT
"""
from datetime import datetime
from loguru import logger

class AuditoriaService:
    """Registra todas las acciones del sistema para cumplimiento legal"""
    
    def __init__(self, repositorio):
        """
        Inicializa el servicio de auditor√≠a
        
        Args:
            repositorio: Instancia de AuditoriaRepositorio
        """
        self.repositorio = repositorio
    
    def registrar(self, usuario, accion, tabla, registro_id, datos_anteriores=None, datos_nuevos=None):
        """
        Registra una acci√≥n en el log de auditor√≠a
        
        Args:
            usuario: Nombre del usuario que ejecuta la acci√≥n
            accion: Tipo de acci√≥n (CREAR, MODIFICAR, ELIMINAR, ANULAR, etc)
            tabla: Tabla afectada
            registro_id: ID del registro afectado
            datos_anteriores: Estado anterior (para modificaciones)
            datos_nuevos: Estado nuevo
            
        Returns:
            bool: True si se registr√≥ correctamente
        """
        try:
            # Obtener IP (en un sistema real, obtener de la conexi√≥n)
            ip = '127.0.0.1'
            
            resultado = self.repositorio.insertar(
                usuario=usuario,
                accion=accion,
                tabla=tabla,
                registro_id=registro_id,
                datos_anteriores=str(datos_anteriores) if datos_anteriores else None,
                datos_nuevos=str(datos_nuevos) if datos_nuevos else None,
                ip_address=ip
            )
            
            if resultado:
                logger.info(f"üìù Auditor√≠a: {usuario} - {accion} en {tabla} ID:{registro_id}")
            else:
                logger.error(f"‚ùå Error registrando auditor√≠a: {usuario} - {accion}")
            
            return resultado
            
        except Exception as e:
            logger.error(f"Error en servicio de auditor√≠a: {e}")
            return False
    
    def consultar_por_fecha(self, fecha_inicio, fecha_fin):
        """
        Consulta registros de auditor√≠a por rango de fechas
        
        Args:
            fecha_inicio: Fecha inicial
            fecha_fin: Fecha final
            
        Returns:
            list: Lista de registros
        """
        return self.repositorio.consultar_por_fecha(fecha_inicio, fecha_fin)
    
    def consultar_por_usuario(self, usuario):
        """
        Consulta registros de un usuario espec√≠fico
        
        Args:
            usuario: Nombre del usuario
            
        Returns:
            list: Lista de registros
        """
        return self.repositorio.consultar_por_usuario(usuario)
    
    def consultar_por_tabla(self, tabla, registro_id):
        """
        Consulta historial de cambios en un registro espec√≠fico
        
        Args:
            tabla: Nombre de la tabla
            registro_id: ID del registro
            
        Returns:
            list: Lista de registros
        """
        return self.repositorio.consultar_por_tabla(tabla, registro_id)

----- capa_negocio/base_service.py -----
from typing import Optional, List, Dict, Any
from datetime import datetime
import re
from loguru import logger

class BaseService:
    """Clase base para servicios con validaciones comunes"""
    
    @staticmethod
    def validar_requerido(valor: Any, nombre_campo: str) -> bool:
        """Valida que un campo requerido no est√© vac√≠o"""
        if valor is None or (isinstance(valor, str) and not valor.strip()):
            logger.warning(f"‚ö†Ô∏è El campo {nombre_campo} es requerido")
            return False
        return True
    
    @staticmethod
    def validar_longitud(texto: str, nombre_campo: str, min_len: int = None, max_len: int = None) -> bool:
        """Valida la longitud de un texto"""
        if texto is None:
            return False
        
        if min_len is not None and len(texto) < min_len:
            logger.warning(f"‚ö†Ô∏è El campo {nombre_campo} debe tener al menos {min_len} caracteres")
            return False
        
        if max_len is not None and len(texto) > max_len:
            logger.warning(f"‚ö†Ô∏è El campo {nombre_campo} no debe exceder {max_len} caracteres")
            return False
        
        return True
    
    @staticmethod
    def validar_email(email: str) -> bool:
        """Valida formato de email"""
        if not email:
            return True  # Email puede ser opcional
        
        patron = r'^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$'
        if not re.match(patron, email):
            logger.warning(f"‚ö†Ô∏è El email {email} no tiene formato v√°lido")
            return False
        return True
    
    @staticmethod
    def validar_telefono(telefono: str) -> bool:
        """Valida formato de tel√©fono (solo n√∫meros, longitud entre 7-15)"""
        if not telefono:
            return True  # Tel√©fono puede ser opcional
        
        if not telefono.isdigit():
            logger.warning("‚ö†Ô∏è El tel√©fono debe contener solo n√∫meros")
            return False
        
        if len(telefono) < 7 or len(telefono) > 15:
            logger.warning("‚ö†Ô∏è El tel√©fono debe tener entre 7 y 15 d√≠gitos")
            return False
        
        return True
    
    @staticmethod
    def validar_documento(tipo: str, numero: str) -> bool:
        """Valida documento seg√∫n tipo (DNI, RUC, etc.)"""
        if tipo.upper() == 'DNI':
            if len(numero) != 8 or not numero.isdigit():
                logger.warning("‚ö†Ô∏è DNI debe tener 8 d√≠gitos")
                return False
        elif tipo.upper() == 'RUC':
            if len(numero) != 11 or not numero.isdigit():
                logger.warning("‚ö†Ô∏è RUC debe tener 11 d√≠gitos")
                return False
        elif tipo.upper() == 'PASAPORTE':
            if len(numero) < 6 or len(numero) > 12:
                logger.warning("‚ö†Ô∏è Pasaporte debe tener entre 6 y 12 caracteres")
                return False
        return True
    
    @staticmethod
    def validar_fecha(fecha: datetime, nombre_campo: str, min_fecha: datetime = None, max_fecha: datetime = None) -> bool:
        """Valida que una fecha sea v√°lida y est√© en rango"""
        if not isinstance(fecha, datetime):
            logger.warning(f"‚ö†Ô∏è {nombre_campo} debe ser una fecha v√°lida")
            return False
        
        if min_fecha and fecha < min_fecha:
            logger.warning(f"‚ö†Ô∏è {nombre_campo} no puede ser anterior a {min_fecha.strftime('%d/%m/%Y')}")
            return False
        
        if max_fecha and fecha > max_fecha:
            logger.warning(f"‚ö†Ô∏è {nombre_campo} no puede ser posterior a {max_fecha.strftime('%d/%m/%Y')}")
            return False
        
        return True
    
    @staticmethod
    def validar_entero_positivo(valor: int, nombre_campo: str, permitir_cero: bool = False) -> bool:
        """Valida que un n√∫mero entero sea positivo"""
        if not isinstance(valor, int):
            logger.warning(f"‚ö†Ô∏è {nombre_campo} debe ser un n√∫mero entero")
            return False
        
        if permitir_cero:
            if valor < 0:
                logger.warning(f"‚ö†Ô∏è {nombre_campo} no puede ser negativo")
                return False
        else:
            if valor <= 0:
                logger.warning(f"‚ö†Ô∏è {nombre_campo} debe ser mayor que cero")
                return False
        
        return True
    
    @staticmethod
    def validar_decimal_positivo(valor: float, nombre_campo: str, permitir_cero: bool = False) -> bool:
        """Valida que un n√∫mero decimal sea positivo"""
        if not isinstance(valor, (int, float)):
            logger.warning(f"‚ö†Ô∏è {nombre_campo} debe ser un n√∫mero")
            return False
        
        if permitir_cero:
            if valor < 0:
                logger.warning(f"‚ö†Ô∏è {nombre_campo} no puede ser negativo")
                return False
        else:
            if valor <= 0:
                logger.warning(f"‚ö†Ô∏è {nombre_campo} debe ser mayor que cero")
                return False
        
        return True


----- capa_negocio/categoria_service.py -----

from typing import List, Dict, Optional
from loguru import logger
from capa_negocio.base_service import BaseService

class CategoriaService(BaseService):
    """Servicio de categor√≠as con validaciones y l√≥gica de negocio"""
    
    def __init__(self, repositorio):
        self.repositorio = repositorio
        self.nombre_campo = "Categor√≠a"
    
    def listar(self) -> List[Dict]:
        """Lista todas las categor√≠as"""
        try:
            return self.repositorio.listar()
        except Exception as e:
            logger.error(f"‚ùå Error al listar categor√≠as: {e}")
            return []
    
    def obtener_por_id(self, idcategoria: int) -> Optional[Dict]:
        """Obtiene una categor√≠a por ID con validaci√≥n"""
        if not self.validar_entero_positivo(idcategoria, "ID de categor√≠a"):
            return None
        
        try:
            return self.repositorio.obtener_por_id(idcategoria)
        except Exception as e:
            logger.error(f"‚ùå Error al obtener categor√≠a {idcategoria}: {e}")
            return None
    
    def crear(self, nombre: str, descripcion: str = None) -> bool:
        """Crea una nueva categor√≠a con validaciones"""
        # Validaciones
        if not self.validar_requerido(nombre, "nombre"):
            return False
        
        if not self.validar_longitud(nombre, "nombre", max_len=50):
            return False
        
        if descripcion and not self.validar_longitud(descripcion, "descripci√≥n", max_len=256):
            return False
        
        try:
            return self.repositorio.insertar(nombre.strip(), descripcion)
        except Exception as e:
            logger.error(f"‚ùå Error al crear categor√≠a: {e}")
            return False
    
    def actualizar(self, idcategoria: int, nombre: str, descripcion: str = None) -> bool:
        """Actualiza una categor√≠a con validaciones"""
        if not self.validar_entero_positivo(idcategoria, "ID de categor√≠a"):
            return False
        
        if not self.validar_requerido(nombre, "nombre"):
            return False
        
        if not self.validar_longitud(nombre, "nombre", max_len=50):
            return False
        
        if descripcion and not self.validar_longitud(descripcion, "descripci√≥n", max_len=256):
            return False
        
        try:
            return self.repositorio.actualizar(idcategoria, nombre.strip(), descripcion)
        except Exception as e:
            logger.error(f"‚ùå Error al actualizar categor√≠a: {e}")
            return False
    
    def eliminar(self, idcategoria: int) -> bool:
        """Elimina una categor√≠a con validaci√≥n"""
        if not self.validar_entero_positivo(idcategoria, "ID de categor√≠a"):
            return False
        
        try:
            return self.repositorio.eliminar(idcategoria)
        except Exception as e:
            logger.error(f"‚ùå Error al eliminar categor√≠a: {e}")
            return False




----- capa_negocio/cliente_service.py -----
"""
Servicio para la gesti√≥n de clientes
"""
from loguru import logger
import re
from capa_negocio.base_service import BaseService
from capa_negocio.validacion_venezuela import ValidacionVenezuela

class ClienteService(BaseService):
    """Servicio que implementa la l√≥gica de negocio para clientes"""
    
    def __init__(self, repositorio):
        """
        Inicializa el servicio con un repositorio de clientes
        
        Args:
            repositorio: Instancia de ClienteRepositorio
        """
        # CORRECCI√ìN: Llamar correctamente al constructor de BaseService
        # BaseService no requiere argumentos en __init__
        super().__init__()
        self.repositorio = repositorio
    
    def listar(self):
        """
        Lista todos los clientes
        
        Returns:
            list: Lista de clientes o lista vac√≠a si hay error
        """
        try:
            return self.repositorio.listar()
        except Exception as e:
            logger.error(f"Error al listar clientes: {e}")
            return []
    
    def obtener_por_id(self, idcliente):
        """
        Obtiene un cliente por su ID
        
        Args:
            idcliente (int): ID del cliente
            
        Returns:
            dict: Datos del cliente o None si no existe
        """
        try:
            return self.repositorio.obtener_por_id(idcliente)
        except Exception as e:
            logger.error(f"Error al obtener cliente {idcliente}: {e}")
            return None
    
    def buscar_por_documento(self, documento):
        """
        Busca un cliente por su n√∫mero de documento
        
        Args:
            documento (str): Documento completo (ej: V12345678)
            
        Returns:
            dict: Datos del cliente o None si no existe
        """
        try:
            # Separar tipo y n√∫mero
            if documento and documento[0] in ['V', 'E', 'J', 'G', 'C']:
                tipo = documento[0]
                numero = documento[1:]
                return self.repositorio.buscar_por_documento(tipo, numero)
            return None
        except Exception as e:
            logger.error(f"Error al buscar cliente por documento {documento}: {e}")
            return None
    
    def crear(self, nombre, apellidos, fecha_nacimiento, tipo_documento, 
              num_documento, sexo=None, direccion=None, telefono=None, email=None):
        """
        Crea un nuevo cliente (fecha_nacimiento puede ser None)
        
        Args:
            nombre (str): Nombre del cliente
            apellidos (str): Apellidos del cliente
            fecha_nacimiento (str or None): Fecha de nacimiento (YYYY-MM-DD o None)
            tipo_documento (str): Tipo de documento (V, E, J, G, C, PASAPORTE)
            num_documento (str): N√∫mero de documento
            sexo (str, optional): Sexo (M, F, O)
            direccion (str, optional): Direcci√≥n
            telefono (str, optional): Tel√©fono
            email (str, optional): Email
            
        Returns:
            bool: True si se cre√≥ correctamente, False en caso contrario
        """
        try:
            # Validar campos obligatorios
            if not nombre or not nombre.strip():
                logger.error("El nombre es obligatorio")
                return False
            
            if not apellidos or not apellidos.strip():
                logger.error("Los apellidos son obligatorios")
                return False
            
            if not tipo_documento:
                logger.error("El tipo de documento es obligatorio")
                return False
            
            if not num_documento or not num_documento.strip():
                logger.error("El n√∫mero de documento es obligatorio")
                return False
            
            # Validar formato del documento seg√∫n el tipo
            if tipo_documento in ['V', 'E', 'J', 'G', 'C']:
                # Debe ser solo n√∫meros y tener 8 d√≠gitos
                if not num_documento.isdigit():
                    logger.error(f"El n√∫mero de documento para tipo {tipo_documento} debe contener solo d√≠gitos")
                    return False
                if len(num_documento) != 8:
                    logger.error(f"El n√∫mero de documento para tipo {tipo_documento} debe tener 8 d√≠gitos")
                    return False
            elif tipo_documento == 'PASAPORTE':
                # Pasaporte: entre 6 y 12 caracteres alfanum√©ricos
                if len(num_documento) < 6 or len(num_documento) > 12:
                    logger.error("El pasaporte debe tener entre 6 y 12 caracteres")
                    return False
                # Puede contener letras y n√∫meros
                if not num_documento.isalnum():
                    logger.error("El pasaporte solo puede contener letras y n√∫meros")
                    return False
            else:
                logger.error(f"Tipo de documento no v√°lido: {tipo_documento}")
                return False
            
            # Validar email si se proporciona
            if email:
                if not self.validar_email(email):
                    logger.error("Formato de email inv√°lido")
                    return False
            
            # Validar tel√©fono si se proporciona
            if telefono:
                if not self.validar_telefono(telefono):
                    logger.error("Formato de tel√©fono inv√°lido")
                    return False
            
            # Validar fecha si se proporciona (formato YYYY-MM-DD)
            if fecha_nacimiento:
                # Verificar formato b√°sico
                if not re.match(r'^\d{4}-\d{2}-\d{2}$', fecha_nacimiento):
                    logger.error("Formato de fecha inv√°lido. Use YYYY-MM-DD")
                    return False
            
            # Crear cliente
            resultado = self.repositorio.crear(
                nombre.strip(), 
                apellidos.strip(), 
                fecha_nacimiento,  # Puede ser None
                tipo_documento, 
                num_documento.strip(),
                sexo.strip().upper() if sexo else None, 
                direccion.strip() if direccion else None, 
                telefono.strip() if telefono else None, 
                email.strip().lower() if email else None
            )
            
            if resultado:
                logger.info(f"Cliente creado: {nombre} {apellidos}")
                return True
            else:
                logger.error("No se pudo crear el cliente")
                return False
                
        except Exception as e:
            logger.error(f"Error al crear cliente: {e}")
            return False
    
    def actualizar(self, idcliente, nombre, apellidos, fecha_nacimiento, tipo_documento,
                   num_documento, sexo=None, direccion=None, telefono=None, email=None):
        """
        Actualiza un cliente existente
        
        Args:
            idcliente (int): ID del cliente a actualizar
            nombre (str): Nombre del cliente
            apellidos (str): Apellidos del cliente
            fecha_nacimiento (str or None): Fecha de nacimiento (YYYY-MM-DD o None)
            tipo_documento (str): Tipo de documento
            num_documento (str): N√∫mero de documento
            sexo (str, optional): Sexo
            direccion (str, optional): Direcci√≥n
            telefono (str, optional): Tel√©fono
            email (str, optional): Email
            
        Returns:
            bool: True si se actualiz√≥ correctamente, False en caso contrario
        """
        try:
            # Validar que el cliente existe
            cliente = self.obtener_por_id(idcliente)
            if not cliente:
                logger.error(f"Cliente {idcliente} no encontrado")
                return False
            
            # Validar campos obligatorios
            if not nombre or not nombre.strip():
                logger.error("El nombre es obligatorio")
                return False
            
            if not apellidos or not apellidos.strip():
                logger.error("Los apellidos son obligatorios")
                return False
            
            if not tipo_documento:
                logger.error("El tipo de documento es obligatorio")
                return False
            
            if not num_documento or not num_documento.strip():
                logger.error("El n√∫mero de documento es obligatorio")
                return False
            
            # Validar formato del documento seg√∫n el tipo
            if tipo_documento in ['V', 'E', 'J', 'G', 'C']:
                if not num_documento.isdigit():
                    logger.error(f"El n√∫mero de documento para tipo {tipo_documento} debe contener solo d√≠gitos")
                    return False
                if len(num_documento) != 8:
                    logger.error(f"El n√∫mero de documento para tipo {tipo_documento} debe tener 8 d√≠gitos")
                    return False
            elif tipo_documento == 'PASAPORTE':
                if len(num_documento) < 6 or len(num_documento) > 12:
                    logger.error("El pasaporte debe tener entre 6 y 12 caracteres")
                    return False
                if not num_documento.isalnum():
                    logger.error("El pasaporte solo puede contener letras y n√∫meros")
                    return False
            else:
                logger.error(f"Tipo de documento no v√°lido: {tipo_documento}")
                return False
            
            # Validar email si se proporciona
            if email:
                if not self.validar_email(email):
                    logger.error("Formato de email inv√°lido")
                    return False
            
            # Validar tel√©fono si se proporciona
            if telefono:
                if not self.validar_telefono(telefono):
                    logger.error("Formato de tel√©fono inv√°lido")
                    return False
            
            # Actualizar cliente
            resultado = self.repositorio.actualizar(
                idcliente,
                nombre.strip(), 
                apellidos.strip(), 
                fecha_nacimiento,  # Puede ser None
                tipo_documento, 
                num_documento.strip(),
                sexo.strip().upper() if sexo else None, 
                direccion.strip() if direccion else None, 
                telefono.strip() if telefono else None, 
                email.strip().lower() if email else None
            )
            
            if resultado:
                logger.info(f"Cliente {idcliente} actualizado correctamente")
                return True
            else:
                logger.error(f"No se pudo actualizar el cliente {idcliente}")
                return False
                
        except Exception as e:
            logger.error(f"Error al actualizar cliente {idcliente}: {e}")
            return False
    
    def eliminar(self, idcliente):
        """
        Elimina un cliente (l√≥gicamente)
        
        Args:
            idcliente (int): ID del cliente a eliminar
            
        Returns:
            bool: True si se elimin√≥ correctamente, False en caso contrario
        """
        try:
            # Validar que el cliente existe
            cliente = self.obtener_por_id(idcliente)
            if not cliente:
                logger.error(f"Cliente {idcliente} no encontrado")
                return False
            
            # Verificar si tiene ventas asociadas (esto lo har√≠a el repositorio)
            resultado = self.repositorio.eliminar(idcliente)
            
            if resultado:
                logger.info(f"Cliente {idcliente} eliminado correctamente")
                return True
            else:
                logger.error(f"No se pudo eliminar el cliente {idcliente}")
                return False
                
        except Exception as e:
            logger.error(f"Error al eliminar cliente {idcliente}: {e}")
            return False
    
    def validar_email(self, email):
        """
        Valida el formato de un email
        
        Args:
            email (str): Email a validar
            
        Returns:
            bool: True si es v√°lido, False en caso contrario
        """
        if not email:
            return True  # Email opcional
        
        patron = r'^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$'
        return re.match(patron, email) is not None
    
    def validar_telefono(self, telefono):
        """
        Valida el formato de un tel√©fono venezolano
        
        Args:
            telefono (str): Tel√©fono a validar
            
        Returns:
            bool: True si es v√°lido, False en caso contrario
        """
        if not telefono:
            return True  # Tel√©fono opcional
        
        # Limpiar el tel√©fono (quitar +, -, espacios)
        telefono_limpio = re.sub(r'[\+\-\s]', '', telefono)
        
        # Verificar que sea solo n√∫meros y tenga entre 10 y 12 d√≠gitos
        if not telefono_limpio.isdigit():
            return False
        
        if len(telefono_limpio) < 10 or len(telefono_limpio) > 12:
            return False
        
        return True

----- capa_negocio/compra_service.py -----
"""
Servicio para gesti√≥n de compras - VERSI√ìN SIMPLIFICADA
"""
from loguru import logger
from capa_datos.compra_repo import CompraRepositorio
from capa_datos.conexion import ConexionDB

class CompraService:
    def __init__(self):
        # Solo usamos el repositorio de compras
        self.repo = CompraRepositorio()
    
    def listar_compras(self):
        """Lista todas las compras"""
        try:
            return self.repo.listar()
        except Exception as e:
            logger.error(f"Error listando compras: {e}")
            return []
    
    def buscar_compra(self, idcompra):
        """Busca una compra por ID"""
        try:
            return self.repo.buscar_por_id(idcompra)
        except Exception as e:
            logger.error(f"Error buscando compra: {e}")
            return None
    
    def anular_compra(self, idcompra):
        """Anula una compra"""
        try:
            return self.repo.anular(idcompra)
        except Exception as e:
            logger.error(f"Error anulando compra: {e}")
            return False

----- capa_negocio/email_service.py -----
import smtplib
import random
import string
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart
from email.header import Header
from email.utils import formataddr
from loguru import logger

class EmailService:
    """Servicio para env√≠o de correos electr√≥nicos"""
    
    def __init__(self, smtp_server="smtp.gmail.com", smtp_port=587, 
                 email_remitente="tu_correo@gmail.com", password="tu_contrase√±a"):
        self.smtp_server = smtp_server
        self.smtp_port = smtp_port
        self.email_remitente = email_remitente
        self.password = password
        self.codigos_recuperacion = {}  # Para compatibilidad
    
    def generar_codigo(self, longitud=6):
        """Genera un c√≥digo aleatorio de recuperaci√≥n (para compatibilidad)"""
        return ''.join(random.choices(string.digits, k=longitud))
    
    def enviar_enlace_magico(self, email_destino, token, nombre_usuario):
        """Env√≠a un enlace m√°gico para recuperaci√≥n de contrase√±a"""
        try:
            # Crear mensaje con codificaci√≥n UTF-8
            mensaje = MIMEMultipart('alternative')
            mensaje['From'] = formataddr((str(Header('Sistema Ventas', 'utf-8')), self.email_remitente))
            mensaje['To'] = email_destino
            mensaje['Subject'] = Header('üîê Recuperaci√≥n de contrase√±a - Sistema de Ventas', 'utf-8')
            
            # Versi√≥n texto plano (para clientes que no soportan HTML)
            texto_plano = f"""
Recuperaci√≥n de Contrase√±a - Sistema de Ventas

Hola {nombre_usuario},

Has solicitado restablecer tu contrase√±a.

Tu token de recuperaci√≥n es: {token}

Este token expirar√° en 30 minutos.

Instrucciones:
1. Vuelve al programa
2. Selecciona opci√≥n "Recuperar contrase√±a"
3. Elige "Ingresar token manual"
4. Copia y pega este token
5. Establece tu nueva contrase√±a

Si no solicitaste esto, ignora este mensaje.

Sistema de Ventas
"""
            
            # Versi√≥n HTML
            html = f"""
            <html>
                <head>
                    <meta charset="UTF-8">
                </head>
                <body style="font-family: Arial, sans-serif; padding: 20px; max-width: 600px;">
                    <h2 style="color: #4CAF50;">Recuperaci√≥n de Contrase√±a</h2>
                    <p>Hola <strong>{nombre_usuario}</strong>,</p>
                    <p>Recibimos una solicitud para restablecer tu contrase√±a.</p>
                    
                    <div style="background-color: #f5f5f5; padding: 20px; border-radius: 10px; margin: 20px 0; text-align: center;">
                        <p style="font-size: 16px; margin-bottom: 20px;">Tu token de recuperaci√≥n es:</p>
                        <div style="background-color: #333; color: #fff; padding: 15px; font-family: monospace; font-size: 18px; letter-spacing: 2px; border-radius: 5px;">
                            {token}
                        </div>
                        <p style="margin-top: 20px; font-size: 14px; color: #666;">
                            ‚è∞ Este token expirar√° en <strong>30 minutos</strong>.
                        </p>
                    </div>
                    
                    <div style="background-color: #fff3cd; border: 1px solid #ffeeba; padding: 15px; border-radius: 5px; margin: 20px 0;">
                        <p style="margin: 0; color: #856404;">
                            <strong>üìù Instrucciones:</strong><br>
                            1. Vuelve al programa<br>
                            2. Selecciona opci√≥n "Recuperar contrase√±a"<br>
                            3. Elige "Ingresar token manual"<br>
                            4. Copia y pega el token de arriba<br>
                            5. Establece tu nueva contrase√±a
                        </p>
                    </div>
                    
                    <div style="background-color: #f8f9fa; padding: 15px; border-radius: 5px; margin: 20px 0;">
                        <p style="margin: 0; font-size: 13px;">
                            <strong>¬øNo solicitaste esto?</strong><br>
                            Si no solicitaste restablecer tu contrase√±a, ignora este correo. 
                            Tu cuenta permanece segura.
                        </p>
                    </div>
                    
                    <hr style="border: none; border-top: 1px solid #eee;">
                    <p style="color: #999; font-size: 12px;">
                        Sistema de Ventas - 3 Capas<br>
                        Si tienes problemas, contacta al administrador.
                    </p>
                </body>
            </html>
            """
            
            # Adjuntar versiones con UTF-8 expl√≠cito
            mensaje.attach(MIMEText(texto_plano, 'plain', 'utf-8'))
            mensaje.attach(MIMEText(html, 'html', 'utf-8'))
            
            # Enviar correo
            server = smtplib.SMTP(self.smtp_server, self.smtp_port)
            server.starttls()
            server.login(self.email_remitente, self.password)
            server.send_message(mensaje)
            server.quit()
            
            logger.success(f"üìß Enlace m√°gico enviado a {email_destino}")
            return True
            
        except Exception as e:
            logger.error(f"‚ùå Error al enviar enlace: {e}")
            return False
    
    def enviar_codigo_recuperacion(self, email_destino, codigo):
        """Versi√≥n antigua para compatibilidad"""
        return self.enviar_enlace_magico(email_destino, codigo, "Usuario")

----- capa_negocio/ia_productos_service.py -----
"""
Servicio de Inteligencia Artificial para clasificaci√≥n autom√°tica de productos
"""
from loguru import logger
from typing import Dict, List, Optional, Tuple
import re

class IAProductosService:
    def __init__(self, repo_reglas=None):
        self.repo_reglas = repo_reglas
        self.reglas_cargadas = False
        self.palabras_clave = {}  # {palabra: id_impuesto}
        self.marcas_conocidas = {} # {marca: id_impuesto}
        self.cargar_reglas_iniciales()

    def detectar_categoria_motos(self, nombre: str) -> Optional[Dict]:
        """
        Detecta si el producto pertenece a la categor√≠a de motos
        y devuelve el ID de categor√≠a (101-111) e impuesto (siempre 2 - General)
        """
        if not nombre:
            return None
        
        nombre_upper = nombre.upper()
        
        # Reglas para cada categor√≠a de motos
        reglas_motos = [
            # (palabras clave, idcategoria, nombre_categoria)
            (['PISTON', 'ANILLO', 'CIGUE√ëAL', 'VALVULA', 'EMPACADURA'], 101, 'Motor'),
            (['CADENA', 'PI√ëON', 'CORONA', 'CORREA', 'EMBRAGUE'], 102, 'Transmisi√≥n'),
            (['PASTILLA', 'BANDA', 'DISCO FRENO', 'GUAYA', 'FRENO'], 103, 'Frenos'),
            (['AMORTIGUADOR', 'BARRA', 'RODAMIENTO', 'SUSPENSION'], 104, 'Suspensi√≥n'),
            (['BATERIA', 'BUJIA', 'CDI', 'REGULADOR', 'BOMBILLO', 'BOYA'], 105, 'El√©ctrico'),
            (['ACEITE 2T', 'ACEITE 4T', 'LIGA FRENO', 'LUBRICANTE', 'ACEITE MOTOR'], 106, 'Lubricantes'),
            (['FILTRO ACEITE', 'FILTRO AIRE', 'FILTRO GASOLINA'], 107, 'Filtros'),
            (['CAUCHO', 'LLANTA', 'TRIPA', 'NEUMATICO', 'CAMARA'], 108, 'Cauchos'),
            (['CASCO', 'GUANTE', 'CHAQUETA', 'MALETERO', 'CALCOMANIA', 'PEGATINA'], 109, 'Accesorios'),
            (['HERRAMIENTA', 'LLAVE', 'DESARMADOR', 'ALICATE', 'JUEGO LLAVES'], 110, 'Herramientas'),
            (['SERVICIO', 'MANO OBRA', 'REPARACION', 'CAMBIO ACEITE', 'ENTONACION'], 111, 'Servicios')
        ]
        
        # Buscar coincidencias
        for palabras, cat_id, cat_nombre in reglas_motos:
            if any(palabra in nombre_upper for palabra in palabras):
                return {
                    'idcategoria': cat_id,
                    'nombre_categoria': cat_nombre,
                    'id_impuesto': 2,  # Siempre General (G) para motos
                    'confianza': 0.90,
                    'tipo': 'MOTOS',
                    'palabra_encontrada': [p for p in palabras if p in nombre_upper][0]
                }
        
        return None
    
    def cargar_reglas_iniciales(self):
        """Carga reglas por defecto en memoria"""
        # Exentos (id_impuesto=1)
        self.palabras_clave = {
            'harina': 1, 'arroz': 1, 'azucar': 1, 'leche': 1, 'huevo': 1,
            'pan': 1, 'pasta': 1, 'carne': 1, 'pollo': 1, 'pescado': 1,
            'fruta': 1, 'verdura': 1, 'legumbre': 1, 'medicina': 1,
            # Generales (id_impuesto=2)
            'mayonesa': 2, 'salsa': 2, 'atun': 2, 'gaseosa': 2, 'refresco': 2,
            'jabon': 2, 'detergente': 2, 'shampoo': 2, 'desodorante': 2,
        }
        
        self.marcas_conocidas = {
            'santoni': 1, 'bondora': 1, 'konfit': 1, 'pampa': 1,
            'ole': 2, 'ronco': 2,
        }
        
        self.reglas_cargadas = True
        logger.info(f"‚úÖ IAProductosService inicializado con {len(self.palabras_clave)} palabras clave")
    
    def analizar_producto(self, nombre: str) -> Optional[Dict]:
        """
        Analiza el nombre del producto y sugiere el impuesto y categor√≠a
        Primero intenta con motos, luego con supermercado
        """
        if not nombre:
            return None
        
        # 1. Intentar detectar si es producto de motos
        resultado_motos = self.detectar_categoria_motos(nombre)
        if resultado_motos:
            logger.info(f"üèçÔ∏è Producto de motos detectado: {resultado_motos['nombre_categoria']}")
            return resultado_motos
        
        # 2. Si no es moto, usar la l√≥gica existente de supermercado
        nombre_lower = nombre.lower()
        
        # Buscar por marca (prioridad alta)
        for marca, impuesto in self.marcas_conocidas.items():
            if marca in nombre_lower:
                return {
                    'id_impuesto': impuesto,
                    'confianza': 0.95,
                    'metodo': 'marca',
                    'palabra': marca
                }
        
        # Buscar por palabra clave
        palabras_encontradas = []
        for palabra, impuesto in self.palabras_clave.items():
            if palabra in nombre_lower:
                palabras_encontradas.append((palabra, impuesto))
        
        if palabras_encontradas:
            votos = {}
            for palabra, impuesto in palabras_encontradas:
                votos[impuesto] = votos.get(impuesto, 0) + 1
            
            impuesto_final = max(votos, key=votos.get)
            confianza = min(0.8 + (votos[impuesto_final] * 0.05), 0.95)
            
            return {
                'id_impuesto': impuesto_final,
                'confianza': confianza,
                'metodo': 'palabras_clave',
                'palabras': [p for p, _ in palabras_encontradas]
            }
        
        return None
    
    def obtener_nombre_impuesto(self, id_impuesto: int) -> str:
        """Obtiene el nombre del impuesto por su ID"""
        mapa = {1: 'Exento', 2: 'General', 3: 'Reducida', 4: 'Adicional'}
        return mapa.get(id_impuesto, 'Desconocido')
    
    def obtener_letra_fiscal(self, id_impuesto: int) -> str:
        """Obtiene la letra fiscal por ID de impuesto"""
        mapa = {1: 'E', 2: 'G', 3: 'R', 4: 'A'}
        return mapa.get(id_impuesto, '?')

    def detectar_categoria_venezolana(self, nombre: str) -> int:
        """
        Detecta la categor√≠a venezolana basada en el nombre del producto
        Usando los IDs REALES de la BD:
        1: Electr√≥nicos
        2: Viveres
        3: Bebidas
        4: L√°cteos
        5: Otros
        7: Perecederos
        8: Limpieza
        9: Higiene
        """
        if not nombre:
            return 5  # Otros por defecto
        
        nombre_upper = nombre.upper()
        
        # ELECTR√ìNICOS (ID 1)
        if any(palabra in nombre_upper for palabra in ['LAPTOP', 'COMPUTADORA', 'MOUSE', 'TECLADO', 
                                                        'MONITOR', 'CELULAR', 'TELEFONO', 'IMPRESORA']):
            return 1
        
        # V√çVERES (ID 2)
        if any(palabra in nombre_upper for palabra in ['HARINA', 'ARROZ', 'PASTA', 'GRANO', 'LENTEJA', 
                                                        'CARAOTA', 'QUINCHONCHO', 'AZUCAR', 'SAL', 
                                                        'ATUN', 'SARDINA', 'ENLATADO', 'MAYONESA', 
                                                        'SALSA', 'VINAGRE', 'ACEITE', 'CAFE']):
            return 2
        
        # BEBIDAS (ID 3)
        if any(palabra in nombre_upper for palabra in ['REFRESCO', 'GASEOSA', 'JUGO', 'MALTA', 'AGUA',
                                                        'POLAR', 'COCA', 'PEPSI', 'CHINOTO', 'FRESCOLITA']):
            return 3
        
        # L√ÅCTEOS (ID 4)
        if any(palabra in nombre_upper for palabra in ['LECHE', 'QUESO', 'YOGURT', 'MANTEQUILLA', 
                                                        'MARGARINA', 'KUMIS']):
            return 4
        
        # PERECEDEROS (ID 7)
        if any(palabra in nombre_upper for palabra in ['CARNE', 'POLLO', 'PESCADO', 'RES', 'CERDO',
                                                        'FRUTA', 'VERDURA', 'CEBOLLA', 'TOMATE',
                                                        'PIMENTON', 'Auyama', 'LECHOSA', 'PATILLA',
                                                        'MELON', 'CAMBUR', 'PLATANO']):
            return 7
        
        # LIMPIEZA (ID 8)
        if any(palabra in nombre_upper for palabra in ['JABON', 'DETERGENTE', 'CLORO', 'LIMPIDO',
                                                        'SUAVIZANTE', 'LYSOL', 'FAB', 'ARIEL']):
            return 8
        
        # HIGIENE (ID 9)
        if any(palabra in nombre_upper for palabra in ['SHAMPOO', 'ACONDICIONADOR', 'DESODORANTE',
                                                        'PASTA DENTAL', 'CEPILLO', 'JABON DE BA√ëO',
                                                        'PREND', 'COLGATE', 'AXE']):
            return 9
        
        # OTROS (ID 5) - por defecto
        return 5

----- capa_negocio/ingreso_service.py -----
from typing import List, Dict, Optional
from datetime import datetime
from loguru import logger
from capa_negocio.base_service import BaseService

class IngresoService(BaseService):
    """Servicio para gesti√≥n de ingresos de mercanc√≠a"""
    
    def __init__(self, repositorio, articulo_service=None, proveedor_service=None, trabajador_service=None):
        self.repositorio = repositorio
        self.articulo_service = articulo_service
        self.proveedor_service = proveedor_service
        self.trabajador_service = trabajador_service
    
    def listar_ingresos(self) -> List[Dict]:
        """Lista todos los ingresos"""
        try:
            return self.repositorio.listar()
        except Exception as e:
            logger.error(f"‚ùå Error al listar ingresos: {e}")
            return []
    
    def obtener_ingreso(self, idingreso: int) -> Optional[Dict]:
        """Obtiene un ingreso por ID con su detalle"""
        if not self.validar_entero_positivo(idingreso, "ID de ingreso"):
            return None
        try:
            return self.repositorio.obtener_por_id(idingreso)
        except Exception as e:
            logger.error(f"‚ùå Error al obtener ingreso {idingreso}: {e}")
            return None
    
    def registrar_ingreso(self, idtrabajador: int, idproveedor: int,
                          tipo_comprobante: str, serie: str, numero_comprobante: str,
                          igv: float, detalle: List[Dict] = None,
                          fecha: datetime = None) -> Optional[int]:
        """
        Registra un nuevo ingreso con su detalle
        detalle: lista de dict con idarticulo, cantidad, precio_compra
        """
        
        # Validaciones b√°sicas
        if not self.validar_entero_positivo(idtrabajador, "trabajador"):
            logger.warning("‚ö†Ô∏è ID de trabajador inv√°lido")
            return None
        if not self.validar_entero_positivo(idproveedor, "proveedor"):
            logger.warning("‚ö†Ô∏è ID de proveedor inv√°lido")
            return None
        if not self.validar_requerido(tipo_comprobante, "tipo de comprobante"):
            logger.warning("‚ö†Ô∏è Tipo de comprobante requerido")
            return None
        if not self.validar_requerido(serie, "serie"):
            logger.warning("‚ö†Ô∏è Serie requerida")
            return None
        if not self.validar_requerido(numero_comprobante, "n√∫mero de comprobante"):
            logger.warning("‚ö†Ô∏è N√∫mero de comprobante requerido")
            return None
        if not self.validar_decimal_positivo(igv, "IGV", permitir_cero=True):
            logger.warning("‚ö†Ô∏è IGV inv√°lido")
            return None
        
        # Validar que existan proveedor y trabajador
        if self.proveedor_service:
            proveedor = self.proveedor_service.obtener_por_id(idproveedor)
            if not proveedor:
                logger.warning(f"‚ö†Ô∏è El proveedor {idproveedor} no existe")
                return None
        
        if self.trabajador_service:
            trabajador = self.trabajador_service.obtener_por_id(idtrabajador)
            if not trabajador:
                logger.warning(f"‚ö†Ô∏è El trabajador {idtrabajador} no existe")
                return None
        
        # Validar detalle
        if not detalle or len(detalle) == 0:
            logger.warning("‚ö†Ô∏è El ingreso debe tener al menos un art√≠culo")
            return None
        
        total = 0
        for item in detalle:
            # Validar art√≠culo
            if not self.validar_entero_positivo(item.get('idarticulo'), "ID de art√≠culo"):
                logger.warning(f"‚ö†Ô∏è ID de art√≠culo inv√°lido: {item.get('idarticulo')}")
                return None
            if not self.validar_entero_positivo(item.get('cantidad'), "cantidad"):
                logger.warning(f"‚ö†Ô∏è Cantidad inv√°lida: {item.get('cantidad')}")
                return None
            if not self.validar_decimal_positivo(item.get('precio_compra'), "precio de compra"):
                logger.warning(f"‚ö†Ô∏è Precio de compra inv√°lido: {item.get('precio_compra')}")
                return None
            
            # Verificar que el art√≠culo existe
            if self.articulo_service:
                articulo = self.articulo_service.obtener_por_id(item['idarticulo'])
                if not articulo:
                    logger.warning(f"‚ö†Ô∏è El art√≠culo {item['idarticulo']} no existe")
                    return None
            
            # Calcular subtotal
            subtotal = item['cantidad'] * item['precio_compra']
            total += subtotal
            logger.info(f"   - Art√≠culo ID {item['idarticulo']}: {item['cantidad']} und @ Bs.{item['precio_compra']:.2f} = Bs.{subtotal:.2f}")
        
        logger.info(f"üí∞ Total del ingreso: Bs.{total:.2f}")
        
        try:
            # Registrar el ingreso
            if not fecha:
                fecha = datetime.now()
            
            idingreso = self.repositorio.insertar(
                idtrabajador, idproveedor, tipo_comprobante,
                serie, numero_comprobante, igv,
                fecha=fecha, detalle=detalle
            )
            
            if idingreso:
                logger.success(f"‚úÖ Ingreso #{idingreso} registrado con {len(detalle)} productos")
                logger.info(f"üì¶ Stock actualizado autom√°ticamente")
                return idingreso
            else:
                logger.error("‚ùå No se pudo insertar el ingreso en la base de datos")
                return None
                
        except Exception as e:
            logger.error(f"‚ùå Error al registrar ingreso: {e}")
            return None
    
    def anular_ingreso(self, idingreso: int) -> bool:
        """Anula un ingreso"""
        if not self.validar_entero_positivo(idingreso, "ID de ingreso"):
            return False
        try:
            return self.repositorio.anular(idingreso)
        except Exception as e:
            logger.error(f"‚ùå Error al anular ingreso {idingreso}: {e}")
            return False

----- capa_negocio/inventario_service.py -----
"""
Servicio para la gesti√≥n de inventario y stock - VERSI√ìN CORREGIDA
"""
from loguru import logger
from capa_negocio.base_service import BaseService

class InventarioService(BaseService):
    """Servicio que implementa la l√≥gica de negocio para inventario"""
    
    COLOR_ROJO = '\033[91m'
    COLOR_AMARILLO = '\033[93m'
    COLOR_VERDE = '\033[92m'
    COLOR_RESET = '\033[0m'
    
    def __init__(self, articulo_service):
        """Inicializa el servicio de inventario"""
        self.articulo_service = articulo_service
        from capa_datos.inventario_repo import InventarioRepositorio
        self.repo = InventarioRepositorio()
        logger.info("‚úÖ InventarioService inicializado")
    
    def obtener_stock_articulo(self, idarticulo):
        """
        Obtiene el stock actual de un art√≠culo desde la tabla kardex
        """
        try:
            if not self.validar_entero_positivo(idarticulo, "ID del art√≠culo"):
                return 0
            
            # Obtener conexi√≥n
            conn = self.articulo_service.repositorio.conn
            cursor = conn.cursor()
            
            # Consultar el √∫ltimo stock registrado en kardex
            query = """
            SELECT TOP 1 stock_nuevo 
            FROM kardex 
            WHERE idarticulo = ? 
            ORDER BY fecha_movimiento DESC
            """
            cursor.execute(query, (idarticulo,))
            row = cursor.fetchone()
            
            if row and row[0] is not None:
                stock = row[0]
                logger.info(f"Stock del art√≠culo {idarticulo} desde kardex: {stock} unidades")
                return stock
            else:
                # Si no hay movimientos, stock inicial = 0
                logger.warning(f"No hay registros en kardex para art√≠culo {idarticulo}")
                return 0
            
        except Exception as e:
            logger.error(f"Error al obtener stock del art√≠culo {idarticulo}: {e}")
            return 0

    def registrar_movimiento(self, idarticulo, tipo_movimiento, cantidad, 
                            referencia, precio_compra=None, lote=None, 
                            fecha_vencimiento=None):
        """
        Registra un movimiento en el kardex
        
        Args:
            idarticulo: ID del art√≠culo
            tipo_movimiento: 'ENTRADA' o 'SALIDA'
            cantidad: Cantidad del movimiento
            referencia: Referencia del movimiento (ej: "RECEPCI√ìN #123")
            precio_compra: Precio de compra (opcional)
            lote: N√∫mero de lote (opcional)
            fecha_vencimiento: Fecha de vencimiento (opcional)
            
        Returns:
            bool: True si se registr√≥ correctamente
        """
        try:
            if not self.validar_entero_positivo(idarticulo, "ID del art√≠culo"):
                return False
            
            if cantidad <= 0:
                logger.warning(f"‚ö†Ô∏è Cantidad inv√°lida: {cantidad}")
                return False
            
            # Validar tipo de movimiento
            if tipo_movimiento not in ['ENTRADA', 'SALIDA']:
                logger.warning(f"‚ö†Ô∏è Tipo de movimiento inv√°lido: {tipo_movimiento}")
                return False
            
            # Crear repositorio si no existe
            from capa_datos.inventario_repo import InventarioRepositorio
            repo = InventarioRepositorio()
            
            # Registrar en el repositorio
            resultado = repo.registrar_movimiento(
                idarticulo=idarticulo,
                tipo_movimiento=tipo_movimiento,
                cantidad=cantidad,
                referencia=referencia,
                precio_compra=precio_compra,
                lote=lote,
                fecha_vencimiento=fecha_vencimiento
            )
            
            if resultado:
                logger.info(f"‚úÖ Movimiento registrado: {tipo_movimiento} {cantidad} unidades - Art√≠culo {idarticulo}")
                return True
            else:
                logger.error(f"‚ùå Error registrando movimiento en repositorio")
                return False
                
        except Exception as e:
            logger.error(f"‚ùå Error en registrar_movimiento: {e}")
            return False
    
    def _insertar_stock_inicial(self, idarticulo):
        """
        Inserta un registro de stock inicial para un art√≠culo
        Usa 'INGRESO' como tipo_movimiento para cumplir con la restricci√≥n CHECK
        """
        try:
            conn = self.articulo_service.repositorio.conn
            cursor = conn.cursor()
            
            # CORREGIDO: Usar 'INGRESO' en lugar de 'INICIAL' para cumplir con la restricci√≥n
            query = """
            INSERT INTO kardex 
            (idarticulo, tipo_movimiento, documento_referencia, cantidad, 
             precio_unitario, valor_total, stock_anterior, stock_nuevo, fecha_movimiento)
            VALUES (?, 'INGRESO', 'INVENTARIO INICIAL', 0, 0, 0, 0, 0, GETDATE())
            """
            cursor.execute(query, (idarticulo,))
            conn.commit()
            logger.info(f"üìù Stock inicial creado para art√≠culo {idarticulo} (tipo: INGRESO)")
        except Exception as e:
            logger.error(f"Error al insertar stock inicial: {e}")
    
    def descontar_stock(self, idarticulo, cantidad, idventa=None, precio_unitario=None):
        """
        Descuenta stock de un art√≠culo por una venta (ACTUALIZA KARDEX)
        
        Args:
            idarticulo (int): ID del art√≠culo
            cantidad (int): Cantidad a descontar
            idventa (int, optional): ID de la venta asociada
            precio_unitario (float, optional): Precio de venta unitario
            
        Returns:
            bool: True si se descont√≥ correctamente, False en caso contrario
        """
        try:
            # Validaciones
            if not self.validar_entero_positivo(idarticulo, "ID del art√≠culo"):
                return False
            
            if not self.validar_entero_positivo(cantidad, "Cantidad a descontar"):
                return False
            
            # Obtener stock actual
            stock_actual = self.obtener_stock_articulo(idarticulo)
            
            if stock_actual < cantidad:
                logger.error(f"Stock insuficiente. Disponible: {stock_actual}, Solicitado: {cantidad}")
                return False
            
            # Calcular nuevo stock
            stock_nuevo = stock_actual - cantidad
            
            # Calcular valor total
            valor_total = cantidad * precio_unitario if precio_unitario else 0
            
            # Insertar en kardex
            conn = self.articulo_service.repositorio.conn
            cursor = conn.cursor()
            
            documento = f"VENTA-{idventa}" if idventa else "VENTA-DIRECTA"
            
            query = """
            INSERT INTO kardex 
            (idarticulo, tipo_movimiento, documento_referencia, cantidad, 
             precio_unitario, valor_total, stock_anterior, stock_nuevo, fecha_movimiento)
            VALUES (?, 'VENTA', ?, ?, ?, ?, ?, ?, GETDATE())
            """
            
            cursor.execute(query, (idarticulo, documento, cantidad, precio_unitario, valor_total, stock_actual, stock_nuevo))
            conn.commit()
            
            logger.info(f"‚úÖ Descontando {cantidad} unidades del art√≠culo {idarticulo}")
            logger.info(f"   Stock: {stock_actual} ‚Üí {stock_nuevo}")
            if precio_unitario:
                logger.info(f"   Precio unitario: Bs. {precio_unitario:.2f}")
                logger.info(f"   Valor total: Bs. {valor_total:.2f}")
            if idventa:
                logger.info(f"   Venta asociada: #{idventa}")
            
            return True
            
        except Exception as e:
            logger.error(f"Error al descontar stock del art√≠culo {idarticulo}: {e}")
            return False
    
    def reponer_stock(self, idarticulo, cantidad, idingreso=None, precio_compra=None):
        """
        Repone stock de un art√≠culo por un ingreso (ACTUALIZA KARDEX)
        
        Args:
            idarticulo (int): ID del art√≠culo
            cantidad (int): Cantidad a reponer
            idingreso (int, optional): ID del ingreso asociado
            precio_compra (float, optional): Precio de compra unitario
            
        Returns:
            bool: True si se repuso correctamente, False en caso contrario
        """
        try:
            # Validaciones
            if not self.validar_entero_positivo(idarticulo, "ID del art√≠culo"):
                return False
            
            if not self.validar_entero_positivo(cantidad, "Cantidad a reponer"):
                return False
            
            # Obtener stock actual
            stock_actual = self.obtener_stock_articulo(idarticulo)
            stock_nuevo = stock_actual + cantidad
            
            # Calcular valor total
            valor_total = cantidad * precio_compra if precio_compra else 0
            
            # Insertar en kardex
            conn = self.articulo_service.repositorio.conn
            cursor = conn.cursor()
            
            documento = f"INGRESO-{idingreso}" if idingreso else "INGRESO-MANUAL"
            
            query = """
            INSERT INTO kardex 
            (idarticulo, tipo_movimiento, documento_referencia, cantidad, 
             precio_unitario, valor_total, stock_anterior, stock_nuevo, fecha_movimiento)
            VALUES (?, 'INGRESO', ?, ?, ?, ?, ?, ?, GETDATE())
            """
            
            cursor.execute(query, (idarticulo, documento, cantidad, precio_compra, valor_total, stock_actual, stock_nuevo))
            conn.commit()
            
            logger.info(f"‚úÖ Reponiendo {cantidad} unidades del art√≠culo {idarticulo}")
            logger.info(f"   Stock: {stock_actual} ‚Üí {stock_nuevo}")
            if precio_compra:
                logger.info(f"   Precio compra: Bs. {precio_compra:.2f}")
                logger.info(f"   Valor total: Bs. {valor_total:.2f}")
            if idingreso:
                logger.info(f"   Ingreso asociado: #{idingreso}")
            
            return True
            
        except Exception as e:
            logger.error(f"Error al reponer stock del art√≠culo {idarticulo}: {e}")
            return False
    
    def obtener_nivel_stock(self, stock_actual):
        """
        Determina el nivel de stock (CR√çTICO, BAJO, NORMAL)
        
        Args:
            stock_actual (int): Stock actual del art√≠culo
            
        Returns:
            dict: Nivel de stock con color y mensaje
        """
        if stock_actual < 3:
            return {
                'nivel': 'CR√çTICO',
                'color': self.COLOR_ROJO,
                'emoji': 'üî¥',
                'mensaje': '¬°URGENTE! Reponer stock inmediatamente'
            }
        elif stock_actual < 6:
            return {
                'nivel': 'BAJO',
                'color': self.COLOR_AMARILLO,
                'emoji': 'üü°',
                'mensaje': 'Stock bajo, considerar reposici√≥n'
            }
        else:
            return {
                'nivel': 'NORMAL',
                'color': self.COLOR_VERDE,
                'emoji': 'üü¢',
                'mensaje': 'Stock normal'
            }
    
    def listar_con_stock(self):
        """
        Lista todos los art√≠culos con su stock actual desde kardex
        """
        try:
            if not self.articulo_service:
                logger.error("‚ùå ArticuloService no disponible")
                return []
            
            # Obtener art√≠culos usando el m√©todo correcto
            articulos = self.articulo_service.listar_articulos()
            
            if not articulos:
                logger.info("üì≠ No hay art√≠culos registrados")
                return []
            
            # Enriquecer con stock actual (sin perder otros campos)
            for art in articulos:
                try:
                    stock = self.obtener_stock_articulo(art['idarticulo'])
                    art['stock_actual'] = stock
                    
                    # DEBUG - Verificar que letra_fiscal se mantiene
                    if 'letra_fiscal' in art:
                        logger.debug(f"Art√≠culo {art['idarticulo']} tiene letra: {art['letra_fiscal']}")
                    
                except Exception as e:
                    logger.error(f"Error obteniendo stock para art√≠culo {art['idarticulo']}: {e}")
                    art['stock_actual'] = 0
            
            logger.info(f"‚úÖ {len(articulos)} art√≠culos listados con stock")
            return articulos
            
        except Exception as e:
            logger.error(f"‚ùå Error al listar art√≠culos con stock: {e}")
            return []
    
    def mostrar_tabla_stock(self):
        """
        Genera una tabla formateada del stock actual
        
        Returns:
            str: Tabla formateada para mostrar en consola
        """
        articulos = self.listar_con_stock()
        
        if not articulos:
            return "üì≠ No hay art√≠culos registrados"
        
        lineas = []
        lineas.append(f"{'ID':<5} {'C√ìDIGO':<15} {'NOMBRE':<30} {'STOCK':<10} {'ESTADO':<15}")
        lineas.append("-" * 75)
        
        for art in articulos:
            linea = f"{art['idarticulo']:<5} {art['codigo']:<15} {art['nombre']:<30} {art['stock_actual']:<10} {art['emoji']} {art['nivel_stock']}"
            lineas.append(f"{art['color']}{linea}{self.COLOR_RESET}")
        
        return "\n".join(lineas)
    
    def mostrar_resumen_stock(self):
        """
        Muestra un resumen del inventario
        
        Returns:
            str: Resumen formateado
        """
        articulos = self.listar_con_stock()
        
        if not articulos:
            return "üì≠ No hay art√≠culos registrados"
        
        total_articulos = len(articulos)
        criticos = sum(1 for a in articulos if a['nivel_stock'] == 'CR√çTICO')
        bajos = sum(1 for a in articulos if a['nivel_stock'] == 'BAJO')
        normales = sum(1 for a in articulos if a['nivel_stock'] == 'NORMAL')
        stock_total = sum(a['stock_actual'] for a in articulos)
        
        resumen = []
        resumen.append("üìä RESUMEN DE INVENTARIO")
        resumen.append("=" * 40)
        resumen.append(f"Total art√≠culos: {total_articulos}")
        resumen.append(f"Stock total: {stock_total} unidades")
        resumen.append("")
        resumen.append(f"{self.COLOR_ROJO}üî¥ Cr√≠ticos: {criticos}{self.COLOR_RESET}")
        resumen.append(f"{self.COLOR_AMARILLO}üü° Bajos: {bajos}{self.COLOR_RESET}")
        resumen.append(f"{self.COLOR_VERDE}üü¢ Normales: {normales}{self.COLOR_RESET}")
        
        if criticos > 0:
            resumen.append("")
            resumen.append(f"{self.COLOR_ROJO}‚ö†Ô∏è Art√≠culos cr√≠ticos:{self.COLOR_RESET}")
            for art in articulos:
                if art['nivel_stock'] == 'CR√çTICO':
                    resumen.append(f"   - {art['nombre']} (Stock: {art['stock_actual']})")
        
        return "\n".join(resumen)
    
    def obtener_alertas_stock(self):
        """
        Obtiene alertas de stock bajo y cr√≠tico
        
        Returns:
            list: Lista de alertas formateadas
        """
        articulos = self.listar_con_stock()
        alertas = []
        
        for art in articulos:
            if art['nivel_stock'] == 'CR√çTICO':
                alertas.append(f"{self.COLOR_ROJO}üî¥ {art['nombre']} - Stock CR√çTICO ({art['stock_actual']} und){self.COLOR_RESET}")
            elif art['nivel_stock'] == 'BAJO':
                alertas.append(f"{self.COLOR_AMARILLO}üü° {art['nombre']} - Stock BAJO ({art['stock_actual']} und){self.COLOR_RESET}")
        
        return alertas
    
    def verificar_stock_para_venta(self, items):
        """
        Verifica si hay stock suficiente para una venta
        
        Args:
            items (list): Lista de items con idarticulo y cantidad
            
        Returns:
            tuple: (bool, list) - (aprobado, lista de errores)
        """
        errores = []
        for item in items:
            stock = self.obtener_stock_articulo(item['idarticulo'])
            if item['cantidad'] > stock:
                errores.append(f"Art√≠culo {item['idarticulo']}: requiere {item['cantidad']}, disponible {stock}")
        
        return len(errores) == 0, errores

----- capa_negocio/moneda_service.py -----
"""
Servicio para gesti√≥n de multimoneda y tasas de cambio
"""
from datetime import datetime
from loguru import logger
import requests

class MonedaService:
    """Servicio para manejar operaciones con m√∫ltiples monedas"""
    
    MONEDAS = {
        'VES': {'nombre': 'Bol√≠var', 'simbolo': 'Bs.', 'decimales': 2},
        'USD': {'nombre': 'D√≥lar', 'simbolo': '$', 'decimales': 2},
        'EUR': {'nombre': 'Euro', 'simbolo': '‚Ç¨', 'decimales': 2}
    }
    
    def __init__(self, conn):
        self.conn = conn
        logger.info("‚úÖ MonedaService inicializado")
    
    def obtener_tasa_actual(self):
        """
        Obtiene la tasa de cambio actual (USD/VES)
        Prioridad: 1. BCV, 2. √öltima registrada, 3. Manual
        """
        try:
            # Intentar obtener tasa del BCV
            tasa_bcv = self._obtener_tasa_bcv()
            if tasa_bcv:
                self._guardar_tasa(tasa_bcv, 'BCV')
                return tasa_bcv
            
            # Si no, obtener √∫ltima tasa registrada
            cursor = self.conn.cursor()
            query = """
            SELECT TOP 1 tasa 
            FROM tasa_cambio 
            WHERE activa = 1 
            ORDER BY fecha DESC
            """
            cursor.execute(query)
            row = cursor.fetchone()
            
            if row:
                return row[0]
            
            return 1.0  # Tasa por defecto
            
        except Exception as e:
            logger.error(f"Error obteniendo tasa: {e}")
            return 1.0
    
    def _obtener_tasa_bcv(self):
        """
        Consulta la tasa del BCV (simulado por ahora)
        En producci√≥n, conectar con API real del BCV
        """
        try:
            # Simulaci√≥n - en producci√≥n conectar con API real
            # response = requests.get('https://api.bcv.org.ve/tasas', timeout=5)
            # return response.json()['usd']
            
            # Por ahora, retornar tasa simulada
            return 60.0  # Simular 60 Bs/USD
        except:
            return None
    
    def _guardar_tasa(self, tasa, fuente='MANUAL'):
        """Guarda una tasa en la base de datos"""
        try:
            cursor = self.conn.cursor()
            
            # Desactivar tasas anteriores
            cursor.execute("UPDATE tasa_cambio SET activa = 0 WHERE activa = 1")
            
            # Insertar nueva tasa
            query = """
            INSERT INTO tasa_cambio (fecha, tasa, fuente, activa)
            VALUES (GETDATE(), ?, ?, 1)
            """
            cursor.execute(query, (tasa, fuente))
            self.conn.commit()
            
            logger.info(f"‚úÖ Tasa guardada: 1 USD = {tasa} VES ({fuente})")
            
        except Exception as e:
            logger.error(f"Error guardando tasa: {e}")
    
    def actualizar_tasa_manual(self, tasa):
        """Actualiza la tasa manualmente"""
        return self._guardar_tasa(tasa, 'MANUAL')
    
    def convertir(self, monto, moneda_origen, moneda_destino, tasa=None):
        """
        Convierte entre monedas
        
        Args:
            monto: Cantidad a convertir
            moneda_origen: VES, USD, EUR
            moneda_destino: VES, USD, EUR
            tasa: Tasa de cambio (si es None, usa la actual)
        
        Returns:
            float: Monto convertido
        """
        if moneda_origen == moneda_destino:
            return monto
        
        if tasa is None:
            tasa = self.obtener_tasa_actual()
        
        if moneda_origen == 'USD' and moneda_destino == 'VES':
            return monto * tasa
        elif moneda_origen == 'VES' and moneda_destino == 'USD':
            return monto / tasa
        else:
            logger.error(f"Conversi√≥n no soportada: {moneda_origen} ‚Üí {moneda_destino}")
            return monto
    
    def formatear_monto(self, monto, moneda='VES'):
        """Formatea un monto seg√∫n la moneda"""
        info = self.MONEDAS.get(moneda, self.MONEDAS['VES'])
        formato = f"{info['simbolo']} {monto:,.{info['decimales']}f}"
        return formato.replace(',', ' ').replace('.', ',')

class IGTFService:
    """Servicio para calcular el IGTF (Impuesto a Grandes Transacciones Financieras)"""
    
    TASA_IGTF = 0.03  # 3% para pagos en divisas
    
    @staticmethod
    def calcular_igtf(monto, moneda_pago, moneda_transaccion='VES'):
        """
        Calcula el IGTF seg√∫n la moneda de pago
        
        Args:
            monto: Monto de la transacci√≥n
            moneda_pago: Moneda en que se paga (USD, VES, etc)
            moneda_transaccion: Moneda de la factura
            
        Returns:
            float: Monto del IGTF
        """
        if moneda_pago in ['USD', 'EUR']:
            return monto * IGTFService.TASA_IGTF
        return 0.0

----- capa_negocio/orden_compra_service.py -----
"""
Servicio para gesti√≥n de √≥rdenes de compra
"""
from loguru import logger
from capa_datos.orden_compra_repo import OrdenCompraRepositorio
from capa_datos.conexion import ConexionDB
from capa_negocio.tasa_service import TasaService
from capa_datos.tasa_repo import TasaRepositorio

class OrdenCompraService:
    def __init__(self):
        """Inicializa el servicio de √≥rdenes de compra"""
        self.db = ConexionDB()
        self.conn = self.db.conectar()
        self.repo = OrdenCompraRepositorio()
        
        # Inicializar servicio de tasas con su propia conexi√≥n
        try:
            self.db_tasa = ConexionDB()
            self.conn_tasa = self.db_tasa.conectar()
            if self.conn_tasa:
                tasa_repo = TasaRepositorio(self.conn_tasa)
                self.tasa_service = TasaService(tasa_repo)
                logger.info("‚úÖ Servicio de tasas inicializado en OrdenCompraService")
            else:
                logger.error("‚ùå No se pudo conectar para servicio de tasas")
                self.tasa_service = None
        except Exception as e:
            logger.error(f"‚ùå Error inicializando servicio de tasas: {e}")
            self.tasa_service = None
    
    def registrar_orden(self, codigo_factura, idproveedor, idtrabajador, 
                        fecha_compra, monto_total_usd, fecha_estimada_llegada=None,
                        archivo_adjunto=None, estatus='POR_RECIBIR', observaciones=None):
        """Registra una nueva orden de compra"""
        try:
            # Obtener tasa BCV del d√≠a
            tasa_bcv = None
            monto_total_bs = None
            
            if self.tasa_service:
                tasa_bcv = self.tasa_service.obtener_tasa_del_dia('USD')
                if tasa_bcv and tasa_bcv > 0:
                    monto_total_bs = monto_total_usd * tasa_bcv
                    logger.info(f"üí∞ Tasa aplicada: {tasa_bcv} Bs/USD - Monto Bs: {monto_total_bs:,.2f}")
            else:
                logger.warning("‚ö†Ô∏è Servicio de tasas no disponible")
            
            idorden = self.repo.crear(
                codigo_factura, idproveedor, idtrabajador, fecha_compra,
                monto_total_usd, monto_total_bs, tasa_bcv,
                fecha_estimada_llegada, archivo_adjunto, estatus, observaciones
            )
            
            if idorden:
                logger.info(f"‚úÖ Orden de compra #{idorden} - {codigo_factura} registrada")
                return idorden
            return None
            
        except Exception as e:
            logger.error(f"‚ùå Error registrando orden: {e}")
            return None
    
    def buscar_por_codigo_factura(self, codigo_factura):
        """Busca orden por c√≥digo de factura"""
        try:
            return self.repo.buscar_por_codigo_factura(codigo_factura)
        except Exception as e:
            logger.error(f"‚ùå Error buscando orden por c√≥digo: {e}")
            return None
    
    def listar_ordenes_pendientes(self):
        """Lista √≥rdenes pendientes de recepci√≥n"""
        try:
            return self.repo.listar_por_estatus('POR_RECIBIR')
        except Exception as e:
            logger.error(f"‚ùå Error listando √≥rdenes pendientes: {e}")
            return []
    
    def listar_todas_ordenes(self):
        """Lista todas las √≥rdenes"""
        try:
            return self.repo.listar_todas()
        except Exception as e:
            logger.error(f"‚ùå Error listando √≥rdenes: {e}")
            return []
    
    def actualizar_estatus(self, idorden, estatus):
        """Actualiza estatus de la orden"""
        try:
            return self.repo.actualizar_estatus(idorden, estatus)
        except Exception as e:
            logger.error(f"‚ùå Error actualizando estatus: {e}")
            return False
    
    def __del__(self):
        """Cierra conexiones al destruir el objeto"""
        try:
            if hasattr(self, 'db'):
                self.db.cerrar()
            if hasattr(self, 'db_tasa'):
                self.db_tasa.cerrar()
        except:
            pass

----- capa_negocio/proveedor_archivo_service.py -----
from typing import List, Dict, Optional
import os
from datetime import datetime
from loguru import logger
from capa_negocio.base_service import BaseService

class ProveedorArchivoService(BaseService):
    """Servicio para gesti√≥n de archivos de proveedores"""
    
    # Extensiones permitidas
    EXTENSIONES_PERMITIDAS = {
        '.jpg': 'image/jpeg',
        '.jpeg': 'image/jpeg',
        '.png': 'image/png',
        '.gif': 'image/gif',
        '.pdf': 'application/pdf',
        '.xls': 'application/vnd.ms-excel',
        '.xlsx': 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
        '.csv': 'text/csv',
        '.txt': 'text/plain',
        '.doc': 'application/msword',
        '.docx': 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'
    }
    
    TAMANO_MAXIMO = 10 * 1024 * 1024  # 10 MB
    
    def __init__(self, repositorio, proveedor_service=None):
        self.repositorio = repositorio
        self.proveedor_service = proveedor_service
    
    def listar_archivos_proveedor(self, idproveedor: int) -> List[Dict]:
        """Lista los archivos de un proveedor"""
        if not self.validar_entero_positivo(idproveedor, "ID de proveedor"):
            return []
        return self.repositorio.listar_por_proveedor(idproveedor)
    
    def obtener_archivo(self, idarchivo: int) -> Optional[Dict]:
        """Obtiene un archivo completo por su ID"""
        if not self.validar_entero_positivo(idarchivo, "ID de archivo"):
            return None
        return self.repositorio.obtener_archivo(idarchivo)
    
    def validar_archivo(self, nombre_archivo: str, contenido: bytes) -> bool:
        """Valida que el archivo sea v√°lido (extensi√≥n y tama√±o)"""
        if len(contenido) > self.TAMANO_MAXIMO:
            logger.warning(f"‚ö†Ô∏è Archivo demasiado grande: {len(contenido)} bytes")
            return False
        
        extension = os.path.splitext(nombre_archivo)[1].lower()
        if extension not in self.EXTENSIONES_PERMITIDAS:
            logger.warning(f"‚ö†Ô∏è Extensi√≥n '{extension}' no permitida")
            return False
        
        return True
    
    def subir_archivo(self, idproveedor: int, ruta_archivo: str, 
                      descripcion: str = None) -> Optional[int]:
        """Sube un archivo desde el sistema de archivos local"""
        
        if not self.validar_entero_positivo(idproveedor, "ID de proveedor"):
            return None
        
        if not os.path.exists(ruta_archivo):
            logger.warning(f"‚ö†Ô∏è El archivo '{ruta_archivo}' no existe")
            return None
        
        try:
            with open(ruta_archivo, 'rb') as f:
                contenido = f.read()
            
            nombre_archivo = os.path.basename(ruta_archivo)
            
            if not self.validar_archivo(nombre_archivo, contenido):
                return None
            
            extension = os.path.splitext(nombre_archivo)[1].lower()
            tipo_archivo = self.EXTENSIONES_PERMITIDAS.get(extension, 'application/octet-stream')
            
            return self.repositorio.insertar(
                idproveedor, nombre_archivo, tipo_archivo, contenido, descripcion
            )
        except Exception as e:
            logger.error(f"‚ùå Error al subir archivo: {e}")
            return None
    
    def guardar_archivo(self, idarchivo: int, ruta_destino: str) -> bool:
        """Guarda un archivo de la BD al sistema de archivos local"""
        if not self.validar_entero_positivo(idarchivo, "ID de archivo"):
            return False
        
        archivo = self.obtener_archivo(idarchivo)
        if not archivo:
            return False
        
        try:
            directorio = os.path.dirname(ruta_destino)
            if directorio and not os.path.exists(directorio):
                os.makedirs(directorio)
            
            with open(ruta_destino, 'wb') as f:
                f.write(archivo['contenido'])
            
            logger.success(f"‚úÖ Archivo guardado en '{ruta_destino}'")
            return True
        except Exception as e:
            logger.error(f"‚ùå Error al guardar archivo: {e}")
            return False
    
    def eliminar_archivo(self, idarchivo: int) -> bool:
        """Elimina un archivo de la BD"""
        if not self.validar_entero_positivo(idarchivo, "ID de archivo"):
            return False
        return self.repositorio.eliminar(idarchivo)
    
    def obtener_tamano_legible(self, tamano_bytes: int) -> str:
        """Convierte tama√±o de bytes a formato legible"""
        if tamano_bytes < 1024:
            return f"{tamano_bytes} B"
        elif tamano_bytes < 1024 * 1024:
            return f"{tamano_bytes / 1024:.1f} KB"
        else:
            return f"{tamano_bytes / (1024 * 1024):.1f} MB"

----- capa_negocio/proveedor_service.py -----
from typing import List, Dict, Optional
from loguru import logger
from capa_negocio.base_service import BaseService
from capa_negocio.validacion_venezuela import ValidacionVenezuela

class ProveedorService(BaseService):
    """Servicio para gesti√≥n de proveedores con validaci√≥n venezolana"""
    
    def __init__(self, repositorio):
        self.repositorio = repositorio
    
    def listar(self) -> List[Dict]:
        """Lista todos los proveedores"""
        try:
            return self.repositorio.listar()
        except Exception as e:
            logger.error(f"‚ùå Error al listar proveedores: {e}")
            return []
    
    def obtener_por_id(self, idproveedor: int) -> Optional[Dict]:
        """Obtiene un proveedor por ID"""
        if not self.validar_entero_positivo(idproveedor, "ID de proveedor"):
            return None
        return self.repositorio.obtener_por_id(idproveedor)
    
    def _validar_documento_venezolano(self, tipo_doc: str, num_doc: str) -> bool:
        """
        Valida documentos venezolanos para proveedores
        - Personas naturales: V (venezolano), E (extranjero) ‚Üí c√©dula
        - Personas jur√≠dicas: J (empresa), G (gobierno), C (consejo comunal) ‚Üí RIF
        - Pasaporte: PASAPORTE
        """
        tipo_doc = tipo_doc.upper()
        
        # Validar seg√∫n el tipo de documento
        if tipo_doc in ['V', 'E']:
            # C√©dula venezolana o extranjera
            if not ValidacionVenezuela.validar_cedula(num_doc):
                logger.warning(f"‚ö†Ô∏è C√©dula '{num_doc}' inv√°lida para tipo {tipo_doc}")
                return False
        
        elif tipo_doc in ['J', 'G', 'C']:
            # RIF de empresa, gobierno o consejo comunal
            rif_completo = f"{tipo_doc}-{num_doc}"
            if not ValidacionVenezuela.validar_rif(rif_completo):
                logger.warning(f"‚ö†Ô∏è RIF '{rif_completo}' inv√°lido")
                return False
        
        elif tipo_doc == 'PASAPORTE':
            # Pasaporte (validaci√≥n b√°sica)
            if len(num_doc) < 6 or len(num_doc) > 12:
                logger.warning("‚ö†Ô∏è Pasaporte debe tener entre 6 y 12 caracteres")
                return False
        
        else:
            logger.warning(f"‚ö†Ô∏è Tipo de documento '{tipo_doc}' no v√°lido")
            return False
        
        return True
    
    def crear(self, razon_social: str, sector_comercial: str,
              tipo_documento: str, num_documento: str,
              direccion: str = None, telefono: str = None,
              email: str = None, url: str = None) -> bool:
        """Crea un nuevo proveedor con validaciones"""
        
        # Validaciones b√°sicas
        if not self.validar_requerido(razon_social, "raz√≥n social"):
            return False
        if not self.validar_requerido(sector_comercial, "sector comercial"):
            return False
        if not self.validar_requerido(tipo_documento, "tipo de documento"):
            return False
        if not self.validar_requerido(num_documento, "n√∫mero de documento"):
            return False
        
        # Validaci√≥n de longitud
        if not self.validar_longitud(razon_social, "raz√≥n social", max_len=150):
            return False
        
        # Validaci√≥n de email si se proporciona
        if email and not self.validar_email(email):
            return False
        
        # Validaci√≥n de tel√©fono si se proporciona
        if telefono and not self.validar_telefono(telefono):
            return False
        
        # Validaci√≥n de documento venezolano
        if not self._validar_documento_venezolano(tipo_documento, num_documento):
            return False
        
        try:
            return self.repositorio.insertar(
                razon_social.strip(), sector_comercial.strip(),
                tipo_documento, num_documento.strip(),
                direccion, telefono, email, url
            )
        except Exception as e:
            logger.error(f"‚ùå Error al crear proveedor: {e}")
            return False
    
    def actualizar(self, idproveedor: int, razon_social: str, sector_comercial: str,
                   tipo_documento: str, num_documento: str,
                   direccion: str = None, telefono: str = None,
                   email: str = None, url: str = None) -> bool:
        """Actualiza un proveedor existente"""
        
        if not self.validar_entero_positivo(idproveedor, "ID de proveedor"):
            return False
        
        # Validaciones b√°sicas
        if not self.validar_requerido(razon_social, "raz√≥n social"):
            return False
        if not self.validar_requerido(sector_comercial, "sector comercial"):
            return False
        if not self.validar_requerido(tipo_documento, "tipo de documento"):
            return False
        if not self.validar_requerido(num_documento, "n√∫mero de documento"):
            return False
        
        # Validaci√≥n de documento venezolano
        if not self._validar_documento_venezolano(tipo_documento, num_documento):
            return False
        
        if email and not self.validar_email(email):
            return False
        
        if telefono and not self.validar_telefono(telefono):
            return False
        
        try:
            return self.repositorio.actualizar(
                idproveedor, razon_social.strip(), sector_comercial.strip(),
                tipo_documento, num_documento.strip(),
                direccion, telefono, email, url
            )
        except Exception as e:
            logger.error(f"‚ùå Error al actualizar proveedor: {e}")
            return False
    
    def eliminar(self, idproveedor: int) -> bool:
        """Elimina un proveedor"""
        if not self.validar_entero_positivo(idproveedor, "ID de proveedor"):
            return False
        return self.repositorio.eliminar(idproveedor)

----- capa_negocio/recepcion_service.py -----
"""
Servicio para gesti√≥n de recepciones de mercanc√≠a
"""
from loguru import logger
from capa_datos.recepcion_repo import RecepcionRepositorio
from capa_datos.compra_repo import CompraRepositorio
from capa_datos.articulo_repo import ArticuloRepositorio
from capa_negocio.inventario_service import InventarioService

class RecepcionService:
    def __init__(self):
        self.repo = RecepcionRepositorio()
        self.compra_repo = CompraRepositorio()
        self.articulo_repo = ArticuloRepositorio()
        self.inventario_service = InventarioService()
    
    def recibir_mercancia(self, idproveedor, idtrabajador, items, idcompra_original=None, observaciones=None):
        """
        Registra una recepci√≥n de mercanc√≠a
        items: lista de dict con idarticulo, cantidad_recibida, costo_unitario_usd, 
               opcional: iddetalle_compra_original, cantidad_pedida, lote, fecha_vencimiento
        """
        try:
            if not items:
                logger.warning("‚ö†Ô∏è No hay items en la recepci√≥n")
                return None
            
            # Obtener tasa del d√≠a
            from capa_negocio.tasa_service import TasaService
            tasa_service = TasaService()
            tasa_bcv = tasa_service.obtener_tasa_del_dia('USD')
            
            if tasa_bcv <= 0:
                logger.error("‚ùå Tasa BCV no disponible")
                return None
            
            # Crear recepci√≥n
            idrecepcion = self.repo.crear_recepcion(
                idproveedor, idtrabajador, idcompra_original, observaciones
            )
            
            if not idrecepcion:
                return None
            
            # Procesar cada item
            for item in items:
                # Agregar detalle de recepci√≥n
                self.repo.agregar_detalle(
                    idrecepcion=idrecepcion,
                    idarticulo=item['idarticulo'],
                    cantidad_recibida=item['cantidad_recibida'],
                    costo_unitario_usd=item['costo_unitario_usd'],
                    tasa_bcv=tasa_bcv,
                    iddetalle_compra_original=item.get('iddetalle_compra_original'),
                    cantidad_pedida=item.get('cantidad_pedida'),
                    lote=item.get('lote'),
                    fecha_vencimiento=item.get('fecha_vencimiento')
                )
                
                # Calcular costo en bol√≠vares
                costo_bs = item['costo_unitario_usd'] * tasa_bcv
                
                # Actualizar inventario (entrada por recepci√≥n)
                self.inventario_service.registrar_movimiento(
                    idarticulo=item['idarticulo'],
                    tipo_movimiento='ENTRADA',
                    cantidad=item['cantidad_recibida'],
                    referencia=f"RECEPCI√ìN #{idrecepcion}",
                    precio_compra=costo_bs,
                    precio_compra_usd=item['costo_unitario_usd'],
                    lote=item.get('lote'),
                    fecha_vencimiento=item.get('fecha_vencimiento')
                )
                
                # Actualizar costo promedio del art√≠culo
                self._actualizar_costo_promedio(
                    item['idarticulo'], 
                    item['cantidad_recibida'], 
                    item['costo_unitario_usd'],
                    tasa_bcv
                )
            
            logger.info(f"‚úÖ Recepci√≥n #{idrecepcion} procesada con {len(items)} items")
            return idrecepcion
            
        except Exception as e:
            logger.error(f"‚ùå Error procesando recepci√≥n: {e}")
            return None
    
    def _actualizar_costo_promedio(self, idarticulo, cantidad_nueva, precio_usd, tasa_bcv):
        """Actualiza el costo promedio ponderado en USD y Bs"""
        try:
            articulo = self.articulo_repo.obtener_por_id(idarticulo)
            if not articulo:
                return
            
            stock_actual = articulo['stock_actual']
            costo_usd_actual = articulo.get('costo_promedio_usd', 0) or 0
            
            # Calcular nuevo costo promedio en USD
            if stock_actual == 0:
                nuevo_costo_usd = precio_usd
            else:
                total_costo_usd_actual = stock_actual * costo_usd_actual
                total_costo_usd_nuevo = cantidad_nueva * precio_usd
                nuevo_stock = stock_actual + cantidad_nueva
                nuevo_costo_usd = (total_costo_usd_actual + total_costo_usd_nuevo) / nuevo_stock
            
            # Actualizar en BD (necesitas agregar campo costo_promedio_usd a articulo)
            self.articulo_repo.actualizar_costo_promedio_usd(idarticulo, nuevo_costo_usd)
            
        except Exception as e:
            logger.error(f"‚ùå Error actualizando costo promedio: {e}")
    
    def obtener_recepciones_pendientes(self, idcompra=None):
        """Obtiene recepciones pendientes"""
        return self.repo.buscar_recepciones_pendientes(idcompra)

----- capa_negocio/reporte_contable_service.py -----
"""
Servicio para generaci√≥n de reportes contables
"""
from datetime import datetime, timedelta
from loguru import logger
import csv
import os

class ReporteContableService:
    """Genera reportes contables para ventas y movimientos"""
    
    def __init__(self, venta_service, inventario_service):
        self.venta_service = venta_service
        self.inventario_service = inventario_service
        logger.info("‚úÖ ReporteContableService inicializado")
    
    def obtener_ventas_por_periodo(self, fecha_inicio, fecha_fin):
        """
        Obtiene todas las ventas en un per√≠odo
        """
        ventas = self.venta_service.ventas_por_fecha(fecha_inicio, fecha_fin)
        
        print("\n" + "="*60)
        print("üîç DEPURACI√ìN DE VENTAS")
        print("="*60)
        print(f"Total ventas encontradas: {len(ventas)}")
        
        # Calcular totales por moneda
        total_bs = 0.0
        total_usd = 0.0
        total_eur = 0.0
        igtf_total = 0.0
        
        for idx, v in enumerate(ventas):
            print(f"\n--- VENTA #{idx+1} (ID: {v.get('idventa')}) ---")
            
            # Mostrar todos los campos de la venta
            for key, value in v.items():
                print(f"   {key}: {value} (tipo: {type(value)})")
            
            # Determinar moneda
            moneda = v.get('moneda', 'NO ESPECIFICADA')
            print(f"   ‚Üí Moneda detectada: {moneda}")
            
            # Obtener montos
            monto_bs = v.get('monto_bs')
            monto_divisa = v.get('monto_divisa')
            
            print(f"   ‚Üí monto_bs: {monto_bs}")
            print(f"   ‚Üí monto_divisa: {monto_divisa}")
            
            # Sumar seg√∫n moneda
            if moneda == 'VES' and monto_bs is not None:
                total_bs += float(monto_bs)
                print(f"   ‚úì Sumando a Bs.: +{float(monto_bs)}")
            elif moneda == 'USD' and monto_divisa is not None:
                total_usd += float(monto_divisa)
                print(f"   ‚úì Sumando a USD: +{float(monto_divisa)}")
            elif moneda == 'EUR' and monto_divisa is not None:
                total_eur += float(monto_divisa)
                print(f"   ‚úì Sumando a EUR: +{float(monto_divisa)}")
            else:
                print(f"   ‚úó No se pudo sumar - moneda: {moneda}, monto_bs: {monto_bs}, monto_divisa: {monto_divisa}")
        
        print("\n" + "="*60)
        print("üìä TOTALES CALCULADOS:")
        print(f"   Bs.: {total_bs}")
        print(f"   USD: {total_usd}")
        print(f"   EUR: {total_eur}")
        print(f"   IGTF: {igtf_total}")
        print("="*60)
        
        return {
            'fecha_inicio': str(fecha_inicio),
            'fecha_fin': str(fecha_fin),
            'total_ventas': len(ventas),
            'total_bs': total_bs,
            'total_usd': total_usd,
            'total_eur': total_eur,
            'igtf_total': igtf_total,
            'ventas': ventas,
            'detalle': self._agrupar_por_dia(ventas)
        }
    
    def _agrupar_por_dia(self, ventas):
        """Agrupa ventas por d√≠a para reportes detallados"""
        dias = {}
        for v in ventas:
            # Obtener fecha
            if hasattr(v['fecha'], 'strftime'):
                fecha = v['fecha'].strftime('%Y-%m-%d')
            else:
                fecha = str(v['fecha'])[:10]
            
            if fecha not in dias:
                dias[fecha] = {
                    'ventas': 0,
                    'bs': 0.0,
                    'usd': 0.0,
                    'eur': 0.0
                }
            
            dias[fecha]['ventas'] += 1
            
            # Sumar seg√∫n moneda
            moneda = v.get('moneda', 'VES')
            monto_bs = v.get('monto_bs')
            monto_divisa = v.get('monto_divisa')
            
            if moneda == 'VES' and monto_bs is not None:
                dias[fecha]['bs'] += float(monto_bs)
            elif moneda == 'USD' and monto_divisa is not None:
                dias[fecha]['usd'] += float(monto_divisa)
            elif moneda == 'EUR' and monto_divisa is not None:
                dias[fecha]['eur'] += float(monto_divisa)
        
        return dias
    
    def reporte_diario(self, fecha=None):
        """Reporte de ventas del d√≠a"""
        if fecha is None:
            fecha = datetime.now().date()
        return self.obtener_ventas_por_periodo(fecha, fecha)
    
    def reporte_semanal(self, fecha=None):
        """Reporte de la √∫ltima semana"""
        if fecha is None:
            fecha = datetime.now().date()
        fecha_inicio = fecha - timedelta(days=7)
        return self.obtener_ventas_por_periodo(fecha_inicio, fecha)
    
    def reporte_mensual(self, fecha=None):
        """Reporte del √∫ltimo mes"""
        if fecha is None:
            fecha = datetime.now().date()
        fecha_inicio = fecha - timedelta(days=30)
        return self.obtener_ventas_por_periodo(fecha_inicio, fecha)
    
    def reporte_trimestral(self, fecha=None):
        """Reporte del √∫ltimo trimestre"""
        if fecha is None:
            fecha = datetime.now().date()
        fecha_inicio = fecha - timedelta(days=90)
        return self.obtener_ventas_por_periodo(fecha_inicio, fecha)
    
    def reporte_anual(self, fecha=None):
        """Reporte del √∫ltimo a√±o"""
        if fecha is None:
            fecha = datetime.now().date()
        fecha_inicio = fecha - timedelta(days=365)
        return self.obtener_ventas_por_periodo(fecha_inicio, fecha)
    
    def exportar_a_csv(self, datos_reporte, nombre_archivo=None):
        """
        Exporta reporte a CSV para usar en Excel/contabilidad
        """
        if nombre_archivo is None:
            fecha = datetime.now().strftime("%Y%m%d_%H%M%S")
            nombre_archivo = f"reporte_ventas_{fecha}.csv"
        
        # Asegurar directorio de reportes
        os.makedirs("reportes", exist_ok=True)
        ruta_completa = os.path.join("reportes", nombre_archivo)
        
        with open(ruta_completa, 'w', newline='', encoding='utf-8') as csvfile:
            writer = csv.writer(csvfile)
            
            # Encabezados contables
            writer.writerow(['REPORTE CONTABLE DE VENTAS'])
            writer.writerow([f'Per√≠odo: {datos_reporte["fecha_inicio"]} al {datos_reporte["fecha_fin"]}'])
            writer.writerow([])
            
            # Totales
            writer.writerow(['RESUMEN GENERAL'])
            writer.writerow(['Total Ventas', datos_reporte['total_ventas']])
            writer.writerow(['Total Bs.', f"{datos_reporte['total_bs']:.2f}"])
            writer.writerow(['Total USD', f"{datos_reporte['total_usd']:.2f}"])
            writer.writerow(['Total EUR', f"{datos_reporte['total_eur']:.2f}"])
            writer.writerow(['IGTF Total', f"{datos_reporte['igtf_total']:.2f}"])
            writer.writerow([])
            
            # Detalle por d√≠a
            writer.writerow(['DETALLE POR D√çA'])
            writer.writerow(['Fecha', 'Ventas', 'Bs.', 'USD', 'EUR'])
            
            for fecha, datos in sorted(datos_reporte['detalle'].items()):
                writer.writerow([
                    fecha,
                    datos['ventas'],
                    f"{datos['bs']:.2f}",
                    f"{datos['usd']:.2f}",
                    f"{datos['eur']:.2f}"
                ])
        
        logger.info(f"‚úÖ Reporte exportado: {ruta_completa}")
        return ruta_completa

----- capa_negocio/rol_service.py -----
from typing import List, Dict, Optional, Set
from loguru import logger
from capa_negocio.base_service import BaseService

class PermisoDenegadoError(Exception):
    """Excepci√≥n para cuando un usuario no tiene permiso"""
    pass

class RolService(BaseService):
    """Servicio para gesti√≥n de roles y permisos"""
    
    def __init__(self, repositorio):
        self.repositorio = repositorio
        self.permisos_usuario_actual: Set[str] = set()
    
    def cargar_permisos_usuario(self, idrol: int):
        """Carga los permisos del rol del usuario actual"""
        if idrol:
            self.permisos_usuario_actual = set(self.repositorio.obtener_permisos_rol(idrol))
            logger.info(f"‚úÖ Permisos cargados para rol {idrol}: {len(self.permisos_usuario_actual)} permisos")
        else:
            self.permisos_usuario_actual = set()
    
    def tiene_permiso(self, permiso: str) -> bool:
        """Verifica si el usuario actual tiene un permiso espec√≠fico"""
        return permiso in self.permisos_usuario_actual
    
    def verificar_permiso(self, permiso: str):
        """Verifica permiso o lanza excepci√≥n"""
        if not self.tiene_permiso(permiso):
            logger.warning(f"‚ö†Ô∏è Permiso denegado: {permiso}")
            raise PermisoDenegadoError(f"No tiene permiso para: {permiso}")
    
    def listar_roles(self) -> List[Dict]:
        """Lista roles disponibles"""
        return self.repositorio.listar_roles()
    
    def obtener_rol(self, idrol: int) -> Optional[Dict]:
        """Obtiene un rol por su ID"""
        try:
            return self.repositorio.obtener_rol(idrol)
        except Exception as e:
            logger.error(f"‚ùå Error al obtener rol {idrol}: {e}")
            return None
    
    def listar_permisos_por_modulo(self) -> Dict[str, List[Dict]]:
        """Lista permisos agrupados por m√≥dulo"""
        todos = self.repositorio.listar_permisos()
        por_modulo = {}
        for permiso in todos:
            modulo = permiso['modulo']
            if modulo not in por_modulo:
                por_modulo[modulo] = []
            por_modulo[modulo].append(permiso)
        return por_modulo
    
    def obtener_permisos_rol(self, idrol: int) -> List[str]:
        """Obtiene permisos de un rol"""
        return self.repositorio.obtener_permisos_rol(idrol)
    
    def asignar_permisos_rol(self, idrol: int, permisos: List[int]) -> bool:
        """Asigna permisos a un rol (requiere permiso de administrador)"""
        self.verificar_permiso('usuarios_asignar_roles')
        return self.repositorio.asignar_permisos_rol(idrol, permisos)
    
    def asignar_rol_trabajador(self, idtrabajador: int, idrol: int) -> bool:
        """Asigna rol a trabajador (requiere permiso de administrador)"""
        self.verificar_permiso('usuarios_editar')
        return self.repositorio.asignar_rol_trabajador(idtrabajador, idrol)
    
    def crear_rol(self, nombre: str, descripcion: str = None, nivel: int = 1) -> Optional[int]:
        """Crea un nuevo rol (requiere permiso de administrador)"""
        self.verificar_permiso('usuarios_crear')
        return self.repositorio.crear_rol(nombre, descripcion, nivel)
    
    def get_permisos_usuario(self) -> Set[str]:
        """Retorna los permisos del usuario actual"""
        return self.permisos_usuario_actual

----- capa_negocio/tasa_service.py -----
"""
Servicio para gesti√≥n de tasas de cambio - VERSI√ìN MANUAL (ESCALABLE)
"""
from datetime import datetime, date
from loguru import logger
from capa_negocio.base_service import BaseService

class TasaService(BaseService):
    """Servicio para manejar tasas de cambio (d√≥lar, euro)"""
    
    MONEDAS_SOPORTADAS = ['USD', 'EUR']
    
    # Colores para la consola
    COLOR_AMARILLO = '\033[93m'
    COLOR_VERDE = '\033[92m'
    COLOR_ROJO = '\033[91m'
    COLOR_RESET = '\033[0m'
    
    def __init__(self, repositorio_tasa):
        """
        Inicializa el servicio de tasas
        
        Args:
            repositorio_tasa: Repositorio para acceso a BD
        """
        super().__init__()
        self.repo = repositorio_tasa
        self.modo_automatico = False  # Por ahora manual
        logger.info("‚úÖ TasaService inicializado en modo MANUAL")
    
    def obtener_tasa_del_dia(self, moneda='USD'):
        """
        Obtiene la √∫ltima tasa registrada para una moneda
        
        Args:
            moneda: USD, EUR
            
        Returns:
            float: Tasa de cambio o None si no existe
        """
        try:
            tasa = self.repo.obtener_ultima_tasa(moneda)
            if tasa:
                logger.info(f"üí± Tasa {moneda}: {tasa:.2f} (de BD)")
                return tasa
            else:
                logger.warning(f"No hay tasa registrada para {moneda}")
                return None
        except Exception as e:
            logger.error(f"Error obteniendo tasa: {e}")
            return None
    
    def registrar_tasa_manual(self, moneda, tasa, usuario):
        """
        Registra una tasa ingresada manualmente por el usuario
        
        Args:
            moneda: USD, EUR
            tasa: Valor de la tasa
            usuario: Nombre del usuario que registra
            
        Returns:
            bool: True si se registr√≥ correctamente
        """
        try:
            if not self.validar_decimal_positivo(tasa, "Tasa"):
                return False
            
            if moneda not in self.MONEDAS_SOPORTADAS:
                logger.error(f"Moneda no soportada: {moneda}")
                return False
            
            # Fuente manual tiene ID 1
            idfuente = 1
            
            resultado = self.repo.insertar_tasa(
                idfuente=idfuente,
                moneda_origen=moneda,
                tasa=tasa,
                usuario=usuario,
                observaciones="Ingreso manual"
            )
            
            if resultado:
                logger.info(f"‚úÖ Tasa {moneda} registrada: {tasa:.2f} por {usuario}")
                return True
            return False
            
        except Exception as e:
            logger.error(f"Error registrando tasa manual: {e}")
            return False
    
    def obtener_tasa_para_venta(self, moneda='USD', usuario=None):
        """
        Obtiene la tasa actual, solicitando al usuario si es necesario
        
        Args:
            moneda: USD, EUR
            usuario: Usuario actual (para registro)
            
        Returns:
            float: Tasa a usar o None si se cancela
        """
        # Modo MANUAL: preguntar siempre
        print(f"\n{self.COLOR_AMARILLO}üí± CONFIGURACI√ìN DE TASA DE CAMBIO{self.COLOR_RESET}")
        print("=" * 50)
        
        # Intentar obtener √∫ltima tasa como referencia
        tasa_anterior = self.obtener_tasa_del_dia(moneda)
        if tasa_anterior:
            print(f"üìä √öltima tasa registrada: 1 {moneda} = {tasa_anterior:.2f} VES")
            print(f"   Fecha: {date.today().strftime('%d/%m/%Y')}")
        else:
            print(f"üìä No hay tasa previa registrada para {moneda}")
        
        print("\nIngrese la tasa de cambio del d√≠a de HOY:")
        
        while True:
            try:
                tasa_input = input(f"üíµ 1 {moneda} = Bs. ").strip()
                if not tasa_input:
                    print(f"{self.COLOR_ROJO}‚ùå Operaci√≥n cancelada{self.COLOR_RESET}")
                    return None
                
                tasa = float(tasa_input.replace(',', '.'))
                if tasa <= 0:
                    print(f"{self.COLOR_ROJO}‚ùå La tasa debe ser positiva{self.COLOR_RESET}")
                    continue
                
                # Confirmar
                print(f"\n‚úÖ Tasa ingresada: 1 {moneda} = {tasa:.2f} VES")
                confirmar = input(f"{self.COLOR_AMARILLO}¬øConfirmar? (s/N): {self.COLOR_RESET}").lower()
                
                if confirmar == 's':
                    # Registrar en BD
                    if usuario:
                        self.registrar_tasa_manual(moneda, tasa, usuario)
                    return tasa
                else:
                    print("Por favor, ingrese la tasa correcta:")
                    
            except ValueError:
                print(f"{self.COLOR_ROJO}‚ùå Ingrese un n√∫mero v√°lido (ej: 60.50){self.COLOR_RESET}")
    
    def mostrar_historial(self, moneda='USD', dias=7):
        """
        Muestra el historial reciente de tasas
        
        Args:
            moneda: USD, EUR
            dias: N√∫mero de d√≠as a mostrar
        """
        historial = self.repo.obtener_historial(moneda, dias)
        
        if not historial:
            print(f"üì≠ No hay historial para {moneda}")
            return
        
        print(f"\nüìä HISTORIAL DE TASAS {moneda} (√∫ltimos {dias} d√≠as)")
        print("-" * 60)
        print(f"{'FECHA':<12} {'TASA':<10} {'FUENTE':<15} {'USUARIO':<15}")
        print("-" * 60)
        
        for h in historial:
            fecha = h['fecha'].strftime('%d/%m/%Y') if hasattr(h['fecha'], 'strftime') else h['fecha']
            print(f"{fecha:<12} {h['tasa']:<10.2f} {h['fuente']:<15} {h['usuario_registro'] or '':<15}")
    
    # ========== M√âTODOS PARA FUTURAS MEJORAS AUTOM√ÅTICAS ==========
    
    def activar_modo_automatico(self):
        """Activa el modo autom√°tico (para futuro)"""
        self.modo_automatico = True
        logger.info("ü§ñ Modo autom√°tico activado")
    
    def consultar_api_bcv(self):
        """
        M√âTODO PARA FUTURO: Consulta API del BCV
        """
        # Aqu√≠ ir√° la l√≥gica para consultar APIs
        pass

----- capa_negocio/token_service.py -----
from datetime import datetime, timedelta
import secrets
import hashlib
from loguru import logger

class TokenService:
    """Servicio para gestionar tokens de recuperaci√≥n"""
    
    def __init__(self, conexion):
        self.conexion = conexion
        self.cursor = conexion.cursor()
    
    def generar_token(self):
        """Genera un token criptogr√°ficamente seguro"""
        return secrets.token_urlsafe(32)  # Ej: "x7q9p3m2k1j5h8g4f6d3s9a2w5e7r8t9"
    
    def crear_token(self, idtrabajador):
        """Crea un token √∫nico y lo guarda en BD"""
        try:
            # Generar token seguro
            token_raw = self.generar_token()
            
            # Crear hash del token para almacenar (por seguridad)
            token_hash = hashlib.sha256(token_raw.encode()).hexdigest()
            
            # Fecha de expiraci√≥n (30 minutos)
            expires_at = datetime.now() + timedelta(minutes=30)
            
            # Guardar en BD
            self.cursor.execute("""
                INSERT INTO reset_tokens (idtrabajador, token, expires_at)
                VALUES (?, ?, ?)
            """, (idtrabajador, token_hash, expires_at))
            self.cursor.commit()
            
            logger.info(f"‚úÖ Token creado para trabajador {idtrabajador}")
            
            # Devolver el token original para enviar por email
            return token_raw
            
        except Exception as e:
            logger.error(f"‚ùå Error al crear token: {e}")
            return None
    
    def verificar_token(self, token_raw):
        """Verifica si un token es v√°lido y devuelve el id del trabajador"""
        try:
            # Calcular hash del token recibido
            token_hash = hashlib.sha256(token_raw.encode()).hexdigest()
            
            # Buscar token en BD
            self.cursor.execute("""
                SELECT idtrabajador, expires_at, used
                FROM reset_tokens
                WHERE token = ? AND used = 0 AND expires_at > GETDATE()
            """, (token_hash,))
            
            resultado = self.cursor.fetchone()
            if resultado:
                idtrabajador = resultado[0]
                
                # Marcar como usado (opcional - lo marcaremos despu√©s del cambio)
                # self.cursor.execute("UPDATE reset_tokens SET used = 1 WHERE token = ?", (token_hash,))
                # self.cursor.commit()
                
                logger.info(f"‚úÖ Token v√°lido para trabajador {idtrabajador}")
                return idtrabajador
            
            logger.warning("‚ö†Ô∏è Token inv√°lido o expirado")
            return None
            
        except Exception as e:
            logger.error(f"‚ùå Error al verificar token: {e}")
            return None
    
    def marcar_token_usado(self, token_raw):
        """Marca un token como usado despu√©s de cambiar la contrase√±a"""
        try:
            token_hash = hashlib.sha256(token_raw.encode()).hexdigest()
            self.cursor.execute("UPDATE reset_tokens SET used = 1 WHERE token = ?", (token_hash,))
            self.cursor.commit()
            return True
        except Exception as e:
            logger.error(f"‚ùå Error al marcar token como usado: {e}")
            return False
    
    def limpiar_tokens_expirados(self):
        """Elimina tokens expirados de la BD"""
        try:
            self.cursor.execute("DELETE FROM reset_tokens WHERE expires_at < GETDATE()")
            self.cursor.commit()
            logger.info("üßπ Tokens expirados eliminados")
            return True
        except Exception as e:
            logger.error(f"‚ùå Error al limpiar tokens: {e}")
            return False


----- capa_negocio/trabajador_service.py -----
from typing import List, Dict, Optional
from datetime import date
from loguru import logger
from capa_negocio.base_service import BaseService

class TrabajadorService(BaseService):
    """Servicio de trabajadores con autenticaci√≥n y roles"""
    
    def __init__(self, repositorio):
        self.repositorio = repositorio
        self.usuario_actual = None
        self.rol_service = None  # Se asignar√° desde el men√∫ principal
    
    def listar(self) -> List[Dict]:
        """Lista todos los trabajadores"""
        try:
            return self.repositorio.listar()
        except Exception as e:
            logger.error(f"‚ùå Error al listar trabajadores: {e}")
            return []
    
    def obtener_por_id(self, idtrabajador: int) -> Optional[Dict]:
        """Obtiene un trabajador por ID"""
        if not self.validar_entero_positivo(idtrabajador, "ID de trabajador"):
            return None
        return self.repositorio.obtener_por_id(idtrabajador)
    
    def login(self, usuario: str, password: str) -> bool:
        """Autentica un trabajador por usuario y contrase√±a (compatibilidad)"""
        if not usuario or not password:
            logger.warning("‚ö†Ô∏è Usuario y contrase√±a requeridos")
            return False
        
        trabajador = self.repositorio.autenticar(usuario, password)
        if trabajador:
            # Obtener rol del trabajador
            trabajador_completo = self.repositorio.obtener_por_id(trabajador['idtrabajador'])
            trabajador['idrol'] = trabajador_completo.get('idrol')
            
            self.usuario_actual = trabajador
            logger.success(f"‚úÖ Bienvenido {trabajador['nombre']} {trabajador['apellidos']}")
            
            # Cargar permisos si hay servicio de roles disponible
            if self.rol_service and trabajador['idrol']:
                self.rol_service.cargar_permisos_usuario(trabajador['idrol'])
                permisos = len(self.rol_service.get_permisos_usuario())
                logger.info(f"üîë Permisos cargados: {permisos} permisos")
            
            return True
        else:
            logger.warning("‚ùå Usuario o contrase√±a incorrectos")
            return False
    
    def login_por_email(self, email: str, password: str) -> bool:
        """Autentica un trabajador por email y contrase√±a"""
        if not email or not password:
            logger.warning("‚ö†Ô∏è Email y contrase√±a requeridos")
            return False
        
        trabajador = self.repositorio.autenticar_por_email(email, password)
        if trabajador:
            # Obtener rol del trabajador
            trabajador_completo = self.repositorio.obtener_por_id(trabajador['idtrabajador'])
            trabajador['idrol'] = trabajador_completo.get('idrol')
            
            self.usuario_actual = trabajador
            logger.success(f"‚úÖ Bienvenido {trabajador['nombre']} {trabajador['apellidos']}")
            
            # Cargar permisos si hay servicio de roles disponible
            if self.rol_service and trabajador['idrol']:
                self.rol_service.cargar_permisos_usuario(trabajador['idrol'])
                permisos = len(self.rol_service.get_permisos_usuario())
                logger.info(f"üîë Permisos cargados: {permisos} permisos")
            
            return True
        else:
            logger.warning("‚ùå Email o contrase√±a incorrectos")
            return False
    
    def buscar_por_email(self, email: str) -> Optional[Dict]:
        """Busca un trabajador por su email"""
        return self.repositorio.buscar_por_email(email)
    
    def logout(self):
        """Cierra sesi√≥n del trabajador actual"""
        if self.usuario_actual:
            logger.info(f"üëã Hasta luego {self.usuario_actual['nombre']}")
            self.usuario_actual = None
            if self.rol_service:
                self.rol_service.permisos_usuario_actual = set()
    
    def get_usuario_actual(self) -> Optional[Dict]:
        """Retorna el trabajador autenticado"""
        return self.usuario_actual
    
    def crear(self, nombre: str, apellidos: str, sexo: str,
              fecha_nacimiento, num_documento: str,
              usuario: str, password: str,
              direccion: str = None, telefono: str = None,
              email: str = None) -> bool:
        """Crea un nuevo trabajador con validaciones"""
        
        # Validaciones
        if not self.validar_requerido(nombre, "nombre"):
            return False
        if not self.validar_requerido(apellidos, "apellidos"):
            return False
        if not self.validar_requerido(sexo, "sexo"):
            return False
        if not self.validar_requerido(num_documento, "documento"):
            return False
        if not self.validar_requerido(usuario, "usuario"):
            return False
        if not self.validar_requerido(password, "contrase√±a"):
            return False
        
        # Validaciones espec√≠ficas
        if sexo not in ['M', 'F', 'O']:
            logger.warning("‚ö†Ô∏è Sexo debe ser M, F u O")
            return False
        
        if len(password) < 6:
            logger.warning("‚ö†Ô∏è La contrase√±a debe tener al menos 6 caracteres")
            return False
        
        if email and not self.validar_email(email):
            return False
        
        if telefono and not self.validar_telefono(telefono):
            return False
        
        # Validar mayor√≠a de edad
        if isinstance(fecha_nacimiento, str):
            fecha_nacimiento = date.fromisoformat(fecha_nacimiento)
        
        hoy = date.today()
        edad = hoy.year - fecha_nacimiento.year - ((hoy.month, hoy.day) < (fecha_nacimiento.month, fecha_nacimiento.day))
        
        if edad < 18:
            logger.warning("‚ö†Ô∏è El trabajador debe ser mayor de edad")
            return False
        
        try:
            return self.repositorio.insertar(
                nombre.strip(), apellidos.strip(), sexo, fecha_nacimiento,
                num_documento, usuario, password, direccion, telefono, email
            )
        except Exception as e:
            logger.error(f"‚ùå Error al crear trabajador: {e}")
            return False
    
    def actualizar(self, idtrabajador: int, nombre: str, apellidos: str, sexo: str,
                   fecha_nacimiento, num_documento: str, usuario: str,
                   password: str = None, direccion: str = None,
                   telefono: str = None, email: str = None) -> bool:
        """Actualiza un trabajador existente"""
        
        if not self.validar_entero_positivo(idtrabajador, "ID de trabajador"):
            return False
        
        # Validaciones
        if not self.validar_requerido(nombre, "nombre"):
            return False
        if not self.validar_requerido(apellidos, "apellidos"):
            return False
        if not self.validar_requerido(sexo, "sexo"):
            return False
        if not self.validar_requerido(num_documento, "documento"):
            return False
        if not self.validar_requerido(usuario, "usuario"):
            return False
        
        if sexo not in ['M', 'F', 'O']:
            logger.warning("‚ö†Ô∏è Sexo debe ser M, F u O")
            return False
        
        if password and len(password) < 6:
            logger.warning("‚ö†Ô∏è La contrase√±a debe tener al menos 6 caracteres")
            return False
        
        if email and not self.validar_email(email):
            return False
        
        if telefono and not self.validar_telefono(telefono):
            return False
        
        try:
            return self.repositorio.actualizar(
                idtrabajador, nombre.strip(), apellidos.strip(), sexo, fecha_nacimiento,
                num_documento, usuario, password, direccion, telefono, email
            )
        except Exception as e:
            logger.error(f"‚ùå Error al actualizar trabajador: {e}")
            return False
    
    def eliminar(self, idtrabajador: int) -> bool:
        """Elimina un trabajador"""
        if not self.validar_entero_positivo(idtrabajador, "ID de trabajador"):
            return False
        return self.repositorio.eliminar(idtrabajador)
    
    def actualizar_password(self, email, nueva_password):
        """Actualiza la contrase√±a de un trabajador"""
        try:
            import hashlib
            password_hash = hashlib.sha256(nueva_password.encode()).hexdigest()
            cursor = self.repositorio.cursor
            cursor.execute("UPDATE trabajador SET password_hash = ? WHERE email = ?", 
                          (password_hash, email))
            cursor.commit()
            logger.success(f"‚úÖ Contrase√±a actualizada para email: {email}")
            return True
        except Exception as e:
            logger.error(f"‚ùå Error al actualizar password: {e}")
            return False


----- capa_negocio/usuario_admin_service.py -----
from typing import List, Dict, Optional
from datetime import datetime, date
from loguru import logger
from capa_negocio.base_service import BaseService

class UsuarioAdminService(BaseService):
    """Servicio para administraci√≥n de usuarios (solo para admin)"""
    
    def __init__(self, repositorio, rol_service=None):
        self.repositorio = repositorio
        self.rol_service = rol_service
    
    def listar_usuarios(self) -> List[Dict]:
        """Lista todos los usuarios"""
        try:
            return self.repositorio.listar_usuarios()
        except Exception as e:
            logger.error(f"‚ùå Error al listar usuarios: {e}")
            return []
    
    def obtener_usuario(self, idtrabajador: int) -> Optional[Dict]:
        """Obtiene un usuario por ID"""
        if not self.validar_entero_positivo(idtrabajador, "ID de usuario"):
            return None
        return self.repositorio.obtener_usuario(idtrabajador)
    
    def crear_usuario(self, nombre: str, apellidos: str, sexo: str,
                      fecha_nacimiento, num_documento: str,
                      usuario: str, password: str,
                      email: str, idrol: int,
                      direccion: str = None, telefono: str = None) -> bool:
        """Crea un nuevo usuario con validaciones"""
        
        # Validaciones b√°sicas
        if not self.validar_requerido(nombre, "nombre"):
            return False
        if not self.validar_requerido(apellidos, "apellidos"):
            return False
        if not self.validar_requerido(usuario, "usuario"):
            return False
        if not self.validar_requerido(password, "contrase√±a"):
            return False
        if not self.validar_requerido(email, "email"):
            return False
        if not self.validar_requerido(num_documento, "documento"):
            return False
        if not self.validar_entero_positivo(idrol, "rol"):
            return False
        
        # Validaciones espec√≠ficas
        if len(password) < 6:
            logger.warning("‚ö†Ô∏è La contrase√±a debe tener al menos 6 caracteres")
            return False
        
        if not self.validar_email(email):
            return False
        
        if telefono and not self.validar_telefono(telefono):
            return False
        
        if sexo and sexo not in ['M', 'F', 'O']:
            logger.warning("‚ö†Ô∏è Sexo debe ser M, F u O")
            return False
        
        # Validar que no exista usuario con mismo username o email
        if self.repositorio.verificar_usuario_existe(usuario, email):
            logger.warning("‚ö†Ô∏è Ya existe un usuario con ese nombre de usuario o email")
            return False
        
        # Validar fecha de nacimiento (mayor de edad)
        if isinstance(fecha_nacimiento, str):
            fecha_nacimiento = datetime.strptime(fecha_nacimiento, '%Y-%m-%d').date()
        
        hoy = date.today()
        edad = hoy.year - fecha_nacimiento.year - ((hoy.month, hoy.day) < (fecha_nacimiento.month, fecha_nacimiento.day))
        
        if edad < 18:
            logger.warning("‚ö†Ô∏è El usuario debe ser mayor de edad")
            return False
        
        # Verificar que el rol existe
        if self.rol_service:
            rol = self.rol_service.obtener_rol(idrol)
            if not rol:
                logger.warning(f"‚ö†Ô∏è El rol {idrol} no existe")
                return False
        
        try:
            return self.repositorio.crear_usuario(
                nombre.strip(), apellidos.strip(), sexo, fecha_nacimiento,
                num_documento, usuario.strip(), password, email.strip(),
                idrol, direccion, telefono
            )
        except Exception as e:
            logger.error(f"‚ùå Error al crear usuario: {e}")
            return False
    
    def actualizar_usuario(self, idtrabajador: int, nombre: str, apellidos: str,
                           sexo: str, fecha_nacimiento, num_documento: str,
                           usuario: str, email: str, idrol: int,
                           direccion: str = None, telefono: str = None,
                           nueva_password: str = None) -> bool:
        """Actualiza un usuario existente"""
        
        if not self.validar_entero_positivo(idtrabajador, "ID de usuario"):
            return False
        
        # Validaciones
        if not self.validar_requerido(nombre, "nombre"):
            return False
        if not self.validar_requerido(apellidos, "apellidos"):
            return False
        if not self.validar_requerido(usuario, "usuario"):
            return False
        if not self.validar_requerido(email, "email"):
            return False
        if not self.validar_entero_positivo(idrol, "rol"):
            return False
        
        if not self.validar_email(email):
            return False
        
        if telefono and not self.validar_telefono(telefono):
            return False
        
        if sexo and sexo not in ['M', 'F', 'O']:
            logger.warning("‚ö†Ô∏è Sexo debe ser M, F u O")
            return False
        
        if nueva_password and len(nueva_password) < 6:
            logger.warning("‚ö†Ô∏è La nueva contrase√±a debe tener al menos 6 caracteres")
            return False
        
        try:
            return self.repositorio.actualizar_usuario(
                idtrabajador, nombre.strip(), apellidos.strip(), sexo, fecha_nacimiento,
                num_documento, usuario.strip(), email.strip(), idrol,
                direccion, telefono, nueva_password
            )
        except Exception as e:
            logger.error(f"‚ùå Error al actualizar usuario: {e}")
            return False
    
    def eliminar_usuario(self, idtrabajador: int) -> bool:
        """Elimina un usuario (no puede eliminarse a s√≠ mismo)"""
        # Esta validaci√≥n se har√° en el men√∫
        if not self.validar_entero_positivo(idtrabajador, "ID de usuario"):
            return False
        return self.repositorio.eliminar_usuario(idtrabajador)

----- capa_negocio/utils.py -----
"""
Utilidades para el sistema de ventas
"""
import random
import string

def generar_codigo_profesional():
    """
    Genera un c√≥digo profesional √∫nico de formato LNNNN
    Ejemplo: A3829, M7401, C2918, F4512
    
    Returns:
        str: C√≥digo de 5 caracteres (1 letra + 4 n√∫meros)
    """
    # Letra aleatoria (A-Z)
    letra = random.choice(string.ascii_uppercase)
    
    # 4 n√∫meros aleatorios
    numeros = ''.join([str(random.randint(0, 9)) for _ in range(4)])
    
    return f"{letra}{numeros}"

def generar_codigo_unico_existente(codigos_existentes):
    """
    Genera un c√≥digo √∫nico que no est√© en la lista de existentes
    
    Args:
        codigos_existentes: Lista de c√≥digos ya usados
        
    Returns:
        str: C√≥digo √∫nico
    """
    while True:
        codigo = generar_codigo_profesional()
        if codigo not in codigos_existentes:
            return codigo

----- capa_negocio/validacion_venezuela.py -----
from datetime import datetime
import re

class ValidacionVenezuela:
    """Clase con m√©todos de validaci√≥n para documentos venezolanos"""
    
    @staticmethod
    def validar_cedula(cedula):
        """
        Valida una c√©dula venezolana (formato: V12345678 o E12345678)
        Retorna: (bool, mensaje_error)
        """
        if not cedula:
            return False, "La c√©dula no puede estar vac√≠a"
        
        # Patr√≥n para c√©dula venezolana: V/E + 8 d√≠gitos
        patron = r'^[VE]\d{8}$'
        if not re.match(patron, cedula):
            return False, "Formato inv√°lido. Debe ser V/E seguido de 8 d√≠gitos (ej: V12345678)"
        
        return True, ""
    
    @staticmethod
    def validar_rif(rif):
        """
        Valida un RIF venezolano (formato: J123456789, G123456789, etc)
        Retorna: (bool, mensaje_error)
        """
        if not rif:
            return False, "El RIF no puede estar vac√≠o"
        
        # Patr√≥n para RIF: letra + 9 d√≠gitos
        patron = r'^[JPGVE]\d{9}$'
        if not re.match(patron, rif):
            return False, "Formato inv√°lido. Debe ser letra (J,P,G,V,E) seguida de 9 d√≠gitos"
        
        return True, ""
    
    @staticmethod
    def validar_fecha(fecha_str):
        """
        Valida una fecha en formato DD/MM/YYYY
        Retorna: (bool, datetime or None, mensaje_error)
        """
        if not fecha_str or fecha_str.strip() == "":
            return True, None, ""  # Fecha vac√≠a es v√°lida (opcional)
        
        # Limpiar la fecha (quitar espacios)
        fecha_str = fecha_str.strip()
        
        # Patr√≥n para DD/MM/YYYY
        patron = r'^(\d{1,2})/(\d{1,2})/(\d{4})$'
        match = re.match(patron, fecha_str)
        
        if not match:
            return False, None, "‚ùå Formato incorrecto. Use DD/MM/YYYY (ej: 15/05/1990)"
        
        dia, mes, a√±o = map(int, match.groups())
        
        # Validar rangos b√°sicos
        if mes < 1 or mes > 12:
            return False, None, "‚ùå Mes inv√°lido (debe ser entre 01 y 12)"
        
        # D√≠as por mes
        dias_por_mes = {
            1: 31, 2: 29, 3: 31, 4: 30, 5: 31, 6: 30,
            7: 31, 8: 31, 9: 30, 10: 31, 11: 30, 12: 31
        }
        
        if dia < 1 or dia > dias_por_mes[mes]:
            return False, None, f"‚ùå D√≠a inv√°lido para el mes {mes:02d} (m√°ximo {dias_por_mes[mes]} d√≠as)"
        
        # Validaci√≥n especial para febrero en a√±os bisiestos
        if mes == 2 and dia == 29:
            if not ValidacionVenezuela._es_bisiesto(a√±o):
                return False, None, f"‚ùå El a√±o {a√±o} no es bisiesto, febrero solo tiene 28 d√≠as"
        
        # Validar que no sea fecha futura
        try:
            fecha_obj = datetime(a√±o, mes, dia)
            hoy = datetime.now()
            
            if fecha_obj > hoy:
                return False, None, "‚ùå La fecha no puede ser futura"
            
        except ValueError:
            return False, None, "‚ùå Fecha inv√°lida (ej: 31/11/2023 no existe)"
        
        return True, fecha_obj, ""
    
    @staticmethod
    def _es_bisiesto(a√±o):
        """Determina si un a√±o es bisiesto"""
        return (a√±o % 4 == 0 and a√±o % 100 != 0) or (a√±o % 400 == 0)
    
    @staticmethod
    def formatear_fecha_para_bd(fecha_obj):
        """Convierte un objeto datetime a string YYYY-MM-DD para BD"""
        if fecha_obj:
            return fecha_obj.strftime('%Y-%m-%d')
        return None
    
    @staticmethod
    def validar_telefono(telefono):
        """
        Valida un tel√©fono venezolano
        Acepta: 04141234567, 0414-1234567, +584141234567, etc
        """
        if not telefono:
            return True  # Tel√©fono opcional
        
        # Limpiar el tel√©fono (quitar +, -, espacios)
        telefono_limpio = re.sub(r'[\+\-\s]', '', telefono)
        
        # Verificar que sea solo n√∫meros y tenga entre 10 y 12 d√≠gitos
        if not telefono_limpio.isdigit():
            return False
        
        if len(telefono_limpio) < 10 or len(telefono_limpio) > 12:
            return False
        
        return True
    
    @staticmethod
    def validar_email(email):
        """
        Valida un email
        """
        if not email:
            return True  # Email opcional
        
        patron = r'^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$'
        return re.match(patron, email) is not None

----- capa_negocio/venta_service.py -----
"""
Servicio para la gesti√≥n de ventas - VERSI√ìN CON MULTIMONEDA Y TASAS DE CAMBIO
"""
from loguru import logger
from capa_negocio.base_service import BaseService
from capa_negocio.moneda_service import IGTFService
from capa_negocio.tasa_service import TasaService

class VentaService(BaseService):
    """Servicio que implementa la l√≥gica de negocio para ventas con soporte multimoneda"""
    
    def __init__(self, repositorio, cliente_service, trabajador_service, inventario_service, tasa_repo=None):
        """
        Inicializa el servicio de ventas
        
        Args:
            repositorio: Instancia de VentaRepositorio
            cliente_service: Servicio de clientes
            trabajador_service: Servicio de trabajadores
            inventario_service: Servicio de inventario
            tasa_repo: Repositorio de tasas (opcional, para multimoneda)
        """
        super().__init__()
        self.repositorio = repositorio
        self.cliente_service = cliente_service
        self.trabajador_service = trabajador_service
        self.inventario_service = inventario_service
        
        # Inicializar servicio de tasas si se proporciona el repositorio
        if tasa_repo:
            self.tasa_service = TasaService(tasa_repo)
            logger.info("‚úÖ Servicio de tasas inicializado")
        else:
            self.tasa_service = None
            logger.warning("‚ö†Ô∏è Servicio de tasas no disponible - solo moneda VES")
        
        logger.info("‚úÖ VentaService inicializado")
    
    def listar(self):
        """
        Lista todas las ventas
        
        Returns:
            list: Lista de ventas o lista vac√≠a si hay error
        """
        try:
            return self.repositorio.listar()
        except Exception as e:
            logger.error(f"Error al listar ventas: {e}")
            return []
    
    def obtener_por_id(self, idventa):
        """
        Obtiene una venta por su ID con todos los detalles
        
        Args:
            idventa (int): ID de la venta
            
        Returns:
            dict: Datos de la venta o None si no existe
        """
        try:
            if not self.validar_entero_positivo(idventa, "ID de venta"):
                return None
            
            venta = self.repositorio.obtener_por_id(idventa)
            if not venta:
                logger.warning(f"Venta {idventa} no encontrada")
                return None
            
            detalles = self.repositorio.obtener_detalles(idventa)
            venta['detalle'] = detalles
            return venta
            
        except Exception as e:
            logger.error(f"Error al obtener venta {idventa}: {e}")
            return None
    
    def registrar(self, idtrabajador, idcliente, tipo_comprobante, 
                  serie, numero_comprobante, igv, detalle,
                  moneda='VES', moneda_pago=None, tasa_cambio=None):
        """
        Registra una nueva venta con soporte multimoneda
        
        Args:
            idtrabajador (int): ID del trabajador que realiza la venta
            idcliente (int or None): ID del cliente (puede ser None para consumidor final)
            tipo_comprobante (str): FACTURA, BOLETA, TICKET
            serie (str): Serie del comprobante
            numero_comprobante (str): N√∫mero del comprobante
            igv (float): Porcentaje de IGV
            detalle (list): Lista de items de la venta
            moneda (str): Moneda de la factura (VES, USD, EUR)
            moneda_pago (str): Moneda con que paga el cliente (si es diferente)
            tasa_cambio (float): Tasa de cambio (si viene, se usa; si no, se pide)
            
        Returns:
            int or None: ID de la venta creada o None si hay error
        """
        try:
            # Validar campos obligatorios
            if not self.validar_entero_positivo(idtrabajador, "ID del trabajador"):
                logger.error("ID del trabajador inv√°lido")
                return None
            
            # Para consumidor final, idcliente puede ser None
            if idcliente is not None:
                if not self.validar_entero_positivo(idcliente, "ID del cliente"):
                    return None
                
                # Verificar que el cliente existe
                cliente = self.cliente_service.obtener_por_id(idcliente)
                if not cliente:
                    logger.error(f"Cliente {idcliente} no encontrado")
                    return None
            
            # Validar tipo de comprobante
            tipos_validos = ['FACTURA', 'BOLETA', 'TICKET']
            if tipo_comprobante not in tipos_validos:
                logger.error(f"Tipo de comprobante inv√°lido: {tipo_comprobante}")
                return None
            
            # Validar serie y n√∫mero
            if not serie or not serie.strip():
                logger.error("La serie del comprobante es obligatoria")
                return None
            
            if not numero_comprobante or not numero_comprobante.strip():
                logger.error("El n√∫mero del comprobante es obligatorio")
                return None
            
            # Validar IGV
            if not self.validar_decimal_positivo(igv, "IGV"):
                return None
            
            # Validar detalle
            if not detalle or len(detalle) == 0:
                logger.error("La venta debe tener al menos un producto")
                return None
            
            # ===== GESTI√ìN DE TASA DE CAMBIO =====
            tasa_final = tasa_cambio
            usuario_nombre = None
            
            # Obtener nombre del usuario para registro
            usuario_actual = self.trabajador_service.get_usuario_actual()
            if usuario_actual:
                usuario_nombre = f"{usuario_actual['nombre']} {usuario_actual['apellidos']}"
            
            # Si la venta es en USD o el pago es en USD, necesitamos la tasa
            if moneda in ['USD', 'EUR'] or moneda_pago in ['USD', 'EUR']:
                # Si no nos pasaron la tasa, la pedimos al usuario
                if tasa_final is None:
                    if self.tasa_service is None:
                        logger.error("No hay servicio de tasas disponible")
                        return None
                    
                    # Determinar qu√© moneda preguntar
                    moneda_tasa = moneda if moneda != 'VES' else moneda_pago
                    
                    tasa_final = self.tasa_service.obtener_tasa_para_venta(
                        moneda=moneda_tasa,
                        usuario=usuario_nombre
                    )
                    
                    if tasa_final is None:
                        logger.info("Venta cancelada por el usuario")
                        return None
                
                logger.info(f"üí± Tasa de cambio aplicada: 1 USD = {tasa_final:.2f} VES")
            else:
                tasa_final = 1.0  # Tasa por defecto para VES
            
            # ===== C√ÅLCULO DE MONTOS =====
            # Calcular subtotal y total
            subtotal = sum(item['cantidad'] * item['precio_venta'] for item in detalle)
            iva_total = subtotal * (igv / 100)
            total = subtotal + iva_total
            
            # Calcular montos por moneda
            monto_bs = None
            monto_divisa = None
            
            if moneda == 'VES':
                monto_bs = total
                if moneda_pago == 'USD':
                    monto_divisa = total / tasa_final
                    logger.info(f"   Pago en USD: ${monto_divisa:.2f} (tasa {tasa_final:.2f})")
            else:  # USD u otra divisa
                monto_divisa = total
                monto_bs = total * tasa_final
                logger.info(f"   Equivalente en Bs.: Bs. {monto_bs:.2f} (tasa {tasa_final:.2f})")
            
            # Calcular IGTF si aplica (3% para pagos en divisas)
            igtf = IGTFService.calcular_igtf(
                monto=total,
                moneda_pago=moneda_pago or moneda,
                moneda_transaccion=moneda
            )
            if igtf > 0:
                logger.info(f"üí∞ IGTF (3%): {igtf:.2f}")
            
            # ===== VALIDAR STOCK =====
            logger.info("üîç Verificando stock disponible...")
            for idx, item in enumerate(detalle, 1):
                # Validar que cada item tenga los campos requeridos
                if 'idarticulo' not in item:
                    logger.error(f"Item {idx} de venta sin ID de art√≠culo")
                    return None
                
                if 'cantidad' not in item:
                    logger.error(f"Item {idx} de venta sin cantidad")
                    return None
                
                if 'precio_venta' not in item:
                    logger.error(f"Item {idx} de venta sin precio")
                    return None
                
                # Validar que cantidad sea entero positivo
                if not self.validar_entero_positivo(item['cantidad'], f"Cantidad del item {idx}"):
                    return None
                
                # Validar que precio sea positivo
                if not self.validar_decimal_positivo(item['precio_venta'], f"Precio del item {idx}"):
                    return None
                
                # Verificar stock usando inventario_service
                try:
                    stock_actual = self.inventario_service.obtener_stock_articulo(item['idarticulo'])
                    logger.info(f"   Art√≠culo ID {item['idarticulo']}: Stock disponible {stock_actual}, Solicitado {item['cantidad']}")
                    
                    if item['cantidad'] > stock_actual:
                        logger.error(f"‚ùå Stock insuficiente para art√≠culo ID {item['idarticulo']}. "
                                   f"Disponible: {stock_actual}, Solicitado: {item['cantidad']}")
                        return None
                except AttributeError as e:
                    logger.error(f"ERROR: inventario_service no tiene el m√©todo obtener_stock_articulo")
                    logger.error(f"   - Tipo de inventario_service: {type(self.inventario_service).__name__}")
                    return None
            
            # Validar que el trabajador existe
            trabajador = self.trabajador_service.obtener_por_id(idtrabajador)
            if not trabajador:
                logger.error(f"Trabajador ID {idtrabajador} no encontrado")
                return None
            
            # ===== REGISTRAR VENTA =====
            logger.info("üìù Registrando venta en base de datos...")
            idventa = self.repositorio.crear(
                idtrabajador=idtrabajador,
                idcliente=idcliente,
                tipo_comprobante=tipo_comprobante,
                serie=serie,
                numero_comprobante=numero_comprobante,
                igv=igv,
                estado='REGISTRADO',
                moneda=moneda,
                tasa_cambio=tasa_final,
                monto_bs=monto_bs,
                monto_divisa=monto_divisa
            )
            
            if not idventa:
                logger.error("No se pudo crear la venta en la base de datos")
                return None
            
            logger.info(f"‚úÖ Venta #{idventa} creada en BD")
            
            # ===== REGISTRAR DETALLE Y DESCONTAR STOCK =====
            for item in detalle:
                # Agregar detalle a la venta
                detalle_id = self.repositorio.agregar_detalle(
                    idventa=idventa,
                    idarticulo=item['idarticulo'],
                    cantidad=item['cantidad'],
                    precio_venta=item['precio_venta']
                )
                
                if not detalle_id:
                    logger.error(f"Error al agregar detalle para art√≠culo {item['idarticulo']}")
                    continue
                
                logger.info(f"   ‚úÖ Detalle agregado: {item['cantidad']} x {item['precio_venta']:.2f}")
                
                # Actualizar stock usando inventario_service
                self.inventario_service.descontar_stock(
                    idarticulo=item['idarticulo'],
                    cantidad=item['cantidad'],
                    idventa=idventa,
                    precio_unitario=item['precio_venta']
                )
            
            # ===== RESUMEN FINAL =====
            tipo_cliente = "CONSUMIDOR FINAL" if idcliente is None else "CLIENTE IDENTIFICADO"
            
            logger.info(f"‚úÖ Venta {idventa} registrada correctamente")
            logger.info(f"   Cliente: {tipo_cliente}")
            logger.info(f"   Moneda factura: {moneda}")
            
            if moneda == 'VES':
                logger.info(f"   Total: Bs. {total:.2f}")
                if moneda_pago == 'USD':
                    logger.info(f"   Pagado en USD: ${monto_divisa:.2f}")
            else:
                if moneda == 'USD':
                    logger.info(f"   Total: ${total:.2f} USD")
                elif moneda == 'EUR':
                    logger.info(f"   Total: ‚Ç¨{total:.2f} EUR")
                logger.info(f"   Equivalente: Bs. {monto_bs:.2f}")
            
            if igtf > 0:
                logger.info(f"   IGTF (3%): {igtf:.2f}")
            
            return idventa
            
        except Exception as e:
            logger.error(f"‚ùå Error al registrar venta: {e}")
            return None
    
    def anular(self, idventa):
        """
        Anula una venta (cambia estado a ANULADO) y repone stock
        
        Args:
            idventa (int): ID de la venta a anular
            
        Returns:
            bool: True si se anul√≥ correctamente, False en caso contrario
        """
        try:
            if not self.validar_entero_positivo(idventa, "ID de venta"):
                return False
            
            venta = self.obtener_por_id(idventa)
            if not venta:
                logger.error(f"Venta {idventa} no encontrada")
                return False
            
            if venta.get('estado') == 'ANULADO':
                logger.warning(f"La venta {idventa} ya est√° anulada")
                return False
            
            # Anular venta
            resultado = self.repositorio.anular(idventa)
            
            if resultado:
                logger.info(f"‚úÖ Venta {idventa} anulada correctamente")
                
                # Reponer stock
                if venta.get('detalle'):
                    logger.info("   Reponiendo stock...")
                    for item in venta['detalle']:
                        self.inventario_service.reponer_stock(
                            idarticulo=item['idarticulo'],
                            cantidad=item['cantidad'],
                            idingreso=None,
                            precio_compra=item['precio_venta']
                        )
            else:
                logger.error(f"‚ùå No se pudo anular la venta {idventa}")
            
            return resultado
            
        except Exception as e:
            logger.error(f"Error al anular venta {idventa}: {e}")
            return False
    
    def ventas_por_cliente(self, idcliente):
        """
        Obtiene todas las ventas de un cliente espec√≠fico
        
        Args:
            idcliente (int): ID del cliente
            
        Returns:
            list: Lista de ventas del cliente
        """
        try:
            if not self.validar_entero_positivo(idcliente, "ID del cliente"):
                return []
            return self.repositorio.ventas_por_cliente(idcliente)
        except Exception as e:
            logger.error(f"Error al obtener ventas del cliente {idcliente}: {e}")
            return []
    
    def ventas_por_fecha(self, fecha_inicio, fecha_fin):
        """
        Obtiene ventas en un rango de fechas
        
        Args:
            fecha_inicio: Fecha inicial
            fecha_fin: Fecha final
            
        Returns:
            list: Lista de ventas en el rango
        """
        try:
            return self.repositorio.ventas_por_fecha(fecha_inicio, fecha_fin)
        except Exception as e:
            logger.error(f"Error al obtener ventas por fecha: {e}")
            return []
    
    def total_ventas_dia(self, fecha=None):
        """
        Calcula el total de ventas de un d√≠a espec√≠fico
        
        Args:
            fecha: Fecha (si es None, usa la fecha actual)
            
        Returns:
            float: Total de ventas del d√≠a
        """
        try:
            from datetime import datetime
            if fecha is None:
                fecha = datetime.now().date()
            ventas = self.repositorio.ventas_por_fecha(fecha, fecha)
            return sum(v.get('total', 0) for v in ventas)
        except Exception as e:
            logger.error(f"Error al calcular total de ventas del d√≠a: {e}")
            return 0.0
    
    def ventas_del_dia(self):
        """
        Obtiene las ventas del d√≠a actual
        
        Returns:
            list: Lista de ventas del d√≠a
        """
        try:
            from datetime import datetime
            hoy = datetime.now().date()
            return self.ventas_por_fecha(hoy, hoy)
        except Exception as e:
            logger.error(f"Error al obtener ventas del d√≠a: {e}")
            return []
    
    def resumen_ventas(self, fecha_inicio, fecha_fin):
        """
        Genera un resumen de ventas en un per√≠odo
        
        Args:
            fecha_inicio: Fecha inicial
            fecha_fin: Fecha final
            
        Returns:
            dict: Resumen con totales y estad√≠sticas
        """
        try:
            ventas = self.ventas_por_fecha(fecha_inicio, fecha_fin)
            
            total_ventas = len(ventas)
            total_ingresos = sum(v.get('total', 0) for v in ventas)
            promedio_por_venta = total_ingresos / total_ventas if total_ventas > 0 else 0
            
            # Contar por tipo de comprobante
            por_tipo = {}
            # Resumen por moneda
            por_moneda = {'VES': 0, 'USD': 0, 'EUR': 0}
            
            for v in ventas:
                tipo = v.get('tipo_comprobante', 'OTRO')
                por_tipo[tipo] = por_tipo.get(tipo, 0) + 1
                
                moneda = v.get('moneda', 'VES')
                if moneda in por_moneda:
                    por_moneda[moneda] += v.get('total', 0)
            
            return {
                'fecha_inicio': fecha_inicio,
                'fecha_fin': fecha_fin,
                'total_ventas': total_ventas,
                'total_ingresos': total_ingresos,
                'promedio_por_venta': promedio_por_venta,
                'por_tipo': por_tipo,
                'por_moneda': por_moneda,
                'ventas': ventas
            }
            
        except Exception as e:
            logger.error(f"Error al generar resumen de ventas: {e}")
            return {}

=== CAPA DE PRESENTACI√ìN ===

----- capa_presentacion/decoradores.py -----
from functools import wraps
from loguru import logger
from capa_negocio.rol_service import PermisoDenegadoError

def requiere_permiso(permiso: str):
    """Decorador para verificar permisos en m√©todos de men√∫"""
    def decorator(func):
        @wraps(func)
        def wrapper(self, *args, **kwargs):
            try:
                # Verificar si el usuario tiene el permiso
                if hasattr(self, 'rol_service') and self.rol_service:
                    self.rol_service.verificar_permiso(permiso)
                return func(self, *args, **kwargs)
            except PermisoDenegadoError as e:
                logger.warning(f"‚õî Acceso denegado: {e}")
                print(f"\n‚õî No tiene permisos para realizar esta operaci√≥n.")
                print(f"   Permiso requerido: {permiso}")
                if hasattr(self, 'pausa'):
                    self.pausa()
                return None
        return wrapper
    return decorator

----- capa_presentacion/input_con_mascara.py -----
import sys
import tty
import termios

def leer_con_mascara(mascara):
    """
    Lee entrada del usuario aplicando una m√°scara.
    Ejemplo: leer_con_mascara("DD/MM/YYYY")
    """
    import sys
    import tty
    import termios
    
    print(f"\r{mascara}", end='', flush=True)
    
    pos = 0
    resultado = list(mascara)
    lugares = [i for i, char in enumerate(mascara) if char in ('D', 'M', 'Y')]
    
    # Guardar configuraci√≥n original de la terminal
    fd = sys.stdin.fileno()
    old_settings = termios.tcgetattr(fd)
    
    try:
        # Configurar terminal para modo raw
        tty.setraw(sys.stdin.fileno())
        
        while pos < len(lugares):
            char = sys.stdin.read(1)
            
            if ord(char) == 3:  # Ctrl+C
                raise KeyboardInterrupt
            elif ord(char) == 127 or ord(char) == 8:  # Backspace
                if pos > 0:
                    pos -= 1
                    resultado[lugares[pos]] = mascara[lugares[pos]]
                    print(f"\r{''.join(resultado)}", end='', flush=True)
            elif char.isdigit():
                if pos < len(lugares):
                    resultado[lugares[pos]] = char
                    pos += 1
                    print(f"\r{''.join(resultado)}", end='', flush=True)
    finally:
        # Restaurar configuraci√≥n original
        termios.tcsetattr(fd, termios.TCSADRAIN, old_settings)
        print()
    
    # Extraer las partes de la fecha
    partes = ''.join(resultado).split('/')
    if len(partes) == 3:
        return f"{partes[0]}/{partes[1]}/{partes[2]}"
    return ''.join(resultado)

----- capa_presentacion/menu_principal_backup.py -----
#!/usr/bin/env python3
"""
Men√∫ principal del sistema de ventas (Interfaz de consola)
"""
import os
import sys
from datetime import datetime

# A√±adir el directorio padre al path para importar m√≥dulos
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from capa_datos.conexion import ConexionDB
from capa_datos.categoria_repo import CategoriaRepositorio
from capa_datos.cliente_repo import ClienteRepositorio
from capa_datos.articulo_repo import ArticuloRepositorio
from capa_datos.proveedor_repo import ProveedorRepositorio
from capa_datos.trabajador_repo import TrabajadorRepositorio
from capa_datos.venta_repo import VentaRepositorio
from capa_datos.ingreso_repo import IngresoRepositorio
from capa_datos.lote_repo import LoteRepositorio

from capa_negocio.categoria_service import CategoriaService
from capa_negocio.cliente_service import ClienteService
from capa_negocio.articulo_service import ArticuloService
from capa_negocio.trabajador_service import TrabajadorService
from capa_negocio.venta_service import VentaService
from capa_negocio.base_service import BaseService

from loguru import logger

# Configurar logger
logger.remove()
logger.add(sys.stderr, format="<level>{level: <8}</level> | <cyan>{name}</cyan>:<cyan>{function}</cyan>:<cyan>{line}</cyan> - <level>{message}</level>")

class SistemaVentas:
    """Clase principal del sistema"""
    
    def __init__(self):
        self.db = ConexionDB()
        self.conn = None
        self.trabajador_service = None
        self.categoria_service = None
        self.cliente_service = None
        self.articulo_service = None
        self.venta_service = None
    
    def conectar_db(self):
        """Establece conexi√≥n con la base de datos"""
        self.conn = self.db.conectar()
        if not self.conn:
            print("‚ùå No se pudo conectar a la base de datos")
            return False
        
        # Inicializar repositorios
        trabajador_repo = TrabajadorRepositorio(self.conn)
        categoria_repo = CategoriaRepositorio(self.conn)
        cliente_repo = ClienteRepositorio(self.conn)
        articulo_repo = ArticuloRepositorio(self.conn)
        venta_repo = VentaRepositorio(self.conn)
        
        # Inicializar servicios
        self.trabajador_service = TrabajadorService(trabajador_repo)
        self.categoria_service = CategoriaService(categoria_repo)
        self.cliente_service = ClienteService(cliente_repo)
        self.articulo_service = ArticuloService(articulo_repo, self.categoria_service)
        self.venta_service = VentaService(
            venta_repo, 
            self.cliente_service, 
            self.trabajador_service, 
            self.articulo_service
        )
        
        return True
    
    def limpiar_pantalla(self):
        """Limpia la pantalla de la consola"""
        os.system('clear' if os.name == 'posix' else 'cls')
    
    def pausa(self):
        """Pausa la ejecuci√≥n hasta que el usuario presione Enter"""
        input("\nüîπ Presione Enter para continuar...")
    
    def mostrar_cabecera(self, titulo):
        """Muestra una cabecera formateada"""
        self.limpiar_pantalla()
        print("=" * 60)
        print(f"{titulo:^60}")
        print("=" * 60)
        print()
    
    def mostrar_menu_principal(self):
        """Muestra el men√∫ principal"""
        self.mostrar_cabecera("SISTEMA DE VENTAS - 3 CAPAS")
        
        usuario = self.trabajador_service.get_usuario_actual()
        if usuario:
            print(f"üë§ Usuario: {usuario['nombre']} {usuario['apellidos']}")
            print()
        
        print("1. Gesti√≥n de Categor√≠as")
        print("2. Gesti√≥n de Clientes")
        print("3. Gesti√≥n de Art√≠culos")
        print("4. Gesti√≥n de Ventas")
        print("5. Gesti√≥n de Ingresos")
        print("6. Reportes")
        if usuario:
            print("7. Cerrar Sesi√≥n")
        else:
            print("7. Iniciar Sesi√≥n")
        print("0. Salir")
        print()
        
        return input("üîπ Seleccione una opci√≥n: ").strip()
    
    def menu_categorias(self):
        """Men√∫ de gesti√≥n de categor√≠as"""
        while True:
            self.mostrar_cabecera("GESTI√ìN DE CATEGOR√çAS")
            print("1. Listar categor√≠as")
            print("2. Buscar categor√≠a por ID")
            print("3. Crear categor√≠a")
            print("4. Actualizar categor√≠a")
            print("5. Eliminar categor√≠a")
            print("0. Volver")
            print()
            
            opcion = input("üîπ Seleccione una opci√≥n: ").strip()
            
            if opcion == '1':
                self.listar_categorias()
            elif opcion == '2':
                self.buscar_categoria()
            elif opcion == '3':
                self.crear_categoria()
            elif opcion == '4':
                self.actualizar_categoria()
            elif opcion == '5':
                self.eliminar_categoria()
            elif opcion == '0':
                break
            else:
                print("‚ùå Opci√≥n no v√°lida")
                self.pausa()
    
    def listar_categorias(self):
        """Lista todas las categor√≠as"""
        self.mostrar_cabecera("LISTADO DE CATEGOR√çAS")
        
        categorias = self.categoria_service.listar()
        
        if not categorias:
            print("üì≠ No hay categor√≠as registradas")
        else:
            print(f"{'ID':<5} {'NOMBRE':<30} {'DESCRIPCI√ìN':<40}")
            print("-" * 75)
            for cat in categorias:
                desc = cat['descripcion'][:37] + "..." if cat['descripcion'] and len(cat['descripcion']) > 40 else cat['descripcion'] or ""
                print(f"{cat['idcategoria']:<5} {cat['nombre']:<30} {desc:<40}")
        
        self.pausa()
    
    def buscar_categoria(self):
        """Busca una categor√≠a por ID"""
        self.mostrar_cabecera("BUSCAR CATEGOR√çA")
        
        try:
            idcategoria = int(input("Ingrese ID de categor√≠a: "))
            categoria = self.categoria_service.obtener_por_id(idcategoria)
            
            if categoria:
                print(f"\nüìå ID: {categoria['idcategoria']}")
                print(f"üìå Nombre: {categoria['nombre']}")
                print(f"üìå Descripci√≥n: {categoria['descripcion'] or 'Sin descripci√≥n'}")
            else:
                print(f"‚ùå No existe categor√≠a con ID {idcategoria}")
        except ValueError:
            print("‚ùå Debe ingresar un n√∫mero v√°lido")
        
        self.pausa()
    
    def crear_categoria(self):
        """Crea una nueva categor√≠a"""
        self.mostrar_cabecera("CREAR CATEGOR√çA")
        
        nombre = input("Ingrese nombre de categor√≠a: ")
        descripcion = input("Ingrese descripci√≥n (opcional): ") or None
        
        if self.categoria_service.crear(nombre, descripcion):
            print("‚úÖ Categor√≠a creada exitosamente")
        else:
            print("‚ùå No se pudo crear la categor√≠a")
        
        self.pausa()
    
    def actualizar_categoria(self):
        """Actualiza una categor√≠a"""
        self.mostrar_cabecera("ACTUALIZAR CATEGOR√çA")
        
        try:
            idcategoria = int(input("Ingrese ID de categor√≠a a actualizar: "))
            categoria = self.categoria_service.obtener_por_id(idcategoria)
            
            if not categoria:
                print(f"‚ùå No existe categor√≠a con ID {idcategoria}")
                self.pausa()
                return
            
            print(f"\nüìå Datos actuales:")
            print(f"   Nombre: {categoria['nombre']}")
            print(f"   Descripci√≥n: {categoria['descripcion'] or 'Sin descripci√≥n'}")
            print()
            
            nombre = input("Nuevo nombre (Enter para mantener): ") or categoria['nombre']
            descripcion = input("Nueva descripci√≥n (Enter para mantener): ") or categoria['descripcion']
            
            if self.categoria_service.actualizar(idcategoria, nombre, descripcion):
                print("‚úÖ Categor√≠a actualizada exitosamente")
            else:
                print("‚ùå No se pudo actualizar la categor√≠a")
        except ValueError:
            print("‚ùå Debe ingresar un n√∫mero v√°lido")
        
        self.pausa()
    
    def eliminar_categoria(self):
        """Elimina una categor√≠a"""
        self.mostrar_cabecera("ELIMINAR CATEGOR√çA")
        
        try:
            idcategoria = int(input("Ingrese ID de categor√≠a a eliminar: "))
            
            confirmacion = input(f"¬øEst√° seguro de eliminar la categor√≠a {idcategoria}? (s/N): ")
            if confirmacion.lower() == 's':
                if self.categoria_service.eliminar(idcategoria):
                    print("‚úÖ Categor√≠a eliminada exitosamente")
                else:
                    print("‚ùå No se pudo eliminar la categor√≠a (puede tener art√≠culos asociados)")
            else:
                print("Operaci√≥n cancelada")
        except ValueError:
            print("‚ùå Debe ingresar un n√∫mero v√°lido")
        
        self.pausa()
    
    def menu_login(self):
        """Men√∫ de inicio de sesi√≥n"""
        self.mostrar_cabecera("INICIAR SESI√ìN")
        
        usuario = input("Usuario: ")
        password = input("Contrase√±a: ")
        
        if self.trabajador_service.login(usuario, password):
            print("‚úÖ Sesi√≥n iniciada correctamente")
        else:
            print("‚ùå Error al iniciar sesi√≥n")
        
        self.pausa()
    
    def menu_logout(self):
        """Cerrar sesi√≥n"""
        self.trabajador_service.logout()
        self.pausa()
    
    def run(self):
        """Ejecuta el sistema"""
        if not self.conectar_db():
            return
        
        while True:
            opcion = self.mostrar_menu_principal()
            
            if opcion == '1':
                self.menu_categorias()
            elif opcion == '2':
                print("üîß M√≥dulo de clientes en desarrollo")
                self.pausa()
            elif opcion == '3':
                print("üîß M√≥dulo de art√≠culos en desarrollo")
                self.pausa()
            elif opcion == '4':
                print("üîß M√≥dulo de ventas en desarrollo")
                self.pausa()
            elif opcion == '5':
                print("üîß M√≥dulo de ingresos en desarrollo")
                self.pausa()
            elif opcion == '6':
                print("üîß M√≥dulo de reportes en desarrollo")
                self.pausa()
            elif opcion == '7':
                if self.trabajador_service.get_usuario_actual():
                    self.menu_logout()
                else:
                    self.menu_login()
            elif opcion == '0':
                print("\nüëã ¬°Hasta luego!")
                break
            else:
                print("‚ùå Opci√≥n no v√°lida")
                self.pausa()
        
        self.db.cerrar()

if __name__ == "__main__":
    sistema = SistemaVentas()
    sistema.run()

----- capa_presentacion/menu_principal.py -----
#!/usr/bin/env python3
"""
Men√∫ principal del sistema de ventas (Interfaz de consola)
"""
import os
import sys
import readchar
from datetime import datetime

# A√±adir el directorio padre al path para importar m√≥dulos
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from capa_datos.conexion import ConexionDB
from capa_datos.categoria_repo import CategoriaRepositorio
from capa_datos.cliente_repo import ClienteRepositorio
from capa_datos.articulo_repo import ArticuloRepositorio
from capa_datos.proveedor_repo import ProveedorRepositorio
from capa_datos.trabajador_repo import TrabajadorRepositorio
from capa_datos.venta_repo import VentaRepositorio
from capa_datos.ingreso_repo import IngresoRepositorio
from capa_datos.lote_repo import LoteRepositorio
from capa_datos.rol_repo import RolRepositorio
from capa_datos.usuario_admin_repo import UsuarioAdminRepositorio
from capa_datos.proveedor_archivo_repo import ProveedorArchivoRepositorio

from capa_negocio.categoria_service import CategoriaService
from capa_negocio.cliente_service import ClienteService
from capa_negocio.articulo_service import ArticuloService
from capa_negocio.trabajador_service import TrabajadorService
from capa_negocio.venta_service import VentaService
from capa_negocio.rol_service import RolService, PermisoDenegadoError
from capa_negocio.base_service import BaseService
from capa_negocio.email_service import EmailService
from capa_negocio.usuario_admin_service import UsuarioAdminService
from capa_negocio.token_service import TokenService
from capa_negocio.proveedor_service import ProveedorService
from capa_negocio.validacion_venezuela import ValidacionVenezuela
from capa_negocio.inventario_service import InventarioService
from capa_negocio.ingreso_service import IngresoService
from capa_negocio.proveedor_archivo_service import ProveedorArchivoService
from capa_negocio.reporte_contable_service import ReporteContableService

# Importaciones para SENIAT y auditor√≠a
from capa_datos.auditoria_repo import AuditoriaRepositorio
from capa_datos.tasa_repo import TasaRepositorio
from capa_negocio.auditoria_service import AuditoriaService
from config.seniat_config import SENIAT_CONFIG, TECLAS_ATAJO, MENSAJES_LEGALES

from capa_presentacion.decoradores import requiere_permiso
from capa_presentacion.input_con_mascara import leer_con_mascara

from loguru import logger

# Configurar logger
logger.remove()
logger.add(sys.stderr, format="<level>{level: <8}</level> | <cyan>{name}</cyan>:<cyan>{function}</cyan>:<cyan>{line}</cyan> - <level>{message}</level>")

class SistemaVentas:
    """Clase principal del sistema"""
    
    # Colores para la terminal
    COLOR_ROJO = '\033[91m'
    COLOR_VERDE = '\033[92m'
    COLOR_AMARILLO = '\033[93m'
    COLOR_AZUL = '\033[94m'
    COLOR_MAGENTA = '\033[95m'
    COLOR_CYAN = '\033[96m'
    COLOR_NARANJA = '\033[38;5;208m'
    COLOR_RESET = '\033[0m'
    COLOR_NEGRITA = '\033[1m'
    
    def __init__(self):
        self.db = ConexionDB()
        self.conn = None
        self.trabajador_service = None
        self.categoria_service = None
        self.cliente_service = None
        self.articulo_service = None
        self.proveedor_service = None
        self.proveedor_archivo_service = None
        self.venta_service = None
        self.rol_service = None
        self.email_service = None
        self.usuario_admin_service = None
        self.token_service = None
        self.inventario_service = None
        self.ingreso_service = None
        self.auditoria_service = None
    
    def conectar_db(self):
        """Establece conexi√≥n con la base de datos"""
        self.conn = self.db.conectar()
        if not self.conn:
            print("‚ùå No se pudo conectar a la base de datos")
            return False
        
        # Inicializar repositorios
        trabajador_repo = TrabajadorRepositorio(self.conn)
        categoria_repo = CategoriaRepositorio(self.conn)
        cliente_repo = ClienteRepositorio(self.conn)
        articulo_repo = ArticuloRepositorio(self.conn)
        proveedor_repo = ProveedorRepositorio(self.conn)
        venta_repo = VentaRepositorio(self.conn)
        ingreso_repo = IngresoRepositorio(self.conn)
        rol_repo = RolRepositorio(self.conn)
        usuario_admin_repo = UsuarioAdminRepositorio(self.conn)
        proveedor_archivo_repo = ProveedorArchivoRepositorio(self.conn)
        
        # Inicializar repositorio de tasas
        from capa_datos.tasa_repo import TasaRepositorio
        tasa_repo = TasaRepositorio(self.conn)
        
        # Inicializar servicios base
        self.trabajador_service = TrabajadorService(trabajador_repo)
        self.categoria_service = CategoriaService(categoria_repo)
        self.cliente_service = ClienteService(cliente_repo)
        self.articulo_service = ArticuloService(articulo_repo, self.categoria_service)
        self.proveedor_service = ProveedorService(proveedor_repo)
        self.proveedor_archivo_service = ProveedorArchivoService(proveedor_archivo_repo, self.proveedor_service)
        
        # Inicializar inventario
        self.inventario_service = InventarioService(self.articulo_service)
        logger.info("‚úÖ InventarioService inicializado")
        
        # Inicializar venta con soporte de tasas
        self.venta_service = VentaService(
            venta_repo, 
            self.cliente_service, 
            self.trabajador_service, 
            self.inventario_service,
            tasa_repo=tasa_repo
        )
        logger.info("‚úÖ VentaService inicializado con soporte de tasas")
        
        self.ingreso_service = IngresoService(
            ingreso_repo, 
            self.articulo_service, 
            self.proveedor_service,
            self.trabajador_service
        )
        self.rol_service = RolService(rol_repo)
        self.usuario_admin_service = UsuarioAdminService(usuario_admin_repo, self.rol_service)
        self.token_service = TokenService(self.conn)
        
        self.trabajador_service.rol_service = self.rol_service
        
        self.email_service = EmailService(
            smtp_server="smtp.gmail.com",
            smtp_port=587,
            email_remitente="carlosberenguel554@gmail.com",
            password="fhnh tiax mfus fmok"
        )
        
        # Inicializar servicio de auditor√≠a
        from capa_datos.auditoria_repo import AuditoriaRepositorio
        from capa_negocio.auditoria_service import AuditoriaService
        auditoria_repo = AuditoriaRepositorio(self.conn)
        self.auditoria_service = AuditoriaService(auditoria_repo)
        logger.info("‚úÖ Servicio de auditor√≠a inicializado")
        
        # Inicializar servicio de reportes contables
        from capa_negocio.reporte_contable_service import ReporteContableService
        self.reporte_service = ReporteContableService(
            self.venta_service,
            self.inventario_service
        )
        logger.info("‚úÖ ReporteContableService inicializado")
        
        return True
    
    def limpiar_pantalla(self):
        """Limpia la pantalla de la consola"""
        os.system('clear' if os.name == 'posix' else 'cls')
    
    def pausa(self):
        """Pausa la ejecuci√≥n hasta que el usuario presione Enter"""
        input(f"\n{self.COLOR_AMARILLO}üîπ Presione Enter para continuar...{self.COLOR_RESET}")
    
    def obtener_tasas_actuales(self):
        """
        Obtiene las tasas de cambio actuales del sistema
        Returns:
            dict: Diccionario con tasas de USD y EUR
        """
        tasas = {'USD': None, 'EUR': None}
        
        try:
            # Intentar obtener tasas desde el servicio de ventas
            if hasattr(self, 'venta_service') and self.venta_service and hasattr(self.venta_service, 'tasa_service'):
                if self.venta_service.tasa_service:
                    tasas['USD'] = self.venta_service.tasa_service.obtener_tasa_del_dia('USD')
                    tasas['EUR'] = self.venta_service.tasa_service.obtener_tasa_del_dia('EUR')
            else:
                # Fallback: consulta directa a BD
                if hasattr(self, 'conn') and self.conn:
                    tasa_repo = TasaRepositorio(self.conn)
                    tasas['USD'] = tasa_repo.obtener_ultima_tasa('USD')
                    tasas['EUR'] = tasa_repo.obtener_ultima_tasa('EUR')
        except Exception as e:
            logger.error(f"Error obteniendo tasas para men√∫: {e}")
        
        return tasas

    def obtener_fecha_hora_actual(self):
        """
        Retorna la fecha y hora actual formateada
        Returns:
            tuple: (dia_semana, fecha, hora)
        """
        ahora = datetime.now()
        dias_semana = ["Lunes", "Martes", "Mi√©rcoles", "Jueves", "Viernes", "S√°bado", "Domingo"]
        dia_semana = dias_semana[ahora.weekday()]
        fecha = ahora.strftime("%d/%m/%Y")
        hora = ahora.strftime("%I:%M:%S %p")
        return dia_semana, fecha, hora

    def registrar_auditoria(self, accion, tabla, registro_id, datos_anteriores=None, datos_nuevos=None):
        """
        Registra una acci√≥n en el log de auditor√≠a
        """
        try:
            usuario_actual = self.trabajador_service.get_usuario_actual()
            if usuario_actual:
                usuario_nombre = f"{usuario_actual['nombre']} {usuario_actual['apellidos']}"
            else:
                usuario_nombre = "SISTEMA"
            
            if self.auditoria_service:
                self.auditoria_service.registrar(
                    usuario=usuario_nombre,
                    accion=accion,
                    tabla=tabla,
                    registro_id=registro_id,
                    datos_anteriores=datos_anteriores,
                    datos_nuevos=datos_nuevos
                )
        except Exception as e:
            logger.error(f"Error registrando auditor√≠a: {e}")
    
    def mostrar_cabecera(self, titulo):
        """Muestra una cabecera formateada con color"""
        self.limpiar_pantalla()
        print(f"{self.COLOR_AZUL}{'=' * 60}{self.COLOR_RESET}")
        print(f"{self.COLOR_NEGRITA}{titulo:^60}{self.COLOR_RESET}")
        print(f"{self.COLOR_AZUL}{'=' * 60}{self.COLOR_RESET}")
        print()
    
    def mostrar_menu_principal(self):
        """Muestra el men√∫ principal con fecha, hora, tasas de cambio y colores"""
        self.limpiar_pantalla()
        
        dia_semana, fecha, hora = self.obtener_fecha_hora_actual()
        
        # Obtener tasas de cambio
        tasas = self.obtener_tasas_actuales()
        
        # L√≠nea superior
        print(f"{self.COLOR_AZUL}‚ïî" + "‚ïê" * 78 + f"‚ïó{self.COLOR_RESET}")
        
        # T√≠tulo centrado
        titulo = "SISTEMA DE VENTAS - 3 CAPAS"
        espacios_izq = (78 - len(titulo)) // 2
        espacios_der = 78 - len(titulo) - espacios_izq
        print(f"{self.COLOR_AZUL}‚ïë{self.COLOR_RESET}{' ' * espacios_izq}{self.COLOR_NEGRITA}{titulo}{self.COLOR_RESET}{' ' * espacios_der}{self.COLOR_AZUL}‚ïë{self.COLOR_RESET}")
        
        # L√≠nea separadora
        print(f"{self.COLOR_AZUL}‚ï†" + "‚ïê" * 78 + f"‚ï£{self.COLOR_RESET}")
        
        # Fecha y hora
        fecha_hora_str = f"   {self.COLOR_VERDE}üìÖ {dia_semana}, {fecha}{self.COLOR_RESET}  {self.COLOR_AMARILLO}‚è∞ {hora}{self.COLOR_RESET}  {self.COLOR_NARANJA}üáªüá™ Hora Local{self.COLOR_RESET}"
        print(f"{self.COLOR_AZUL}‚ïë{self.COLOR_RESET}{fecha_hora_str:<78}{self.COLOR_AZUL}‚ïë{self.COLOR_RESET}")
        
        # L√≠nea separadora
        print(f"{self.COLOR_AZUL}‚ï†" + "‚ïê" * 78 + f"‚ï£{self.COLOR_RESET}")
        
        # Tasas de cambio
        linea_tasas = f"   {self.COLOR_AMARILLO}üí± TASAS DEL D√çA:{self.COLOR_RESET}"
        print(f"{self.COLOR_AZUL}‚ïë{self.COLOR_RESET}{linea_tasas:<78}{self.COLOR_AZUL}‚ïë{self.COLOR_RESET}")
        
        if tasas['USD']:
            linea_usd = f"      {self.COLOR_VERDE}üíµ USD:{self.COLOR_RESET} 1 = {self.COLOR_AMARILLO}Bs. {tasas['USD']:.2f}{self.COLOR_RESET}"
        else:
            linea_usd = f"      {self.COLOR_VERDE}üíµ USD:{self.COLOR_RESET} {self.COLOR_ROJO}No registrada{self.COLOR_RESET}"
        
        if tasas['EUR']:
            linea_eur = f"      {self.COLOR_VERDE}üí∂ EUR:{self.COLOR_RESET} 1 = {self.COLOR_AMARILLO}Bs. {tasas['EUR']:.2f}{self.COLOR_RESET}"
        else:
            linea_eur = f"      {self.COLOR_VERDE}üí∂ EUR:{self.COLOR_RESET} {self.COLOR_ROJO}No registrada{self.COLOR_RESET}"
        
        print(f"{self.COLOR_AZUL}‚ïë{self.COLOR_RESET}{linea_usd:<78}{self.COLOR_AZUL}‚ïë{self.COLOR_RESET}")
        print(f"{self.COLOR_AZUL}‚ïë{self.COLOR_RESET}{linea_eur:<78}{self.COLOR_AZUL}‚ïë{self.COLOR_RESET}")
        
        # NUEVA OPCI√ìN PARA MODIFICAR TASAS
        print(f"{self.COLOR_AZUL}‚ïë{self.COLOR_RESET}      {self.COLOR_AMARILLO}[X]{self.COLOR_RESET} Modificar tasas de cambio{' ' * 54}{self.COLOR_AZUL}‚ïë{self.COLOR_RESET}")
        
        # L√≠nea separadora
        print(f"{self.COLOR_AZUL}‚ï†" + "‚ïê" * 78 + f"‚ï£{self.COLOR_RESET}")
        
        # Informaci√≥n de usuario
        usuario = self.trabajador_service.get_usuario_actual()
        if usuario:
            rol_nombre = "Sin rol"
            if usuario.get('idrol'):
                rol = self.rol_service.repositorio.obtener_rol(usuario['idrol'])
                if rol:
                    rol_nombre = rol['nombre']
            
            usuario_str = f"   üë§ Usuario: {self.COLOR_VERDE}{usuario['nombre']} {usuario['apellidos']} [{rol_nombre}]{self.COLOR_RESET}"
            permisos_str = f"   üîë Permisos: {self.COLOR_AMARILLO}{len(self.rol_service.get_permisos_usuario())} activos{self.COLOR_RESET}"
            
            print(f"{self.COLOR_AZUL}‚ïë{self.COLOR_RESET}{usuario_str:<78}{self.COLOR_AZUL}‚ïë{self.COLOR_RESET}")
            print(f"{self.COLOR_AZUL}‚ïë{self.COLOR_RESET}{permisos_str:<78}{self.COLOR_AZUL}‚ïë{self.COLOR_RESET}")
        else:
            usuario_str = f"   üë§ Usuario: {self.COLOR_AMARILLO}No autenticado{self.COLOR_RESET}"
            print(f"{self.COLOR_AZUL}‚ïë{self.COLOR_RESET}{usuario_str:<78}{self.COLOR_AZUL}‚ïë{self.COLOR_RESET}")
        
        # L√≠nea separadora
        print(f"{self.COLOR_AZUL}‚ï†" + "‚ïê" * 78 + f"‚ï£{self.COLOR_RESET}")
        
        # T√≠tulo del men√∫
        menu_titulo = "MEN√ö PRINCIPAL"
        espacios_izq_menu = (78 - len(menu_titulo)) // 2
        espacios_der_menu = 78 - len(menu_titulo) - espacios_izq_menu
        print(f"{self.COLOR_AZUL}‚ïë{self.COLOR_RESET}{' ' * espacios_izq_menu}{self.COLOR_NEGRITA}{menu_titulo}{self.COLOR_RESET}{' ' * espacios_der_menu}{self.COLOR_AZUL}‚ïë{self.COLOR_RESET}")
        
        # L√≠nea separadora
        print(f"{self.COLOR_AZUL}‚ï†" + "‚ïê" * 78 + f"‚ï£{self.COLOR_RESET}")
        
        # Opciones del men√∫
        opciones = []
        
        if not usuario or self.rol_service.tiene_permiso('clientes_ver'):
            opciones.append(("1", "Gesti√≥n de Clientes", "üë•"))
        if not usuario or self.rol_service.tiene_permiso('articulos_ver'):
            opciones.append(("2", "Gesti√≥n de Art√≠culos", "üì¶"))
        if not usuario or self.rol_service.tiene_permiso('proveedores_ver'):
            opciones.append(("3", "Gesti√≥n de Proveedores", "üè¢"))
        if not usuario or self.rol_service.tiene_permiso('ventas_ver'):
            opciones.append(("4", "Gesti√≥n de Ventas", "üí∞"))
        if not usuario or self.rol_service.tiene_permiso('compras_ver'):  # NUEVA OPCI√ìN
            opciones.append(("5", "Gesti√≥n de Compras", "üì•"))              # NUEVA OPCI√ìN
        if not usuario or self.rol_service.tiene_permiso('inventario_ver'):
            opciones.append(("6", "Gesti√≥n de Inventario", "üìä"))
        if not usuario or self.rol_service.tiene_permiso('reportes_ventas'):
            opciones.append(("7", "Reportes Contables", "üìà"))
        if usuario and self.rol_service.tiene_permiso('usuarios_ver'):
            opciones.append(("8", "Administraci√≥n de Usuarios", "üë§"))
        
        for num, desc, icono in opciones:
            linea_opcion = f"   {icono} {num}. {desc}"
            espacios = 78 - len(linea_opcion)
            print(f"{self.COLOR_AZUL}‚ïë{self.COLOR_RESET}{linea_opcion}{' ' * espacios}{self.COLOR_AZUL}‚ïë{self.COLOR_RESET}")
        
        # L√≠nea separadora
        print(f"{self.COLOR_AZUL}‚ï†" + "‚ïê" * 78 + f"‚ï£{self.COLOR_RESET}")
        
        # Opci√≥n de sesi√≥n
        if usuario:
            linea_sesion = f"   üîë 8. Cerrar Sesi√≥n"
        else:
            linea_sesion = f"   üîë 8. Iniciar Sesi√≥n"
        espacios_sesion = 78 - len(linea_sesion)
        print(f"{self.COLOR_AZUL}‚ïë{self.COLOR_RESET}{linea_sesion}{' ' * espacios_sesion}{self.COLOR_AZUL}‚ïë{self.COLOR_RESET}")
        
        # Opci√≥n de salir
        linea_salir = f"   ‚ùå 0. Salir"
        espacios_salir = 78 - len(linea_salir)
        print(f"{self.COLOR_AZUL}‚ïë{self.COLOR_RESET}{linea_salir}{' ' * espacios_salir}{self.COLOR_AZUL}‚ïë{self.COLOR_RESET}")
        
        # L√≠nea inferior
        print(f"{self.COLOR_AZUL}‚ïö" + "‚ïê" * 78 + f"‚ïù{self.COLOR_RESET}")
        print()
        
        return input(f"{self.COLOR_AMARILLO}üîπ Seleccione una opci√≥n: {self.COLOR_RESET}").strip()
        
        return input(f"{self.COLOR_AMARILLO}üîπ Seleccione una opci√≥n: {self.COLOR_RESET}").strip()

    def menu_login(self):
        """Men√∫ de inicio de sesi√≥n con opci√≥n de recuperaci√≥n"""
        while True:
            self.mostrar_cabecera("INICIAR SESI√ìN")
            
            print("1. Iniciar sesi√≥n")
            print("2. ¬øOlvidaste tu contrase√±a?")
            print("0. Volver")
            print()
            
            opcion = input(f"{self.COLOR_AMARILLO}üîπ Seleccione una opci√≥n: {self.COLOR_RESET}").strip()
            
            if opcion == '1':
                self._login_normal()
                break
            elif opcion == '2':
                self._recuperar_contrase√±a()
            elif opcion == '0':
                break
            else:
                print("‚ùå Opci√≥n no v√°lida")
                self.pausa()
    
    def _login_normal(self):
        """Login normal con email y contrase√±a"""
        self.mostrar_cabecera("INICIAR SESI√ìN POR EMAIL")
        
        print("üîê Ingrese sus credenciales")
        print()
        email = input("Email: ")
        password = input("Contrase√±a: ")
        
        if self.trabajador_service.login_por_email(email, password):
            print(f"{self.COLOR_VERDE}‚úÖ Sesi√≥n iniciada correctamente{self.COLOR_RESET}")
            self.registrar_auditoria(
                accion="LOGIN",
                tabla="trabajador",
                registro_id=self.trabajador_service.get_usuario_actual()['idtrabajador'],
                datos_nuevos=f"Login exitoso - Email: {email}"
            )
        else:
            print(f"{self.COLOR_ROJO}‚ùå Email o contrase√±a incorrectos{self.COLOR_RESET}")
        
        self.pausa()
    
    def _recuperar_contrase√±a(self):
        """Proceso de recuperaci√≥n con enlace m√°gico"""
        while True:
            self.mostrar_cabecera("RECUPERAR CONTRASE√ëA")
            
            print("1. Solicitar enlace m√°gico por email")
            print("2. Ya tengo un token, ingresar manualmente")
            print("0. Volver")
            print()
            
            opcion = input(f"{self.COLOR_AMARILLO}üîπ Seleccione una opci√≥n: {self.COLOR_RESET}").strip()
            
            if opcion == '1':
                self._solicitar_enlace_magico()
            elif opcion == '2':
                self._ingresar_token_manual()
            elif opcion == '0':
                break
            else:
                print("‚ùå Opci√≥n no v√°lida")
                self.pausa()
    
    def _solicitar_enlace_magico(self):
        """Solicita un enlace m√°gico por email"""
        self.mostrar_cabecera("SOLICITAR ENLACE M√ÅGICO")
        
        email = input("Ingrese su email registrado: ")
        
        usuario = self.trabajador_service.buscar_por_email(email)
        
        if not usuario:
            print("‚ùå No existe un usuario con ese email")
            self.pausa()
            return
        
        print(f"\nüë§ Usuario encontrado: {usuario['nombre']} {usuario['apellidos']}")
        print(f"üìß Email: {usuario['email']}")
        print()
        
        token = self.token_service.crear_token(usuario['idtrabajador'])
        
        if token:
            if self.email_service.enviar_enlace_magico(
                email, token, usuario['nombre']
            ):
                print(f"‚úÖ Se ha enviado un enlace m√°gico a:")
                print(f"   {email}")
                print(f"\nüìß Revisa tu bandeja de entrada (y carpeta SPAM)")
                print(f"‚è∞ El enlace expirar√° en 30 minutos")
                print(f"\nüìù Si no recibes el correo, usa la opci√≥n 2 para ingresar manualmente:")
                print(f"   Token: {token}")
                
                self.registrar_auditoria(
                    accion="RECUPERAR_CONTRASE√ëA",
                    tabla="trabajador",
                    registro_id=usuario['idtrabajador'],
                    datos_nuevos=f"Token enviado a: {email}"
                )
            else:
                print("‚ùå Error al enviar el correo")
                print(f"\nüìù Para pruebas, usa este token manualmente:")
                print(f"   {token}")
        else:
            print("‚ùå Error al generar el token")
        
        self.pausa()
    
    def _ingresar_token_manual(self):
        """Permite ingresar un token manualmente para restablecer contrase√±a"""
        self.mostrar_cabecera("INGRESAR TOKEN MANUAL")
        
        token = input("Ingrese el token recibido: ").strip()
        
        idtrabajador = self.token_service.verificar_token(token)
        
        if idtrabajador:
            usuario = self.trabajador_service.obtener_por_id(idtrabajador)
            print(f"\n‚úÖ Token v√°lido para: {usuario['nombre']} {usuario['apellidos']}")
            
            print("\n" + "="*50)
            print("üîë CAMBIO DE CONTRASE√ëA")
            print("="*50)
            print()
            
            logger.remove()
            logger.add(lambda msg: None)
            
            try:
                nueva_pass = input("‚û§ Ingrese NUEVA contrase√±a (m√≠nimo 6 caracteres): ")
                confirmar = input("‚û§ Confirme la NUEVA contrase√±a: ")
            finally:
                logger.remove()
                logger.add(sys.stderr, format="<level>{level: <8}</level> | <cyan>{name}</cyan>:<cyan>{function}</cyan>:<cyan>{line}</cyan> - <level>{message}</level>")
            
            if nueva_pass == confirmar and len(nueva_pass) >= 6:
                if self.trabajador_service.actualizar_password(usuario['email'], nueva_pass):
                    self.token_service.marcar_token_usado(token)
                    print("\n‚úÖ Contrase√±a actualizada correctamente")
                    print("üîê Ya puede iniciar sesi√≥n con su nueva contrase√±a")
                    
                    self.registrar_auditoria(
                        accion="CAMBIAR_CONTRASE√ëA",
                        tabla="trabajador",
                        registro_id=idtrabajador,
                        datos_nuevos="Contrase√±a actualizada mediante recuperaci√≥n"
                    )
                else:
                    print("\n‚ùå Error al actualizar la contrase√±a")
            else:
                print("\n‚ùå Las contrase√±as no coinciden o son muy cortas")
        else:
            print("\n‚ùå Token inv√°lido o expirado")
        
        self.pausa()
    
    @requiere_permiso('usuarios_ver')
    def menu_administracion_usuarios(self):
        """Men√∫ de administraci√≥n de usuarios"""
        while True:
            self.mostrar_cabecera("ADMINISTRACI√ìN DE USUARIOS")
            print("1. Listar usuarios")
            print("2. Crear nuevo usuario")
            print("3. Ver detalle de usuario")
            print("4. Editar usuario")
            print("5. Eliminar usuario")
            print("0. Volver")
            print()
            
            opcion = input(f"{self.COLOR_AMARILLO}üîπ Seleccione una opci√≥n: {self.COLOR_RESET}").strip()
            
            if opcion == '1':
                self._listar_usuarios()
            elif opcion == '2':
                self._crear_usuario()
            elif opcion == '3':
                self._ver_usuario()
            elif opcion == '4':
                self._editar_usuario()
            elif opcion == '5':
                self._eliminar_usuario()
            elif opcion == '0':
                break
            else:
                print("‚ùå Opci√≥n no v√°lida")
                self.pausa()
    
    def _listar_usuarios(self):
        """Lista todos los usuarios"""
        self.mostrar_cabecera("LISTADO DE USUARIOS")
        
        usuarios = self.usuario_admin_service.listar_usuarios()
        
        if not usuarios:
            print("üì≠ No hay usuarios registrados")
        else:
            print(f"{'ID':<5} {'USUARIO':<15} {'NOMBRE':<25} {'EMAIL':<30} {'ROL':<15}")
            print("-" * 90)
            for u in usuarios:
                rol = u.get('rol_nombre') or f"Rol {u['idrol']}"
                email_val = u.get('email', '') or ''
                print(f"{u['idtrabajador']:<5} {u['usuario']:<15} {u['nombre'] + ' ' + u['apellidos']:<25} {email_val:<30} {rol:<15}")
        
        self.pausa()
    
    def _crear_usuario(self):
        """Crea un nuevo usuario del sistema"""
        self.mostrar_cabecera("CREAR NUEVO USUARIO")
        
        print("üìù Complete los datos del nuevo usuario:")
        print()
        
        nombre = input("Nombre: ")
        apellidos = input("Apellidos: ")
        sexo = input("Sexo (M/F/O): ").upper()
        
        print("\nüìÖ Fecha de nacimiento (OPCIONAL - presione Enter para omitir)")
        print("   Formato: DD/MM/YYYY (ej: 15/05/1990)")
        
        while True:
            fecha_nac_str = input("Fecha de nacimiento: ").strip()
            
            if fecha_nac_str == "":
                fecha_nac = None
                break
            
            valida, fecha_obj, mensaje = ValidacionVenezuela.validar_fecha(fecha_nac_str)
            
            if valida:
                fecha_nac = fecha_obj
                break
            else:
                print(mensaje)
                print("   Intente nuevamente o presione Enter para omitir:")
        
        print("\n" + "="*60)
        print("üîç TIPO DE DOCUMENTO DEL USUARIO")
        print("="*60)
        print("1. üáªüá™ Venezolano (V) ‚Üí V12345678")
        print("2. üåé Extranjero (E) ‚Üí E87654321")
        print("3. üõÇ Pasaporte ‚Üí n√∫mero de pasaporte")
        print("="*60)
        
        tipo_persona = input("Seleccione tipo de documento (1-3): ").strip()
        
        if tipo_persona == '1':
            tipo_doc = 'V'
            print("\n‚úÖ Seleccion√≥: Venezolano (V)")
            print("üìù Formato requerido: V + 8 d√≠gitos")
            print("   Ejemplo: V12345678")
            num_doc = input("Documento completo: ").upper()
            
            if not num_doc.startswith('V'):
                print("‚ùå El documento debe comenzar con 'V'")
                self.pausa()
                return
            documento_completo = num_doc
            
        elif tipo_persona == '2':
            tipo_doc = 'E'
            print("\n‚úÖ Seleccion√≥: Extranjero (E)")
            print("üìù Formato requerido: E + 8 d√≠gitos")
            print("   Ejemplo: E87654321")
            num_doc = input("Documento completo: ").upper()
            
            if not num_doc.startswith('E'):
                print("‚ùå El documento debe comenzar con 'E'")
                self.pausa()
                return
            documento_completo = num_doc
            
        elif tipo_persona == '3':
            tipo_doc = 'PASAPORTE'
            print("\n‚úÖ Seleccion√≥: Pasaporte")
            print("üìù Ingrese n√∫mero de pasaporte (6-12 caracteres)")
            print("   Ejemplo: ABC123456")
            documento_completo = input("Pasaporte: ").upper()
            
        else:
            print("‚ùå Opci√≥n no v√°lida")
            self.pausa()
            return
        
        usuario = input("Nombre de usuario: ")
        password = input("Contrase√±a (m√≠nimo 6 caracteres): ")
        email = input("Email: ")
        telefono = input("Tel√©fono (opcional): ") or None
        direccion = input("Direcci√≥n (opcional): ") or None
        
        print("\nRoles disponibles:")
        roles = self.rol_service.listar_roles()
        for r in roles:
            print(f"  {r['idrol']}. {r['nombre']}")
        
        try:
            idrol = int(input("\nID del rol: "))
        except:
            print("‚ùå Rol inv√°lido")
            self.pausa()
            return
        
        fecha_nac_bd = ValidacionVenezuela.formatear_fecha_para_bd(fecha_nac) if fecha_nac else None
        
        if self.usuario_admin_service.crear_usuario(
            nombre, apellidos, sexo, fecha_nac_bd, documento_completo,
            usuario, password, email, idrol, direccion, telefono
        ):
            print("\n‚úÖ Usuario creado exitosamente")
            if not fecha_nac:
                print("   ‚ÑπÔ∏è Fecha de nacimiento no registrada")
            
            self.registrar_auditoria(
                accion="CREAR",
                tabla="trabajador",
                registro_id=self.trabajador_service.buscar_por_email(email)['idtrabajador'],
                datos_nuevos=f"Usuario: {usuario}, Email: {email}"
            )
        else:
            print("\n‚ùå Error al crear el usuario")
        
        self.pausa()
    
    def _ver_usuario(self):
        """Muestra detalle de un usuario"""
        self.mostrar_cabecera("DETALLE DE USUARIO")
        
        try:
            iduser = int(input("ID del usuario: "))
            usuario = self.usuario_admin_service.obtener_usuario(iduser)
            
            if usuario:
                print(f"\nüìå ID: {usuario['idtrabajador']}")
                print(f"üìå Nombre: {usuario['nombre']} {usuario['apellidos']}")
                print(f"üìå Sexo: {usuario['sexo']}")
                print(f"üìå Fecha Nac.: {usuario['fecha_nacimiento'] or 'No registrada'}")
                print(f"üìå Documento: {usuario['num_documento']}")
                print(f"üìå Usuario: {usuario['usuario']}")
                print(f"üìå Email: {usuario['email']}")
                print(f"üìå Tel√©fono: {usuario.get('telefono', 'No registrado')}")
                print(f"üìå Direcci√≥n: {usuario.get('direccion', 'No registrada')}")
                print(f"üìå Rol: {usuario.get('rol_nombre')} (ID: {usuario['idrol']})")
                
                print("\nüìã √öLTIMAS ACCIONES DE AUDITOR√çA:")
                logs = self.auditoria_service.consultar_por_tabla("trabajador", iduser)
                for log in logs[:5]:
                    print(f"   - {log['fecha_hora']}: {log['accion']}")
            else:
                print(f"‚ùå No existe usuario con ID {iduser}")
        except Exception as e:
            print(f"‚ùå Error: {e}")
        
        self.pausa()
    
    def _editar_usuario(self):
        """Edita un usuario existente"""
        self.mostrar_cabecera("EDITAR USUARIO")
        
        try:
            iduser = int(input("ID del usuario a editar: "))
            usuario = self.usuario_admin_service.obtener_usuario(iduser)
            
            if not usuario:
                print(f"‚ùå No existe usuario con ID {iduser}")
                self.pausa()
                return
            
            datos_anteriores = f"Usuario: {usuario['usuario']}, Email: {usuario['email']}, Rol: {usuario['idrol']}"
            
            print(f"\nEditando a: {usuario['nombre']} {usuario['apellidos']}")
            print("(Deje en blanco para mantener el valor actual)")
            print()
            
            nombre = input(f"Nombre [{usuario['nombre']}]: ") or usuario['nombre']
            apellidos = input(f"Apellidos [{usuario['apellidos']}]: ") or usuario['apellidos']
            sexo = input(f"Sexo [{usuario['sexo']}]: ").upper() or usuario['sexo']
            
            fecha_actual = usuario['fecha_nacimiento']
            fecha_actual_str = fecha_actual.strftime('%d/%m/%Y') if fecha_actual else "No registrada"
            
            print(f"\nüìÖ Fecha de nacimiento actual: {fecha_actual_str}")
            print("   (Enter para mantener, 'NUEVA' para cambiar, 'BORRAR' para eliminar)")
            
            while True:
                opcion_fecha = input("Opci√≥n: ").strip().upper()
                
                if opcion_fecha == "":
                    fecha_nac = fecha_actual
                    break
                elif opcion_fecha == "BORRAR":
                    fecha_nac = None
                    print("‚úÖ Fecha de nacimiento eliminada")
                    break
                elif opcion_fecha == "NUEVA":
                    print("Ingrese nueva fecha (DD/MM/YYYY) o Enter para cancelar:")
                    nueva_fecha = input("Nueva fecha: ").strip()
                    
                    if nueva_fecha == "":
                        fecha_nac = fecha_actual
                        break
                    
                    valida, fecha_obj, mensaje = ValidacionVenezuela.validar_fecha(nueva_fecha)
                    if valida:
                        fecha_nac = fecha_obj
                        break
                    else:
                        print(mensaje)
                else:
                    print("Opci√≥n no v√°lida. Use Enter, NUEVA o BORRAR")
            
            documento = input(f"Documento [{usuario['num_documento']}]: ") or usuario['num_documento']
            username = input(f"Usuario [{usuario['usuario']}]: ") or usuario['usuario']
            email = input(f"Email [{usuario['email']}]: ") or usuario['email']
            telefono = input(f"Tel√©fono [{usuario.get('telefono', '')}]: ") or usuario.get('telefono')
            direccion = input(f"Direcci√≥n [{usuario.get('direccion', '')}]: ") or usuario.get('direccion')
            
            cambiar_pass = input("¬øCambiar contrase√±a? (s/N): ").lower()
            nueva_pass = None
            if cambiar_pass == 's':
                nueva_pass = input("Nueva contrase√±a: ")
                confirmar = input("Confirmar contrase√±a: ")
                if nueva_pass != confirmar:
                    print("‚ùå Las contrase√±as no coinciden")
                    self.pausa()
                    return
            
            print("\nRoles disponibles:")
            roles = self.rol_service.listar_roles()
            for r in roles:
                print(f"  {r['idrol']}. {r['nombre']}")
            
            try:
                idrol = int(input(f"\nID del rol [{usuario['idrol']}]: ") or usuario['idrol'])
            except:
                idrol = usuario['idrol']
            
            fecha_nac_bd = ValidacionVenezuela.formatear_fecha_para_bd(fecha_nac) if fecha_nac else None
            
            if self.usuario_admin_service.actualizar_usuario(
                iduser, nombre, apellidos, sexo, fecha_nac_bd, documento,
                username, email, idrol, direccion, telefono, nueva_pass
            ):
                print("‚úÖ Usuario actualizado correctamente")
                
                datos_nuevos = f"Usuario: {username}, Email: {email}, Rol: {idrol}"
                self.registrar_auditoria(
                    accion="MODIFICAR",
                    tabla="trabajador",
                    registro_id=iduser,
                    datos_anteriores=datos_anteriores,
                    datos_nuevos=datos_nuevos
                )
            else:
                print("‚ùå Error al actualizar el usuario")
        
        except Exception as e:
            print(f"‚ùå Error: {e}")
        
        self.pausa()
    
    def _eliminar_usuario(self):
        """Elimina un usuario"""
        self.mostrar_cabecera("ELIMINAR USUARIO")
        
        try:
            iduser = int(input("ID del usuario a eliminar: "))
            
            usuario_actual = self.trabajador_service.get_usuario_actual()
            if usuario_actual and usuario_actual['idtrabajador'] == iduser:
                print("‚ùå No puede eliminarse a s√≠ mismo")
                self.pausa()
                return
            
            usuario = self.usuario_admin_service.obtener_usuario(iduser)
            if not usuario:
                print(f"‚ùå No existe usuario con ID {iduser}")
                self.pausa()
                return
            
            datos_usuario = f"Usuario: {usuario['usuario']}, Email: {usuario['email']}"
            
            print(f"\n¬øEst√° seguro de eliminar a {usuario['nombre']} {usuario['apellidos']}?")
            confirmacion = input("Esta acci√≥n no se puede deshacer (escriba 'ELIMINAR' para confirmar): ")
            
            if confirmacion == 'ELIMINAR':
                if self.usuario_admin_service.eliminar_usuario(iduser):
                    print("‚úÖ Usuario eliminado correctamente")
                    
                    self.registrar_auditoria(
                        accion="ELIMINAR",
                        tabla="trabajador",
                        registro_id=iduser,
                        datos_anteriores=datos_usuario
                    )
                else:
                    print("‚ùå Error al eliminar el usuario")
            else:
                print("Operaci√≥n cancelada")
        
        except Exception as e:
            print(f"‚ùå Error: {e}")
        
        self.pausa()
    
    def menu_categorias(self):
        """Men√∫ de gesti√≥n de categor√≠as"""
        while True:
            self.mostrar_cabecera("GESTI√ìN DE CATEGOR√çAS")
            print("1. Listar categor√≠as")
            print("2. Buscar categor√≠a por ID")
            print("3. Crear categor√≠a")
            print("4. Actualizar categor√≠a")
            print("5. Eliminar categor√≠a")
            print("0. Volver")
            print()
            
            opcion = input(f"{self.COLOR_AMARILLO}üîπ Seleccione una opci√≥n: {self.COLOR_RESET}").strip()
            
            if opcion == '1':
                self.listar_categorias()
            elif opcion == '2':
                self.buscar_categoria()
            elif opcion == '3':
                self.crear_categoria()
            elif opcion == '4':
                self.actualizar_categoria()
            elif opcion == '5':
                self.eliminar_categoria()
            elif opcion == '0':
                break
            else:
                print("‚ùå Opci√≥n no v√°lida")
                self.pausa()
    
    def listar_categorias(self):
        """Lista todas las categor√≠as"""
        self.mostrar_cabecera("LISTADO DE CATEGOR√çAS")
        
        categorias = self.categoria_service.listar()
        
        if not categorias:
            print("üì≠ No hay categor√≠as registradas")
        else:
            print(f"{'ID':<5} {'NOMBRE':<30} {'DESCRIPCI√ìN':<40}")
            print("-" * 75)
            for cat in categorias:
                desc = cat['descripcion'][:37] + "..." if cat['descripcion'] and len(cat['descripcion']) > 40 else cat['descripcion'] or ""
                print(f"{cat['idcategoria']:<5} {cat['nombre']:<30} {desc:<40}")
        
        self.pausa()
    
    def buscar_categoria(self):
        """Busca una categor√≠a por ID"""
        self.mostrar_cabecera("BUSCAR CATEGOR√çA")
        
        try:
            idcategoria = int(input("Ingrese ID de categor√≠a: "))
            categoria = self.categoria_service.obtener_por_id(idcategoria)
            
            if categoria:
                print(f"\nüìå ID: {categoria['idcategoria']}")
                print(f"üìå Nombre: {categoria['nombre']}")
                print(f"üìå Descripci√≥n: {categoria['descripcion'] or 'Sin descripci√≥n'}")
            else:
                print(f"‚ùå No existe categor√≠a con ID {idcategoria}")
        except ValueError:
            print("‚ùå Debe ingresar un n√∫mero v√°lido")
        
        self.pausa()
    
    def crear_categoria(self):
        """Crea una nueva categor√≠a"""
        self.mostrar_cabecera("CREAR CATEGOR√çA")
        
        nombre = input("Ingrese nombre de categor√≠a: ")
        descripcion = input("Ingrese descripci√≥n (opcional): ") or None
        
        if self.categoria_service.crear(nombre, descripcion):
            print("‚úÖ Categor√≠a creada exitosamente")
            
            categorias = self.categoria_service.listar()
            if categorias:
                idcategoria = categorias[0]['idcategoria']
                self.registrar_auditoria(
                    accion="CREAR",
                    tabla="categoria",
                    registro_id=idcategoria,
                    datos_nuevos=f"Categor√≠a: {nombre}"
                )
        else:
            print("‚ùå No se pudo crear la categor√≠a")
        
        self.pausa()
    
    def actualizar_categoria(self):
        """Actualiza una categor√≠a"""
        self.mostrar_cabecera("ACTUALIZAR CATEGOR√çA")
        
        try:
            idcategoria = int(input("Ingrese ID de categor√≠a a actualizar: "))
            categoria = self.categoria_service.obtener_por_id(idcategoria)
            
            if not categoria:
                print(f"‚ùå No existe categor√≠a con ID {idcategoria}")
                self.pausa()
                return
            
            datos_anteriores = f"Categor√≠a: {categoria['nombre']}"
            
            print(f"\nüìå Datos actuales:")
            print(f"   Nombre: {categoria['nombre']}")
            print(f"   Descripci√≥n: {categoria['descripcion'] or 'Sin descripci√≥n'}")
            print()
            
            nombre = input("Nuevo nombre (Enter para mantener): ") or categoria['nombre']
            descripcion = input("Nueva descripci√≥n (Enter para mantener): ") or categoria['descripcion']
            
            if self.categoria_service.actualizar(idcategoria, nombre, descripcion):
                print("‚úÖ Categor√≠a actualizada exitosamente")
                
                self.registrar_auditoria(
                    accion="MODIFICAR",
                    tabla="categoria",
                    registro_id=idcategoria,
                    datos_anteriores=datos_anteriores,
                    datos_nuevos=f"Categor√≠a: {nombre}"
                )
            else:
                print("‚ùå No se pudo actualizar la categor√≠a")
        except ValueError:
            print("‚ùå Debe ingresar un n√∫mero v√°lido")
        
        self.pausa()
    
    def eliminar_categoria(self):
        """Elimina una categor√≠a"""
        self.mostrar_cabecera("ELIMINAR CATEGOR√çA")
        
        try:
            idcategoria = int(input("Ingrese ID de categor√≠a a eliminar: "))
            categoria = self.categoria_service.obtener_por_id(idcategoria)
            
            if not categoria:
                print(f"‚ùå No existe categor√≠a con ID {idcategoria}")
                self.pausa()
                return
            
            datos_categoria = f"Categor√≠a: {categoria['nombre']}"
            
            confirmacion = input(f"¬øEst√° seguro de eliminar la categor√≠a {idcategoria}? (s/N): ")
            if confirmacion.lower() == 's':
                if self.categoria_service.eliminar(idcategoria):
                    print("‚úÖ Categor√≠a eliminada exitosamente")
                    
                    self.registrar_auditoria(
                        accion="ELIMINAR",
                        tabla="categoria",
                        registro_id=idcategoria,
                        datos_anteriores=datos_categoria
                    )
                else:
                    print("‚ùå No se pudo eliminar la categor√≠a (puede tener art√≠culos asociados)")
            else:
                print("Operaci√≥n cancelada")
        except ValueError:
            print("‚ùå Debe ingresar un n√∫mero v√°lido")
        
        self.pausa()
    
    def menu_clientes(self):
        """Men√∫ de gesti√≥n de clientes"""
        while True:
            self.mostrar_cabecera("GESTI√ìN DE CLIENTES")
            print("1. Listar clientes")
            print("2. Buscar cliente")
            print("3. Crear cliente")
            print("4. Editar cliente")
            print("5. Eliminar cliente")
            print("0. Volver")
            print()
            
            opcion = input(f"{self.COLOR_AMARILLO}üîπ Seleccione una opci√≥n: {self.COLOR_RESET}").strip()
            
            if opcion == '1':
                self._listar_clientes()
            elif opcion == '2':
                self._buscar_cliente()
            elif opcion == '3':
                self._crear_cliente()
            elif opcion == '4':
                self._editar_cliente()
            elif opcion == '5':
                self._eliminar_cliente()
            elif opcion == '0':
                break
            else:
                print("‚ùå Opci√≥n no v√°lida")
                self.pausa()
    
    @requiere_permiso('clientes_ver')
    def _listar_clientes(self):
        """Lista todos los clientes"""
        self.mostrar_cabecera("LISTADO DE CLIENTES")
        
        clientes = self.cliente_service.listar()
        
        if not clientes:
            print("üì≠ No hay clientes registrados")
        else:
            print(f"{'ID':<5} {'NOMBRE':<25} {'DOCUMENTO':<20} {'TEL√âFONO':<12} {'EMAIL':<25}")
            print("-" * 87)
            for c in clientes:
                nombre_completo = f"{c['nombre']} {c['apellidos']}"
                documento = f"{c['tipo_documento']}-{c['num_documento']}"
                telefono_val = c.get('telefono', '') or ''
                email_val = c.get('email', '') or ''
                print(f"{c['idcliente']:<5} {nombre_completo:<25} {documento:<20} {telefono_val:<12} {email_val:<25}")
        
        self.pausa()
    
    @requiere_permiso('clientes_crear')
    def _crear_cliente(self):
        """Crea un nuevo cliente con validaci√≥n venezolana y fecha opcional"""
        self.mostrar_cabecera("CREAR CLIENTE")
        
        print("üìù Complete los datos del cliente (los campos con * son obligatorios):")
        print()
        
        nombre = input("* Nombre: ")
        apellidos = input("* Apellidos: ")
        sexo = input("* Sexo (M/F/O): ").upper()
        
        print("\nüìÖ Fecha de nacimiento (OPCIONAL - presione Enter para omitir)")
        print("   Formato: DD/MM/YYYY (ej: 15/05/1990)")
        
        while True:
            fecha_nac_str = input("Fecha de nacimiento: ").strip()
            
            if fecha_nac_str == "":
                fecha_nac = None
                break
            
            valida, fecha_obj, mensaje = ValidacionVenezuela.validar_fecha(fecha_nac_str)
            
            if valida:
                fecha_nac = fecha_obj
                break
            else:
                print(mensaje)
                print("   Intente nuevamente o presione Enter para omitir:")
        
        print("\n" + "="*60)
        print("üîç TIPO DE PERSONA - FORMATO DEL DOCUMENTO")
        print("="*60)
        print("1. üáªüá™ Persona Natural Venezolana  ‚Üí  V12345678")
        print("2. üåé Persona Natural Extranjera   ‚Üí  E87654321")
        print("3. üè¢ Persona Jur√≠dica (Empresa)   ‚Üí  J12345678")
        print("4. üèõÔ∏è Gobierno / Instituci√≥n        ‚Üí  G12345678")
        print("5. üë• Consejo Comunal               ‚Üí  C12345678")
        print("6. üõÇ Pasaporte                      ‚Üí  N√∫mero de pasaporte")
        print("="*60)
        
        tipo_persona = input("Seleccione tipo de persona (1-6): ").strip()
        
        if tipo_persona == '1':
            tipo_doc = 'V'
            print("\n‚úÖ Seleccion√≥: Persona Natural Venezolana (V)")
            print("üìù Formato requerido: V + 8 d√≠gitos")
            print("   Ejemplo: V12345678")
            num_doc_completo = input("Documento completo: ").upper()
            
            if not num_doc_completo.startswith('V'):
                print("‚ùå El documento debe comenzar con 'V'")
                self.pausa()
                return
            num_doc = num_doc_completo[1:]
            
        elif tipo_persona == '2':
            tipo_doc = 'E'
            print("\n‚úÖ Seleccion√≥: Persona Natural Extranjera (E)")
            print("üìù Formato requerido: E + 8 d√≠gitos")
            print("   Ejemplo: E87654321")
            num_doc_completo = input("Documento completo: ").upper()
            
            if not num_doc_completo.startswith('E'):
                print("‚ùå El documento debe comenzar con 'E'")
                self.pausa()
                return
            num_doc = num_doc_completo[1:]
            
        elif tipo_persona == '3':
            tipo_doc = 'J'
            print("\n‚úÖ Seleccion√≥: Empresa (J)")
            print("üìù Formato requerido: J + 8 d√≠gitos")
            print("   Ejemplo: J12345678")
            num_doc_completo = input("Documento completo: ").upper()
            
            if not num_doc_completo.startswith('J'):
                print("‚ùå El documento debe comenzar con 'J'")
                self.pausa()
                return
            num_doc = num_doc_completo[1:]
            
        elif tipo_persona == '4':
            tipo_doc = 'G'
            print("\n‚úÖ Seleccion√≥: Gobierno / Instituci√≥n (G)")
            print("üìù Formato requerido: G + 8 d√≠gitos")
            print("   Ejemplo: G12345678")
            num_doc_completo = input("Documento completo: ").upper()
            
            if not num_doc_completo.startswith('G'):
                print("‚ùå El documento debe comenzar con 'G'")
                self.pausa()
                return
            num_doc = num_doc_completo[1:]
            
        elif tipo_persona == '5':
            tipo_doc = 'C'
            print("\n‚úÖ Seleccion√≥: Consejo Comunal (C)")
            print("üìù Formato requerido: C + 8 d√≠gitos")
            print("   Ejemplo: C12345678")
            num_doc_completo = input("Documento completo: ").upper()
            
            if not num_doc_completo.startswith('C'):
                print("‚ùå El documento debe comenzar con 'C'")
                self.pausa()
                return
            num_doc = num_doc_completo[1:]
            
        elif tipo_persona == '6':
            tipo_doc = 'PASAPORTE'
            print("\n‚úÖ Seleccion√≥: Pasaporte")
            print("üìù Ingrese n√∫mero de pasaporte (6-12 caracteres)")
            print("   Ejemplo: ABC123456")
            num_doc = input("Pasaporte: ").upper()
            
        else:
            print("‚ùå Opci√≥n no v√°lida")
            self.pausa()
            return
        
        print("\nüìß Email (opcional para clientes):")
        email = input("Email: ").strip()
        if email and ('@' not in email or '.' not in email):
            print("‚ùå El email no tiene un formato v√°lido")
            self.pausa()
            return
        if not email:
            email = None
        
        direccion = input("Direcci√≥n (opcional): ") or None
        telefono = input("Tel√©fono (opcional): ") or None
        
        fecha_nac_bd = ValidacionVenezuela.formatear_fecha_para_bd(fecha_nac) if fecha_nac else None
        
        if self.cliente_service.crear(
            nombre, apellidos, fecha_nac_bd, tipo_doc, num_doc,
            sexo, direccion, telefono, email
        ):
            print("\n‚úÖ Cliente creado exitosamente")
            if not fecha_nac:
                print("   ‚ÑπÔ∏è Fecha de nacimiento no registrada")
            
            cliente_nuevo = self.cliente_service.buscar_por_documento(tipo_doc + num_doc)
            if cliente_nuevo:
                idcliente = cliente_nuevo['idcliente']
                self.registrar_auditoria(
                    accion="CREAR",
                    tabla="cliente",
                    registro_id=idcliente,
                    datos_nuevos=f"Cliente: {nombre} {apellidos}, Doc: {tipo_doc}-{num_doc}"
                )
        else:
            print("\n‚ùå Error al crear el cliente")
        
        self.pausa()
    
    @requiere_permiso('clientes_ver')
    def _buscar_cliente(self):
        """Busca un cliente por ID o documento"""
        self.mostrar_cabecera("BUSCAR CLIENTE")
        
        print("1. Buscar por ID")
        print("2. Buscar por documento")
        opcion = input(f"{self.COLOR_AMARILLO}üîπ Seleccione: {self.COLOR_RESET}").strip()
        
        if opcion == '1':
            try:
                idcliente = int(input("ID del cliente: "))
                cliente = self.cliente_service.obtener_por_id(idcliente)
                if cliente:
                    self._mostrar_detalle_cliente(cliente)
                else:
                    print(f"‚ùå No existe cliente con ID {idcliente}")
            except:
                print("‚ùå ID inv√°lido")
        
        elif opcion == '2':
            doc = input("N√∫mero de documento (ej: V12345678): ").upper()
            if doc and doc[0] in ['V', 'E', 'J', 'G', 'C']:
                tipo = doc[0]
                numero = doc[1:]
                clientes = self.cliente_service.listar()
                encontrado = None
                for c in clientes:
                    if c['tipo_documento'] == tipo and c['num_documento'] == numero:
                        encontrado = c
                        break
                if encontrado:
                    self._mostrar_detalle_cliente(encontrado)
                    
                    self.registrar_auditoria(
                        accion="CONSULTAR",
                        tabla="cliente",
                        registro_id=encontrado['idcliente'],
                        datos_nuevos=f"B√∫squeda por documento: {doc}"
                    )
                else:
                    print(f"‚ùå No existe cliente con documento {doc}")
            else:
                print("‚ùå Formato de documento inv√°lido")
        
        self.pausa()
    
    def _mostrar_detalle_cliente(self, c):
        """Muestra detalles completos de un cliente"""
        print(f"\nüìå ID: {c['idcliente']}")
        print(f"üìå Nombre: {c['nombre']} {c['apellidos']}")
        print(f"üìå Sexo: {c.get('sexo', 'No especificado')}")
        print(f"üìå Fecha Nac.: {c['fecha_nacimiento'] or 'No registrada'}")
        print(f"üìå Documento: {c['tipo_documento']}-{c['num_documento']}")
        print(f"üìå Direcci√≥n: {c.get('direccion', 'No registrada')}")
        print(f"üìå Tel√©fono: {c.get('telefono', 'No registrado')}")
        print(f"üìå Email: {c.get('email', 'No registrado')}")
    
    @requiere_permiso('clientes_editar')
    def _editar_cliente(self):
        """Edita un cliente existente con fecha opcional"""
        self.mostrar_cabecera("EDITAR CLIENTE")
        
        print("¬øC√≥mo desea buscar el cliente?")
        print("1. Buscar por ID")
        print("2. Buscar por documento")
        opcion = input(f"{self.COLOR_AMARILLO}üîπ Seleccione: {self.COLOR_RESET}").strip()
        
        cliente = None
        
        if opcion == '1':
            try:
                idcliente = int(input("ID del cliente: "))
                cliente = self.cliente_service.obtener_por_id(idcliente)
                if not cliente:
                    print(f"‚ùå No existe cliente con ID {idcliente}")
                    self.pausa()
                    return
            except ValueError:
                print("‚ùå ID inv√°lido")
                self.pausa()
                return
                
        elif opcion == '2':
            doc = input("N√∫mero de documento (ej: V12345678): ").upper()
            doc_limpio = doc.replace('-', '').replace(' ', '')
            
            cliente_simple = None
            cliente_simple = self.cliente_service.buscar_por_documento(doc)
            if not cliente_simple:
                cliente_simple = self.cliente_service.buscar_por_documento(doc_limpio)
            if not cliente_simple and len(doc_limpio) >= 9:
                doc_con_guion = doc_limpio[0] + '-' + doc_limpio[1:]
                cliente_simple = self.cliente_service.buscar_por_documento(doc_con_guion)
            
            if not cliente_simple:
                print(f"‚ùå No existe cliente con documento {doc}")
                self.pausa()
                return
            cliente = self.cliente_service.obtener_por_id(cliente_simple['idcliente'])
            
        else:
            print("‚ùå Opci√≥n no v√°lida")
            self.pausa()
            return
        
        tipo_actual = cliente['tipo_documento']
        tipo_texto = {
            'V': "üáªüá™ Persona Natural Venezolana",
            'E': "üåé Persona Natural Extranjera",
            'J': "üè¢ Empresa",
            'G': "üèõÔ∏è Gobierno / Instituci√≥n",
            'C': "üë• Consejo Comunal",
            'PASAPORTE': "üõÇ Pasaporte"
        }.get(tipo_actual, tipo_actual)
        
        print(f"\nEditando a: {cliente['nombre']} {cliente['apellidos']}")
        print(f"üìå Tipo actual: {tipo_texto}")
        print("(Deje en blanco para mantener el valor actual)")
        print()
        
        datos_anteriores = f"Cliente: {cliente['nombre']} {cliente['apellidos']}, Doc: {cliente['tipo_documento']}-{cliente['num_documento']}"
        
        nombre = input(f"Nombre [{cliente['nombre']}]: ") or cliente['nombre']
        apellidos = input(f"Apellidos [{cliente['apellidos']}]: ") or cliente['apellidos']
        sexo = input(f"Sexo [{cliente['sexo']}]: ").upper() or cliente['sexo']
        
        fecha_actual = cliente['fecha_nacimiento']
        fecha_actual_str = fecha_actual.strftime('%d/%m/%Y') if fecha_actual else "No registrada"
        
        print(f"\nüìÖ Fecha de nacimiento actual: {fecha_actual_str}")
        print("   (Enter para mantener, 'NUEVA' para cambiar, 'BORRAR' para eliminar)")
        
        while True:
            opcion_fecha = input("Opci√≥n: ").strip().upper()
            
            if opcion_fecha == "":
                fecha_nac = fecha_actual
                break
            elif opcion_fecha == "BORRAR":
                fecha_nac = None
                print("‚úÖ Fecha de nacimiento eliminada")
                break
            elif opcion_fecha == "NUEVA":
                print("Ingrese nueva fecha (DD/MM/YYYY) o Enter para cancelar:")
                nueva_fecha = input("Nueva fecha: ").strip()
                
                if nueva_fecha == "":
                    fecha_nac = fecha_actual
                    break
                
                valida, fecha_obj, mensaje = ValidacionVenezuela.validar_fecha(nueva_fecha)
                if valida:
                    fecha_nac = fecha_obj
                    break
                else:
                    print(mensaje)
            else:
                print("Opci√≥n no v√°lida. Use Enter, NUEVA o BORRAR")
        
        print("\n¬øCambiar tipo de documento? (s/N): ", end="")
        cambiar_tipo = input().lower()
        
        if cambiar_tipo == 's':
            print("\n" + "="*60)
            print("üîç NUEVO TIPO DE DOCUMENTO")
            print("="*60)
            print("1. üáªüá™ Venezolano (V) ‚Üí V12345678")
            print("2. üåé Extranjero (E) ‚Üí E87654321")
            print("3. üè¢ Empresa (J) ‚Üí J12345678")
            print("4. üèõÔ∏è Gobierno (G) ‚Üí G12345678")
            print("5. üë• Consejo Comunal (C) ‚Üí C12345678")
            print("6. üõÇ Pasaporte ‚Üí texto libre")
            print("="*60)
            
            tipo_op = input("Seleccione nuevo tipo (1-6): ").strip()
            
            if tipo_op == '1':
                tipo_doc = 'V'
                print("Ingrese documento completo (ej: V12345678):")
                doc_completo = input("Documento: ").upper()
                if doc_completo.startswith('V'):
                    num_doc = doc_completo[1:]
                else:
                    print("‚ùå Debe comenzar con V")
                    self.pausa()
                    return
            elif tipo_op == '2':
                tipo_doc = 'E'
                print("Ingrese documento completo (ej: E87654321):")
                doc_completo = input("Documento: ").upper()
                if doc_completo.startswith('E'):
                    num_doc = doc_completo[1:]
                else:
                    print("‚ùå Debe comenzar con E")
                    self.pausa()
                    return
            elif tipo_op == '3':
                tipo_doc = 'J'
                print("Ingrese documento completo (ej: J12345678):")
                doc_completo = input("Documento: ").upper()
                if doc_completo.startswith('J'):
                    num_doc = doc_completo[1:]
                else:
                    print("‚ùå Debe comenzar con J")
                    self.pausa()
                    return
            elif tipo_op == '4':
                tipo_doc = 'G'
                print("Ingrese documento completo (ej: G12345678):")
                doc_completo = input("Documento: ").upper()
                if doc_completo.startswith('G'):
                    num_doc = doc_completo[1:]
                else:
                    print("‚ùå Debe comenzar con G")
                    self.pausa()
                    return
            elif tipo_op == '5':
                tipo_doc = 'C'
                print("Ingrese documento completo (ej: C12345678):")
                doc_completo = input("Documento: ").upper()
                if doc_completo.startswith('C'):
                    num_doc = doc_completo[1:]
                else:
                    print("‚ùå Debe comenzar con C")
                    self.pausa()
                    return
            elif tipo_op == '6':
                tipo_doc = 'PASAPORTE'
                num_doc = input("N√∫mero de pasaporte: ").upper()
            else:
                print("‚ùå Opci√≥n no v√°lida")
                self.pausa()
                return
        else:
            tipo_doc = cliente['tipo_documento']
            num_doc = cliente['num_documento']
        
        direccion = input(f"Direcci√≥n [{cliente.get('direccion', '')}]: ") or cliente.get('direccion')
        telefono = input(f"Tel√©fono [{cliente.get('telefono', '')}]: ") or cliente.get('telefono')
        email = input(f"Email [{cliente.get('email', '')}]: ") or cliente.get('email')
        
        fecha_nac_bd = ValidacionVenezuela.formatear_fecha_para_bd(fecha_nac) if fecha_nac else None
        
        if self.cliente_service.actualizar(
            cliente['idcliente'], nombre, apellidos, fecha_nac_bd, tipo_doc, num_doc,
            sexo, direccion, telefono, email
        ):
            print("\n‚úÖ Cliente actualizado correctamente")
            
            datos_nuevos = f"Cliente: {nombre} {apellidos}, Doc: {tipo_doc}-{num_doc}"
            self.registrar_auditoria(
                accion="MODIFICAR",
                tabla="cliente",
                registro_id=cliente['idcliente'],
                datos_anteriores=datos_anteriores,
                datos_nuevos=datos_nuevos
            )
        else:
            print("\n‚ùå Error al actualizar el cliente")
        
        self.pausa()
    
    @requiere_permiso('clientes_eliminar')
    def _eliminar_cliente(self):
        """Elimina un cliente"""
        self.mostrar_cabecera("ELIMINAR CLIENTE")
        
        try:
            idcliente = int(input("ID del cliente a eliminar: "))
            
            cliente = self.cliente_service.obtener_por_id(idcliente)
            if not cliente:
                print(f"‚ùå No existe cliente con ID {idcliente}")
                self.pausa()
                return
            
            datos_cliente = f"Cliente: {cliente['nombre']} {cliente['apellidos']}, Doc: {cliente['tipo_documento']}-{cliente['num_documento']}"
            
            print(f"\n¬øEst√° seguro de eliminar a {cliente['nombre']} {cliente['apellidos']}?")
            confirmacion = input("Esta acci√≥n no se puede deshacer (escriba 'ELIMINAR' para confirmar): ")
            
            if confirmacion == 'ELIMINAR':
                if self.cliente_service.eliminar(idcliente):
                    print("‚úÖ Cliente eliminado correctamente")
                    
                    self.registrar_auditoria(
                        accion="ELIMINAR",
                        tabla="cliente",
                        registro_id=idcliente,
                        datos_anteriores=datos_cliente
                    )
                else:
                    print("‚ùå Error al eliminar el cliente (puede tener ventas asociadas)")
            else:
                print("Operaci√≥n cancelada")
        
        except Exception as e:
            print(f"‚ùå Error: {e}")
        
        self.pausa()
    
    @requiere_permiso('articulos_ver')
    def menu_articulos(self):
        """Men√∫ de gesti√≥n de art√≠culos"""
        while True:
            self.mostrar_cabecera("GESTI√ìN DE ART√çCULOS")
            print("1. Listar art√≠culos")
            print("2. Buscar art√≠culo (por c√≥digo/nombre)")
            print("3. Crear art√≠culo")
            print("4. Editar art√≠culo")
            print("5. Eliminar art√≠culo")
            print("6. Ver stock por lote")
            print("7. üîç B√∫squeda avanzada (c√≥digo barras/PLU)")
            print("0. Volver")
            print()
            
            opcion = input(f"{self.COLOR_AMARILLO}üîπ Seleccione una opci√≥n: {self.COLOR_RESET}").strip()
            
            if opcion == '1':
                self._listar_articulos()
            elif opcion == '2':
                self._buscar_articulo()
            elif opcion == '3':
                self._crear_articulo()
            elif opcion == '4':
                self._editar_articulo()
            elif opcion == '5':
                self._eliminar_articulo()
            elif opcion == '6':
                self._ver_stock_lotes()
            elif opcion == '7':
                self._buscar_articulo_gestion()
            elif opcion == '0':
                break
            else:
                print("‚ùå Opci√≥n no v√°lida")
                self.pausa()
    
    @requiere_permiso('articulos_ver')
    def _listar_articulos(self):
        """Lista todos los art√≠culos con su stock actual"""
        self.mostrar_cabecera("LISTADO DE ART√çCULOS")
        
        try:
            from capa_negocio.inventario_service import InventarioService
            inventario_service = InventarioService(self.articulo_service)
            
            # Obtener art√≠culos con stock
            articulos = inventario_service.listar_con_stock()
            
            if not articulos:
                print(f"\n{self.COLOR_AMARILLO}üì≠ No hay art√≠culos registrados{self.COLOR_RESET}")
                self.pausa()
                return
            
            # Cabecera de la tabla
            print(f"\n{self.COLOR_VERDE}{'ID':<5} {'C√ìDIGO':<15} {'NOMBRE':<30} {'CATEGOR√çA':<20} {'PRECIO $':<10} {'STOCK':<10} {'ESTADO':<10}{self.COLOR_RESET}")
            print(f"{self.COLOR_CYAN}{'-'*110}{self.COLOR_RESET}")
            
            for a in articulos:
                id_art = a.get('idarticulo', '')
                codigo = a.get('codigo_barras', '')
                if not codigo:
                    codigo = a.get('codigo', '') or a.get('plu', '') or 'S/C'
                codigo = codigo[:14]
                
                nombre_base = a.get('nombre', '')
                letra_fiscal = a.get('letra_fiscal', '')
                if letra_fiscal:
                    nombre = f"{nombre_base} ({letra_fiscal})"[:29]
                else:
                    nombre = nombre_base[:29]
                categoria = a.get('categoria_nombre', a.get('categoria', 'Sin categor√≠a'))[:19]
                precio = a.get('precio_venta', 0)
                stock_actual = a.get('stock_actual', 0)
                stock_minimo = a.get('stock_minimo', 5)
                
                # Determinar color y emoji seg√∫n TU NUEVA L√ìGICA
                if stock_actual <= 5:
                    color_estado = self.COLOR_ROJO
                    emoji = "üî¥"
                    estado_texto = "CR√çTICO"
                elif stock_actual <= 10:
                    color_estado = self.COLOR_AMARILLO
                    emoji = "üü°"
                    estado_texto = "BAJO"
                else:
                    color_estado = self.COLOR_VERDE
                    emoji = "üü¢"
                    estado_texto = "NORMAL"
                
                # Formatear precio: entero sin decimales, decimal con 2 decimales
                if precio == int(precio):
                    precio_formateado = f"${int(precio)}"
                else:
                    precio_formateado = f"${precio:.2f}"
                
                # Formatear stock con "und"
                stock_formateado = f"{stock_actual} und"
                
                # Mostrar con color seg√∫n estado
                print(f"{id_art:<5} {codigo:<15} {nombre:<30} {categoria:<20} {precio_formateado:<10} {stock_formateado:<10} {color_estado}{emoji} {estado_texto}{self.COLOR_RESET}")
            
            print(f"{self.COLOR_CYAN}{'-'*110}{self.COLOR_RESET}")
            print(f"\n{self.COLOR_AMARILLO}Opciones de edici√≥n:{self.COLOR_RESET}")
            print(f"  {self.COLOR_VERDE}[E]{self.COLOR_RESET} Editar (categor√≠a, nombre)")
            print(f"  {self.COLOR_VERDE}[M]{self.COLOR_RESET} Editar solo PRECIO en d√≥lares $")
            print(f"  {self.COLOR_VERDE}[D]{self.COLOR_RESET} Ver DETALLES del art√≠culo")
            print(f"  {self.COLOR_ROJO}[V]{self.COLOR_RESET} Volver al men√∫")
            print(f"{self.COLOR_CYAN}{'-'*40}{self.COLOR_RESET}")
            
            opcion = input(f"\n{self.COLOR_AMARILLO}üîπ Seleccione: {self.COLOR_RESET}").strip().upper()
            
            if opcion == 'V':
                return
            elif opcion == 'E':
                self._buscar_articulo_para_editar()
            elif opcion == 'M':
                self._buscar_articulo_para_precio()
            elif opcion == 'D':
                self._buscar_articulo_para_detalle()
            else:
                print(f"{self.COLOR_ROJO}‚ùå Opci√≥n inv√°lida{self.COLOR_RESET}")
                self.pausa()
                
        except Exception as e:
            logger.error(f"Error en listado de art√≠culos: {e}")
            print(f"{self.COLOR_ROJO}‚ùå Error al listar art√≠culos: {e}{self.COLOR_RESET}")
            self.pausa()
    
    @requiere_permiso('articulos_crear')
    def _crear_articulo(self):
        """Crea un nuevo art√≠culo con precio de venta"""
        self.mostrar_cabecera("CREAR ART√çCULO")
        
        # Mostrar categor√≠as disponibles
        categorias = self.categoria_service.listar()
        if not categorias:
            print("‚ùå No hay categor√≠as. Cree una primero.")
            self.pausa()
            return
        
        print("Categor√≠as disponibles:")
        for c in categorias:
            print(f"  {c['idcategoria']}. {c['nombre']}")
        
        try:
            idcat = int(input("\nID de categor√≠a: "))
        except:
            print("‚ùå Categor√≠a inv√°lida")
            self.pausa()
            return
        
        # Mostrar presentaciones
        print("\nPresentaciones:")
        print("  1. Unidad")
        print("  2. Caja")
        print("  3. Kilogramo")
        
        try:
            idpres = int(input("ID de presentaci√≥n: "))
        except:
            print("‚ùå Presentaci√≥n inv√°lida")
            self.pausa()
            return
        
        print()
        codigo = input("C√≥digo del art√≠culo: ")
        nombre = input("Nombre del art√≠culo: ")
        descripcion = input("Descripci√≥n (opcional): ") or None
        
        # Solicitar precio de venta
        print("\nüí∞ PRECIO DE VENTA")
        print("="*40)
        try:
            precio_venta = float(input("Precio de venta (Bs.): "))
            if precio_venta < 0:
                print("‚ùå El precio no puede ser negativo")
                precio_venta = 0
        except:
            print("‚ùå Precio inv√°lido. Se asignar√° 0 por defecto.")
            precio_venta = 0
        
        # Solicitar precio de referencia (opcional)
        print("\nüì¶ PRECIO DE REFERENCIA (costo)")
        print("="*40)
        print("(Opcional - Enter para omitir)")
        try:
            precio_ref_input = input("Precio de referencia (costo): ").strip()
            if precio_ref_input:
                precio_referencia = float(precio_ref_input)
                if precio_referencia < 0:
                    precio_referencia = 0
            else:
                precio_referencia = None
        except:
            precio_referencia = None
        
        # Solicitar stock inicial
        print("\nüì¶ STOCK INICIAL")
        print("="*40)
        try:
            stock_inicial = int(input("Cantidad inicial: "))
            if stock_inicial < 0:
                print("‚ùå La cantidad no puede ser negativa")
                stock_inicial = 0
        except:
            print("‚ùå Cantidad inv√°lida. Se asignar√° 0 por defecto.")
            stock_inicial = 0
        
        if self.articulo_service.crear(
            codigo, nombre, idcat, idpres, descripcion, 
            precio_venta, precio_referencia
        ):
            print(f"\n{self.COLOR_VERDE}‚úÖ Art√≠culo creado exitosamente{self.COLOR_RESET}")
            
            # Buscar el ID del art√≠culo reci√©n creado
            articulo_nuevo = self.articulo_service.buscar_por_codigo(codigo)
            if articulo_nuevo:
                idarticulo = articulo_nuevo['idarticulo']
                
                # Registrar stock inicial en kardex
                if stock_inicial > 0:
                    self.inventario_service.reponer_stock(
                        idarticulo=idarticulo,
                        cantidad=stock_inicial,
                        idingreso=None,
                        precio_compra=precio_referencia or 0
                    )
                    print(f"   üì¶ Stock inicial: {stock_inicial} unidades")
                    print(f"   üí∞ Precio venta: Bs. {precio_venta:.2f}")
                    if precio_referencia:
                        print(f"   üí∞ Precio referencia: Bs. {precio_referencia:.2f}")
                
                self.registrar_auditoria(
                    accion="CREAR",
                    tabla="articulo",
                    registro_id=idarticulo,
                    datos_nuevos=f"Art√≠culo: {nombre}, C√≥digo: {codigo}, Precio: {precio_venta}"
                )
        else:
            print(f"\n{self.COLOR_ROJO}‚ùå Error al crear el art√≠culo{self.COLOR_RESET}")
        
        self.pausa()
    
    @requiere_permiso('articulos_ver')
    def _buscar_articulo(self):
        """Busca un art√≠culo por ID o c√≥digo"""
        self.mostrar_cabecera("BUSCAR ART√çCULO")
        
        print("1. Buscar por ID")
        print("2. Buscar por c√≥digo")
        opcion = input(f"{self.COLOR_AMARILLO}üîπ Seleccione: {self.COLOR_RESET}").strip()
        
        if opcion == '1':
            try:
                idart = int(input("ID del art√≠culo: "))
                art = self.articulo_service.obtener_por_id(idart)
                if art:
                    self._mostrar_detalle_articulo(art)
                    
                    self.registrar_auditoria(
                        accion="CONSULTAR",
                        tabla="articulo",
                        registro_id=idart,
                        datos_nuevos=f"Art√≠culo: {art['nombre']}"
                    )
                else:
                    print(f"‚ùå No existe art√≠culo con ID {idart}")
            except:
                print("‚ùå ID inv√°lido")
        
        elif opcion == '2':
            codigo = input("C√≥digo del art√≠culo: ")
            art = self.articulo_service.buscar_por_codigo(codigo)
            if art:
                art = self.articulo_service.obtener_por_id(art['idarticulo'])
                self._mostrar_detalle_articulo(art)
                
                self.registrar_auditoria(
                    accion="CONSULTAR",
                    tabla="articulo",
                    registro_id=art['idarticulo'],
                    datos_nuevos=f"Art√≠culo: {art['nombre']}, C√≥digo: {codigo}"
                )
            else:
                print(f"‚ùå No existe art√≠culo con c√≥digo {codigo}")
        
        self.pausa()
    
    def _mostrar_detalle_articulo(self, a):
        """Muestra detalles completos de un art√≠culo"""
        print(f"\nüìå ID: {a['idarticulo']}")
        print(f"üìå C√≥digo: {a['codigo']}")
        print(f"üìå Nombre: {a['nombre']}")
        print(f"üìå Categor√≠a: {a.get('categoria', 'N/A')}")
        print(f"üìå Presentaci√≥n: {a.get('presentacion', 'N/A')}")
        print(f"üìå Descripci√≥n: {a.get('descripcion', 'Sin descripci√≥n')}")
    
    @requiere_permiso('articulos_editar')
    def _editar_articulo(self):
        """Edita un art√≠culo existente mostrando stock actual"""
        self.mostrar_cabecera("EDITAR ART√çCULO")
        
        try:
            idart = int(input("ID del art√≠culo a editar: "))
            art = self.articulo_service.obtener_por_id(idart)
            
            if not art:
                print(f"‚ùå No existe art√≠culo con ID {idart}")
                self.pausa()
                return
            
            # Obtener stock actual
            stock_actual = self.inventario_service.obtener_stock_articulo(idart)
            nivel = self.inventario_service.obtener_nivel_stock(stock_actual)
            
            # Guardar datos anteriores para auditor√≠a
            datos_anteriores = f"Art√≠culo: {art['nombre']}, C√≥digo: {art['codigo']}, Stock: {stock_actual}"
            
            print(f"\nüìå Editando: {art['nombre']}")
            print(f"{nivel['color']}üì¶ Stock actual: {stock_actual} unidades {nivel['emoji']} {nivel['nivel']}{self.COLOR_RESET}")
            print("(Deje en blanco para mantener el valor actual)")
            print()
            
            codigo = input(f"C√≥digo [{art['codigo']}]: ") or art['codigo']
            nombre = input(f"Nombre [{art['nombre']}]: ") or art['nombre']
            descripcion = input(f"Descripci√≥n [{art.get('descripcion', '')}]: ") or art.get('descripcion')
            
            # Opci√≥n de ajustar stock
            print(f"\nüì¶ AJUSTE DE STOCK")
            print("="*40)
            print(f"Stock actual: {stock_actual} unidades")
            print("¬øDesea ajustar el stock?")
            print("1. S√≠, agregar stock")
            print("2. S√≠, quitar stock")
            print("3. No, mantener stock actual")
            opcion_stock = input(f"{self.COLOR_AMARILLO}üîπ Seleccione: {self.COLOR_RESET}").strip()
            
            if opcion_stock == '1':
                try:
                    cantidad = int(input("Cantidad a AGREGAR: "))
                    if cantidad > 0:
                        self.inventario_service.reponer_stock(
                            idarticulo=idart,
                            cantidad=cantidad,
                            idingreso=None,
                            precio_compra=0
                        )
                        print(f"{self.COLOR_VERDE}‚úÖ Stock aumentado: +{cantidad} unidades{self.COLOR_RESET}")
                        stock_actual += cantidad
                except:
                    print("‚ùå Cantidad inv√°lida")
            
            elif opcion_stock == '2':
                try:
                    cantidad = int(input("Cantidad a QUITAR: "))
                    if cantidad > 0 and cantidad <= stock_actual:
                        self.inventario_service.descontar_stock(
                            idarticulo=idart,
                            cantidad=cantidad,
                            idventa=None,
                            precio_unitario=0
                        )
                        print(f"{self.COLOR_VERDE}‚úÖ Stock disminuido: -{cantidad} unidades{self.COLOR_RESET}")
                        stock_actual -= cantidad
                    else:
                        print(f"‚ùå Cantidad inv√°lida o superior al stock actual ({stock_actual})")
                except:
                    print("‚ùå Cantidad inv√°lida")
            
            # Mostrar categor√≠as
            print("\nCategor√≠as disponibles:")
            categorias = self.categoria_service.listar()
            for c in categorias:
                print(f"  {c['idcategoria']}. {c['nombre']}")
            
            try:
                idcat = int(input(f"ID categor√≠a [{art['idcategoria']}]: ") or art['idcategoria'])
            except:
                idcat = art['idcategoria']
            
            # Presentaciones
            print("\nPresentaciones:")
            print("  1. Unidad")
            print("  2. Caja")
            print("  3. Kilogramo")
            
            try:
                idpres = int(input(f"ID presentaci√≥n [{art['idpresentacion']}]: ") or art['idpresentacion'])
            except:
                idpres = art['idpresentacion']
            
            if self.articulo_service.actualizar(idart, codigo, nombre, idcat, idpres, descripcion):
                print(f"\n{self.COLOR_VERDE}‚úÖ Art√≠culo actualizado correctamente{self.COLOR_RESET}")
                print(f"   üì¶ Stock final: {stock_actual} unidades")
                
                datos_nuevos = f"Art√≠culo: {nombre}, C√≥digo: {codigo}, Stock: {stock_actual}"
                self.registrar_auditoria(
                    accion="MODIFICAR",
                    tabla="articulo",
                    registro_id=idart,
                    datos_anteriores=datos_anteriores,
                    datos_nuevos=datos_nuevos
                )
            else:
                print(f"\n{self.COLOR_ROJO}‚ùå Error al actualizar el art√≠culo{self.COLOR_RESET}")
        
        except Exception as e:
            print(f"‚ùå Error: {e}")
        
        self.pausa()
    
    @requiere_permiso('articulos_eliminar')
    def _eliminar_articulo(self):
        """Elimina un art√≠culo"""
        self.mostrar_cabecera("ELIMINAR ART√çCULO")
        
        try:
            idart = int(input("ID del art√≠culo a eliminar: "))
            
            art = self.articulo_service.obtener_por_id(idart)
            if not art:
                print(f"‚ùå No existe art√≠culo con ID {idart}")
                self.pausa()
                return
            
            datos_articulo = f"Art√≠culo: {art['nombre']}, C√≥digo: {art['codigo']}"
            
            print(f"\n¬øEst√° seguro de eliminar {art['nombre']}?")
            confirmacion = input("Esta acci√≥n no se puede deshacer (escriba 'ELIMINAR' para confirmar): ")
            
            if confirmacion == 'ELIMINAR':
                if self.articulo_service.eliminar(idart):
                    print("‚úÖ Art√≠culo eliminado correctamente")
                    
                    self.registrar_auditoria(
                        accion="ELIMINAR",
                        tabla="articulo",
                        registro_id=idart,
                        datos_anteriores=datos_articulo
                    )
                else:
                    print("‚ùå Error al eliminar el art√≠culo (puede tener movimientos asociados)")
            else:
                print("Operaci√≥n cancelada")
        
        except Exception as e:
            print(f"‚ùå Error: {e}")
        
        self.pausa()
    
    @requiere_permiso('inventario_ver')
    def _ver_stock_lotes(self):
        """Ver stock por lotes de un art√≠culo"""
        self.mostrar_cabecera("STOCK POR LOTES")
        
        try:
            idart = int(input("ID del art√≠culo: "))
            art = self.articulo_service.obtener_por_id(idart)
            
            if not art:
                print(f"‚ùå No existe art√≠culo con ID {idart}")
                self.pausa()
                return
            
            print(f"\nArt√≠culo: {art['nombre']}")
            stock = self.inventario_service.obtener_stock_articulo(idart)
            nivel = self.inventario_service.obtener_nivel_stock(stock)
            
            print(f"Stock total: {stock} unidades")
            print(f"Estado: {nivel['color']}{nivel['emoji']} {nivel['nivel']}{self.inventario_service.COLOR_RESET}")
            print("üîß M√≥dulo de lotes en desarrollo")
            
        except Exception as e:
            print(f"‚ùå Error: {e}")
        
        self.pausa()
    
    @requiere_permiso('ventas_ver')
    def menu_ventas(self):
        """Men√∫ de gesti√≥n de ventas (con 3 opciones de identificaci√≥n)"""
        while True:
            self.mostrar_cabecera("GESTI√ìN DE VENTAS")
            print("1. Listar ventas")
            print("2. Registrar venta")
            print("3. Ver detalle de venta")
            print("4. Anular venta")
            print("0. Volver")
            print()
            
            opcion = input(f"{self.COLOR_AMARILLO}üîπ Seleccione una opci√≥n: {self.COLOR_RESET}").strip()
            
            if opcion == '1':
                self._listar_ventas()
            elif opcion == '2':
                self._registrar_venta()
            elif opcion == '3':
                self._ver_venta()
            elif opcion == '4':
                self._anular_venta()
            elif opcion == '0':
                break
            else:
                print("‚ùå Opci√≥n no v√°lida")
                self.pausa()

    @requiere_permiso('ventas_crear')
    def _registrar_venta(self):
        """Registra una nueva venta"""
        self.mostrar_cabecera("REGISTRAR VENTA - MULTIMONEDA")
        
        usuario = self.trabajador_service.get_usuario_actual()
        if not usuario:
            print(f"{self.COLOR_ROJO}‚ùå Debe iniciar sesi√≥n{self.COLOR_RESET}")
            self.pausa()
            return
        
        tasas = self.obtener_tasas_actuales()
        tasa_usd = tasas.get('USD', 0)
        
        if tasa_usd <= 0:
            print(f"{self.COLOR_AMARILLO}‚ö†Ô∏è Configure tasa con [X]{self.COLOR_RESET}")
            self.pausa()
            return
        
        # ===== SELECCI√ìN DE CLIENTE =====
        print("\nüìã IDENTIFICACI√ìN DEL CLIENTE")
        print("="*60)
        print("1. üáªüá™ RIF")
        print("2. üÜî C√©dula")
        print("3. üõí CONSUMIDOR FINAL")
        opcion = input(f"{self.COLOR_AMARILLO}üîπ Seleccione: {self.COLOR_RESET}").strip()
        
        idcliente = None
        cliente = None
        
        if opcion == '1' or opcion == '2':
            print("Buscar cliente... (simulado)")
            idcliente = 1
        # else: consumidor final (None)
        
        # ===== MONEDA DE PAGO =====
        print("\nüí≥ MONEDA DE PAGO")
        print("="*60)
        print("1. USD  2. VES  3. EUR")
        pago = input(f"{self.COLOR_AMARILLO}üîπ Seleccione: {self.COLOR_RESET}").strip()
        moneda_pago = {'1': 'USD', '2': 'VES', '3': 'EUR'}.get(pago, 'USD')
        
        # ===== COMPROBANTE =====
        print("\nüìÑ COMPROBANTE")
        print("="*60)
        print("1. Boleta  2. Ticket")
        tipo = input(f"{self.COLOR_AMARILLO}üîπ Seleccione: {self.COLOR_RESET}").strip()
        tipo_comp = 'BOLETA' if tipo == '1' else 'TICKET'
        serie = input("Serie: ").strip() or "F001"
        numero = input("N√∫mero: ").strip() or "001"
        
        # ===== PRODUCTOS (INTERFAZ LIMPIA) =====
        detalle = []
        print("\n" + "="*60)
        print("üõí PRODUCTOS")
        print("="*60)
        print(f"üí∞ Tasa: Bs. {tasa_usd:.2f}")
        print("üìå Opciones:")
        print("   [1] Buscar por nombre")
        print("   [2] Ingresar c√≥digo")
        print("   [3] Ver lista")
        print("   [4] Finalizar")
        print("="*60)
        
        while True:
            opt = input(f"{self.COLOR_AMARILLO}üîπ Opci√≥n: {self.COLOR_RESET}").strip()
            
            if opt == '4':
                break
                
            if opt == '3':
                self._mostrar_lista_articulos()
                cod = input("C√≥digo: ").strip()
                art = self.articulo_service.buscar_por_codigo(cod) or self.articulo_service.buscar_por_codigo_barras(cod)
                if not art:
                    print("‚ùå No encontrado")
                    continue
            elif opt == '2':
                cod = input("C√≥digo: ").strip()
                art = self.articulo_service.buscar_por_codigo(cod) or self.articulo_service.buscar_por_codigo_barras(cod)
                if not art:
                    print("‚ùå No encontrado")
                    continue
            elif opt == '1':
                nom = input("Nombre: ").strip()
                res = self.articulo_service.buscar_por_nombre(nom)
                if not res:
                    print("‚ùå No encontrado")
                    continue
                if len(res) == 1:
                    art = res[0]
                else:
                    for i, a in enumerate(res, 1):
                        print(f"  {i}. {a['nombre']}")
                    try:
                        s = int(input("Seleccione: ")) - 1
                        art = res[s] if 0 <= s < len(res) else None
                    except:
                        continue
                    if not art:
                        continue
            else:
                print("‚ùå Opci√≥n inv√°lida")
                continue
            
            # Procesar art√≠culo
            try:
                precio = float(art.get('precio_venta', 0))
            except:
                precio = 0.0
                
            stock = self.inventario_service.obtener_stock_articulo(art['idarticulo'])
            print(f"\nüìå {art['nombre']} - ${precio:.2f} - Stock: {stock}")
            
            try:
                cant = int(input("Cantidad: "))
                if cant <= 0 or cant > stock:
                    print("‚ùå Cantidad inv√°lida")
                    continue
            except:
                print("‚ùå Cantidad inv√°lida")
                continue
            
            subtotal = cant * precio
            print(f"   Subtotal: ${subtotal:.2f} = Bs. {subtotal * tasa_usd:.2f}")
            
            detalle.append({
                'idarticulo': art['idarticulo'],
                'cantidad': cant,
                'precio_venta': precio,
                'nombre': art['nombre']
            })
            print("‚úÖ Agregado")
        
        if not detalle:
            print("‚ùå Sin productos")
            self.pausa()
            return
        
        # ===== RESUMEN =====
        total = sum(d['cantidad'] * d['precio_venta'] for d in detalle)
        iva = total * 0.16
        total_iva = total + iva
        total_bs = total_iva * tasa_usd
        
        print("\n" + "="*60)
        print("üìã RESUMEN")
        print("="*60)
        for d in detalle:
            print(f"  {d['nombre']:<30} x{d['cantidad']}  ${d['precio_venta']:.2f}")
        print("-"*60)
        print(f"SUBTOTAL: ${total:.2f}")
        print(f"IVA 16%:  ${iva:.2f}")
        print(f"TOTAL:    ${total_iva:.2f} = Bs. {total_bs:.2f}")
        print("="*60)
        
        if input("¬øConfirmar? (s/N): ").lower() != 's':
            print("Cancelado")
            self.pausa()
            return
        
        # ===== REGISTRAR =====
        idv = self.venta_service.registrar(
            usuario['idtrabajador'], idcliente, tipo_comp,
            serie, numero, 16.0, detalle,
            moneda='USD', moneda_pago=moneda_pago, tasa_cambio=tasa_usd
        )
        
        if idv:
            print(f"\n‚úÖ Venta #{idv} registrada")
        else:
            print("‚ùå Error")
        
        self.pausa()

    def _continuar_flujo_venta(self, usuario, idcliente, cliente, opcion_ident):
        """Continuaci√≥n del flujo de venta despu√©s de seleccionar cliente"""
        
        # Obtener tasas actuales
        tasas_actuales = self.obtener_tasas_actuales()
        tasa_usd = tasas_actuales.get('USD', 0)
        
        # ===== MONEDA DE PAGO =====
        print("\n" + "="*60)
        print("üí≥ MONEDA DE PAGO")
        print("="*60)
        print("1. D√≥lares (USD)")
        print("2. Bol√≠vares (VES)")
        print("3. Euros (EUR)")
        opcion_pago = input(f"{self.COLOR_AMARILLO}üîπ Seleccione moneda de pago: {self.COLOR_RESET}").strip()
        
        moneda_pago_map = {'1': 'USD', '2': 'VES', '3': 'EUR'}
        moneda_pago = moneda_pago_map.get(opcion_pago, 'USD')
        
        # ===== DATOS DEL COMPROBANTE =====
        print("\n" + "="*60)
        print("üìÑ DATOS DEL COMPROBANTE")
        print("="*60)
        
        if opcion_ident == '1':
            print("Tipo de comprobante:")
            print("  1. Factura (con RIF)")
            tipo_op = '1'
            tipo_comprobante = 'FACTURA'
        elif opcion_ident == '2':
            print("Tipo de comprobante:")
            print("  1. Factura (con C√©dula)")
            print("  2. Boleta (consumo)")
            tipo_op = input(f"{self.COLOR_AMARILLO}Seleccione: {self.COLOR_RESET}").strip()
            tipo_comprobante = 'FACTURA' if tipo_op == '1' else 'BOLETA'
        else:
            print("Tipo de comprobante:")
            print("  1. Boleta (consumo final)")
            print("  2. Ticket (consumo final)")
            tipo_map = {'1': 'BOLETA', '2': 'TICKET'}
            tipo_op = input(f"{self.COLOR_AMARILLO}Seleccione: {self.COLOR_RESET}").strip()
            tipo_comprobante = tipo_map.get(tipo_op, 'BOLETA')
        
        serie = input("Serie (ej. F001): ")
        numero = input("N√∫mero: ")
        
        # ===== AGREGAR PRODUCTOS =====
        detalle = []
        print("\n" + "="*50)
        print("üõí AGREGAR PRODUCTOS")
        print("="*50)
        print(f"{self.COLOR_VERDE}üí° Use '?' para ver lista, '*' para b√∫squeda avanzada{self.COLOR_RESET}")
        print(f"{self.COLOR_AMARILLO}üí∞ Tasa USD actual: Bs. {tasa_usd:.2f}{self.COLOR_RESET}")
        
        while True:
            print("\n--- Agregar producto ---")
            entrada = input("C√≥digo/PLU (0=terminar, ?=lista, *=b√∫squeda): ").lower()
            
            if entrada == '0':
                break
            elif entrada == '?':
                self._mostrar_lista_articulos()
                continue
            elif entrada == '*':
                art = self._buscar_articulo_para_venta()
                if not art:
                    continue
            else:
                art = self.articulo_service.buscar_por_codigo(entrada)
                if not art:
                    art = self.articulo_service.buscar_por_codigo_barras(entrada)
            
            if not art:
                print(f"{self.COLOR_ROJO}‚ùå Art√≠culo no encontrado. Use '*' para b√∫squeda avanzada{self.COLOR_RESET}")
                continue
            
            precio_usd = art.get('precio_venta', 0)
            stock = self.inventario_service.obtener_stock_articulo(art['idarticulo'])
            
            print(f"üìå Art√≠culo: {art['nombre']}")
            print(f"   Precio: ${precio_usd:.2f} USD")
            print(f"   Stock: {stock} und")
            
            try:
                if art.get('tipo_medida') == 'PESO':
                    cantidad = float(input("Cantidad (kg): "))
                else:
                    cantidad = int(input("Cantidad (unidades): "))
                
                if cantidad > stock and art.get('tipo_medida') != 'PESO':
                    print(f"‚ùå Stock insuficiente")
                    continue
            except:
                print("‚ùå Cantidad inv√°lida")
                continue
            
            detalle.append({
                'idarticulo': art['idarticulo'],
                'cantidad': cantidad,
                'precio_venta': precio_usd,
                'nombre': art['nombre']
            })
            print(f"‚úÖ {art['nombre']} agregado")
        
        if not detalle:
            print("‚ùå Debe agregar al menos un producto")
            self.pausa()
            return
        
        # ===== RESUMEN =====
        total_usd = sum(item['cantidad'] * item['precio_venta'] for item in detalle)
        iva_usd = total_usd * 0.16
        total_con_iva_usd = total_usd + iva_usd
        total_bs = total_con_iva_usd * tasa_usd
        
        print("\n" + "="*50)
        print("üìã RESUMEN DE VENTA")
        print("="*50)
        for item in detalle:
            print(f"  - {item['nombre']}: {item['cantidad']} x ${item['precio_venta']:.2f} = ${item['cantidad'] * item['precio_venta']:.2f}")
        print(f"\nüí∞ TOTAL USD: ${total_con_iva_usd:.2f}")
        print(f"üí∞ TOTAL Bs.: Bs. {total_bs:.2f} (tasa {tasa_usd:.2f})")
        print("="*50)
        
        confirmar = input(f"{self.COLOR_AMARILLO}¬øConfirmar venta? (s/N): {self.COLOR_RESET}").lower()
        if confirmar != 's':
            print("Operaci√≥n cancelada")
            self.pausa()
            return
        
        # ===== REGISTRAR =====
        idventa = self.venta_service.registrar(
            usuario['idtrabajador'], 
            idcliente,
            tipo_comprobante,
            serie, 
            numero, 
            16.0,
            detalle,
            moneda='USD',
            moneda_pago=moneda_pago,
            tasa_cambio=tasa_usd
        )
        
        if idventa:
            print(f"\n{self.COLOR_VERDE}‚úÖ Venta #{idventa} registrada correctamente{self.COLOR_RESET}")
            self.registrar_auditoria(
                accion="CREAR",
                tabla="venta",
                registro_id=idventa,
                datos_nuevos=f"Venta #{idventa} - Total: ${total_con_iva_usd:.2f} (Bs. {total_bs:.2f})"
            )
        else:
            print(f"\n{self.COLOR_ROJO}‚ùå Error al registrar la venta{self.COLOR_RESET}")
        
        self.pausa()

    def _imprimir_factura_rapido(self, usuario):
        """Atajo para imprimir la √∫ltima factura o buscar por ID"""
        import platform
        sistema = platform.system()
        atajo = "F11" if sistema == "Windows" else "4"
        
        print(f"\n{self.COLOR_VERDE}üñ®Ô∏è IMPRIMIR FACTURA (Atajo {atajo}){self.COLOR_RESET}")
        print("="*60)
        print("1. Imprimir √∫ltima factura")
        print("2. Buscar factura por ID")
        print("3. Volver")
        opcion = input(f"{self.COLOR_AMARILLO}üîπ Seleccione: {self.COLOR_RESET}").strip()
        
        if opcion == '1':
            # Obtener la √∫ltima venta
            ventas = self.venta_service.listar()
            if ventas:
                ultima_venta = ventas[0]
                self._imprimir_factura(ultima_venta['idventa'])
            else:
                print(f"{self.COLOR_ROJO}‚ùå No hay ventas registradas{self.COLOR_RESET}")
                self.pausa()
        
        elif opcion == '2':
            try:
                idventa = int(input("ID de la factura a imprimir: "))
                self._imprimir_factura(idventa)
            except:
                print(f"{self.COLOR_ROJO}‚ùå ID inv√°lido{self.COLOR_RESET}")
                self.pausa()
        
        return self._registrar_venta()

    def _imprimir_factura(self, idventa):
        """Imprime una factura en formato texto"""
        venta = self.venta_service.obtener_por_id(idventa)
        
        if not venta:
            print(f"{self.COLOR_ROJO}‚ùå Factura {idventa} no encontrada{self.COLOR_RESET}")
            return
        
        print("\n" + "="*50)
        print("üñ®Ô∏è IMPRIMIENDO FACTURA")
        print("="*50)
        print(f"FACTURA #{venta['idventa']}")
        print(f"Fecha: {venta['fecha']}")
        print(f"Cliente: {venta.get('cliente', 'CONSUMIDOR FINAL')}")
        print(f"Comprobante: {venta['tipo_comprobante']} {venta['serie']}-{venta['numero_comprobante']}")
        print("-"*50)
        print("PRODUCTOS:")
        total = 0
        for d in venta.get('detalle', []):
            subtotal = d['cantidad'] * d['precio_venta']
            total += subtotal
            print(f"  {d['articulo']} x{d['cantidad']} @ {d['precio_venta']:.2f} = {subtotal:.2f}")
        print("-"*50)
        print(f"TOTAL: {total:.2f}")
        print("="*50)
        print("¬°Gracias por su compra!")
        print("="*50)
        
        # Aqu√≠ ir√≠a la l√≥gica para enviar a impresora f√≠sica
        print(f"\n{self.COLOR_VERDE}‚úÖ Factura enviada a imprimir{self.COLOR_RESET}")
        self.pausa()

    def _buscar_por_cedula_rapido(self, usuario):
        """B√∫squeda r√°pida por c√©dula (compatible Windows/Linux)"""
        import platform
        sistema = platform.system()
        atajo = "F9" if sistema == "Windows" else "2"
        print(f"\n{self.COLOR_VERDE}üîç B√öSQUEDA R√ÅPIDA POR C√âDULA (Atajo {atajo}){self.COLOR_RESET}")
        print("="*60)
        
        cedula = input("Ingrese c√©dula (ej: V12345678): ").upper()
        
        if not (cedula.startswith('V') or cedula.startswith('E')):
            print(f"{self.COLOR_ROJO}‚ùå Formato inv√°lido{self.COLOR_RESET}")
            self.pausa()
            return self._registrar_venta()
        
        cliente_simple = self.cliente_service.buscar_por_documento(cedula)
        
        if cliente_simple:
            idcliente = cliente_simple['idcliente']
            cliente = self.cliente_service.obtener_por_id(idcliente)
            print(f"{self.COLOR_VERDE}‚úÖ Cliente encontrado: {cliente['nombre']} {cliente['apellidos']}{self.COLOR_RESET}")
            
            if cliente['tipo_documento'] in ['V', 'E']:
                opcion_ident = '2'
            else:
                opcion_ident = '1'
            
            return self._continuar_flujo_venta(usuario, idcliente, cliente, opcion_ident)
        else:
            print(f"{self.COLOR_AMARILLO}‚ö†Ô∏è Cliente no encontrado{self.COLOR_RESET}")
            print("1. Registrar nuevo cliente")
            print("2. Continuar como consumidor final")
            print("3. Volver")
            opcion = input(f"{self.COLOR_AMARILLO}üîπ Seleccione: {self.COLOR_RESET}").strip()
            
            if opcion == '1':
                self._crear_cliente()
                return self._registrar_venta()
            elif opcion == '2':
                return self._continuar_venta_consumidor_final(usuario)
            else:
                return self._registrar_venta()

    def _buscar_por_rif_rapido(self, usuario):
        """B√∫squeda r√°pida por RIF (compatible Windows/Linux)"""
        import platform
        sistema = platform.system()
        atajo = "F10" if sistema == "Windows" else "3"
        print(f"\n{self.COLOR_VERDE}üîç B√öSQUEDA R√ÅPIDA POR RIF (Atajo {atajo}){self.COLOR_RESET}")
        print("="*60)
        
        rif = input("Ingrese RIF (ej: J123456789): ").upper()
        
        if not rif:
            print(f"{self.COLOR_ROJO}‚ùå RIF no ingresado{self.COLOR_RESET}")
            self.pausa()
            return self._registrar_venta()
        
        cliente_simple = self.cliente_service.buscar_por_documento(rif)
        
        if cliente_simple:
            idcliente = cliente_simple['idcliente']
            cliente = self.cliente_service.obtener_por_id(idcliente)
            print(f"{self.COLOR_VERDE}‚úÖ Cliente encontrado: {cliente['nombre']} {cliente['apellidos']}{self.COLOR_RESET}")
            
            if cliente['tipo_documento'] in ['J', 'G', 'C']:
                opcion_ident = '1'
            else:
                opcion_ident = '2'
            
            return self._continuar_flujo_venta(usuario, idcliente, cliente, opcion_ident)
        else:
            print(f"{self.COLOR_AMARILLO}‚ö†Ô∏è Cliente con RIF {rif} no encontrado{self.COLOR_RESET}")
            print("1. Registrar nuevo cliente")
            print("2. Volver")
            opcion = input(f"{self.COLOR_AMARILLO}üîπ Seleccione: {self.COLOR_RESET}").strip()
            
            if opcion == '1':
                self._crear_cliente()
                return self._registrar_venta()
            else:
                return self._registrar_venta()

    def _continuar_venta_consumidor_final(self, usuario):
        """Contin√∫a con venta a consumidor final"""
        print(f"\n{self.COLOR_VERDE}üõí Venta a CONSUMIDOR FINAL{self.COLOR_RESET}")
        idcliente = None
        cliente = None
        opcion_ident = '3'
        
        return self._continuar_flujo_venta(usuario, idcliente, cliente, opcion_ident)
    
    def _continuar_venta_con_cliente(self, idcliente, cliente):
        """Contin√∫a el flujo de venta con un cliente ya seleccionado"""
        # Aqu√≠ ir√≠a la continuaci√≥n de la venta
        # Por ahora, redirigimos al m√©todo principal con los datos
        print(f"\nContinuando venta con cliente: {cliente['nombre']} {cliente['apellidos']}")
        # Este m√©todo deber√≠a continuar con el flujo normal
        # Por ahora, volvemos al men√∫ principal de ventas
        self.pausa()
        self.menu_ventas()
    
    def _mostrar_lista_articulos(self):
        """Muestra lista de art√≠culos disponibles con precios"""
        articulos = self.articulo_service.listar()
        print("\n" + "="*107)
        print("üìã LISTADO DE ART√çCULOS DISPONIBLES")
        print("="*107)
        print(f"{'ID':<5} {'C√ìDIGO':<15} {'NOMBRE':<30} {'CATEGOR√çA':<20} {'PRECIO $':<12} {'STOCK':<10}")
        print("-" * 107)
        for a in articulos:
            stock = self.inventario_service.obtener_stock_articulo(a['idarticulo'])
            precio = float(a.get('precio_venta', 0))
            
            # Formatear precio
            if precio == int(precio):
                precio_str = f"${int(precio)}"
            else:
                precio_str = f"${precio:.2f}".rstrip('0').rstrip('.')
            
            print(f"{a['idarticulo']:<5} {a['codigo']:<15} {a['nombre']:<30} {a.get('categoria', 'N/A'):<20} {precio_str:<12} {stock} und")
        print("-" * 107)

    # ======================================================
    # NUEVOS M√âTODOS DE B√öSQUEDA PARA VENTAS
    # ======================================================
    
    def _buscar_articulo_para_venta(self):
        """
        Men√∫ de b√∫squeda de art√≠culos durante la venta
        """
        self.mostrar_cabecera("üîç BUSCAR ART√çCULO")
        
        print("Opciones de b√∫squeda:")
        print("1. üîé Escanear c√≥digo de barras")
        print("2. ‚å®Ô∏è Ingresar c√≥digo manualmente")
        print("3. üìù Buscar por nombre")
        print("4. ‚Ü©Ô∏è Volver")
        
        opcion = input(f"{self.COLOR_AMARILLO}üîπ Seleccione: {self.COLOR_RESET}").strip()
        
        if opcion == '1':
            codigo = input("Ingrese c√≥digo de barras: ").strip()
            return self._buscar_articulo_por_codigo(codigo)
        
        elif opcion == '2':
            codigo = input("Ingrese c√≥digo manual: ").strip()
            art = self.articulo_service.buscar_por_codigo(codigo)
            if not art:
                art = self.articulo_service.buscar_por_codigo_barras(codigo)
            if art:
                return art
            print(f"{self.COLOR_ROJO}‚ùå Art√≠culo no encontrado{self.COLOR_RESET}")
            return None
        
        elif opcion == '3':
            termino = input("Ingrese nombre: ").strip()
            # CORREGIDO: usar _buscar_articulo_por_nombre en lugar de _buscar_por_nombre
            return self._buscar_articulo_por_nombre(termino)
        
        else:
            return None
    
    def _buscar_articulo_por_codigo(self, codigo):
        """
        NUEVO: Busca art√≠culo por c√≥digo de barras (con soporte para balanza)
        """
        # Intentar buscar por c√≥digo de barras exacto
        articulo = self.articulo_service.buscar_por_codigo_barras(codigo)
        
        if articulo:
            return articulo
        
        # Si no encuentra, verificar si es c√≥digo de balanza (prefijo 21)
        if codigo.startswith('21') and len(codigo) == 13:
            return self._procesar_codigo_balanza(codigo)
        
        print(f"{self.COLOR_ROJO}‚ùå Art√≠culo no encontrado{self.COLOR_RESET}")
        return None
    
    def _procesar_codigo_balanza(self, codigo):
        """
        Procesa c√≥digos de balanza (prefijo 21)
        """
        try:
            # Extraer PLU (posiciones 3-7)
            plu = codigo[2:7].lstrip('0') or '0'
            
            # Extraer peso (posiciones 8-12) convertido a kg
            peso_gramos = int(codigo[7:12])
            peso_kg = peso_gramos / 1000
            
            # Buscar art√≠culo por PLU
            articulo = self.articulo_service.buscar_por_plu(plu)
            
            if articulo:
                # Crear una copia del art√≠culo con datos calculados
                resultado = articulo.copy()
                
                if articulo.get('es_pesado'):
                    precio_por_kilo = float(articulo.get('precio_por_kilo', 0))
                    precio_calculado = precio_por_kilo * peso_kg
                    resultado['precio_calculado'] = precio_calculado
                    resultado['cantidad'] = peso_kg
                    resultado['unidad'] = 'kg'
                    print(f"‚úÖ {articulo['nombre']} - {peso_kg:.3f} kg")
                
                return resultado
            
        except Exception as e:
            logger.error(f"Error procesando c√≥digo de balanza: {e}")
        
        return None
    
    def _buscar_articulo_por_nombre(self, termino):
        """
        NUEVO: Busca art√≠culos por nombre y muestra lista para seleccionar
        """
        resultados = self.articulo_service.buscar_por_nombre(termino)
        
        if not resultados:
            print(f"{self.COLOR_ROJO}‚ùå No se encontraron art√≠culos{self.COLOR_RESET}")
            return None
        
        print(f"\n{self.COLOR_VERDE}üìã RESULTADOS ({len(resultados)}):{self.COLOR_RESET}")
        print(f"{'#':<3} {'C√ìDIGO':<15} {'NOMBRE':<50} {'PRECIO':<10}")
        print("-" * 78)
        
        for i, art in enumerate(resultados, 1):
            precio = art.get('precio_venta', 0)
            print(f"{i:<3} {art['codigo']:<15} {art['nombre']:<50} {precio:>10.2f}")
        
        try:
            seleccion = input(f"\n{self.COLOR_AMARILLO}Seleccione n√∫mero (Enter para cancelar): {self.COLOR_RESET}").strip()
            if seleccion:
                idx = int(seleccion) - 1
                if 0 <= idx < len(resultados):
                    return resultados[idx]
        except:
            pass
        
        return None

    # ======================================================
    # NUEVOS M√âTODOS DE B√öSQUEDA PARA GESTI√ìN DE ART√çCULOS
    # ======================================================
    
    def _buscar_articulo_gestion(self):
        """
        NUEVO: Busca art√≠culos en gesti√≥n (por c√≥digo o nombre)
        """
        self.mostrar_cabecera("üîç BUSCAR ART√çCULO")
        
        print("Buscar por:")
        print("1. üì¶ C√≥digo de barras")
        print("2. üìù Nombre")
        print("3. üî¢ C√≥digo interno (PLU)")
        print("4. ‚Ü©Ô∏è Volver")
        
        opcion = input(f"{self.COLOR_AMARILLO}üîπ Seleccione: {self.COLOR_RESET}").strip()
        
        if opcion == '1':
            codigo = input("Ingrese c√≥digo de barras: ").strip()
            self._mostrar_resultado_busqueda(codigo, 'codigo')
        
        elif opcion == '2':
            termino = input("Ingrese nombre: ").strip()
            self._mostrar_resultado_busqueda(termino, 'nombre')
        
        elif opcion == '3':
            plu = input("Ingrese PLU: ").strip()
            self._mostrar_resultado_busqueda(plu, 'plu')
        
        self.pausa()
    
    def _mostrar_resultado_busqueda(self, valor, tipo):
        """
        Muestra resultados de b√∫squeda seg√∫n el tipo
        """
        if tipo == 'codigo':
            articulo = self.articulo_service.buscar_por_codigo_barras(valor)
            if articulo:
                self._mostrar_detalle_articulo(articulo)
            else:
                print(f"{self.COLOR_ROJO}‚ùå Art√≠culo no encontrado{self.COLOR_RESET}")
        
        elif tipo == 'plu':
            articulo = self.articulo_service.buscar_por_plu(valor)
            if articulo:
                self._mostrar_detalle_articulo(articulo)
            else:
                print(f"{self.COLOR_ROJO}‚ùå Art√≠culo con PLU {valor} no encontrado{self.COLOR_RESET}")
        
        elif tipo == 'nombre':
            resultados = self.articulo_service.buscar_por_nombre(valor)
            if resultados:
                print(f"\n{self.COLOR_VERDE}üìã RESULTADOS ({len(resultados)}):{self.COLOR_RESET}")
                print(f"{'ID':<5} {'C√ìDIGO':<15} {'NOMBRE':<40} {'PRECIO':<12}")
                print("-" * 72)
                for art in resultados:
                    precio = art.get('precio_venta', 0)
                    print(f"{art['idarticulo']:<5} {art['codigo']:<15} {art['nombre']:<40} Bs.{precio:>10,.2f}")
                
                # Opci√≥n de editar desde resultados
                print("\n" + "-" * 30)
                editar = input(f"{self.COLOR_AMARILLO}¬øEditar alg√∫n art√≠culo? (ID o Enter para continuar): {self.COLOR_RESET}").strip()
                if editar.isdigit():
                    self._editar_articulo_por_id(int(editar))
            else:
                print(f"{self.COLOR_ROJO}‚ùå No se encontraron art√≠culos{self.COLOR_RESET}")
    
    @requiere_permiso('ventas_ver')
    def _listar_ventas(self):
        """Lista todas las ventas con fecha, hora y montos"""
        self.mostrar_cabecera("LISTADO DE VENTAS")
        
        ventas = self.venta_service.listar()
        
        if not ventas:
            print("üì≠ No hay ventas registradas")
        else:
            # Cabecera con columna de MONTO
            print(f"{'ID':<5} {'FECHA Y HORA':<19} {'COMPROBANTE':<20} {'CLIENTE':<20} {'MONTO':<15} {'ESTADO':<10}")
            print("-" * 89)
            
            for v in ventas:
                comp = f"{v['tipo_comprobante']} {v['serie']}-{v['numero_comprobante']}"
                
                # Manejar cliente
                cliente_nombre = v.get('cliente')
                if cliente_nombre is None:
                    cliente_nombre = 'CONSUMIDOR FINAL'
                
                # Truncar cliente si es muy largo
                if len(cliente_nombre) > 20:
                    cliente_nombre = cliente_nombre[:17] + "..."
                
                # Determinar monto y moneda
                moneda = v.get('moneda', 'VES')
                
                if moneda == 'USD':
                    monto = v.get('monto_divisa', 0)
                    if monto:
                        monto_str = f"${monto:,.2f}"
                    else:
                        monto_str = "$0.00"
                elif moneda == 'EUR':
                    monto = v.get('monto_divisa', 0)
                    if monto:
                        monto_str = f"‚Ç¨{monto:,.2f}"
                    else:
                        monto_str = "‚Ç¨0.00"
                else:  # VES
                    monto = v.get('monto_bs', v.get('total', 0))
                    if monto:
                        monto_str = f"Bs. {monto:,.2f}".replace(',', ' ')
                    else:
                        monto_str = "Bs. 0.00"
                
                # Truncar monto si es muy largo
                if len(monto_str) > 15:
                    monto_str = monto_str[:12] + "..."
                
                print(f"{v['idventa']:<5} {v['fecha']:<19} {comp:<20} {cliente_nombre:<20} {monto_str:<15} {v['estado']:<10}")
        
        self.pausa()

    def _ver_venta(self):
        """Muestra detalle de una venta con hora exacta"""
        self.mostrar_cabecera("DETALLE DE VENTA")
        
        try:
            idventa = int(input("ID de la venta: "))
            venta = self.venta_service.obtener_por_id(idventa)
            
            if not venta:
                print(f"‚ùå No existe venta con ID {idventa}")
                self.pausa()
                return
            
            print(f"\nüìå Venta N¬∞: {venta['idventa']}")
            print(f"üìå Fecha y Hora: {venta['fecha']}")
            
            # CORREGIDO: Manejar cliente cuando es None
            cliente_nombre = venta.get('cliente')
            if cliente_nombre is None:
                cliente_nombre = 'CONSUMIDOR FINAL'
                
            print(f"üìå Cliente: {cliente_nombre}")
            print(f"üìå Comprobante: {venta['tipo_comprobante']} {venta['serie']}-{venta['numero_comprobante']}")
            print(f"üìå IGV: {venta['igv']}%")
            print(f"üìå Estado: {venta['estado']}")
            print(f"üìå Trabajador: {venta['trabajador']}")
            
            if venta.get('detalle'):
                print("\nüìã DETALLE:")
                total = 0
                for d in venta['detalle']:
                    subtotal = d['cantidad'] * d['precio_venta']
                    total += subtotal
                    print(f"   - {d['articulo']} x{d['cantidad']} @ {d['precio_venta']:.2f} = {subtotal:.2f}")
                print(f"\nüí∞ TOTAL: {total:.2f}")
                
            print("\nüìã REGISTROS DE AUDITOR√çA:")
            logs = self.auditoria_service.consultar_por_tabla("venta", idventa)
            for log in logs:
                fecha_log = log['fecha_hora'].strftime('%d/%m/%Y %H:%M') if hasattr(log['fecha_hora'], 'strftime') else log['fecha_hora']
                print(f"   - {fecha_log}: {log['accion']}")
        
        except Exception as e:
            print(f"‚ùå Error: {e}")
        
        self.pausa()
    def _anular_venta(self):
        """Anula una venta"""
        self.mostrar_cabecera("ANULAR VENTA")
        
        try:
            idventa = int(input("ID de la venta a anular: "))
            venta = self.venta_service.obtener_por_id(idventa)
            
            if not venta:
                print(f"‚ùå No existe venta con ID {idventa}")
                self.pausa()
                return
            
            if venta['estado'] == 'ANULADO':
                print("‚ö†Ô∏è Esta venta ya est√° anulada")
                self.pausa()
                return
            
            cliente_nombre = venta.get('cliente', 'CONSUMIDOR FINAL')
            print(f"\nVenta: {venta['idventa']} - {venta['fecha']}")
            print(f"Cliente: {cliente_nombre}")
            total = sum(d['cantidad'] * d['precio_venta'] for d in venta.get('detalle', []))
            print(f"Total: {total:.2f}")
            
            confirmacion = input(f"{self.COLOR_AMARILLO}\n¬øEst√° seguro de anular esta venta? (s/N): {self.COLOR_RESET}").lower()
            if confirmacion == 's':
                if self.venta_service.anular(idventa):
                    print(f"{self.COLOR_VERDE}‚úÖ Venta anulada correctamente{self.COLOR_RESET}")
                    
                    self.registrar_auditoria(
                        accion="ANULAR",
                        tabla="venta",
                        registro_id=idventa,
                        datos_nuevos=f"Venta #{idventa} anulada - Total: Bs.{total:.2f}"
                    )
                else:
                    print(f"{self.COLOR_ROJO}‚ùå Error al anular la venta{self.COLOR_RESET}")
            else:
                print("Operaci√≥n cancelada")
        
        except Exception as e:
            print(f"‚ùå Error: {e}")
        
        self.pausa()
    
    @requiere_permiso('proveedores_ver')
    def menu_proveedores(self):
        """Men√∫ de gesti√≥n de proveedores"""
        while True:
            self.mostrar_cabecera("GESTI√ìN DE PROVEEDORES")
            print("1. Listar proveedores")
            print("2. Buscar proveedor")
            print("3. Crear proveedor")
            print("4. Editar proveedor")
            print("5. Eliminar proveedor")
            print("6. üìÅ Ver todos los archivos de proveedores")
            print("0. Volver")
            print()
            
            opcion = input(f"{self.COLOR_AMARILLO}üîπ Seleccione una opci√≥n: {self.COLOR_RESET}").strip()
            
            if opcion == '1':
                self._listar_proveedores()
            elif opcion == '2':
                self._buscar_proveedor()
            elif opcion == '3':
                self._crear_proveedor()
            elif opcion == '4':
                self._editar_proveedor()
            elif opcion == '5':
                self._eliminar_proveedor()
            elif opcion == '6':
                self._listar_todos_archivos()
            elif opcion == '0':
                break
            else:
                print("‚ùå Opci√≥n no v√°lida")
                self.pausa()
    
    @requiere_permiso('proveedores_crear')
    def _crear_proveedor(self):
        """Crea un nuevo proveedor"""
        self.mostrar_cabecera("CREAR PROVEEDOR")
        
        print("üìù Complete los datos del proveedor:")
        print()
        
        razon_social = input("Raz√≥n Social / Nombre: ")
        sector = input("Sector Comercial: ")
        
        print("\n" + "="*60)
        print("üîç TIPO DE PERSONA - FORMATO DEL DOCUMENTO")
        print("="*60)
        print("1. üáªüá™ Persona Natural Venezolana  ‚Üí  V12345678")
        print("2. üåé Persona Natural Extranjera   ‚Üí  E87654321")
        print("3. üè¢ Persona Jur√≠dica (Empresa)   ‚Üí  J12345678")
        print("4. üèõÔ∏è Gobierno / Instituci√≥n        ‚Üí  G12345678")
        print("5. üë• Consejo Comunal               ‚Üí  C12345678")
        print("6. üõÇ Pasaporte                      ‚Üí  N√∫mero de pasaporte")
        print("="*60)
        
        tipo_persona = input("Seleccione tipo de persona (1-6): ").strip()
        
        if tipo_persona == '1':
            tipo_doc = 'V'
            print("\n‚úÖ Seleccion√≥: Persona Natural Venezolana (V)")
            print("üìù Formato requerido: V + 8 d√≠gitos")
            print("   Ejemplo: V12345678")
            num_doc = input("Documento completo: ").upper()
            
            if not num_doc.startswith('V'):
                print("‚ùå El documento debe comenzar con 'V'")
                self.pausa()
                return
            num_doc = num_doc[1:]
            
        elif tipo_persona == '2':
            tipo_doc = 'E'
            print("\n‚úÖ Seleccion√≥: Persona Natural Extranjera (E)")
            print("üìù Formato requerido: E + 8 d√≠gitos")
            print("   Ejemplo: E87654321")
            num_doc = input("Documento completo: ").upper()
            
            if not num_doc.startswith('E'):
                print("‚ùå El documento debe comenzar con 'E'")
                self.pausa()
                return
            num_doc = num_doc[1:]
            
        elif tipo_persona == '3':
            tipo_doc = 'J'
            print("\n‚úÖ Seleccion√≥: Empresa (J)")
            print("üìù Formato requerido: J + 8 d√≠gitos")
            print("   Ejemplo: J12345678")
            num_doc = input("Documento completo: ").upper()
            
            if not num_doc.startswith('J'):
                print("‚ùå El documento debe comenzar con 'J'")
                self.pausa()
                return
            num_doc = num_doc[1:]
            
        elif tipo_persona == '4':
            tipo_doc = 'G'
            print("\n‚úÖ Seleccion√≥: Gobierno / Instituci√≥n (G)")
            print("üìù Formato requerido: G + 8 d√≠gitos")
            print("   Ejemplo: G12345678")
            num_doc = input("Documento completo: ").upper()
            
            if not num_doc.startswith('G'):
                print("‚ùå El documento debe comenzar con 'G'")
                self.pausa()
                return
            num_doc = num_doc[1:]
            
        elif tipo_persona == '5':
            tipo_doc = 'C'
            print("\n‚úÖ Seleccion√≥: Consejo Comunal (C)")
            print("üìù Formato requerido: C + 8 d√≠gitos")
            print("   Ejemplo: C12345678")
            num_doc = input("Documento completo: ").upper()
            
            if not num_doc.startswith('C'):
                print("‚ùå El documento debe comenzar con 'C'")
                self.pausa()
                return
            num_doc = num_doc[1:]
            
        elif tipo_persona == '6':
            tipo_doc = 'PASAPORTE'
            print("\n‚úÖ Seleccion√≥: Pasaporte")
            print("üìù Ingrese n√∫mero de pasaporte (6-12 caracteres)")
            print("   Ejemplo: ABC123456")
            num_doc = input("Pasaporte: ").upper()
            
        else:
            print("‚ùå Opci√≥n no v√°lida")
            self.pausa()
            return
        
        direccion = input("\nDirecci√≥n (opcional): ") or None
        telefono = input("Tel√©fono (opcional): ") or None
        email = input("Email (opcional): ") or None
        url = input("URL (opcional): ") or None
        
        if self.proveedor_service.crear(
            razon_social, sector, tipo_doc, num_doc,
            direccion, telefono, email, url
        ):
            print("\n‚úÖ Proveedor creado exitosamente")
            
            self.registrar_auditoria(
                accion="CREAR",
                tabla="proveedor",
                registro_id=self.proveedor_service.buscar_por_documento(tipo_doc+num_doc)['idproveedor'],
                datos_nuevos=f"Proveedor: {razon_social}, Doc: {tipo_doc}-{num_doc}"
            )
        else:
            print("\n‚ùå Error al crear el proveedor")
        
        self.pausa()
    
    @requiere_permiso('proveedores_ver')
    def _listar_proveedores(self):
        """Lista todos los proveedores"""
        self.mostrar_cabecera("LISTADO DE PROVEEDORES")
        
        proveedores = self.proveedor_service.listar()
        
        if not proveedores:
            print("üì≠ No hay proveedores registrados")
        else:
            print(f"{'ID':<5} {'RAZ√ìN SOCIAL':<30} {'DOCUMENTO':<20} {'TEL√âFONO':<15} {'ARCHIVOS':<10}")
            print("-" * 80)
            for p in proveedores:
                archivos = self.proveedor_archivo_service.listar_archivos_proveedor(p['idproveedor'])
                tiene_archivos = "üìÅ" if archivos else ""
                documento = f"{p['tipo_documento']}-{p['num_documento']}"
                telefono_val = p.get('telefono', '') or ''
                print(f"{p['idproveedor']:<5} {p['razon_social']:<30} {documento:<20} {telefono_val:<15} {tiene_archivos:<10}")
        
        self.pausa()
    
    @requiere_permiso('proveedores_ver')
    def _buscar_proveedor(self):
        """Busca un proveedor por ID o documento"""
        self.mostrar_cabecera("BUSCAR PROVEEDOR")
        
        print("1. Buscar por ID")
        print("2. Buscar por documento")
        opcion = input(f"{self.COLOR_AMARILLO}üîπ Seleccione: {self.COLOR_RESET}").strip()
        
        if opcion == '1':
            try:
                idprov = int(input("ID del proveedor: "))
                proveedor = self.proveedor_service.obtener_por_id(idprov)
                if proveedor:
                    self._mostrar_detalle_proveedor(proveedor)
                    
                    self.registrar_auditoria(
                        accion="CONSULTAR",
                        tabla="proveedor",
                        registro_id=idprov,
                        datos_nuevos=f"Proveedor: {proveedor['razon_social']}"
                    )
                else:
                    print(f"‚ùå No existe proveedor con ID {idprov}")
            except:
                print("‚ùå ID inv√°lido")
        
        elif opcion == '2':
            doc = input("N√∫mero de documento (ej: J12345678): ").upper()
            if doc and doc[0] in ['V', 'E', 'J', 'G', 'C']:
                tipo = doc[0]
                numero = doc[1:]
                proveedores = self.proveedor_service.listar()
                encontrado = None
                for p in proveedores:
                    if p['tipo_documento'] == tipo and p['num_documento'] == numero:
                        encontrado = p
                        break
                if encontrado:
                    self._mostrar_detalle_proveedor(encontrado)
                    
                    self.registrar_auditoria(
                        accion="CONSULTAR",
                        tabla="proveedor",
                        registro_id=encontrado['idproveedor'],
                        datos_nuevos=f"B√∫squeda por documento: {doc}"
                    )
                else:
                    print(f"‚ùå No existe proveedor con documento {doc}")
            else:
                print("‚ùå Formato de documento inv√°lido")
        
        self.pausa()
    
    def _mostrar_detalle_proveedor(self, p):
        """Muestra detalles completos de un proveedor"""
        print(f"\nüìå ID: {p['idproveedor']}")
        print(f"üìå Raz√≥n Social: {p['razon_social']}")
        print(f"üìå Sector Comercial: {p.get('sector_comercial', 'No especificado')}")
        print(f"üìå Documento: {p['tipo_documento']}-{p['num_documento']}")
        print(f"üìå Direcci√≥n: {p.get('direccion', 'No registrada')}")
        print(f"üìå Tel√©fono: {p.get('telefono', 'No registrado')}")
        print(f"üìå Email: {p.get('email', 'No registrado')}")
        print(f"üìå URL: {p.get('url', 'No registrada')}")
        
        archivos = self.proveedor_archivo_service.listar_archivos_proveedor(p['idproveedor'])
        if archivos:
            print(f"\nüìÅ ARCHIVOS ASOCIADOS ({len(archivos)}):")
            for a in archivos:
                tamano = self.proveedor_archivo_service.obtener_tamano_legible(a['tamano'])
                print(f"   - {a['nombre_archivo']} ({tamano})")
        else:
            print("\nüìÅ No hay archivos asociados")
    
    @requiere_permiso('proveedores_editar')
    def _editar_proveedor(self):
        """Edita un proveedor existente"""
        self.mostrar_cabecera("EDITAR PROVEEDOR")
        
        try:
            idprov = int(input("ID del proveedor a editar: "))
            proveedor = self.proveedor_service.obtener_por_id(idprov)
            
            if not proveedor:
                print(f"‚ùå No existe proveedor con ID {idprov}")
                self.pausa()
                return
            
            print(f"\nEditando: {proveedor['razon_social']}")
            print("(Deje en blanco para mantener el valor actual)")
            print()
            
            datos_anteriores = f"Proveedor: {proveedor['razon_social']}, Doc: {proveedor['tipo_documento']}-{proveedor['num_documento']}"
            
            razon = input(f"Raz√≥n Social [{proveedor['razon_social']}]: ") or proveedor['razon_social']
            sector = input(f"Sector Comercial [{proveedor['sector_comercial']}]: ") or proveedor['sector_comercial']
            
            print("\n¬øCambiar tipo de documento? (s/N): ", end="")
            cambiar_tipo = input().lower()
            
            if cambiar_tipo == 's':
                print("\n" + "="*60)
                print("üîç NUEVO TIPO DE DOCUMENTO")
                print("="*60)
                print("1. üáªüá™ Venezolano (V) ‚Üí V12345678")
                print("2. üåé Extranjero (E) ‚Üí E87654321")
                print("3. üè¢ Empresa (J) ‚Üí J12345678")
                print("4. üèõÔ∏è Gobierno (G) ‚Üí G12345678")
                print("5. üë• Consejo Comunal (C) ‚Üí C12345678")
                print("6. üõÇ Pasaporte ‚Üí texto libre")
                print("="*60)
                
                tipo_op = input("Seleccione nuevo tipo (1-6): ").strip()
                
                if tipo_op == '1':
                    tipo_doc = 'V'
                    print("Ingrese documento completo (ej: V12345678):")
                    doc_completo = input("Documento: ").upper()
                    if doc_completo.startswith('V'):
                        num_doc = doc_completo[1:]
                    else:
                        print("‚ùå Debe comenzar con V")
                        self.pausa()
                        return
                elif tipo_op == '2':
                    tipo_doc = 'E'
                    print("Ingrese documento completo (ej: E87654321):")
                    doc_completo = input("Documento: ").upper()
                    if doc_completo.startswith('E'):
                        num_doc = doc_completo[1:]
                    else:
                        print("‚ùå Debe comenzar con E")
                        self.pausa()
                        return
                elif tipo_op == '3':
                    tipo_doc = 'J'
                    print("Ingrese documento completo (ej: J12345678):")
                    doc_completo = input("Documento: ").upper()
                    if doc_completo.startswith('J'):
                        num_doc = doc_completo[1:]
                    else:
                        print("‚ùå Debe comenzar con J")
                        self.pausa()
                        return
                elif tipo_op == '4':
                    tipo_doc = 'G'
                    print("Ingrese documento completo (ej: G12345678):")
                    doc_completo = input("Documento: ").upper()
                    if doc_completo.startswith('G'):
                        num_doc = doc_completo[1:]
                    else:
                        print("‚ùå Debe comenzar con G")
                        self.pausa()
                        return
                elif tipo_op == '5':
                    tipo_doc = 'C'
                    print("Ingrese documento completo (ej: C12345678):")
                    doc_completo = input("Documento: ").upper()
                    if doc_completo.startswith('C'):
                        num_doc = doc_completo[1:]
                    else:
                        print("‚ùå Debe comenzar con C")
                        self.pausa()
                        return
                elif tipo_op == '6':
                    tipo_doc = 'PASAPORTE'
                    num_doc = input("N√∫mero de pasaporte: ").upper()
                else:
                    print("‚ùå Opci√≥n no v√°lida")
                    self.pausa()
                    return
            else:
                tipo_doc = proveedor['tipo_documento']
                num_doc = proveedor['num_documento']
            
            direccion = input(f"Direcci√≥n [{proveedor.get('direccion', '')}]: ") or proveedor.get('direccion')
            telefono = input(f"Tel√©fono [{proveedor.get('telefono', '')}]: ") or proveedor.get('telefono')
            email = input(f"Email [{proveedor.get('email', '')}]: ") or proveedor.get('email')
            url = input(f"URL [{proveedor.get('url', '')}]: ") or proveedor.get('url')
            
            if self.proveedor_service.actualizar(
                idprov, razon, sector, tipo_doc, num_doc,
                direccion, telefono, email, url
            ):
                print("\n‚úÖ Proveedor actualizado correctamente")
                
                datos_nuevos = f"Proveedor: {razon}, Doc: {tipo_doc}-{num_doc}"
                self.registrar_auditoria(
                    accion="MODIFICAR",
                    tabla="proveedor",
                    registro_id=idprov,
                    datos_anteriores=datos_anteriores,
                    datos_nuevos=datos_nuevos
                )
            else:
                print("\n‚ùå Error al actualizar el proveedor")
        
        except Exception as e:
            print(f"‚ùå Error: {e}")
        
        self.pausa()
    
    @requiere_permiso('proveedores_eliminar')
    def _eliminar_proveedor(self):
        """Elimina un proveedor"""
        self.mostrar_cabecera("ELIMINAR PROVEEDOR")
        
        try:
            idprov = int(input("ID del proveedor a eliminar: "))
            
            proveedor = self.proveedor_service.obtener_por_id(idprov)
            if not proveedor:
                print(f"‚ùå No existe proveedor con ID {idprov}")
                self.pausa()
                return
            
            datos_proveedor = f"Proveedor: {proveedor['razon_social']}, Doc: {proveedor['tipo_documento']}-{proveedor['num_documento']}"
            
            print(f"\n¬øEst√° seguro de eliminar a {proveedor['razon_social']}?")
            confirmacion = input("Esta acci√≥n no se puede deshacer (escriba 'ELIMINAR' para confirmar): ")
            
            if confirmacion == 'ELIMINAR':
                if self.proveedor_service.eliminar(idprov):
                    print("‚úÖ Proveedor eliminado correctamente")
                    
                    self.registrar_auditoria(
                        accion="ELIMINAR",
                        tabla="proveedor",
                        registro_id=idprov,
                        datos_anteriores=datos_proveedor
                    )
                else:
                    print("‚ùå Error al eliminar el proveedor (puede tener ingresos asociados)")
            else:
                print("Operaci√≥n cancelada")
        
        except Exception as e:
            print(f"‚ùå Error: {e}")
        
        self.pausa()
    
    @requiere_permiso('proveedores_ver')
    def _menu_archivos_proveedor(self, idproveedor):
        """Men√∫ de archivos de un proveedor espec√≠fico"""
        proveedor = self.proveedor_service.obtener_por_id(idproveedor)
        if not proveedor:
            print(f"‚ùå No existe proveedor con ID {idproveedor}")
            self.pausa()
            return
        
        while True:
            self.mostrar_cabecera(f"ARCHIVOS DE: {proveedor['razon_social']}")
            
            archivos = self.proveedor_archivo_service.listar_archivos_proveedor(idproveedor)
            
            if archivos:
                print(f"üìã ARCHIVOS DE: {proveedor['razon_social']}")
                print(f"{'ID':<5} {'NOMBRE DEL ARCHIVO':<50} {'TIPO':<20} {'TAMA√ëO':<10} {'FECHA':<20}")
                print("-" * 105)
                for a in archivos:
                    tamano = self.proveedor_archivo_service.obtener_tamano_legible(a['tamano'])
                    fecha = a['fecha_subida'].strftime('%Y-%m-%d %H:%M') if a['fecha_subida'] else ''
                    nombre = a['nombre_archivo'][:47] + "..." if len(a['nombre_archivo']) > 47 else a['nombre_archivo']
                    print(f"{a['idarchivo']:<5} {nombre:<50} {a['tipo_archivo'][:18]:<20} {tamano:<10} {fecha:<20}")
                print()
            else:
                print(f"üì≠ No hay archivos para {proveedor['razon_social']}")
                print()
            
            print("1. Subir nuevo archivo")
            print("2. Descargar archivo")
            print("3. Eliminar archivo")
            print("0. Volver")
            print()
            
            opcion = input(f"{self.COLOR_AMARILLO}üîπ Seleccione una opci√≥n: {self.COLOR_RESET}").strip()
            
            if opcion == '1':
                self._subir_archivo_proveedor(idproveedor)
            elif opcion == '2':
                self._descargar_archivo_por_id_menu(idproveedor)
            elif opcion == '3':
                self._eliminar_archivo_por_id_menu(idproveedor)
            elif opcion == '0':
                break
            else:
                print("‚ùå Opci√≥n no v√°lida")
                self.pausa()
    
    @requiere_permiso('proveedores_editar')
    def _subir_archivo_proveedor(self, idproveedor):
        """Sube un archivo para un proveedor"""
        self.mostrar_cabecera("SUBIR ARCHIVO")
        
        print("üìÅ Formatos permitidos:")
        print("  - Im√°genes: .jpg, .png, .gif")
        print("  - Documentos: .pdf, .doc, .docx")
        print("  - Hojas de c√°lculo: .xls, .xlsx, .csv")
        print("  - Texto: .txt")
        print(f"  Tama√±o m√°ximo: 10 MB")
        print()
        
        ruta = input("Ruta completa del archivo: ").strip()
        ruta = ruta.replace('"', '').replace("'", "")
        
        if not os.path.exists(ruta):
            print("‚ùå El archivo no existe")
            self.pausa()
            return
        
        descripcion = input("Descripci√≥n (opcional): ").strip() or None
        
        idarchivo = self.proveedor_archivo_service.subir_archivo(idproveedor, ruta, descripcion)
        
        if idarchivo:
            print(f"‚úÖ Archivo subido correctamente (ID: {idarchivo})")
            
            self.registrar_auditoria(
                accion="SUBIR",
                tabla="proveedor_archivos",
                registro_id=idarchivo,
                datos_nuevos=f"Archivo subido para proveedor ID {idproveedor}: {os.path.basename(ruta)}"
            )
        else:
            print("‚ùå Error al subir el archivo")
        
        self.pausa()
    
    def _descargar_archivo_por_id(self, idarchivo):
        """Descarga un archivo por su ID"""
        archivo = self.proveedor_archivo_service.obtener_archivo(idarchivo)
        if not archivo:
            print(f"‚ùå No existe archivo con ID {idarchivo}")
            self.pausa()
            return
        
        print(f"\nüìå Archivo: {archivo['nombre_archivo']}")
        print(f"üìå Proveedor: {archivo['proveedor']}")
        print(f"üìå Tama√±o: {self.proveedor_archivo_service.obtener_tamano_legible(archivo['tamano'])}")
        print()
        
        ruta_destino = input("Ruta donde guardar (Enter para Descargas/): ").strip()
        if not ruta_destino:
            import os
            home = os.path.expanduser("~")
            ruta_destino = os.path.join(home, "Descargas", archivo['nombre_archivo'])
        
        if self.proveedor_archivo_service.guardar_archivo(idarchivo, ruta_destino):
            print(f"‚úÖ Archivo guardado en: {ruta_destino}")
            
            self.registrar_auditoria(
                accion="DESCARGAR",
                tabla="proveedor_archivos",
                registro_id=idarchivo,
                datos_nuevos=f"Archivo descargado: {archivo['nombre_archivo']}"
            )
        else:
            print("‚ùå Error al guardar el archivo")
        
        self.pausa()
    
    def _descargar_archivo_por_id_menu(self, idproveedor):
        try:
            idarchivo = int(input("ID del archivo a descargar: "))
            self._descargar_archivo_por_id(idarchivo)
        except ValueError:
            print("‚ùå ID inv√°lido")
            self.pausa()
    
    def _eliminar_archivo_por_id(self, idarchivo):
        confirmacion = input(f"¬øEst√° seguro de eliminar el archivo ID {idarchivo}? (s/N): ").lower()
        if confirmacion == 's':
            if self.proveedor_archivo_service.eliminar_archivo(idarchivo):
                print("‚úÖ Archivo eliminado correctamente")
                
                self.registrar_auditoria(
                    accion="ELIMINAR",
                    tabla="proveedor_archivos",
                    registro_id=idarchivo,
                    datos_anteriores=f"Archivo ID {idarchivo} eliminado"
                )
            else:
                print("‚ùå Error al eliminar el archivo")
        else:
            print("Operaci√≥n cancelada")
        
        self.pausa()
    
    def _eliminar_archivo_por_id_menu(self, idproveedor):
        try:
            idarchivo = int(input("ID del archivo a eliminar: "))
            self._eliminar_archivo_por_id(idarchivo)
        except ValueError:
            print("‚ùå ID inv√°lido")
            self.pausa()
    
    def _listar_todos_archivos(self):
        """Lista todos los archivos de todos los proveedores"""
        self.mostrar_cabecera("LISTA DE PROVEEDORES (ARCHIVOS)")
        
        proveedores = self.proveedor_service.listar()
        
        todos_archivos = []
        for p in proveedores:
            archivos = self.proveedor_archivo_service.listar_archivos_proveedor(p['idproveedor'])
            for a in archivos:
                a['proveedor_nombre'] = p['razon_social']
                a['proveedor_id'] = p['idproveedor']
                todos_archivos.append(a)
        
        if not todos_archivos:
            print("üì≠ No hay archivos subidos por ning√∫n proveedor")
            self.pausa()
            return
        
        print(f"{'ID':<5} {'PROVEEDOR':<25} {'NOMBRE DEL ARCHIVO':<50} {'TIPO':<20} {'TAMA√ëO':<10} {'FECHA':<15}")
        print("-" * 125)
        for a in todos_archivos:
            tamano = self.proveedor_archivo_service.obtener_tamano_legible(a['tamano'])
            fecha = a['fecha_subida'].strftime('%Y-%m-%d') if a['fecha_subida'] else ''
            nombre = a['nombre_archivo'][:47] + "..." if len(a['nombre_archivo']) > 47 else a['nombre_archivo']
            proveedor = a['proveedor_nombre'][:23] + "..." if len(a['proveedor_nombre']) > 23 else a['proveedor_nombre']
            print(f"{a['idarchivo']:<5} {proveedor:<25} {nombre:<50} {a['tipo_archivo'][:18]:<20} {tamano:<10} {fecha:<15}")
        print()
        
        while True:
            print("\nOpciones:")
            print("1. Descargar archivo por ID")
            print("2. Eliminar archivo por ID")
            print("3. Subir nuevo archivo (seleccionar proveedor)")
            print("4. Ver archivos de un proveedor espec√≠fico")
            print("0. Volver")
            print()
            
            opcion = input(f"{self.COLOR_AMARILLO}üîπ Seleccione una opci√≥n: {self.COLOR_RESET}").strip()
            
            if opcion == '1':
                try:
                    idarchivo = int(input("ID del archivo a descargar: "))
                    self._descargar_archivo_por_id(idarchivo)
                except ValueError:
                    print("‚ùå ID inv√°lido")
                    self.pausa()
            elif opcion == '2':
                try:
                    idarchivo = int(input("ID del archivo a eliminar: "))
                    self._eliminar_archivo_por_id(idarchivo)
                except ValueError:
                    print("‚ùå ID inv√°lido")
                    self.pausa()
            elif opcion == '3':
                self._subir_archivo_con_seleccion_proveedor()
            elif opcion == '4':
                try:
                    idprov = int(input("ID del proveedor: "))
                    self._menu_archivos_proveedor(idprov)
                except ValueError:
                    print("‚ùå ID inv√°lido")
                    self.pausa()
            elif opcion == '0':
                break
            else:
                print("‚ùå Opci√≥n no v√°lida")
                self.pausa()
    
    def _subir_archivo_con_seleccion_proveedor(self):
        proveedores = self.proveedor_service.listar()
        if not proveedores:
            print("‚ùå No hay proveedores registrados")
            self.pausa()
            return
        
        print("\nüìã PROVEEDORES DISPONIBLES:")
        print(f"{'ID':<5} {'RAZ√ìN SOCIAL':<30}")
        print("-" * 35)
        for p in proveedores:
            print(f"{p['idproveedor']:<5} {p['razon_social']:<30}")
        print()
        
        try:
            idproveedor = int(input("ID del proveedor: "))
            proveedor = self.proveedor_service.obtener_por_id(idproveedor)
            if not proveedor:
                print("‚ùå Proveedor no v√°lido")
                self.pausa()
                return
        except ValueError:
            print("‚ùå ID inv√°lido")
            self.pausa()
            return
        
        self._subir_archivo_proveedor(idproveedor)
    
    @requiere_permiso('inventario_ver')
    def menu_inventario(self):
        """Men√∫ de gesti√≥n de inventario"""
        while True:
            self.mostrar_cabecera("GESTI√ìN DE INVENTARIO")
            
            alertas = self.inventario_service.obtener_alertas_stock()
            if alertas:
                print("‚ö†Ô∏è ALERTAS DE STOCK:")
                for alerta in alertas[:3]:
                    print(f"   {alerta}")
                print()
            
            print("1. Ver stock completo")
            print("2. Ver resumen de inventario")
            print("3. Art√≠culos con stock cr√≠tico")
            print("4. Art√≠culos con stock bajo")
            print("5. Ver detalles de art√≠culo")
            print("6. Registrar ingreso de mercanc√≠a")
            print("0. Volver")
            print()
            
            opcion = input(f"{self.COLOR_AMARILLO}üîπ Seleccione una opci√≥n: {self.COLOR_RESET}").strip()
            
            if opcion == '1':
                self._ver_stock_completo()
            elif opcion == '2':
                self._ver_resumen_inventario()
            elif opcion == '3':
                self._ver_stock_critico()
            elif opcion == '4':
                self._ver_stock_bajo()
            elif opcion == '5':
                self._ver_detalle_stock()
            elif opcion == '6':
                self._registrar_ingreso()
            elif opcion == '0':
                break
            else:
                print("‚ùå Opci√≥n no v√°lida")
                self.pausa()

    @requiere_permiso('reportes_ventas')
    def menu_reportes(self):
        """Men√∫ de reportes contables"""
        while True:
            self.mostrar_cabecera("üìä REPORTES CONTABLES")
            
            print("1. üìÖ Reporte Diario")
            print("2. üìÜ Reporte Semanal")
            print("3. üìÜ Reporte Mensual")
            print("4. üìÜ Reporte Trimestral")
            print("5. üìÜ Reporte Anual")
            print("6. üì• Exportar a Excel/CSV")
            print("0. Volver")
            print()
            
            opcion = input(f"{self.COLOR_AMARILLO}üîπ Seleccione: {self.COLOR_RESET}").strip()
            
            if opcion == '1':
                self._reporte_diario()
            elif opcion == '2':
                self._reporte_semanal()
            elif opcion == '3':
                self._reporte_mensual()
            elif opcion == '4':
                self._reporte_trimestral()
            elif opcion == '5':
                self._reporte_anual()
            elif opcion == '6':
                self._exportar_reporte()
            elif opcion == '0':
                break
            else:
                print("‚ùå Opci√≥n no v√°lida")
                self.pausa()

    def _reporte_diario(self):
        """Muestra reporte de ventas del d√≠a"""
        self.mostrar_cabecera("üìÖ REPORTE DIARIO")
        
        try:
            datos = self.reporte_service.reporte_diario()
            self._mostrar_reporte_contable(datos)
        except Exception as e:
            logger.error(f"Error generando reporte diario: {e}")
            print(f"{self.COLOR_ROJO}‚ùå Error al generar reporte{self.COLOR_RESET}")
        
        self.pausa()
    
    def _reporte_semanal(self):
        """Muestra reporte de ventas de la semana"""
        self.mostrar_cabecera("üìÜ REPORTE SEMANAL")
        
        try:
            datos = self.reporte_service.reporte_semanal()
            self._mostrar_reporte_contable(datos)
        except Exception as e:
            logger.error(f"Error generando reporte semanal: {e}")
            print(f"{self.COLOR_ROJO}‚ùå Error al generar reporte{self.COLOR_RESET}")
        
        self.pausa()
    
    def _reporte_mensual(self):
        """Muestra reporte de ventas del mes"""
        self.mostrar_cabecera("üìÜ REPORTE MENSUAL")
        
        try:
            datos = self.reporte_service.reporte_mensual()
            self._mostrar_reporte_contable(datos)
        except Exception as e:
            logger.error(f"Error generando reporte mensual: {e}")
            print(f"{self.COLOR_ROJO}‚ùå Error al generar reporte{self.COLOR_RESET}")
        
        self.pausa()
    
    def _reporte_trimestral(self):
        """Muestra reporte de ventas del trimestre"""
        self.mostrar_cabecera("üìÜ REPORTE TRIMESTRAL")
        
        try:
            datos = self.reporte_service.reporte_trimestral()
            self._mostrar_reporte_contable(datos)
        except Exception as e:
            logger.error(f"Error generando reporte trimestral: {e}")
            print(f"{self.COLOR_ROJO}‚ùå Error al generar reporte{self.COLOR_RESET}")
        
        self.pausa()
    
    def _reporte_anual(self):
        """Muestra reporte de ventas del a√±o"""
        self.mostrar_cabecera("üìÜ REPORTE ANUAL")
        
        try:
            datos = self.reporte_service.reporte_anual()
            self._mostrar_reporte_contable(datos)
        except Exception as e:
            logger.error(f"Error generando reporte anual: {e}")
            print(f"{self.COLOR_ROJO}‚ùå Error al generar reporte{self.COLOR_RESET}")
        
        self.pausa()
    
    def _mostrar_reporte_contable(self, datos):
        """Muestra un reporte contable formateado"""
        print(f"\n{self.COLOR_AZUL}üìä RESUMEN CONTABLE{self.COLOR_RESET}")
        print("=" * 60)
        print(f"Per√≠odo: {datos['fecha_inicio']} al {datos['fecha_fin']}")
        print(f"Total de ventas: {datos['total_ventas']}")
        print("-" * 60)
        print(f"{self.COLOR_VERDE}üí∞ Totales por moneda:{self.COLOR_RESET}")
        print(f"   Bol√≠vares (Bs.): {datos['total_bs']:,.2f}")
        print(f"   D√≥lares (USD):   ${datos['total_usd']:,.2f}")
        print(f"   Euros (EUR):     ‚Ç¨{datos['total_eur']:,.2f}")
        print(f"{self.COLOR_AMARILLO}üìä IGTF Total: Bs. {datos['igtf_total']:,.2f}{self.COLOR_RESET}")
        print("-" * 60)
        print(f"{self.COLOR_CYAN}üìÖ Detalle por d√≠a:{self.COLOR_RESET}")
        print(f"{'Fecha':<12} {'Ventas':<8} {'Bs.':<15} {'USD':<12} {'EUR':<12}")
        print("-" * 60)
        
        # Ordenar fechas cronol√≥gicamente
        fechas_ordenadas = sorted(datos['detalle'].keys())
        
        for fecha in fechas_ordenadas:
            det = datos['detalle'][fecha]
            
            # Formatear fecha de manera segura
            try:
                # Intentar formato YYYY-MM-DD
                if '-' in fecha and len(fecha.split('-')) == 3:
                    a√±o, mes, dia = fecha.split('-')
                    fecha_formateada = f"{dia}/{mes}/{a√±o}"
                else:
                    # Si ya viene en otro formato, usarla directamente
                    fecha_formateada = fecha
            except:
                fecha_formateada = fecha
            
            # Formatear n√∫meros con separadores
            try:
                bs_str = f"{det['bs']:,.2f}".replace(',', ' ')
            except:
                bs_str = "0.00"
            
            try:
                usd_str = f"{det['usd']:,.2f}".replace(',', ' ')
            except:
                usd_str = "0.00"
            
            try:
                eur_str = f"{det['eur']:,.2f}".replace(',', ' ')
            except:
                eur_str = "0.00"
            
            # Imprimir l√≠nea con formato corregido
            print(f"{fecha_formateada:<12} {det['ventas']:<8} {bs_str:>14} bs {usd_str:>10} $ {eur_str:>8} ‚Ç¨")

    def _exportar_reporte(self):
        """Exporta reporte a CSV"""
        self.mostrar_cabecera("üì• EXPORTAR REPORTE")
        
        print("Seleccione per√≠odo a exportar:")
        print("1. Diario")
        print("2. Semanal")
        print("3. Mensual")
        print("4. Trimestral")
        print("5. Anual")
        opcion = input(f"{self.COLOR_AMARILLO}üîπ Seleccione: {self.COLOR_RESET}").strip()
        
        if opcion == '1':
            datos = self.reporte_service.reporte_diario()
        elif opcion == '2':
            datos = self.reporte_service.reporte_semanal()
        elif opcion == '3':
            datos = self.reporte_service.reporte_mensual()
        elif opcion == '4':
            datos = self.reporte_service.reporte_trimestral()
        elif opcion == '5':
            datos = self.reporte_service.reporte_anual()
        else:
            print("‚ùå Opci√≥n no v√°lida")
            self.pausa()
            return
        
        try:
            ruta = self.reporte_service.exportar_a_csv(datos)
            print(f"\n{self.COLOR_VERDE}‚úÖ Reporte exportado a: {ruta}{self.COLOR_RESET}")
            print("   Puede abrirlo con Excel para an√°lisis contable")
        except Exception as e:
            logger.error(f"Error exportando reporte: {e}")
            print(f"{self.COLOR_ROJO}‚ùå Error al exportar reporte{self.COLOR_RESET}")
        
        self.pausa()    

    # ======================================================
    # NUEVOS M√âTODOS PARA MODIFICAR TASAS DE CAMBIO
    # ======================================================
    
    def _modificar_tasas(self):
        """Permite modificar las tasas de cambio USD y EUR manualmente"""
        self.mostrar_cabecera("üí± MODIFICAR TASAS DE CAMBIO")
        
        usuario = self.trabajador_service.get_usuario_actual()
        if not usuario:
            print(f"{self.COLOR_ROJO}‚ùå Debe iniciar sesi√≥n para modificar tasas{self.COLOR_RESET}")
            self.pausa()
            return
        
        print("Tasas actuales:")
        
        # Obtener tasas actuales
        tasas_actuales = self.obtener_tasas_actuales()
        
        if tasas_actuales['USD']:
            print(f"  üíµ USD: 1 = {self.COLOR_VERDE}Bs. {tasas_actuales['USD']:.2f}{self.COLOR_RESET}")
        else:
            print(f"  üíµ USD: {self.COLOR_ROJO}No registrada{self.COLOR_RESET}")
        
        if tasas_actuales['EUR']:
            print(f"  üí∂ EUR: 1 = {self.COLOR_VERDE}Bs. {tasas_actuales['EUR']:.2f}{self.COLOR_RESET}")
        else:
            print(f"  üí∂ EUR: {self.COLOR_ROJO}No registrada{self.COLOR_RESET}")
        
        print("\n" + "="*60)
        print("¬øQu√© tasa desea modificar?")
        print("1. üíµ D√≥lar (USD)")
        print("2. üí∂ Euro (EUR)")
        print("3. Ambas")
        print("0. Volver")
        
        opcion = input(f"{self.COLOR_AMARILLO}üîπ Seleccione: {self.COLOR_RESET}").strip()
        
        if opcion == '1':
            self._modificar_tasa_unica('USD', usuario)
            self.pausa()
        elif opcion == '2':
            self._modificar_tasa_unica('EUR', usuario)
            self.pausa()
        elif opcion == '3':
            self._modificar_tasa_unica('USD', usuario)
            self._modificar_tasa_unica('EUR', usuario)
            self.pausa()
        elif opcion == '0':
            return
        else:
            print("‚ùå Opci√≥n no v√°lida")
            self.pausa()
    
    def _modificar_tasa_unica(self, moneda, usuario):
        """Modifica una tasa espec√≠fica"""
        print(f"\n{self.COLOR_AMARILLO}üí∞ Modificar tasa {moneda}{self.COLOR_RESET}")
        print("="*40)
        
        try:
            nueva_tasa = float(input(f"Nuevo valor para 1 {moneda} = Bs. ").strip())
            if nueva_tasa <= 0:
                print("‚ùå La tasa debe ser positiva")
                return
            
            # Registrar en el servicio de tasas
            if hasattr(self.venta_service, 'tasa_service') and self.venta_service.tasa_service:
                nombre_usuario = f"{usuario['nombre']} {usuario['apellidos']}"
                
                if self.venta_service.tasa_service.registrar_tasa_manual(
                    moneda=moneda,
                    tasa=nueva_tasa,
                    usuario=nombre_usuario
                ):
                    print(f"{self.COLOR_VERDE}‚úÖ Tasa {moneda} actualizada a Bs. {nueva_tasa:.2f}{self.COLOR_RESET}")
                    
                    # Registrar en auditor√≠a
                    self.registrar_auditoria(
                        accion="MODIFICAR_TASA",
                        tabla="tasa_cambio",
                        registro_id=0,
                        datos_nuevos=f"Tasa {moneda} actualizada a {nueva_tasa}"
                    )
                else:
                    print(f"{self.COLOR_ROJO}‚ùå Error al actualizar tasa{self.COLOR_RESET}")
            else:
                print(f"{self.COLOR_ROJO}‚ùå Servicio de tasas no disponible{self.COLOR_RESET}")
                
        except ValueError:
            print("‚ùå Ingrese un n√∫mero v√°lido")
    
    def _ver_stock_completo(self):
        self.mostrar_cabecera("STOCK COMPLETO")
        print(self.inventario_service.mostrar_tabla_stock())
        self.pausa()
    
    def _ver_resumen_inventario(self):
        self.mostrar_cabecera("RESUMEN DE INVENTARIO")
        print(self.inventario_service.mostrar_resumen_stock())
        self.pausa()
    
    def _ver_stock_critico(self):
        self.mostrar_cabecera("STOCK CR√çTICO (menos de 3 unidades)")
        
        articulos = self.inventario_service.listar_con_stock()
        criticos = [a for a in articulos if a['nivel_stock'] == 'CR√çTICO']
        
        if not criticos:
            print("‚úÖ No hay art√≠culos con stock cr√≠tico")
        else:
            print(f"{'ID':<5} {'C√ìDIGO':<15} {'NOMBRE':<30} {'STOCK':<10}")
            print("-" * 60)
            for art in criticos:
                print(f"{art['color']}{art['idarticulo']:<5} {art['codigo']:<15} {art['nombre']:<30} {art['stock_actual']:<10}{self.inventario_service.COLOR_RESET}")
        
        self.pausa()
    
    def _ver_stock_bajo(self):
        self.mostrar_cabecera("STOCK BAJO (entre 3 y 5 unidades)")
        
        articulos = self.inventario_service.listar_con_stock()
        bajos = [a for a in articulos if a['nivel_stock'] == 'BAJO']
        
        if not bajos:
            print("‚úÖ No hay art√≠culos con stock bajo")
        else:
            print(f"{'ID':<5} {'C√ìDIGO':<15} {'NOMBRE':<30} {'STOCK':<10}")
            print("-" * 60)
            for art in bajos:
                print(f"{art['color']}{art['idarticulo']:<5} {art['codigo']:<15} {art['nombre']:<30} {art['stock_actual']:<10}{self.inventario_service.COLOR_RESET}")
        
        self.pausa()
    
    def _ver_detalle_stock(self):
        self.mostrar_cabecera("DETALLE DE STOCK")
        
        try:
            idart = int(input("ID del art√≠culo: "))
            art = self.articulo_service.obtener_por_id(idart)
            
            if not art:
                print(f"‚ùå No existe art√≠culo con ID {idart}")
                self.pausa()
                return
            
            stock = self.inventario_service.obtener_stock_articulo(idart)
            nivel = self.inventario_service.obtener_nivel_stock(stock)
            
            print(f"\nüìå Art√≠culo: {art['nombre']}")
            print(f"üìå C√≥digo: {art['codigo']}")
            print(f"üìå Stock actual: {stock} unidades")
            print(f"üìå Estado: {nivel['color']}{nivel['emoji']} {nivel['nivel']}{self.inventario_service.COLOR_RESET}")
            print(f"üìå {nivel['mensaje']}")
            
        except Exception as e:
            print(f"‚ùå Error: {e}")
        
        self.pausa()
    
    @requiere_permiso('inventario_ingresos')
    def _registrar_ingreso(self):
        """Registra un nuevo ingreso de mercanc√≠a"""
        self.mostrar_cabecera("REGISTRAR INGRESO")
        
        proveedores = self.proveedor_service.listar()
        if not proveedores:
            print("‚ùå No hay proveedores registrados.")
            print("   Por favor, cree un proveedor primero (Opci√≥n 3 ‚Üí Opci√≥n 3)")
            self.pausa()
            return
        
        print("Proveedores disponibles:")
        for p in proveedores:
            print(f"  {p['idproveedor']}. {p['razon_social']}")
        
        try:
            idproveedor = int(input("\nID del proveedor: "))
            proveedor = self.proveedor_service.obtener_por_id(idproveedor)
            if not proveedor:
                print("‚ùå Proveedor no v√°lido")
                self.pausa()
                return
        except:
            print("‚ùå ID inv√°lido")
            self.pausa()
            return
        
        print("\nTipo de comprobante:")
        print("  1. Factura")
        print("  2. Boleta")
        print("  3. Gu√≠a")
        tipo_map = {'1': 'FACTURA', '2': 'BOLETA', '3': 'GUIA'}
        tipo_op = input("Seleccione: ").strip()
        tipo_comprobante = tipo_map.get(tipo_op, 'FACTURA')
        
        serie = input("Serie (ej. F001): ")
        numero = input("N√∫mero: ")
        
        detalle = []
        print("\nüì¶ AGREGAR PRODUCTOS AL INGRESO")
        print("="*40)
        
        print("\nüìã ART√çCULOS DISPONIBLES:")
        articulos = self.articulo_service.listar()
        if not articulos:
            print("‚ùå No hay art√≠culos registrados. Cree art√≠culos primero.")
            self.pausa()
            return
        
        print(f"{'ID':<5} {'C√ìDIGO':<15} {'NOMBRE':<30} {'CATEGOR√çA':<20}")
        print("-" * 70)
        for a in articulos:
            cat_nombre = a.get('categoria', '') or 'N/A'
            print(f"{a['idarticulo']:<5} {a['codigo']:<15} {a['nombre']:<30} {cat_nombre:<20}")
        print()
        
        while True:
            print("\n--- Agregar producto ---")
            codigo = input("C√≥digo del art√≠culo (0 para terminar, '?' para ver lista): ")
            
            if codigo == '0':
                break
            elif codigo == '?':
                print("\nüìã ART√çCULOS DISPONIBLES:")
                print(f"{'ID':<5} {'C√ìDIGO':<15} {'NOMBRE':<30} {'CATEGOR√çA':<20}")
                print("-" * 70)
                for a in articulos:
                    cat_nombre = a.get('categoria', '') or 'N/A'
                    print(f"{a['idarticulo']:<5} {a['codigo']:<15} {a['nombre']:<30} {cat_nombre:<20}")
                continue
            
            art = self.articulo_service.buscar_por_codigo(codigo)
            if not art:
                try:
                    idart = int(codigo)
                    art = self.articulo_service.obtener_por_id(idart)
                except:
                    pass
            
            if not art:
                print("‚ùå Art√≠culo no encontrado. Use '?' para ver la lista.")
                continue
            
            categoria_nombre = art.get('categoria', '') or 'No especificada'
            
            print(f"üìå Art√≠culo seleccionado: {art['nombre']}")
            print(f"   C√≥digo: {art['codigo']}")
            print(f"   Categor√≠a: {categoria_nombre}")
            
            try:
                cantidad = int(input("Cantidad a ingresar: "))
                if cantidad <= 0:
                    print("‚ùå La cantidad debe ser positiva")
                    continue
                precio = float(input("Precio de compra: "))
                if precio <= 0:
                    print("‚ùå El precio debe ser positivo")
                    continue
            except ValueError:
                print("‚ùå Cantidad o precio inv√°lido")
                continue
            
            detalle.append({
                'idarticulo': art['idarticulo'],
                'cantidad': cantidad,
                'precio_compra': precio
            })
            print(f"‚úÖ {art['nombre']} agregado - {cantidad} unidades a Bs. {precio:.2f}")
        
        if not detalle:
            print("‚ùå Debe agregar al menos un producto")
            self.pausa()
            return
        
        print("\n" + "="*50)
        print("üìã RESUMEN DEL INGRESO")
        print("="*50)
        print(f"Proveedor: {proveedor['razon_social']}")
        print(f"Comprobante: {tipo_comprobante} {serie}-{numero}")
        print("\nProductos:")
        total = 0
        for item in detalle:
            art = self.articulo_service.obtener_por_id(item['idarticulo'])
            subtotal = item['cantidad'] * item['precio_compra']
            total += subtotal
            print(f"  - {art['nombre']}: {item['cantidad']} und @ Bs.{item['precio_compra']:.2f} = Bs.{subtotal:.2f}")
        print(f"\nüí∞ TOTAL: Bs.{total:.2f}")
        print("="*50)
        
        confirmar = input(f"{self.COLOR_AMARILLO}¬øConfirmar ingreso? (s/N): {self.COLOR_RESET}").lower()
        if confirmar != 's':
            print("Operaci√≥n cancelada")
            self.pausa()
            return
        
        usuario = self.trabajador_service.get_usuario_actual()
        idingreso = self.ingreso_service.registrar_ingreso(
            usuario['idtrabajador'], idproveedor, tipo_comprobante,
            serie, numero, 16.0, detalle
        )
        
        if idingreso:
            print(f"\n{self.COLOR_VERDE}‚úÖ Ingreso #{idingreso} registrado correctamente{self.COLOR_RESET}")
            print("üì¶ Stock actualizado autom√°ticamente")
            
            self.registrar_auditoria(
                accion="CREAR",
                tabla="ingreso",
                registro_id=idingreso,
                datos_nuevos=f"Ingreso #{idingreso} - Proveedor: {proveedor['razon_social']} - Total: Bs.{total:.2f}"
            )
        else:
            print(f"\n{self.COLOR_ROJO}‚ùå Error al registrar el ingreso{self.COLOR_RESET}")
        
        self.pausa()
    
    def run(self):
        """Ejecuta el sistema"""
        if not self.conectar_db():
            return
        
        while True:
            opcion = self.mostrar_menu_principal()
            
            # NUEVA OPCI√ìN PARA MODIFICAR TASAS
            if opcion.upper() == 'X':
                self._modificar_tasas()
                continue
            
            if opcion == '1':
                if self.rol_service.tiene_permiso('clientes_ver'):
                    self.menu_clientes()
                else:
                    print("‚ùå No tiene permisos para acceder a clientes")
                    self.pausa()
            elif opcion == '2':
                if self.rol_service.tiene_permiso('articulos_ver'):
                    self.menu_articulos()
                else:
                    print("‚ùå No tiene permisos para acceder a art√≠culos")
                    self.pausa()
            elif opcion == '3':
                if self.rol_service.tiene_permiso('proveedores_ver'):
                    self.menu_proveedores()
                else:
                    print("‚ùå No tiene permisos para acceder a proveedores")
                    self.pausa()
            elif opcion == '4':
                if self.rol_service.tiene_permiso('ventas_ver'):
                    self.menu_ventas()
                else:
                    print("‚ùå No tiene permisos para acceder a ventas")
                    self.pausa()
            elif opcion == '5':
                if self.rol_service.tiene_permiso('compras_ver'):
                    self._menu_compras()
                else:
                    print("‚ùå No tiene permisos para acceder a compras")
                    self.pausa()
            elif opcion == '6':
                if self.rol_service.tiene_permiso('inventario_ver'):
                    self.menu_inventario()
                else:
                    print("‚ùå No tiene permisos para acceder a inventario")
                    self.pausa()
            elif opcion == '7':
                if self.rol_service.tiene_permiso('reportes_ventas'):
                    self.menu_reportes()
                else:
                    print("‚ùå No tiene permisos para acceder a reportes")
                    self.pausa()
            elif opcion == '8':
                if self.trabajador_service.get_usuario_actual():
                    # Si ya tiene sesi√≥n, cierra sesi√≥n
                    self.trabajador_service.logout()
                    print(f"{self.COLOR_VERDE}‚úÖ Sesi√≥n cerrada{self.COLOR_RESET}")
                    self.pausa()
                else:
                    # Si no tiene sesi√≥n, inicia sesi√≥n
                    self.menu_login()
            elif opcion == '9':
                if self.trabajador_service.get_usuario_actual() and self.rol_service.tiene_permiso('usuarios_ver'):
                    self.menu_administracion_usuarios()
                else:
                    print("‚ùå No tiene permisos para acceder a usuarios")
                    self.pausa()
            elif opcion == '0':
                print(f"\n{self.COLOR_VERDE}üëã ¬°Hasta luego!{self.COLOR_RESET}")
                break
            else:
                print("‚ùå Opci√≥n no v√°lida")
                self.pausa()

    # ======================================================
    # M√ìDULO DE COMPRAS
    # ======================================================
    
        """Men√∫ de gesti√≥n de compras"""
    def _menu_compras(self):
        """Men√∫ de gesti√≥n de compras"""
        while True:
            self.mostrar_cabecera("üì• M√ìDULO DE COMPRAS")
            print(f"{self.COLOR_VERDE}1{self.COLOR_RESET}. Registrar compra (orden)")
            print(f"{self.COLOR_VERDE}2{self.COLOR_RESET}. Recibir mercanc√≠a")
            print(f"{self.COLOR_VERDE}3{self.COLOR_RESET}. Listar √≥rdenes de compra")
            print(f"{self.COLOR_VERDE}4{self.COLOR_RESET}. Buscar orden por factura")
            print(f"{self.COLOR_VERDE}5{self.COLOR_RESET}. Ver recepciones")
            print(f"{self.COLOR_VERDE}6{self.COLOR_RESET}. Reportes de compras")
            print(f"{self.COLOR_ROJO}0{self.COLOR_RESET}. Volver al men√∫ principal")
            
            opcion = input(f"\n{self.COLOR_AMARILLO}Seleccione: {self.COLOR_RESET}")
            
            if opcion == '1':
                self._registrar_compra()
            elif opcion == '2':
                self._recibir_mercancia()
            elif opcion == '3':
                self._listar_ordenes_compra()
            elif opcion == '4':
                self._buscar_orden_factura()
            elif opcion == '5':
                self._listar_recepciones()
            elif opcion == '6':
                self._reportes_compras()
            elif opcion == '0':
                break
            else:
                print(f"{self.COLOR_ROJO}‚ùå Opci√≥n inv√°lida{self.COLOR_RESET}")
                self.pausa()

    def _registrar_compra(self):
        """Registra una nueva orden de compra (PASO 1 COMPLETO)"""
        self.mostrar_cabecera("üìÑ NUEVA COMPRA")
        
        # Verificar usuario
        usuario = self.trabajador_service.get_usuario_actual()
        if not usuario:
            print(f"{self.COLOR_ROJO}‚ùå Debe iniciar sesi√≥n{self.COLOR_RESET}")
            self.pausa()
            return
        
        # 1. C√ìDIGO FACTURA
        print(f"\n{self.COLOR_AMARILLO}1. C√ìDIGO FACTURA (obligatorio){self.COLOR_RESET}")
        print("   Ingrese c√≥digo de la factura (ser√° el identificador √∫nico de la orden)")
        codigo_factura = input("   C√≥digo Factura: ").strip().upper()
        if not codigo_factura:
            print(f"{self.COLOR_ROJO}‚ùå C√≥digo de factura obligatorio{self.COLOR_RESET}")
            self.pausa()
            return
        
        # 2. PROVEEDOR
        print(f"\n{self.COLOR_AMARILLO}2. PROVEEDOR{self.COLOR_RESET}")
        print("   [1] Seleccionar de la lista")
        print("   [2] Crear nuevo proveedor")
        print("   [0] Cancelar")
        
        opcion_prov = input("\n   Seleccione: ")
        
        if opcion_prov == '0':
            return
            
        idproveedor = None
        proveedor_data = None
        
        if opcion_prov == '1':
            # Listar proveedores existentes
            proveedores = self.proveedor_service.listar()
            if not proveedores:
                print(f"\n{self.COLOR_ROJO}‚ùå No hay proveedores registrados{self.COLOR_RESET}")
                print(f"{self.COLOR_AMARILLO}   Debe crear un proveedor primero{self.COLOR_RESET}")
                self.pausa()
                return
            
            print(f"\n{self.COLOR_VERDE}   Proveedores disponibles:{self.COLOR_RESET}")
            for i, p in enumerate(proveedores[:10], 1):
                razon = p.get('razon_social', 'N/A')
                rif = p.get('num_documento', 'N/A')
                print(f"   {i}. {razon} - {rif}")
            print(f"   {self.COLOR_ROJO}0. Cancelar{self.COLOR_RESET}")
            
            try:
                idx = int(input("\n   Seleccione n√∫mero: ")) - 1
                if idx == -1:
                    return
                proveedor_data = proveedores[idx]
                idproveedor = proveedor_data['idproveedor']
                print(f"{self.COLOR_VERDE}   ‚úÖ Proveedor seleccionado: {proveedor_data.get('razon_social')}{self.COLOR_RESET}")
            except (ValueError, IndexError):
                print(f"{self.COLOR_ROJO}‚ùå Selecci√≥n inv√°lida{self.COLOR_RESET}")
                self.pausa()
                return
                
        elif opcion_prov == '2':
            # Crear nuevo proveedor
            print(f"\n{self.COLOR_AMARILLO}   üìù NUEVO PROVEEDOR{self.COLOR_RESET}")
            
            # Validar RIF
            rif = input("   RIF: ").upper()
            if not rif:
                print(f"{self.COLOR_ROJO}‚ùå RIF obligatorio{self.COLOR_RESET}")
                self.pausa()
                return
            
            # Validar Raz√≥n Social
            razon = input("   Raz√≥n Social: ")
            if not razon:
                print(f"{self.COLOR_ROJO}‚ùå Raz√≥n Social obligatoria{self.COLOR_RESET}")
                self.pausa()
                return
            
            # Datos opcionales
            telefono = input("   Tel√©fono (opcional): ").strip() or None
            email = input("   Email (opcional): ").strip() or None
            direccion = input("   Direcci√≥n (opcional): ").strip() or None
            
            # Aqu√≠ ir√≠a la l√≥gica real para crear proveedor
            # Por ahora simulamos
            print(f"\n{self.COLOR_VERDE}   ‚úÖ Proveedor creado exitosamente (simulado){self.COLOR_RESET}")
            print(f"      RIF: {rif}")
            print(f"      Raz√≥n Social: {razon}")
            
            # Simular datos del proveedor creado
            proveedor_data = {
                'idproveedor': 999,  # ID simulado
                'razon_social': razon,
                'num_documento': rif
            }
            idproveedor = 999
            
            # Preguntar si quiere continuar con la compra
            print(f"\n{self.COLOR_AMARILLO}   ¬øContinuar con el registro de compra?{self.COLOR_RESET}")
            continuar = input("   [S/N]: ").upper()
            if continuar != 'S':
                return
        
        # 3. MONTO TOTAL USD
        print(f"\n{self.COLOR_AMARILLO}3. MONTO TOTAL USD (obligatorio){self.COLOR_RESET}")
        try:
            monto_usd = float(input("   Ingrese monto total en USD: "))
            if monto_usd <= 0:
                print(f"{self.COLOR_ROJO}‚ùå Monto inv√°lido{self.COLOR_RESET}")
                self.pausa()
                return
        except ValueError:
            print(f"{self.COLOR_ROJO}‚ùå Valor inv√°lido{self.COLOR_RESET}")
            self.pausa()
            return
        
        # Obtener tasa del d√≠a - CORREGIDO DEFINITIVO
        from capa_negocio.tasa_service import TasaService
        from capa_datos.tasa_repo import TasaRepositorio
        from capa_datos.conexion import ConexionDB
        
        try:
            # Crear conexi√≥n y repositorio de tasa
            db_tasa = ConexionDB()
            conn_tasa = db_tasa.conectar()
            if conn_tasa:
                tasa_repo = TasaRepositorio(conn_tasa)
                tasa_service = TasaService(tasa_repo)
                tasa = tasa_service.obtener_tasa_del_dia('USD')
                
                if tasa and tasa > 0:
                    monto_bs = monto_usd * tasa
                    print(f"   Tasa BCV del d√≠a: {self.COLOR_VERDE}{tasa:.2f}{self.COLOR_RESET} Bs/USD")
                    print(f"   Monto en Bs: {self.COLOR_AMARILLO}{monto_bs:,.2f}{self.COLOR_RESET}")
                else:
                    print(f"   {self.COLOR_AMARILLO}‚ö†Ô∏è No se pudo obtener la tasa del d√≠a{self.COLOR_RESET}")
                    tasa = None
                
                # Cerrar conexi√≥n de tasa
                db_tasa.cerrar()
            else:
                print(f"   {self.COLOR_AMARILLO}‚ö†Ô∏è No se pudo conectar para obtener tasa{self.COLOR_RESET}")
                tasa = None
                
        except Exception as e:
            print(f"   {self.COLOR_AMARILLO}‚ö†Ô∏è Error al obtener tasa: {e}{self.COLOR_RESET}")
            tasa = None
        
        # 4. FECHA DE LA COMPRA
        print(f"\n{self.COLOR_AMARILLO}4. FECHA DE LA COMPRA{self.COLOR_RESET}")
        from datetime import datetime
        fecha_hoy = datetime.now().strftime("%d/%m/%Y")
        fecha_compra_input = input(f"   Fecha (DD/MM/YYYY) [HOY={fecha_hoy}]: ").strip()
        
        if not fecha_compra_input:
            fecha_compra_input = fecha_hoy
        
        # Convertir de DD/MM/YYYY a YYYY-MM-DD para la BD
        try:
            dia, mes, anio = fecha_compra_input.split('/')
            # Validar que sea una fecha v√°lida
            dia = int(dia)
            mes = int(mes)
            anio = int(anio)
            
            # Validaci√≥n b√°sica
            if dia < 1 or dia > 31 or mes < 1 or mes > 12 or anio < 2000 or anio > 2100:
                print(f"{self.COLOR_ROJO}‚ùå Fecha inv√°lida{self.COLOR_RESET}")
                self.pausa()
                return
                
            fecha_compra = f"{anio:04d}-{mes:02d}-{dia:02d}"
            print(f"   {self.COLOR_VERDE}‚úÖ Fecha registrada: {fecha_compra_input}{self.COLOR_RESET}")
        except (ValueError, IndexError):
            print(f"{self.COLOR_ROJO}‚ùå Formato de fecha inv√°lido. Use DD/MM/YYYY (ejemplo: 25/02/2026){self.COLOR_RESET}")
            self.pausa()
            return
        
        # 5. FECHA ESTIMADA DE LLEGADA (opcional)
        print(f"\n{self.COLOR_AMARILLO}5. FECHA ESTIMADA DE LLEGADA (opcional){self.COLOR_RESET}")
        fecha_llegada_input = input("   Fecha estimada (DD/MM/YYYY) [Enter para omitir]: ").strip()
        
        fecha_llegada = None
        if fecha_llegada_input:
            try:
                dia, mes, anio = fecha_llegada_input.split('/')
                # Validar que sea una fecha v√°lida
                dia = int(dia)
                mes = int(mes)
                anio = int(anio)
                
                # Validaci√≥n b√°sica
                if dia < 1 or dia > 31 or mes < 1 or mes > 12 or anio < 2000 or anio > 2100:
                    print(f"{self.COLOR_ROJO}‚ùå Fecha inv√°lida{self.COLOR_RESET}")
                    self.pausa()
                    return
                    
                fecha_llegada = f"{anio:04d}-{mes:02d}-{dia:02d}"
                print(f"   {self.COLOR_VERDE}‚úÖ Fecha registrada: {fecha_llegada_input}{self.COLOR_RESET}")
            except (ValueError, IndexError):
                print(f"{self.COLOR_ROJO}‚ùå Formato de fecha inv√°lido. Use DD/MM/YYYY (ejemplo: 28/02/2026){self.COLOR_RESET}")
                self.pausa()
                return
        
        # 6. ADJUNTAR ARCHIVO
        print(f"\n{self.COLOR_AMARILLO}6. ADJUNTAR ARCHIVO{self.COLOR_RESET}")
        print("   [1] Subir archivo (PDF/Imagen)")
        print("   [2] No adjuntar ahora")
        opcion_archivo = input("\n   Seleccione: ")
        
        archivo_adjunto = None
        if opcion_archivo == '1':
            ruta = input("   Ruta del archivo: ").strip()
            if ruta:
                archivo_adjunto = ruta
                print(f"{self.COLOR_VERDE}   ‚úÖ Archivo adjuntado: {ruta}{self.COLOR_RESET}")
        
        # 7. ESTATUS DE LA COMPRA
        print(f"\n{self.COLOR_AMARILLO}7. ESTATUS DE LA COMPRA{self.COLOR_RESET}")
        print("   [1] Por recibir (pendiente)")
        print("   [2] Entregado (ya lleg√≥)")
        print("   [3] En tr√°nsito")
        opcion_estatus = input("\n   Seleccione: ")
        
        estatus_map = {
            '1': 'POR_RECIBIR',
            '2': 'ENTREGADO',
            '3': 'EN_TRANSITO'
        }
        estatus = estatus_map.get(opcion_estatus, 'POR_RECIBIR')
        print(f"   {self.COLOR_VERDE}‚úÖ Estatus: {estatus}{self.COLOR_RESET}")
        
        # 8. OBSERVACIONES
        print(f"\n{self.COLOR_AMARILLO}8. OBSERVACIONES (opcional){self.COLOR_RESET}")
        observaciones = input("   Ingrese notas adicionales: ").strip()
        if not observaciones:
            observaciones = None
        
        # 9. PRODUCTOS (OPCIONAL)
        print(f"\n{self.COLOR_AMARILLO}9. PRODUCTOS (opcional){self.COLOR_RESET}")
        print("   ¬øDesea ingresar los productos ahora?")
        ingresar_productos = input("   [S/N]: ").upper()
        if ingresar_productos == 'S':
            print(f"   {self.COLOR_AMARILLO}‚è≥ Puede ingresarlos en la recepci√≥n{self.COLOR_RESET}")
        
        # RESUMEN
        print(f"\n{self.COLOR_CYAN}{'='*60}{self.COLOR_RESET}")
        print(f"{self.COLOR_VERDE}üìã RESUMEN DE COMPRA{self.COLOR_RESET}")
        print(f"{self.COLOR_CYAN}{'='*60}{self.COLOR_RESET}")
        print(f"C√≥digo Factura: {self.COLOR_AMARILLO}{codigo_factura}{self.COLOR_RESET}")
        if proveedor_data:
            print(f"Proveedor: {self.COLOR_VERDE}{proveedor_data.get('razon_social', 'N/A')}{self.COLOR_RESET} - {proveedor_data.get('num_documento', 'N/A')}")
        print(f"Monto USD: {self.COLOR_AMARILLO}{monto_usd:,.2f}{self.COLOR_RESET}")
        if tasa:
            print(f"Monto Bs: {self.COLOR_AMARILLO}{monto_usd * tasa:,.2f}{self.COLOR_RESET} (tasa: {tasa:.2f})")
        print(f"Fecha Compra: {self.COLOR_VERDE}{fecha_compra}{self.COLOR_RESET}")
        if fecha_llegada:
            print(f"Fecha Estimada Llegada: {self.COLOR_VERDE}{fecha_llegada}{self.COLOR_RESET}")
        if archivo_adjunto:
            print(f"Archivo: {self.COLOR_VERDE}{archivo_adjunto}{self.COLOR_RESET}")
        print(f"Estatus: {self.COLOR_AMARILLO}{estatus}{self.COLOR_RESET}")
        print(f"{self.COLOR_CYAN}{'='*60}{self.COLOR_RESET}")
        
        confirmar = input(f"\n{self.COLOR_AMARILLO}¬øConfirmar registro de compra? [S/N]: {self.COLOR_RESET}").upper()
        
        if confirmar == 'S':
            try:
                from capa_negocio.orden_compra_service import OrdenCompraService
                orden_service = OrdenCompraService()
                
                idorden = orden_service.registrar_orden(
                    codigo_factura=codigo_factura,
                    idproveedor=idproveedor,
                    idtrabajador=usuario['idtrabajador'],
                    fecha_compra=fecha_compra,
                    monto_total_usd=monto_usd,
                    fecha_estimada_llegada=fecha_llegada,
                    archivo_adjunto=archivo_adjunto,
                    estatus=estatus,
                    observaciones=observaciones
                )
                
                if idorden:
                    print(f"\n{self.COLOR_VERDE}{'‚úÖ'*10}{self.COLOR_RESET}")
                    print(f"{self.COLOR_VERDE}   COMPRA REGISTRADA EXITOSAMENTE{self.COLOR_RESET}")
                    print(f"{self.COLOR_VERDE}{'‚úÖ'*10}{self.COLOR_RESET}")
                    print(f"   ID de orden: {self.COLOR_AMARILLO}{idorden}{self.COLOR_RESET}")
                    print(f"   C√≥digo Factura: {self.COLOR_AMARILLO}{codigo_factura}{self.COLOR_RESET}")
                else:
                    print(f"\n{self.COLOR_ROJO}‚ùå Error registrando compra{self.COLOR_RESET}")
            except Exception as e:
                logger.error(f"Error: {e}")
                print(f"\n{self.COLOR_ROJO}‚ùå Error al registrar: {e}{self.COLOR_RESET}")
        else:
            print(f"\n{self.COLOR_AMARILLO}Compra cancelada{self.COLOR_RESET}")
        
        self.pausa()

    def _listar_compras(self):
        """Lista todas las compras"""
        self.mostrar_cabecera("üìã LISTADO DE COMPRAS")
        
        try:
            from capa_negocio.compra_service import CompraService
            compra_service = CompraService()
            compras = compra_service.listar_compras()
            
            if not compras:
                print(f"\n{self.COLOR_AMARILLO}üì≠ No hay compras registradas{self.COLOR_RESET}")
            else:
                print(f"\n{self.COLOR_VERDE}Total de compras: {len(compras)}{self.COLOR_RESET}\n")
                for compra in compras[:20]:
                    print(f"ID: {compra['idcompra']}")
                    print(f"Fecha: {compra['fecha_hora']}")
                    print(f"Proveedor: {compra['proveedor']}")
                    print(f"Comprobante: {compra['tipo_comprobante']} {compra['serie']}-{compra['numero_comprobante']}")
                    print(f"Total: Bs. {compra['total']:,.2f}")
                    print(f"Estado: {compra['estado']}")
                    print("-" * 40)
        except Exception as e:
            logger.error(f"Error en listado de compras: {e}")
            print(f"\n{self.COLOR_ROJO}‚ùå Error al cargar compras{self.COLOR_RESET}")
        
        self.pausa()

    def _buscar_compra(self):
        """Busca una compra por ID"""
        self.mostrar_cabecera("üîç BUSCAR COMPRA")
        
        print(f"\n{self.COLOR_AMARILLO}Ingrese el ID de la compra (0 para cancelar):{self.COLOR_RESET}")
        
        try:
            id_input = input("ID de la compra: ").strip()
            
            if id_input == '0':
                print(f"{self.COLOR_AMARILLO}B√∫squeda cancelada{self.COLOR_RESET}")
                self.pausa()
                return
                
            if not id_input:
                print(f"{self.COLOR_ROJO}‚ùå ID no v√°lido{self.COLOR_RESET}")
                self.pausa()
                return
                
            idcompra = int(id_input)
            
        except ValueError:
            print(f"{self.COLOR_ROJO}‚ùå ID inv√°lido (debe ser un n√∫mero){self.COLOR_RESET}")
            self.pausa()
            return
        
        try:
            from capa_negocio.compra_service import CompraService
            compra_service = CompraService()
            compra = compra_service.buscar_compra(idcompra)
            
            if not compra:
                print(f"\n{self.COLOR_ROJO}‚ùå Compra #{idcompra} no encontrada{self.COLOR_RESET}")
            else:
                print(f"\n{self.COLOR_VERDE}üìã COMPRA #{compra['idcompra']}{self.COLOR_RESET}")
                print(f"Fecha: {compra['fecha_hora']}")
                print(f"Proveedor: {compra['proveedor']} - {compra['rif']}")
                print(f"Trabajador: {compra['trabajador']}")
                print(f"Comprobante: {compra['tipo_comprobante']} {compra['serie']}-{compra['numero_comprobante']}")
                print(f"Subtotal: Bs. {compra['subtotal']:,.2f}")
                print(f"IVA: Bs. {compra['iva']:,.2f}")
                print(f"Total: Bs. {compra['total']:,.2f}")
                print(f"Estado: {compra['estado']}")
                
                if compra.get('detalles'):
                    print(f"\n{self.COLOR_VERDE}üì¶ DETALLES:{self.COLOR_RESET}")
                    for d in compra['detalles']:
                        print(f"  ‚Ä¢ {d['articulo']} - {d['cantidad']} x Bs. {d['precio_compra']:,.2f} = Bs. {d['subtotal']:,.2f}")
        except Exception as e:
            logger.error(f"Error buscando compra: {e}")
            print(f"{self.COLOR_ROJO}‚ùå Error al buscar la compra{self.COLOR_RESET}")
        
        self.pausa()

    def _reportes_compras(self):
        """Reportes de compras"""
        self.mostrar_cabecera("üìä REPORTES DE COMPRAS")
        print(f"{self.COLOR_AMARILLO}‚è≥ Reportes en desarrollo...{self.COLOR_RESET}")
        self.pausa()

    def _listar_ordenes_compra(self):
        """Lista todas las √≥rdenes de compra"""
        self.mostrar_cabecera("üìã √ìRDENES DE COMPRA")
        
        try:
            from capa_negocio.orden_compra_service import OrdenCompraService
            service = OrdenCompraService()
            
            print(f"\n{self.COLOR_AMARILLO}√ìrdenes pendientes:{self.COLOR_RESET}")
            ordenes = service.listar_ordenes_pendientes()
            
            if not ordenes:
                print(f"   {self.COLOR_AMARILLO}No hay √≥rdenes pendientes{self.COLOR_RESET}")
            else:
                for o in ordenes[:10]:
                    print(f"   ‚Ä¢ {o['codigo_factura']} - {o['proveedor']} - USD {o['monto_total_usd']:,.2f}")
            
        except Exception as e:
            logger.error(f"Error: {e}")
            print(f"{self.COLOR_ROJO}‚ùå Error al listar √≥rdenes{self.COLOR_RESET}")
        
        self.pausa()

    def _buscar_orden_factura(self):
        """Busca orden por c√≥digo de factura"""
        self.mostrar_cabecera("üîç BUSCAR ORDEN POR FACTURA")
        
        codigo = input("Ingrese c√≥digo de factura: ").strip().upper()
        if not codigo:
            return
        
        try:
            from capa_negocio.orden_compra_service import OrdenCompraService
            service = OrdenCompraService()
            orden = service.buscar_por_codigo_factura(codigo)
            
            if not orden:
                print(f"{self.COLOR_ROJO}‚ùå Orden no encontrada{self.COLOR_RESET}")
            else:
                print(f"\n{self.COLOR_VERDE}üìÑ ORDEN ENCONTRADA{self.COLOR_RESET}")
                print(f"C√≥digo: {orden['codigo_factura']}")
                print(f"Proveedor: {orden['proveedor']}")
                print(f"Fecha compra: {orden['fecha_compra']}")
                print(f"Monto USD: {orden['monto_total_usd']:,.2f}")
                print(f"Estatus: {orden['estatus']}")
        except Exception as e:
            logger.error(f"Error: {e}")
            print(f"{self.COLOR_ROJO}‚ùå Error al buscar{self.COLOR_RESET}")
        
        self.pausa()

    def _listar_recepciones(self):
        """Lista recepciones registradas"""
        self.mostrar_cabecera("üìã RECEPCIONES")
        print(f"{self.COLOR_AMARILLO}‚è≥ Funci√≥n en desarrollo...{self.COLOR_RESET}")
        self.pausa()

    def _recibir_mercancia(self):
        """Registra recepci√≥n de mercanc√≠a (PASO 2 COMPLETO)"""
        self.mostrar_cabecera("üì¶ RECIBIR MERCANC√çA")
        
        # Verificar usuario
        usuario = self.trabajador_service.get_usuario_actual()
        if not usuario:
            print(f"{self.COLOR_ROJO}‚ùå Debe iniciar sesi√≥n{self.COLOR_RESET}")
            self.pausa()
            return
        
        # 1. BUSCAR ORDEN DE COMPRA
        print(f"\n{self.COLOR_AMARILLO}1. BUSCAR ORDEN DE COMPRA{self.COLOR_RESET}")
        print("   [1] Buscar por c√≥digo de factura")
        print("   [2] Buscar por proveedor")
        print("   [3] Ver √≥rdenes pendientes")
        print("   [4] Recepci√≥n directa (sin orden)")
        print("   [0] Cancelar")
        
        opcion = input("\n   Seleccione: ")
        
        if opcion == '0':
            return
        
        orden_data = None
        idorden = None
        idproveedor = None
        
        try:
            from capa_negocio.orden_compra_service import OrdenCompraService
            orden_service = OrdenCompraService()
            
            if opcion == '1':
                codigo = input("   Ingrese c√≥digo de factura: ").strip().upper()
                if not codigo:
                    return
                orden_data = orden_service.buscar_por_codigo_factura(codigo)
                if not orden_data:
                    print(f"{self.COLOR_ROJO}‚ùå Orden no encontrada{self.COLOR_RESET}")
                    self.pausa()
                    return
                
                print(f"\n{self.COLOR_VERDE}   ‚úÖ Orden encontrada:{self.COLOR_RESET}")
                print(f"   {'-'*60}")
                print(f"   C√≥digo: {orden_data['codigo_factura']}")
                print(f"   Proveedor: {orden_data['proveedor']} ({orden_data.get('rif', 'N/A')})")
                print(f"   Fecha compra: {orden_data['fecha_compra']}")
                print(f"   Monto USD: {orden_data['monto_total_usd']:,.2f}")
                print(f"   Estatus: {orden_data['estatus']}")
                print(f"   {'-'*60}")
                
                idorden = orden_data['idorden']
                idproveedor = orden_data['idproveedor']
                
            elif opcion == '2':
                print(f"\n{self.COLOR_AMARILLO}   üîç BUSCAR POR PROVEEDOR{self.COLOR_RESET}")
                print("   [1] Buscar por RIF")
                print("   [2] Buscar por nombre")
                print("   [3] Listar todos")
                subopcion = input("\n   Seleccione: ")
                
                proveedores = []
                if subopcion == '1':
                    rif = input("   RIF: ").upper()
                    proveedor = self.proveedor_service.buscar_por_rif(rif)
                    if proveedor:
                        proveedores = [proveedor]
                elif subopcion == '2':
                    nombre = input("   Nombre/Raz√≥n social: ")
                    proveedores = self.proveedor_service.buscar_por_nombre(nombre)
                elif subopcion == '3':
                    proveedores = self.proveedor_service.listar()
                
                if not proveedores:
                    print(f"{self.COLOR_ROJO}‚ùå No se encontraron proveedores{self.COLOR_RESET}")
                    self.pausa()
                    return
                
                print(f"\n{self.COLOR_VERDE}   Proveedores encontrados:{self.COLOR_RESET}")
                for i, p in enumerate(proveedores[:10], 1):
                    print(f"   {i}. {p.get('razon_social', 'N/A')} - {p.get('num_documento', 'N/A')}")
                print(f"   {self.COLOR_ROJO}0. Cancelar{self.COLOR_RESET}")
                
                try:
                    idx = int(input("\n   Seleccione proveedor: ")) - 1
                    if idx == -1:
                        return
                    proveedor_sel = proveedores[idx]
                    idproveedor = proveedor_sel['idproveedor']
                    
                    # Buscar √≥rdenes de este proveedor
                    ordenes = orden_service.listar_ordenes_pendientes()
                    ordenes_proveedor = [o for o in ordenes if o.get('idproveedor') == idproveedor]
                    
                    if not ordenes_proveedor:
                        print(f"{self.COLOR_AMARILLO}   üì≠ No hay √≥rdenes pendientes para este proveedor{self.COLOR_RESET}")
                        self.pausa()
                        return
                    
                    print(f"\n{self.COLOR_VERDE}   √ìrdenes pendientes:{self.COLOR_RESET}")
                    for i, o in enumerate(ordenes_proveedor[:10], 1):
                        print(f"   {i}. {o['codigo_factura']} - USD {o['monto_total_usd']:,.2f}")
                    print(f"   {self.COLOR_ROJO}0. Cancelar{self.COLOR_RESET}")
                    
                    try:
                        idx_ord = int(input("\n   Seleccione orden: ")) - 1
                        if idx_ord == -1:
                            return
                        orden_data = ordenes_proveedor[idx_ord]
                        idorden = orden_data['idorden']
                        
                        print(f"\n{self.COLOR_VERDE}   ‚úÖ Orden seleccionada:{self.COLOR_RESET}")
                        print(f"   C√≥digo: {orden_data['codigo_factura']}")
                    except (ValueError, IndexError):
                        print(f"{self.COLOR_ROJO}‚ùå Selecci√≥n inv√°lida{self.COLOR_RESET}")
                        self.pausa()
                        return
                        
                except (ValueError, IndexError):
                    print(f"{self.COLOR_ROJO}‚ùå Selecci√≥n inv√°lida{self.COLOR_RESET}")
                    self.pausa()
                    return
                
            elif opcion == '3':
                ordenes = orden_service.listar_ordenes_pendientes()
                if not ordenes:
                    print(f"{self.COLOR_AMARILLO}   üì≠ No hay √≥rdenes pendientes{self.COLOR_RESET}")
                    self.pausa()
                    return
                
                print(f"\n{self.COLOR_VERDE}   √ìrdenes pendientes:{self.COLOR_RESET}")
                for i, o in enumerate(ordenes[:10], 1):
                    print(f"   {i}. {o['codigo_factura']} - {o['proveedor']} - USD {o['monto_total_usd']:,.2f}")
                print(f"   {self.COLOR_ROJO}0. Cancelar{self.COLOR_RESET}")
                
                try:
                    idx = int(input("\n   Seleccione orden: ")) - 1
                    if idx == -1:
                        return
                    orden_data = ordenes[idx]
                    idorden = orden_data['idorden']
                    idproveedor = orden_data['idproveedor']
                    
                    print(f"\n{self.COLOR_VERDE}   ‚úÖ Orden seleccionada:{self.COLOR_RESET}")
                    print(f"   C√≥digo: {orden_data['codigo_factura']}")
                    print(f"   Proveedor: {orden_data['proveedor']}")
                except (ValueError, IndexError):
                    print(f"{self.COLOR_ROJO}‚ùå Selecci√≥n inv√°lida{self.COLOR_RESET}")
                    self.pausa()
                    return
                    
            elif opcion == '4':
                # Recepci√≥n directa: buscar proveedor
                print(f"\n{self.COLOR_AMARILLO}   üîç BUSCAR PROVEEDOR (recepci√≥n directa){self.COLOR_RESET}")
                print("   [1] Buscar por RIF")
                print("   [2] Buscar por nombre")
                print("   [3] Listar todos")
                print("   [4] Crear nuevo proveedor")
                subopcion = input("\n   Seleccione: ")
                
                if subopcion == '4':
                    # Crear nuevo proveedor
                    print(f"\n{self.COLOR_AMARILLO}   üìù NUEVO PROVEEDOR{self.COLOR_RESET}")
                    rif = input("   RIF: ").upper()
                    razon = input("   Raz√≥n Social: ")
                    telefono = input("   Tel√©fono (opcional): ").strip() or None
                    email = input("   Email (opcional): ").strip() or None
                    direccion = input("   Direcci√≥n (opcional): ").strip() or None
                    
                    print(f"{self.COLOR_VERDE}   ‚úÖ Proveedor creado exitosamente (simulado){self.COLOR_RESET}")
                    idproveedor = 999  # Simulado
                else:
                    proveedores = []
                    if subopcion == '1':
                        rif = input("   RIF: ").upper()
                        proveedor = self.proveedor_service.buscar_por_rif(rif)
                        if proveedor:
                            proveedores = [proveedor]
                    elif subopcion == '2':
                        nombre = input("   Nombre/Raz√≥n social: ")
                        proveedores = self.proveedor_service.buscar_por_nombre(nombre)
                    elif subopcion == '3':
                        proveedores = self.proveedor_service.listar()
                    
                    if not proveedores:
                        print(f"{self.COLOR_ROJO}‚ùå No se encontraron proveedores{self.COLOR_RESET}")
                        self.pausa()
                        return
                    
                    print(f"\n{self.COLOR_VERDE}   Proveedores encontrados:{self.COLOR_RESET}")
                    for i, p in enumerate(proveedores[:10], 1):
                        print(f"   {i}. {p.get('razon_social', 'N/A')} - {p.get('num_documento', 'N/A')}")
                    print(f"   {self.COLOR_ROJO}0. Cancelar{self.COLOR_RESET}")
                    
                    try:
                        idx = int(input("\n   Seleccione proveedor: ")) - 1
                        if idx == -1:
                            return
                        proveedor_sel = proveedores[idx]
                        idproveedor = proveedor_sel['idproveedor']
                    except (ValueError, IndexError):
                        print(f"{self.COLOR_ROJO}‚ùå Selecci√≥n inv√°lida{self.COLOR_RESET}")
                        self.pausa()
                        return
            else:
                print(f"{self.COLOR_ROJO}‚ùå Opci√≥n inv√°lida{self.COLOR_RESET}")
                self.pausa()
                return
                
        except Exception as e:
            logger.error(f"Error: {e}")
            print(f"{self.COLOR_ROJO}‚ùå Error al buscar orden: {e}{self.COLOR_RESET}")
            self.pausa()
            return
        
        # 2. DATOS DE RECEPCI√ìN
        print(f"\n{self.COLOR_AMARILLO}2. DATOS DE RECEPCI√ìN{self.COLOR_RESET}")
        from datetime import datetime
        fecha_hoy = datetime.now().strftime("%d/%m/%Y")
        fecha_recepcion_input = input(f"   Fecha de recepci√≥n [HOY={fecha_hoy}]: ").strip()
        
        if not fecha_recepcion_input:
            fecha_recepcion_input = fecha_hoy
        
        # Convertir de DD/MM/YYYY a YYYY-MM-DD para la BD
        try:
            dia, mes, anio = fecha_recepcion_input.split('/')
            fecha_recepcion = f"{anio}-{mes}-{dia}"
        except:
            print(f"{self.COLOR_ROJO}‚ùå Formato de fecha inv√°lido. Use DD/MM/YYYY{self.COLOR_RESET}")
            self.pausa()
            return
        
        print(f"\n   Estado de la mercanc√≠a:")
        print("   [1] Completa (todo lleg√≥ bien)")
        print("   [2] Parcial (faltaron productos)")
        print("   [3] Con da√±os (algunos productos da√±ados)")
        estado_opcion = input("   Seleccione: ")
        
        estado_map = {
            '1': 'COMPLETA',
            '2': 'PARCIAL',
            '3': 'DA√ëADA'
        }
        estado_mercancia = estado_map.get(estado_opcion, 'COMPLETA')
        print(f"   {self.COLOR_VERDE}‚úÖ Estado: {estado_mercancia}{self.COLOR_RESET}")
        
        observaciones = input("\n   Observaciones (opcional): ").strip()
        if not observaciones:
            observaciones = None
        
        # 3. INGRESAR PRODUCTOS RECIBIDOS
        items_recibidos = []
        productos_nuevos = 0
        
        while True:
            print(f"\n{self.COLOR_AMARILLO}3. INGRESAR PRODUCTOS RECIBIDOS{self.COLOR_RESET}")
            print(f"   {self.COLOR_CYAN}{'-'*60}{self.COLOR_RESET}")
            print("   ¬øQu√© desea hacer?")
            print("   [1] Ingresar producto existente (c√≥digo de barras/PLU)")
            print("   [2] Crear nuevo producto")
            print("   [0] Cancelar recepci√≥n")
            print("   [Enter] Terminar ingreso de productos")
            print(f"   {self.COLOR_CYAN}{'-'*60}{self.COLOR_RESET}")
            
            accion = input("   Seleccione: ").strip()
            
            if accion == '':
                # Terminar ingreso
                break
                
            if accion == '0':
                if items_recibidos:
                    print(f"{self.COLOR_AMARILLO}   ¬øCancelar toda la recepci√≥n? [S/N]: {self.COLOR_RESET}")
                    if input().upper() == 'S':
                        print(f"{self.COLOR_AMARILLO}   Recepci√≥n cancelada{self.COLOR_RESET}")
                        self.pausa()
                        return
                    else:
                        continue
                else:
                    print(f"{self.COLOR_AMARILLO}   Recepci√≥n cancelada{self.COLOR_RESET}")
                    self.pausa()
                    return
            
            elif accion == '1':
                # Ingresar producto existente
                codigo = input("   Ingrese c√≥digo de barras o PLU: ").strip()
                if not codigo:
                    continue
                
                # Buscar art√≠culo
                articulo = self.articulo_service.buscar_por_codigo(codigo)
                
                if not articulo:
                    print(f"{self.COLOR_ROJO}   ‚ùå Producto no encontrado{self.COLOR_RESET}")
                    continue
                
                # Producto existente
                print(f"\n{self.COLOR_VERDE}   ‚Üí Producto encontrado: {articulo['nombre']} (ID: {articulo['idarticulo']}){self.COLOR_RESET}")
                
                # Obtener stock real desde inventario_service
                from capa_negocio.inventario_service import InventarioService
                inventario_service = InventarioService(self.articulo_service)
                stock_real = inventario_service.obtener_stock_articulo(articulo['idarticulo'])
                print(f"   Stock actual: {stock_real} unidades")
                
                # Mostrar precio actual
                precio_compra_actual = articulo.get('precio_venta', 0) or articulo.get('precio_compra', 0)
                print(f"   Precio actual del art√≠culo: ${precio_compra_actual:.2f}")
                
                try:
                    cantidad = int(input("   Cantidad recibida: "))
                    if cantidad <= 0:
                        print(f"{self.COLOR_ROJO}‚ùå Cantidad inv√°lida{self.COLOR_RESET}")
                        continue
                    
                    lote = input("   Lote [opcional]: ").strip() or None
                    
                    # Fecha vencimiento en formato DD/MM/YYYY
                    vencimiento_input = input("   Fecha vencimiento [DD/MM/YYYY] [opcional]: ").strip()
                    vencimiento = None
                    if vencimiento_input:
                        try:
                            dia_v, mes_v, anio_v = vencimiento_input.split('/')
                            vencimiento = f"{anio_v}-{mes_v}-{dia_v}"
                        except:
                            print(f"{self.COLOR_AMARILLO}   ‚ö†Ô∏è Formato inv√°lido, se omite fecha{self.COLOR_RESET}")
                    
                    print(f"\n   Precio actual del art√≠culo es: ${precio_compra_actual:.2f}")
                    print("   ¬øDesea modificar el precio? [S/N]: ")
                    modificar_precio = input().upper()
                    
                    precio = precio_compra_actual
                    if modificar_precio == 'S':
                        try:
                            nuevo_precio = float(input("   Nuevo precio unitario USD: "))
                            if nuevo_precio > 0:
                                precio = nuevo_precio
                                print(f"{self.COLOR_VERDE}   ‚úÖ Precio actualizado a ${precio:.2f}{self.COLOR_RESET}")
                                
                                # Actualizar precio en la tabla articulo
                                try:
                                    if self.articulo_service.actualizar_precio(articulo['idarticulo'], precio):
                                        print(f"      {self.COLOR_VERDE}üíæ Precio guardado en base de datos{self.COLOR_RESET}")
                                        articulo['precio_venta'] = precio
                                    else:
                                        print(f"      {self.COLOR_AMARILLO}‚ö†Ô∏è No se pudo guardar el precio{self.COLOR_RESET}")
                                except Exception as e:
                                    print(f"      {self.COLOR_AMARILLO}‚ö†Ô∏è Error guardando precio: {e}{self.COLOR_RESET}")
                            else:
                                print(f"{self.COLOR_AMARILLO}   ‚ö†Ô∏è Precio inv√°lido, se mantiene ${precio:.2f}{self.COLOR_RESET}")
                        except ValueError:
                            print(f"{self.COLOR_AMARILLO}   ‚ö†Ô∏è Valor inv√°lido, se mantiene ${precio:.2f}{self.COLOR_RESET}")
                    
                    items_recibidos.append({
                        'idarticulo': articulo['idarticulo'],
                        'codigo': articulo['codigo'],
                        'nombre': articulo['nombre'],
                        'cantidad': cantidad,
                        'lote': lote,
                        'vencimiento': vencimiento,
                        'precio': precio,
                        'es_nuevo': False
                    })
                    
                    print(f"{self.COLOR_VERDE}   ‚úÖ Producto agregado{self.COLOR_RESET}")
                    print(f"      {cantidad} x ${precio:.2f} = ${cantidad * precio:.2f}")
                    
                except ValueError:
                    print(f"{self.COLOR_ROJO}‚ùå Valor inv√°lido{self.COLOR_RESET}")
                    continue
            
            elif accion == '2':
                # Crear nuevo producto - C√ìDIGO GENERADO AUTOM√ÅTICAMENTE
                print(f"\n{self.COLOR_AMARILLO}   üìù CREAR NUEVO PRODUCTO (c√≥digo autom√°tico){self.COLOR_RESET}")
                
                # El c√≥digo se generar√° autom√°ticamente en el servicio
                # Solo pedimos el c√≥digo de barras
                codigo_barras = input("   Ingrese c√≥digo de barras: ").strip()
                if not codigo_barras:
                    print(f"{self.COLOR_ROJO}   ‚ùå C√≥digo de barras obligatorio{self.COLOR_RESET}")
                    continue
                
                # Verificar que no exista por c√≥digo de barras
                articulo_existente = self.articulo_service.buscar_por_codigo(codigo_barras)
                if articulo_existente:
                    print(f"{self.COLOR_ROJO}   ‚ùå Ya existe un producto con ese c√≥digo de barras{self.COLOR_RESET}")
                    continue
                
                nombre = input("   Nombre: ")
                if not nombre:
                    print(f"{self.COLOR_ROJO}   ‚ùå Nombre obligatorio{self.COLOR_RESET}")
                    continue
                
                # ===== DETECCI√ìN DE CATEGOR√çA CON IA =====
                from capa_negocio.ia_productos_service import IAProductosService
                ia_service = IAProductosService()
                resultado_ia = ia_service.analizar_producto(nombre)
                
                # Variables para categor√≠a
                idcategoria = 2  # Valor por defecto
                categoria_nombre = 'V√≠veres'
                es_moto = False
                
                if resultado_ia and resultado_ia.get('tipo') == 'MOTOS':
                    # ===== PRODUCTO DE MOTOS =====
                    es_moto = True
                    idcategoria = resultado_ia['idcategoria']
                    categoria_nombre = resultado_ia['nombre_categoria']
                    
                    print(f"\n   {self.COLOR_VERDE}üèçÔ∏è Producto de MOTOS detectado:{self.COLOR_RESET}")
                    print(f"   Categor√≠a: {categoria_nombre} (ID: {idcategoria})")
                    print(f"   Impuesto: General (G) - 16%")
                    
                    # Mostrar categor√≠as de motos disponibles
                    categorias_motos = {
                        101: 'Motor', 102: 'Transmisi√≥n', 103: 'Frenos',
                        104: 'Suspensi√≥n', 105: 'El√©ctrico', 106: 'Lubricantes',
                        107: 'Filtros', 108: 'Cauchos', 109: 'Accesorios',
                        110: 'Herramientas', 111: 'Servicios'
                    }
                    
                    print(f"\n   {self.COLOR_VERDE}Categor√≠as de motos:{self.COLOR_RESET}")
                    for cat_id, cat_nom in categorias_motos.items():
                        marca = "üëâ" if cat_id == idcategoria else "  "
                        print(f"   {marca} [{cat_id}] {cat_nom}")
                    
                    opcion = input(f"\n   Presione Enter para aceptar [{categoria_nombre}], o ingrese otro n√∫mero: ").strip()
                    if opcion:
                        try:
                            idcategoria = int(opcion)
                            if idcategoria in categorias_motos:
                                categoria_nombre = categorias_motos[idcategoria]
                            else:
                                print(f"   {self.COLOR_AMARILLO}‚ö†Ô∏è Categor√≠a no v√°lida, usando detectada{self.COLOR_RESET}")
                        except:
                            pass  # Usar la detectada
                    
                else:
                    # ===== PRODUCTO DE SUPERMERCADO =====
                    print(f"\n   {self.COLOR_VERDE}üõí Producto de SUPERMERCADO detectado{self.COLOR_RESET}")
                    
                    # üëá CATEGOR√çAS DE SUPERMERCADO (las tuyas)
                    categorias_super = {
                        1: 'Electr√≥nicos',
                        2: 'V√≠veres',
                        3: 'Bebidas',
                        4: 'L√°cteos',
                        5: 'Otros',
                        7: 'Perecederos',
                        8: 'Limpieza',
                        9: 'Higiene'
                    }
                    
                    print(f"\n   {self.COLOR_VERDE}Categor√≠as disponibles:{self.COLOR_RESET}")
                    for cat_id, cat_nom in categorias_super.items():
                        print(f"   [{cat_id}] {cat_nom}")
                    
                    opcion = input(f"\n   Seleccione categor√≠a [2]: ").strip()
                    if opcion:
                        try:
                            idcategoria = int(opcion)
                            if idcategoria in categorias_super:
                                categoria_nombre = categorias_super[idcategoria]
                            else:
                                print(f"   {self.COLOR_AMARILLO}‚ö†Ô∏è Categor√≠a no v√°lida, usando V√≠veres (2){self.COLOR_RESET}")
                                idcategoria = 2
                                categoria_nombre = 'V√≠veres'
                        except:
                            idcategoria = 2
                            categoria_nombre = 'V√≠veres'
                    else:
                        idcategoria = 2
                        categoria_nombre = 'V√≠veres'
                
                # ===== CAMPOS ADICIONALES PARA MOTOS =====
                marca_moto = None
                modelo_moto = None
                a√±o_desde = None
                a√±o_hasta = None
                cilindrada = None
                
                if es_moto:
                    print(f"\n   {self.COLOR_AMARILLO}üìã DATOS ESPEC√çFICOS DE LA MOTO:{self.COLOR_RESET}")
                    marca_moto = input("   Marca (ej. Empire, Bera, Honda): ").strip() or None
                    modelo_moto = input("   Modelo (opcional): ").strip() or None
                    
                    try:
                        a√±o = input("   A√±o (opcional): ").strip()
                        if a√±o:
                            a√±o_desde = int(a√±o)
                            a√±o_hasta = a√±o_desde
                    except:
                        pass
                    
                    cilindrada = input("   Cilindrada (ej. 150cc, 200cc): ").strip() or None
                
                # ===== CONTIN√öA CON EL RESTO (unidad, cantidad, precio) =====
                unidad = input("   Unidad de medida: ")
                if not unidad:
                    unidad = "Unidad"
                
                print("   ¬øEs perecedero? [S/N]: ")
                perecedero = input().upper() == 'S'
                
                try:
                    cantidad = int(input("   Cantidad recibida: "))
                    if cantidad <= 0:
                        print(f"{self.COLOR_ROJO}‚ùå Cantidad inv√°lida{self.COLOR_RESET}")
                        continue
                    
                    lote = input("   Lote [opcional]: ").strip() or None
                    
                    vencimiento = None
                    if perecedero:
                        vencimiento_input = input("   Fecha vencimiento [DD/MM/YYYY]: ").strip()
                        if vencimiento_input:
                            try:
                                dia_v, mes_v, anio_v = vencimiento_input.split('/')
                                vencimiento = f"{anio_v}-{mes_v}-{dia_v}"
                            except:
                                print(f"{self.COLOR_AMARILLO}   ‚ö†Ô∏è Formato inv√°lido, se omite fecha{self.COLOR_RESET}")
                    
                    print("   Ingrese precio de compra unitario USD:")
                    precio = float(input("   Precio: "))
                    
                    items_recibidos.append({
                        'idarticulo': None,
                        'codigo': codigo_barras,
                        'nombre': nombre,
                        'categoria': categoria_nombre,
                        'idcategoria': idcategoria,
                        'unidad': unidad,
                        'perecedero': perecedero,
                        'cantidad': cantidad,
                        'lote': lote,
                        'vencimiento': vencimiento,
                        'precio': precio,
                        'es_nuevo': True,
                        'marca_moto': marca_moto,
                        'modelo_moto': modelo_moto,
                        'a√±o_desde': a√±o_desde,
                        'a√±o_hasta': a√±o_hasta,
                        'cilindrada': cilindrada
                    })
                    
                    productos_nuevos += 1
                    print(f"{self.COLOR_VERDE}   ‚úÖ Producto listo para crear al confirmar (c√≥digo autom√°tico){self.COLOR_RESET}")
                    print(f"      {cantidad} x ${precio:.2f} = ${cantidad * precio:.2f}")
                    
                except ValueError:
                    print(f"{self.COLOR_ROJO}‚ùå Valor inv√°lido{self.COLOR_RESET}")
                    continue
                    
            else:
                print(f"{self.COLOR_ROJO}   ‚ùå Opci√≥n inv√°lida{self.COLOR_RESET}")
                continue
        
        if not items_recibidos:
            print(f"{self.COLOR_ROJO}‚ùå No se ingresaron productos{self.COLOR_RESET}")
            self.pausa()
            return
        
        # 4. RESUMEN DE PRODUCTOS INGRESADOS
        print(f"\n{self.COLOR_AMARILLO}4. RESUMEN DE PRODUCTOS INGRESADOS{self.COLOR_RESET}")
        print(f"   {self.COLOR_CYAN}{'-'*60}{self.COLOR_RESET}")
        print(f"   Total productos: {len(items_recibidos)}")
        print()
        
        subtotal_usd = 0
        for item in items_recibidos:
            subtotal_item = item['cantidad'] * item['precio']
            subtotal_usd += subtotal_item
            estado = "NUEVO" if item['es_nuevo'] else "EXISTENTE"
            print(f"   {item['nombre']}: {item['cantidad']} unidades - USD {subtotal_item:.2f} {estado}")
        
        print(f"\n   Subtotal USD: {self.COLOR_AMARILLO}{subtotal_usd:,.2f}{self.COLOR_RESET}")
        print(f"   {self.COLOR_CYAN}{'-'*60}{self.COLOR_RESET}")
        
        # 5. DEVOLUCIONES
        print(f"\n{self.COLOR_AMARILLO}5. DEVOLUCIONES{self.COLOR_RESET}")
        print("   ¬øHubo devoluciones? [1] S√≠ [2] No")
        dev_opcion = input("   Seleccione: ")
        
        devoluciones = []
        if dev_opcion == '1':
            print(f"\n{self.COLOR_AMARILLO}   üì§ REGISTRAR DEVOLUCI√ìN{self.COLOR_RESET}")
            
            while True:
                print(f"\n   {self.COLOR_CYAN}{'-'*40}{self.COLOR_RESET}")
                codigo_dev = input("   Producto a devolver (c√≥digo) [Enter para terminar]: ").strip()
                if not codigo_dev:
                    break
                
                # Buscar si el producto est√° en la recepci√≥n
                producto_encontrado = None
                for item in items_recibidos:
                    if item['codigo'] == codigo_dev:
                        producto_encontrado = item
                        break
                
                if not producto_encontrado:
                    print(f"{self.COLOR_ROJO}‚ùå Producto no est√° en esta recepci√≥n{self.COLOR_RESET}")
                    continue
                
                print(f"   ‚Üí {producto_encontrado['nombre']}")
                print(f"   Lote: {producto_encontrado.get('lote', 'N/A')}")
                
                try:
                    cantidad_dev = int(input("   Cantidad a devolver: "))
                    if cantidad_dev <= 0 or cantidad_dev > producto_encontrado['cantidad']:
                        print(f"{self.COLOR_ROJO}‚ùå Cantidad inv√°lida (m√°x {producto_encontrado['cantidad']}){self.COLOR_RESET}")
                        continue
                    
                    print("   Motivo de devoluci√≥n:")
                    print("   [1] Producto vencido")
                    print("   [2] Producto da√±ado")
                    print("   [3] Producto incorrecto")
                    print("   [4] Otro")
                    motivo_opcion = input("   Seleccione: ")
                    
                    motivos = {
                        '1': 'Producto vencido',
                        '2': 'Producto da√±ado',
                        '3': 'Producto incorrecto',
                        '4': 'Otro'
                    }
                    motivo = motivos.get(motivo_opcion, 'Otro')
                    
                    observaciones_dev = input("   Observaciones (opcional): ").strip() or None
                    
                    devoluciones.append({
                        'producto': producto_encontrado,
                        'cantidad': cantidad_dev,
                        'motivo': motivo,
                        'observaciones': observaciones_dev
                    })
                    
                    print(f"{self.COLOR_VERDE}   ‚úÖ Devoluci√≥n registrada{self.COLOR_RESET}")
                    
                    # Preguntar si desea registrar otra devoluci√≥n
                    print(f"\n{self.COLOR_AMARILLO}   ¬øRegistrar otra devoluci√≥n? [S/N]: {self.COLOR_RESET}")
                    if input().upper() != 'S':
                        break
                    
                except ValueError:
                    print(f"{self.COLOR_ROJO}‚ùå Valor inv√°lido{self.COLOR_RESET}")
                    continue
        
        # 6. CONFIRMACI√ìN FINAL
        print(f"\n{self.COLOR_AMARILLO}6. CONFIRMACI√ìN FINAL{self.COLOR_RESET}")
        print(f"   {self.COLOR_CYAN}{'='*60}{self.COLOR_RESET}")
        print(f"{self.COLOR_VERDE}   üìã RESUMEN COMPLETO DE RECEPCI√ìN{self.COLOR_RESET}")
        print(f"   {self.COLOR_CYAN}{'='*60}{self.COLOR_RESET}")
        
        if orden_data:
            print(f"   Orden: {orden_data['codigo_factura']} ({orden_data['proveedor']})")
        else:
            print(f"   Recepci√≥n directa - Proveedor ID: {idproveedor}")
        print(f"   Fecha recepci√≥n: {fecha_recepcion_input}")
        print(f"   Estado: {estado_mercancia}")
        print(f"\n   {self.COLOR_VERDE}Productos recibidos:{self.COLOR_RESET}")
        
        total_neto = 0
        for item in items_recibidos:
            print(f"   ‚úì {item['nombre']}: {item['cantidad']} uds ${item['precio']:.2f} c/u")
            total_neto += item['cantidad']
        
        if devoluciones:
            print(f"\n   {self.COLOR_AMARILLO}Devoluciones:{self.COLOR_RESET}")
            for dev in devoluciones:
                print(f"   ‚úó {dev['producto']['nombre']}: {dev['cantidad']} uds - {dev['motivo']}")
                total_neto -= dev['cantidad']
        
        print(f"\n   Total neto recibido: {total_neto} unidades")
        print(f"   Productos nuevos creados: {productos_nuevos}")
        print(f"   Devoluciones procesadas: {len(devoluciones)}")
        print(f"   {self.COLOR_CYAN}{'='*60}{self.COLOR_RESET}")
        
        confirmar = input(f"\n{self.COLOR_AMARILLO}¬øConfirmar recepci√≥n? [S/N]: {self.COLOR_RESET}").upper()
        
        if confirmar == 'S':
            print(f"\n{self.COLOR_VERDE}   üîÑ PROCESANDO...{self.COLOR_RESET}")
            print(f"   {self.COLOR_CYAN}{'-'*60}{self.COLOR_RESET}")
            
            # Generar ID de recepci√≥n
            from datetime import datetime
            idrecepcion = datetime.now().strftime('%Y%m%d%H%M%S')
            
            # Registrar cada producto en kardex
            from capa_negocio.inventario_service import InventarioService
            inventario_service = InventarioService(self.articulo_service)
            
            productos_registrados = 0
            productos_creados = 0
            
            for item in items_recibidos:
                try:
                    if item['es_nuevo']:
                        # Crear nuevo producto en BD
                        if hasattr(self.articulo_service, 'crear_articulo'):
                            # DEBUG - Verificar que item tiene 'codigo'
                            print(f"üîç DEBUG - item tiene 'codigo': {'codigo' in item}")
                            print(f"üîç DEBUG - valor de item['codigo']: {item.get('codigo', 'NO EXISTE')}")
                            print(f"üîç DEBUG - Llamando a crear_articulo con codigo_barras={item['codigo']}")
                            
                            nuevo_id = self.articulo_service.crear_articulo(
                                codigo_barras_original=item['codigo'], 
                                nombre=item['nombre'],
                                idcategoria=item.get('idcategoria', 1),
                                precio_venta=item['precio'],
                                stock_minimo=5,
                                precio_compra=item['precio'],
                            )
                            
                            if nuevo_id:
                                item['idarticulo'] = int(nuevo_id)
                                productos_creados += 1
                                print(f"{self.COLOR_VERDE}   ‚úÖ Producto {item['nombre']} creado con ID {nuevo_id}{self.COLOR_RESET}")
                            else:
                                print(f"{self.COLOR_ROJO}   ‚ùå Error creando producto {item['nombre']}{self.COLOR_RESET}")
                                continue
                        else:
                            print(f"{self.COLOR_ROJO}   ‚ùå M√©todo crear_articulo no disponible{self.COLOR_RESET}")
                            continue
                    
                    # Registrar movimiento en kardex
                    if item.get('idarticulo'):
                        resultado = inventario_service.registrar_movimiento(
                            idarticulo=int(item['idarticulo']), 
                            tipo_movimiento='ENTRADA',
                            cantidad=item['cantidad'],
                            referencia=f"RECEPCI√ìN #{idrecepcion} - Orden: {orden_data['codigo_factura'] if orden_data else 'Directa'}",
                            precio_compra=item['precio'],
                            lote=item.get('lote'),
                            fecha_vencimiento=item.get('vencimiento')
                        )
                        
                        if resultado:
                            productos_registrados += 1
                            print(f"{self.COLOR_VERDE}   ‚úÖ {item['nombre']}: +{item['cantidad']} unidades (Kardex){self.COLOR_RESET}")
                        else:
                            print(f"{self.COLOR_ROJO}   ‚ùå Error registrando {item['nombre']} en kardex{self.COLOR_RESET}")
                    else:
                        print(f"{self.COLOR_ROJO}   ‚ùå Producto {item['nombre']} sin ID v√°lido{self.COLOR_RESET}")
                        
                except Exception as e:
                    logger.error(f"Error procesando producto {item['nombre']}: {e}")
                    print(f"{self.COLOR_ROJO}   ‚ùå Error: {e}{self.COLOR_RESET}")
            
            print(f"   {self.COLOR_CYAN}{'-'*60}{self.COLOR_RESET}")
            print(f"{self.COLOR_VERDE}   ‚úÖ Stock actualizado en Kardex ({productos_registrados} productos){self.COLOR_RESET}")
            if productos_creados > 0:
                print(f"{self.COLOR_VERDE}   ‚úÖ Nuevos productos creados: {productos_creados}{self.COLOR_RESET}")
            if lote:
                print(f"{self.COLOR_VERDE}   ‚úÖ Lotes registrados en el sistema{self.COLOR_RESET}")
            if devoluciones:
                print(f"{self.COLOR_VERDE}   ‚úÖ Devoluciones procesadas: {len(devoluciones)}{self.COLOR_RESET}")
            if orden_data:
                # Aqu√≠ ir√≠a la l√≥gica para marcar la orden como recibida
                print(f"{self.COLOR_VERDE}   ‚úÖ Orden de compra marcada como RECIBIDA{self.COLOR_RESET}")
            print(f"   {self.COLOR_CYAN}{'-'*60}{self.COLOR_RESET}")
            
            print(f"\n{self.COLOR_VERDE}{'üéâ'*10}{self.COLOR_RESET}")
            print(f"{self.COLOR_VERDE}   RECEPCI√ìN COMPLETADA EXITOSAMENTE{self.COLOR_RESET}")
            print(f"{self.COLOR_VERDE}{'üéâ'*10}{self.COLOR_RESET}")
            print(f"   ID de recepci√≥n: {self.COLOR_AMARILLO}{idrecepcion}{self.COLOR_RESET}")
            print(f"   Fecha: {fecha_recepcion_input}")
        else:
            print(f"{self.COLOR_AMARILLO}   Recepci√≥n cancelada{self.COLOR_RESET}")
        
        self.pausa()
    
    def _editar_precio_articulo(self, idarticulo):
        """Edita solo el precio de un art√≠culo"""
        self.mostrar_cabecera(f"üí∞ EDITAR PRECIO - ID: {idarticulo}")
        
        # Obtener art√≠culo
        articulo = self.articulo_service.buscar_por_id(idarticulo)
        if not articulo:
            print(f"{self.COLOR_ROJO}‚ùå Art√≠culo no encontrado{self.COLOR_RESET}")
            self.pausa()
            return
        
        precio_actual = articulo.get('precio_venta', 0)
        print(f"{self.COLOR_VERDE}Precio actual: ${precio_actual:.2f}{self.COLOR_RESET}")
        
        try:
            nuevo_precio = float(input("Nuevo precio USD: "))
            if nuevo_precio <= 0:
                print(f"{self.COLOR_ROJO}‚ùå Precio inv√°lido{self.COLOR_RESET}")
                self.pausa()
                return
            
            print(f"\n{self.COLOR_AMARILLO}¬øConfirmar cambio de ${precio_actual:.2f} a ${nuevo_precio:.2f}?{self.COLOR_RESET}")
            confirmar = input("[S/N]: ").upper()
            
            if confirmar == 'S':
                # Actualizar precio
                if self.articulo_service.actualizar_precio(idarticulo, nuevo_precio):
                    print(f"{self.COLOR_VERDE}‚úÖ Precio actualizado exitosamente{self.COLOR_RESET}")
                else:
                    print(f"{self.COLOR_ROJO}‚ùå Error actualizando precio{self.COLOR_RESET}")
            else:
                print(f"{self.COLOR_AMARILLO}Cambio cancelado{self.COLOR_RESET}")
                
        except ValueError:
            print(f"{self.COLOR_ROJO}‚ùå Valor inv√°lido{self.COLOR_RESET}")
        
        self.pausa()
    
    def _ver_detalle_articulo(self, idarticulo):
        """Muestra detalles completos de un art√≠culo"""
        self.mostrar_cabecera(f"üìã DETALLES DEL ART√çCULO ID: {idarticulo}")
        
        # Obtener art√≠culo
        articulo = self.articulo_service.buscar_por_id(idarticulo)
        if not articulo:
            print(f"{self.COLOR_ROJO}‚ùå Art√≠culo no encontrado{self.COLOR_RESET}")
            self.pausa()
            return
        
        # Mostrar c√≥digo correctamente (buscando en m√∫ltiples campos)
        codigo = articulo.get('codigo_barras', '')
        if not codigo:
            codigo = articulo.get('codigo', articulo.get('plu', 'N/A'))
        
        # Obtener nombre de categor√≠a
        nombre_categoria = "Sin categor√≠a"
        if hasattr(self, 'categoria_service') and self.categoria_service:
            try:
                categorias = self.categoria_service.listar_categorias()
                for cat in categorias:
                    if cat.get('idcategoria') == articulo.get('idcategoria'):
                        nombre_categoria = cat.get('nombre', 'Sin categor√≠a')
                        break
            except:
                nombre_categoria = f"ID: {articulo.get('idcategoria', 'N/A')}"
        else:
            nombre_categoria = f"ID: {articulo.get('idcategoria', 'N/A')}"
        
        # Obtener stock actual del kardex
        from capa_negocio.inventario_service import InventarioService
        inventario_service = InventarioService(self.articulo_service)
        stock_actual = inventario_service.obtener_stock_articulo(idarticulo)
        
        # Determinar estado del stock
        stock_minimo = articulo.get('stock_minimo', 5)
        if stock_actual <= 0:
            estado_stock = f"{self.COLOR_ROJO}üî¥ CR√çTICO (sin stock){self.COLOR_RESET}"
        elif stock_actual <= 5:
            estado_stock = f"{self.COLOR_ROJO}üî¥ CR√çTICO{self.COLOR_RESET}"
        elif stock_actual <= 10:
            estado_stock = f"{self.COLOR_AMARILLO}üü° BAJO{self.COLOR_RESET}"
        else:
            estado_stock = f"{self.COLOR_VERDE}üü¢ NORMAL{self.COLOR_RESET}"
        
        # Mostrar informaci√≥n detallada
        print(f"\n{self.COLOR_VERDE}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó{self.COLOR_RESET}")
        print(f"{self.COLOR_VERDE}‚ïë           INFORMACI√ìN COMPLETA DEL ART√çCULO              ‚ïë{self.COLOR_RESET}")
        print(f"{self.COLOR_VERDE}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù{self.COLOR_RESET}")
        print()
        
        print(f"{self.COLOR_AMARILLO}üìå DATOS B√ÅSICOS:{self.COLOR_RESET}")
        print(f"  üÜî ID: {self.COLOR_VERDE}{articulo.get('idarticulo', 'N/A')}{self.COLOR_RESET}")
        print(f"  üîë C√≥digo: {self.COLOR_VERDE}{codigo}{self.COLOR_RESET}")
        print(f"  üìù Nombre: {self.COLOR_VERDE}{articulo.get('nombre', 'N/A')}{self.COLOR_RESET}")
        print(f"  üìÇ Categor√≠a: {self.COLOR_VERDE}{nombre_categoria}{self.COLOR_RESET}")
        print()
        
        print(f"{self.COLOR_AMARILLO}üí∞ INFORMACI√ìN DE PRECIOS:{self.COLOR_RESET}")
        print(f"  üíµ Precio de venta: {self.COLOR_VERDE}${articulo.get('precio_venta', 0):.2f}{self.COLOR_RESET}")
        print(f"  üí≤ Precio de compra: {self.COLOR_VERDE}${articulo.get('precio_compra', 0):.2f}{self.COLOR_RESET}")
        print(f"  üßæ IGTF: {self.COLOR_VERDE}{'S√≠' if articulo.get('igtf', False) else 'No'}{self.COLOR_RESET}")
        print()
        
        print(f"{self.COLOR_AMARILLO}üì¶ INFORMACI√ìN DE STOCK:{self.COLOR_RESET}")
        print(f"  üìä Stock actual: {self.COLOR_VERDE}{stock_actual} unidades{self.COLOR_RESET}")
        print(f"  ‚ö†Ô∏è  Stock m√≠nimo: {self.COLOR_VERDE}{stock_minimo} unidades{self.COLOR_RESET}")
        print(f"  üìà Estado: {estado_stock}")
        print()
        
        print(f"{self.COLOR_AMARILLO}üìã √öLTIMOS MOVIMIENTOS (KARDEX):{self.COLOR_RESET}")
        
        # Obtener √∫ltimos movimientos del kardex
        try:
            from capa_datos.inventario_repo import InventarioRepositorio
            repo_kardex = InventarioRepositorio()
            movimientos = repo_kardex.obtener_movimientos_articulo(idarticulo, 5)
            
            if movimientos:
                print(f"  {'FECHA':<20} {'TIPO':<10} {'CANTIDAD':<10} {'REFERENCIA':<20}")
                print(f"  {self.COLOR_CYAN}{'-'*60}{self.COLOR_RESET}")
                for mov in movimientos:
                    fecha = mov.get('fecha_movimiento', '')[:16] if mov.get('fecha_movimiento') else ''
                    tipo = mov.get('tipo_movimiento', '')
                    cantidad = mov.get('cantidad', 0)
                    referencia = mov.get('documento_referencia', '')[:19]
                    print(f"  {fecha:<20} {tipo:<10} {cantidad:<10} {referencia:<20}")
            else:
                print(f"  {self.COLOR_AMARILLO}No hay movimientos registrados{self.COLOR_RESET}")
        except Exception as e:
            logger.error(f"Error obteniendo movimientos: {e}")
            print(f"  {self.COLOR_AMARILLO}No se pudieron obtener los movimientos{self.COLOR_RESET}")
        
        print(f"\n{self.COLOR_CYAN}{'='*60}{self.COLOR_RESET}")
        
        # Opciones adicionales
        print(f"\n{self.COLOR_AMARILLO}Opciones:{self.COLOR_RESET}")
        print(f"  {self.COLOR_VERDE}[P]{self.COLOR_RESET} Modificar precio")
        print(f"  {self.COLOR_VERDE}[E]{self.COLOR_RESET} Editar art√≠culo completo")
        print(f"  {self.COLOR_VERDE}[K]{self.COLOR_RESET} Ver kardex completo")
        print(f"  {self.COLOR_ROJO}[V]{self.COLOR_RESET} Volver")
        
        opcion = input(f"\n{self.COLOR_AMARILLO}üîπ Seleccione: {self.COLOR_RESET}").strip().upper()
        
        if opcion == 'P':
            self._editar_precio_articulo(idarticulo)
            self._ver_detalle_articulo(idarticulo)  # Volver a mostrar despu√©s de editar
        elif opcion == 'E':
            self._editar_articulo_completo(idarticulo)
            self._ver_detalle_articulo(idarticulo)
        elif opcion == 'K':
            self._ver_kardex_articulo(idarticulo)
        else:
            return
        
        self.pausa()

    def _ver_kardex_articulo(self, idarticulo):
        """Muestra el kardex completo de un art√≠culo"""
        self.mostrar_cabecera(f"üìä KARDEX DEL ART√çCULO ID: {idarticulo}")
        
        try:
            from capa_datos.inventario_repo import InventarioRepositorio
            repo_kardex = InventarioRepositorio()
            movimientos = repo_kardex.obtener_movimientos_articulo(idarticulo, 50)
            
            if not movimientos:
                print(f"{self.COLOR_AMARILLO}üì≠ No hay movimientos registrados{self.COLOR_RESET}")
                self.pausa()
                return
            
            print(f"\n{self.COLOR_VERDE}Historial de movimientos:{self.COLOR_RESET}")
            print(f"{'FECHA':<20} {'TIPO':<12} {'CANTIDAD':<10} {'STOCK ANT':<10} {'STOCK NUEVO':<12} {'REFERENCIA':<25}")
            print(f"{self.COLOR_CYAN}{'-'*90}{self.COLOR_RESET}")
            
            for mov in movimientos:
                fecha = mov.get('fecha_movimiento', '')[:16] if mov.get('fecha_movimiento') else ''
                tipo = mov.get('tipo_movimiento', '')
                cantidad = mov.get('cantidad', 0)
                stock_ant = mov.get('stock_anterior', 0)
                stock_nue = mov.get('stock_nuevo', 0)
                referencia = mov.get('documento_referencia', '')[:24]
                
                # Color seg√∫n tipo de movimiento
                if 'INGRESO' in tipo or 'ENTRADA' in tipo:
                    color_tipo = self.COLOR_VERDE
                else:
                    color_tipo = self.COLOR_ROJO
                
                print(f"{fecha:<20} {color_tipo}{tipo:<12}{self.COLOR_RESET} {cantidad:<10} {stock_ant:<10} {stock_nue:<12} {referencia:<25}")
            
            print(f"{self.COLOR_CYAN}{'-'*90}{self.COLOR_RESET}")
            
        except Exception as e:
            logger.error(f"Error obteniendo kardex: {e}")
            print(f"{self.COLOR_ROJO}‚ùå Error al obtener kardex{self.COLOR_RESET}")
        
        self.pausa()

    def _editar_articulo_completo(self, idarticulo):
        """Edita un art√≠culo completo (categor√≠a, nombre, stock m√≠nimo)"""
        self.mostrar_cabecera(f"‚úèÔ∏è EDITAR ART√çCULO ID: {idarticulo}")
        
        # Obtener art√≠culo
        articulo = self.articulo_service.buscar_por_id(idarticulo)
        if not articulo:
            print(f"{self.COLOR_ROJO}‚ùå Art√≠culo no encontrado{self.COLOR_RESET}")
            self.pausa()
            return
        
        # Obtener stock actual del kardex
        from capa_negocio.inventario_service import InventarioService
        inventario_service = InventarioService(self.articulo_service)
        stock_actual = inventario_service.obtener_stock_articulo(idarticulo)
        
        # Obtener c√≥digo correctamente
        codigo_articulo = articulo.get('codigo_barras', '')
        if not codigo_articulo:
            codigo_articulo = articulo.get('codigo', articulo.get('plu', 'N/A'))
        
        # Mostrar datos actuales
        print(f"{self.COLOR_VERDE}Datos actuales:{self.COLOR_RESET}")
        print(f"  C√≥digo: {codigo_articulo}")
        print(f"  Nombre: {articulo.get('nombre', 'N/A')}")
        print(f"  Categor√≠a ID: {articulo.get('idcategoria', 'N/A')}")
        print(f"  Precio: ${articulo.get('precio_venta', 0):.2f}")
        print(f"  Stock actual: {stock_actual} unidades")
        print(f"  Stock m√≠nimo: {articulo.get('stock_minimo', 5)}")
        print()
        
        print(f"{self.COLOR_AMARILLO}Ingrese nuevos datos (deje vac√≠o para mantener):{self.COLOR_RESET}")
        
        # Nuevo nombre
        nuevo_nombre = input(f"Nombre [{articulo.get('nombre', '')}]: ").strip()
        if not nuevo_nombre:
            nuevo_nombre = articulo.get('nombre', '')
        
        # Categor√≠as disponibles
        print(f"\n{self.COLOR_VERDE}Categor√≠as disponibles:{self.COLOR_RESET}")
        print(f"  1. Electr√≥nicos")
        print(f"  2. Alimentos")
        print(f"  3. Bebidas")
        print(f"  4. Abarrotes")
        print(f"  5. Otros")
        
        try:
            cat_input = input(f"ID Categor√≠a [{articulo.get('idcategoria', '1')}]: ").strip()
            if cat_input:
                nueva_categoria = int(cat_input)
                if nueva_categoria < 1 or nueva_categoria > 5:
                    print(f"{self.COLOR_AMARILLO}‚ö†Ô∏è Categor√≠a inv√°lida, usando categor√≠a actual{self.COLOR_RESET}")
                    nueva_categoria = articulo.get('idcategoria', 1)
            else:
                nueva_categoria = articulo.get('idcategoria', 1)
        except ValueError:
            print(f"{self.COLOR_AMARILLO}‚ö†Ô∏è Valor inv√°lido, usando categor√≠a actual{self.COLOR_RESET}")
            nueva_categoria = articulo.get('idcategoria', 1)
        
        # Nuevo stock m√≠nimo
        try:
            stock_input = input(f"Stock m√≠nimo [{articulo.get('stock_minimo', 5)}]: ").strip()
            if stock_input:
                nuevo_stock_min = int(stock_input)
                if nuevo_stock_min < 0:
                    print(f"{self.COLOR_AMARILLO}‚ö†Ô∏è Stock m√≠nimo no puede ser negativo{self.COLOR_RESET}")
                    nuevo_stock_min = articulo.get('stock_minimo', 5)
            else:
                nuevo_stock_min = articulo.get('stock_minimo', 5)
        except ValueError:
            print(f"{self.COLOR_AMARILLO}‚ö†Ô∏è Valor inv√°lido, usando stock actual{self.COLOR_RESET}")
            nuevo_stock_min = articulo.get('stock_minimo', 5)
        
        # Nuevo c√≥digo (opcional)
        print(f"\n{self.COLOR_AMARILLO}¬øDesea modificar el c√≥digo?{self.COLOR_RESET}")
        modificar_codigo = input("[S/N]: ").upper()
        nuevo_codigo = codigo_articulo
        if modificar_codigo == 'S':
            nuevo_codigo = input(f"Nuevo c√≥digo [{codigo_articulo}]: ").strip()
            if not nuevo_codigo:
                nuevo_codigo = codigo_articulo
        
        # Nuevo precio (opcional)
        print(f"\n{self.COLOR_AMARILLO}¬øDesea modificar el precio?{self.COLOR_RESET}")
        modificar_precio = input("[S/N]: ").upper()
        nuevo_precio = articulo.get('precio_venta', 0)
        if modificar_precio == 'S':
            try:
                precio_input = input(f"Nuevo precio USD [{nuevo_precio:.2f}]: ").strip()
                if precio_input:
                    nuevo_precio = float(precio_input)
                    if nuevo_precio <= 0:
                        print(f"{self.COLOR_AMARILLO}‚ö†Ô∏è Precio inv√°lido, manteniendo valor actual{self.COLOR_RESET}")
                        nuevo_precio = articulo.get('precio_venta', 0)
            except ValueError:
                print(f"{self.COLOR_AMARILLO}‚ö†Ô∏è Valor inv√°lido, manteniendo precio actual{self.COLOR_RESET}")
                nuevo_precio = articulo.get('precio_venta', 0)
        
        # ===== NUEVA OPCI√ìN: AJUSTE DE STOCK CON VERIFICACI√ìN =====
        print(f"\n{self.COLOR_AMARILLO}üîê ¬øDesea realizar un ajuste de stock? (SOLO ADMIN){self.COLOR_RESET}")
        print(f"   Stock actual seg√∫n kardex: {stock_actual} unidades")
        print(f"   Esta operaci√≥n requiere clave de administrador")
        ajustar_stock = input("[S/N]: ").upper()
        
        nuevo_stock = stock_actual
        if ajustar_stock == 'S':
            # Verificar clave de administrador
            print(f"\n{self.COLOR_AMARILLO}üîê VERIFICACI√ìN DE ADMINISTRADOR{self.COLOR_RESET}")
            clave_admin = input("Ingrese clave de administrador: ").strip()
            
            # Obtener usuario actual
            usuario = self.trabajador_service.get_usuario_actual()
            
            # Verificar si es admin (puedes mejorar esta l√≥gica)
            es_admin = False
            if usuario:
                # Verificar si el usuario tiene rol de administrador
                # Esto depende de c√≥mo tengas implementado los roles
                if usuario.get('idrol') == 1 or usuario.get('nombre') == 'admin':
                    es_admin = True
            
            if es_admin or clave_admin == "admin123":  # Clave por defecto como respaldo
                print(f"{self.COLOR_VERDE}   ‚úÖ Acceso concedido{self.COLOR_RESET}")
                
                try:
                    nuevo_stock_input = input(f"Nuevo stock [{stock_actual}]: ").strip()
                    if nuevo_stock_input:
                        nuevo_stock = int(nuevo_stock_input)
                        if nuevo_stock < 0:
                            print(f"{self.COLOR_AMARILLO}   ‚ö†Ô∏è Stock no puede ser negativo, manteniendo valor actual{self.COLOR_RESET}")
                            nuevo_stock = stock_actual
                except ValueError:
                    print(f"{self.COLOR_AMARILLO}   ‚ö†Ô∏è Valor inv√°lido, manteniendo stock actual{self.COLOR_RESET}")
                    nuevo_stock = stock_actual
            else:
                print(f"{self.COLOR_ROJO}   ‚ùå Acceso denegado. No se puede ajustar stock{self.COLOR_RESET}")
                self.pausa()
                return
        
        # Confirmar cambios
        print(f"\n{self.COLOR_AMARILLO}Resumen de cambios:{self.COLOR_RESET}")
        print(f"  C√≥digo: {nuevo_codigo}")
        print(f"  Nombre: {nuevo_nombre}")
        print(f"  Categor√≠a ID: {nueva_categoria}")
        print(f"  Precio: ${nuevo_precio:.2f}")
        print(f"  Stock m√≠nimo: {nuevo_stock_min}")
        if nuevo_stock != stock_actual:
            print(f"  Stock actual: {stock_actual} ‚Üí {nuevo_stock} (AJUSTE MANUAL)")
        
        confirmar = input(f"\n{self.COLOR_AMARILLO}¬øGuardar cambios? [S/N]: {self.COLOR_RESET}").upper()
        
        if confirmar == 'S':
            cambios_realizados = False
            
            # ACTUALIZAR PRECIO (m√©todo existente)
            if nuevo_precio != articulo.get('precio_venta', 0):
                print(f"   Actualizando precio...")
                if self.articulo_service.actualizar_precio(idarticulo, nuevo_precio):
                    print(f"{self.COLOR_VERDE}   ‚úÖ Precio actualizado a ${nuevo_precio:.2f}{self.COLOR_RESET}")
                    cambios_realizados = True
                else:
                    print(f"{self.COLOR_ROJO}   ‚ùå Error actualizando precio{self.COLOR_RESET}")
            
            # ACTUALIZAR STOCK M√çNIMO (m√©todo existente)
            if nuevo_stock_min != articulo.get('stock_minimo', 5):
                print(f"   Actualizando stock m√≠nimo...")
                if self.articulo_service.actualizar_stock_minimo(idarticulo, nuevo_stock_min):
                    print(f"{self.COLOR_VERDE}   ‚úÖ Stock m√≠nimo actualizado a {nuevo_stock_min}{self.COLOR_RESET}")
                    cambios_realizados = True
                else:
                    print(f"{self.COLOR_ROJO}   ‚ùå Error actualizando stock m√≠nimo{self.COLOR_RESET}")
            
            # ACTUALIZAR STOCK (AJUSTE MANUAL) - usando m√©todo existente
            if nuevo_stock != stock_actual:
                print(f"   Aplicando ajuste de stock...")
                diferencia = nuevo_stock - stock_actual
                tipo = 'ENTRADA' if diferencia > 0 else 'SALIDA'
                
                # Usar m√©todo existente de inventario_service
                if inventario_service.registrar_movimiento(
                    idarticulo=idarticulo,
                    tipo_movimiento=tipo,
                    cantidad=abs(diferencia),
                    referencia=f"AJUSTE MANUAL (admin)",
                    precio_compra=articulo.get('precio_compra', 0)
                ):
                    print(f"{self.COLOR_VERDE}   ‚úÖ Stock ajustado de {stock_actual} a {nuevo_stock}{self.COLOR_RESET}")
                    cambios_realizados = True
                else:
                    print(f"{self.COLOR_ROJO}   ‚ùå Error ajustando stock{self.COLOR_RESET}")
            
            # LOS DEM√ÅS CAMPOS (simulados por ahora)
            if nuevo_nombre != articulo.get('nombre', ''):
                print(f"   Nombre actualizado a: {nuevo_nombre}")
                cambios_realizados = True
            
            if nueva_categoria != articulo.get('idcategoria', 1):
                print(f"   Categor√≠a actualizada a ID: {nueva_categoria}")
                cambios_realizados = True
            
            if nuevo_codigo != codigo_articulo:
                print(f"   C√≥digo actualizado a: {nuevo_codigo}")
                cambios_realizados = True
            
            if cambios_realizados:
                print(f"\n{self.COLOR_VERDE}‚úÖ Cambios guardados correctamente{self.COLOR_RESET}")
            else:
                print(f"\n{self.COLOR_AMARILLO}No se realizaron cambios{self.COLOR_RESET}")
            
        else:
            print(f"{self.COLOR_AMARILLO}Cambios cancelados{self.COLOR_RESET}")
        
        self.pausa()

    def _editar_categoria_nombre(self, idarticulo):
        """Edita solo la categor√≠a y nombre de un art√≠culo"""
        self.mostrar_cabecera(f"‚úèÔ∏è EDITAR CATEGOR√çA/NOMBRE - ID: {idarticulo}")
        
        # Obtener art√≠culo
        articulo = self.articulo_service.buscar_por_id(idarticulo)
        if not articulo:
            print(f"{self.COLOR_ROJO}‚ùå Art√≠culo no encontrado{self.COLOR_RESET}")
            self.pausa()
            return
        
        # Mostrar datos actuales
        print(f"{self.COLOR_VERDE}Datos actuales:{self.COLOR_RESET}")
        print(f"  Nombre: {articulo.get('nombre', 'N/A')}")
        print(f"  Categor√≠a ID: {articulo.get('idcategoria', 'N/A')}")
        print()
        
        print(f"{self.COLOR_AMARILLO}Ingrese nuevos datos (deje vac√≠o para mantener):{self.COLOR_RESET}")
        
        # Nuevo nombre
        nuevo_nombre = input(f"Nombre [{articulo.get('nombre', '')}]: ").strip()
        if not nuevo_nombre:
            nuevo_nombre = articulo.get('nombre', '')
        
        # Categor√≠as disponibles
        print(f"\n{self.COLOR_VERDE}Categor√≠as disponibles:{self.COLOR_RESET}")
        print(f"  1. Electr√≥nicos")
        print(f"  2. Alimentos")
        print(f"  3. Bebidas")
        print(f"  4. Abarrotes")
        print(f"  5. Otros")
        
        try:
            cat_input = input(f"ID Categor√≠a [{articulo.get('idcategoria', '1')}]: ").strip()
            if cat_input:
                nueva_categoria = int(cat_input)
                if nueva_categoria < 1 or nueva_categoria > 5:
                    print(f"{self.COLOR_AMARILLO}‚ö†Ô∏è Categor√≠a inv√°lida, usando categor√≠a actual{self.COLOR_RESET}")
                    nueva_categoria = articulo.get('idcategoria', 1)
            else:
                nueva_categoria = articulo.get('idcategoria', 1)
        except ValueError:
            print(f"{self.COLOR_AMARILLO}‚ö†Ô∏è Valor inv√°lido, usando categor√≠a actual{self.COLOR_RESET}")
            nueva_categoria = articulo.get('idcategoria', 1)
        
        # Confirmar cambios
        print(f"\n{self.COLOR_AMARILLO}Resumen de cambios:{self.COLOR_RESET}")
        print(f"  Nombre: {nuevo_nombre}")
        print(f"  Categor√≠a ID: {nueva_categoria}")
        
        confirmar = input(f"\n{self.COLOR_AMARILLO}¬øGuardar cambios? [S/N]: {self.COLOR_RESET}").upper()
        
        if confirmar == 'S':
            cambios_realizados = False
            
            # Actualizar nombre si cambi√≥
            if nuevo_nombre != articulo.get('nombre', ''):
                print(f"   Actualizando nombre...")
                if self.articulo_service.actualizar_nombre(idarticulo, nuevo_nombre):
                    print(f"{self.COLOR_VERDE}   ‚úÖ Nombre actualizado a: {nuevo_nombre}{self.COLOR_RESET}")
                    cambios_realizados = True
                else:
                    print(f"{self.COLOR_ROJO}   ‚ùå Error actualizando nombre{self.COLOR_RESET}")
            
            # Actualizar categor√≠a si cambi√≥
            if nueva_categoria != articulo.get('idcategoria', 1):
                print(f"   Actualizando categor√≠a...")
                if self.articulo_service.actualizar_categoria(idarticulo, nueva_categoria):
                    print(f"{self.COLOR_VERDE}   ‚úÖ Categor√≠a actualizada a ID: {nueva_categoria}{self.COLOR_RESET}")
                    cambios_realizados = True
                else:
                    print(f"{self.COLOR_ROJO}   ‚ùå Error actualizando categor√≠a{self.COLOR_RESET}")
            
            if cambios_realizados:
                print(f"\n{self.COLOR_VERDE}‚úÖ Cambios guardados correctamente{self.COLOR_RESET}")
            else:
                print(f"\n{self.COLOR_AMARILLO}No se realizaron cambios{self.COLOR_RESET}")
        else:
            print(f"{self.COLOR_AMARILLO}Cambios cancelados{self.COLOR_RESET}")
        
        self.pausa()

    def _buscar_articulo_para_editar(self):
        """Busca un art√≠culo por nombre o c√≥digo para editar categor√≠a/nombre"""
        self.mostrar_cabecera("üîç BUSCAR ART√çCULO PARA EDITAR")
        
        print(f"{self.COLOR_AMARILLO}¬øC√≥mo desea buscar?{self.COLOR_RESET}")
        print(f"  [A] Por nombre")
        print(f"  [B] Por c√≥digo")
        print(f"  [V] Volver")
        print()
        
        opcion = input(f"{self.COLOR_AMARILLO}üîπ Seleccione: {self.COLOR_RESET}").strip().upper()
        
        if opcion == 'V':
            return
        elif opcion == 'A':
            self._buscar_por_nombre_y_editar()
        elif opcion == 'B':
            self._buscar_por_codigo_y_editar()
        else:
            print(f"{self.COLOR_ROJO}‚ùå Opci√≥n inv√°lida{self.COLOR_RESET}")
            self.pausa()

    def _buscar_articulo_para_precio(self):
        """Busca un art√≠culo por nombre o c√≥digo para editar precio"""
        self.mostrar_cabecera("üîç BUSCAR ART√çCULO PARA CAMBIAR PRECIO")
        
        print(f"{self.COLOR_AMARILLO}¬øC√≥mo desea buscar?{self.COLOR_RESET}")
        print(f"  [A] Por nombre")
        print(f"  [B] Por c√≥digo")
        print(f"  [V] Volver")
        print()
        
        opcion = input(f"{self.COLOR_AMARILLO}üîπ Seleccione: {self.COLOR_RESET}").strip().upper()
        
        if opcion == 'V':
            return
        elif opcion == 'A':
            self._buscar_por_nombre_y_precio()
        elif opcion == 'B':
            self._buscar_por_codigo_y_precio()
        else:
            print(f"{self.COLOR_ROJO}‚ùå Opci√≥n inv√°lida{self.COLOR_RESET}")
            self.pausa()

    def _buscar_articulo_para_detalle(self):
        """Busca un art√≠culo por nombre o c√≥digo para ver detalles"""
        self.mostrar_cabecera("üîç BUSCAR ART√çCULO PARA VER DETALLES")
        
        print(f"{self.COLOR_AMARILLO}¬øC√≥mo desea buscar?{self.COLOR_RESET}")
        print(f"  [A] Por nombre")
        print(f"  [B] Por c√≥digo")
        print(f"  [V] Volver")
        print()
        
        opcion = input(f"{self.COLOR_AMARILLO}üîπ Seleccione: {self.COLOR_RESET}").strip().upper()
        
        if opcion == 'V':
            return
        elif opcion == 'A':
            self._buscar_por_nombre_y_detalle()
        elif opcion == 'B':
            self._buscar_por_codigo_y_detalle()
        else:
            print(f"{self.COLOR_ROJO}‚ùå Opci√≥n inv√°lida{self.COLOR_RESET}")
            self.pausa()

    def _buscar_por_nombre_y_editar(self):
        """Busca por nombre y permite editar el seleccionado"""
        termino = input(f"\n{self.COLOR_AMARILLO}Ingrese nombre o parte del nombre: {self.COLOR_RESET}").strip().lower()
        
        if not termino:
            print(f"{self.COLOR_ROJO}‚ùå T√©rmino de b√∫squeda vac√≠o{self.COLOR_RESET}")
            self.pausa()
            return
        
        from capa_negocio.inventario_service import InventarioService
        inventario_service = InventarioService(self.articulo_service)
        articulos = inventario_service.listar_con_stock()
        
        resultados = []
        for a in articulos:
            nombre = a.get('nombre', '').lower()
            if termino in nombre:
                resultados.append(a)
        
        if not resultados:
            print(f"\n{self.COLOR_AMARILLO}üì≠ No se encontraron art√≠culos con '{termino}'{self.COLOR_RESET}")
            self.pausa()
            return
        
        self._mostrar_resultados_con_accion(resultados, 'editar')

    def _buscar_por_codigo_y_editar(self):
        """Busca por c√≥digo y permite editar el seleccionado"""
        termino = input(f"\n{self.COLOR_AMARILLO}Ingrese c√≥digo o parte del c√≥digo: {self.COLOR_RESET}").strip().lower()
        
        if not termino:
            print(f"{self.COLOR_ROJO}‚ùå T√©rmino de b√∫squeda vac√≠o{self.COLOR_RESET}")
            self.pausa()
            return
        
        from capa_negocio.inventario_service import InventarioService
        inventario_service = InventarioService(self.articulo_service)
        articulos = inventario_service.listar_con_stock()
        
        resultados = []
        for a in articulos:
            # CAMBIO AQU√ç: usar 'codigo' en lugar de 'codigo_barras'
            codigo = str(a.get('codigo', '')).lower()
            nombre = str(a.get('nombre', '')).lower()
            
            if termino in codigo or termino in nombre:
                resultados.append(a)
        
        if not resultados:
            print(f"\n{self.COLOR_AMARILLO}üì≠ No se encontraron art√≠culos con '{termino}'{self.COLOR_RESET}")
            self.pausa()
            return
        
        self._mostrar_resultados_con_accion(resultados, 'editar')

    def _buscar_por_nombre_y_precio(self):
        """Busca por nombre y permite cambiar precio del seleccionado"""
        termino = input(f"\n{self.COLOR_AMARILLO}Ingrese nombre o parte del nombre: {self.COLOR_RESET}").strip().lower()
        
        if not termino:
            print(f"{self.COLOR_ROJO}‚ùå T√©rmino de b√∫squeda vac√≠o{self.COLOR_RESET}")
            self.pausa()
            return
        
        from capa_negocio.inventario_service import InventarioService
        inventario_service = InventarioService(self.articulo_service)
        articulos = inventario_service.listar_con_stock()
        
        resultados = []
        for a in articulos:
            nombre = a.get('nombre', '').lower()
            if termino in nombre:
                resultados.append(a)
        
        if not resultados:
            print(f"\n{self.COLOR_AMARILLO}üì≠ No se encontraron art√≠culos con '{termino}'{self.COLOR_RESET}")
            self.pausa()
            return
        
        self._mostrar_resultados_con_accion(resultados, 'precio')

    def _buscar_por_codigo_y_precio(self):
        """Busca por c√≥digo y permite cambiar precio del seleccionado"""
        termino = input(f"\n{self.COLOR_AMARILLO}Ingrese c√≥digo o parte del c√≥digo: {self.COLOR_RESET}").strip().lower()
        
        if not termino:
            print(f"{self.COLOR_ROJO}‚ùå T√©rmino de b√∫squeda vac√≠o{self.COLOR_RESET}")
            self.pausa()
            return
        
        from capa_negocio.inventario_service import InventarioService
        inventario_service = InventarioService(self.articulo_service)
        articulos = inventario_service.listar_con_stock()
        
        resultados = []
        for a in articulos:
            # CAMBIO AQU√ç: usar 'codigo' en lugar de 'codigo_barras'
            codigo = str(a.get('codigo', '')).lower()
            nombre = str(a.get('nombre', '')).lower()
            
            if termino in codigo or termino in nombre:
                resultados.append(a)
        
        if not resultados:
            print(f"\n{self.COLOR_AMARILLO}üì≠ No se encontraron art√≠culos con '{termino}'{self.COLOR_RESET}")
            self.pausa()
            return
        
        self._mostrar_resultados_con_accion(resultados, 'precio')

    def _buscar_por_nombre_y_detalle(self):
        """Busca por nombre y permite ver detalles del seleccionado"""
        termino = input(f"\n{self.COLOR_AMARILLO}Ingrese nombre o parte del nombre: {self.COLOR_RESET}").strip().lower()
        
        if not termino:
            print(f"{self.COLOR_ROJO}‚ùå T√©rmino de b√∫squeda vac√≠o{self.COLOR_RESET}")
            self.pausa()
            return
        
        from capa_negocio.inventario_service import InventarioService
        inventario_service = InventarioService(self.articulo_service)
        articulos = inventario_service.listar_con_stock()
        
        resultados = []
        for a in articulos:
            nombre = a.get('nombre', '').lower()
            if termino in nombre:
                resultados.append(a)
        
        if not resultados:
            print(f"\n{self.COLOR_AMARILLO}üì≠ No se encontraron art√≠culos con '{termino}'{self.COLOR_RESET}")
            self.pausa()
            return
        
        self._mostrar_resultados_con_accion(resultados, 'detalle')

    def _buscar_por_codigo_y_detalle(self):
        """Busca por c√≥digo y permite ver detalles del seleccionado"""
        termino = input(f"\n{self.COLOR_AMARILLO}Ingrese c√≥digo o parte del c√≥digo: {self.COLOR_RESET}").strip().lower()
        
        if not termino:
            print(f"{self.COLOR_ROJO}‚ùå T√©rmino de b√∫squeda vac√≠o{self.COLOR_RESET}")
            self.pausa()
            return
        
        from capa_negocio.inventario_service import InventarioService
        inventario_service = InventarioService(self.articulo_service)
        articulos = inventario_service.listar_con_stock()
        
        resultados = []
        for a in articulos:
            # CAMBIO AQU√ç: usar 'codigo' en lugar de 'codigo_barras'
            codigo = str(a.get('codigo', '')).lower()
            nombre = str(a.get('nombre', '')).lower()
            
            if termino in codigo or termino in nombre:
                resultados.append(a)
        
        if not resultados:
            print(f"\n{self.COLOR_AMARILLO}üì≠ No se encontraron art√≠culos con '{termino}'{self.COLOR_RESET}")
            self.pausa()
            return
        
        self._mostrar_resultados_con_accion(resultados, 'detalle')

    def _mostrar_resultados_con_accion(self, resultados, accion):
        """Muestra resultados y ejecuta acci√≥n seg√∫n selecci√≥n"""
        self.mostrar_cabecera(f"üîç RESULTADOS DE B√öSQUEDA")
        
        print(f"\n{self.COLOR_VERDE}{'ID':<5} {'C√ìDIGO':<15} {'NOMBRE':<30} {'CATEGOR√çA':<20} {'PRECIO $':<10} {'STOCK':<10}{self.COLOR_RESET}")
        print(f"{self.COLOR_CYAN}{'-'*100}{self.COLOR_RESET}")
        
        for a in resultados:
            id_art = a.get('idarticulo', '')
            # CORREGIDO: usar 'codigo' en lugar de 'codigo_barras'
            codigo = a.get('codigo', '')
            if not codigo:
                codigo = a.get('plu', '') or 'S/C'
            codigo = codigo[:14]
            
            nombre = a.get('nombre', '')[:29]
            categoria = a.get('categoria_nombre', a.get('categoria', 'Sin categor√≠a'))[:19]
            precio = a.get('precio_venta', 0)
            stock = a.get('stock_actual', 0)
            
            # Formatear precio
            if precio == int(precio):
                precio_str = f"${int(precio)}"
            else:
                precio_str = f"${precio:.2f}"
            
            print(f"{id_art:<5} {codigo:<15} {nombre:<30} {categoria:<20} {precio_str:<10} {stock} und")
        
        print(f"{self.COLOR_CYAN}{'-'*100}{self.COLOR_RESET}")
        print(f"\n{self.COLOR_AMARILLO}Seleccione el ID del art√≠culo que desea {accion}:{self.COLOR_RESET}")
        print(f"  [0] Cancelar")
        print(f"  [V] Volver a b√∫squeda")
        
        opcion = input(f"\n{self.COLOR_AMARILLO}ID: {self.COLOR_RESET}").strip().upper()
        
        if opcion == 'V':
            # Volver al men√∫ de b√∫squeda seg√∫n la acci√≥n
            if accion == 'editar':
                self._buscar_articulo_para_editar()
            elif accion == 'precio':
                self._buscar_articulo_para_precio()
            elif accion == 'detalle':
                self._buscar_articulo_para_detalle()
            return
        elif opcion == '0':
            return
        
        try:
            id_seleccionado = int(opcion)
            
            # Verificar que el ID est√° en resultados
            valido = False
            for a in resultados:
                if a.get('idarticulo') == id_seleccionado:
                    valido = True
                    break
            
            if not valido:
                print(f"{self.COLOR_ROJO}‚ùå ID no v√°lido o no est√° en los resultados{self.COLOR_RESET}")
                self.pausa()
                # Volver a mostrar los resultados
                self._mostrar_resultados_con_accion(resultados, accion)
                return
            
            # Ejecutar acci√≥n correspondiente
            if accion == 'editar':
                self._editar_categoria_nombre(id_seleccionado)
            elif accion == 'precio':
                self._editar_precio_articulo(id_seleccionado)
            elif accion == 'detalle':
                self._ver_detalle_articulo(id_seleccionado)
                
        except ValueError:
            print(f"{self.COLOR_ROJO}‚ùå Valor inv√°lido{self.COLOR_RESET}")
            self.pausa()
            # Volver a mostrar los resultados
            self._mostrar_resultados_con_accion(resultados, accion)

        self.db.cerrar()

if __name__ == "__main__":
    sistema = SistemaVentas()
    sistema.run()

=== IA ACTUAL (ia_productos_service.py) ===

"""
Servicio de Inteligencia Artificial para clasificaci√≥n autom√°tica de productos
"""
from loguru import logger
from typing import Dict, List, Optional, Tuple
import re

class IAProductosService:
    def __init__(self, repo_reglas=None):
        self.repo_reglas = repo_reglas
        self.reglas_cargadas = False
        self.palabras_clave = {}  # {palabra: id_impuesto}
        self.marcas_conocidas = {} # {marca: id_impuesto}
        self.cargar_reglas_iniciales()

    def detectar_categoria_motos(self, nombre: str) -> Optional[Dict]:
        """
        Detecta si el producto pertenece a la categor√≠a de motos
        y devuelve el ID de categor√≠a (101-111) e impuesto (siempre 2 - General)
        """
        if not nombre:
            return None
        
        nombre_upper = nombre.upper()
        
        # Reglas para cada categor√≠a de motos
        reglas_motos = [
            # (palabras clave, idcategoria, nombre_categoria)
            (['PISTON', 'ANILLO', 'CIGUE√ëAL', 'VALVULA', 'EMPACADURA'], 101, 'Motor'),
            (['CADENA', 'PI√ëON', 'CORONA', 'CORREA', 'EMBRAGUE'], 102, 'Transmisi√≥n'),
            (['PASTILLA', 'BANDA', 'DISCO FRENO', 'GUAYA', 'FRENO'], 103, 'Frenos'),
            (['AMORTIGUADOR', 'BARRA', 'RODAMIENTO', 'SUSPENSION'], 104, 'Suspensi√≥n'),
            (['BATERIA', 'BUJIA', 'CDI', 'REGULADOR', 'BOMBILLO', 'BOYA'], 105, 'El√©ctrico'),
            (['ACEITE 2T', 'ACEITE 4T', 'LIGA FRENO', 'LUBRICANTE', 'ACEITE MOTOR'], 106, 'Lubricantes'),
            (['FILTRO ACEITE', 'FILTRO AIRE', 'FILTRO GASOLINA'], 107, 'Filtros'),
            (['CAUCHO', 'LLANTA', 'TRIPA', 'NEUMATICO', 'CAMARA'], 108, 'Cauchos'),
            (['CASCO', 'GUANTE', 'CHAQUETA', 'MALETERO', 'CALCOMANIA', 'PEGATINA'], 109, 'Accesorios'),
            (['HERRAMIENTA', 'LLAVE', 'DESARMADOR', 'ALICATE', 'JUEGO LLAVES'], 110, 'Herramientas'),
            (['SERVICIO', 'MANO OBRA', 'REPARACION', 'CAMBIO ACEITE', 'ENTONACION'], 111, 'Servicios')
        ]
        
        # Buscar coincidencias
        for palabras, cat_id, cat_nombre in reglas_motos:
            if any(palabra in nombre_upper for palabra in palabras):
                return {
                    'idcategoria': cat_id,
                    'nombre_categoria': cat_nombre,
                    'id_impuesto': 2,  # Siempre General (G) para motos
                    'confianza': 0.90,
                    'tipo': 'MOTOS',
                    'palabra_encontrada': [p for p in palabras if p in nombre_upper][0]
                }
        
        return None
    
    def cargar_reglas_iniciales(self):
        """Carga reglas por defecto en memoria"""
        # Exentos (id_impuesto=1)
        self.palabras_clave = {
            'harina': 1, 'arroz': 1, 'azucar': 1, 'leche': 1, 'huevo': 1,
            'pan': 1, 'pasta': 1, 'carne': 1, 'pollo': 1, 'pescado': 1,
            'fruta': 1, 'verdura': 1, 'legumbre': 1, 'medicina': 1,
            # Generales (id_impuesto=2)
            'mayonesa': 2, 'salsa': 2, 'atun': 2, 'gaseosa': 2, 'refresco': 2,
            'jabon': 2, 'detergente': 2, 'shampoo': 2, 'desodorante': 2,
        }
        
        self.marcas_conocidas = {
            'santoni': 1, 'bondora': 1, 'konfit': 1, 'pampa': 1,
            'ole': 2, 'ronco': 2,
        }
        
        self.reglas_cargadas = True
        logger.info(f"‚úÖ IAProductosService inicializado con {len(self.palabras_clave)} palabras clave")
    
    def analizar_producto(self, nombre: str) -> Optional[Dict]:
        """
        Analiza el nombre del producto y sugiere el impuesto y categor√≠a
        Primero intenta con motos, luego con supermercado
        """
        if not nombre:
            return None
        
        # 1. Intentar detectar si es producto de motos
        resultado_motos = self.detectar_categoria_motos(nombre)
        if resultado_motos:
            logger.info(f"üèçÔ∏è Producto de motos detectado: {resultado_motos['nombre_categoria']}")
            return resultado_motos
        
        # 2. Si no es moto, usar la l√≥gica existente de supermercado
        nombre_lower = nombre.lower()
        
        # Buscar por marca (prioridad alta)
        for marca, impuesto in self.marcas_conocidas.items():
            if marca in nombre_lower:
                return {
                    'id_impuesto': impuesto,
                    'confianza': 0.95,
                    'metodo': 'marca',
                    'palabra': marca
                }
        
        # Buscar por palabra clave
        palabras_encontradas = []
        for palabra, impuesto in self.palabras_clave.items():
            if palabra in nombre_lower:
                palabras_encontradas.append((palabra, impuesto))
        
        if palabras_encontradas:
            votos = {}
            for palabra, impuesto in palabras_encontradas:
                votos[impuesto] = votos.get(impuesto, 0) + 1
            
            impuesto_final = max(votos, key=votos.get)
            confianza = min(0.8 + (votos[impuesto_final] * 0.05), 0.95)
            
            return {
                'id_impuesto': impuesto_final,
                'confianza': confianza,
                'metodo': 'palabras_clave',
                'palabras': [p for p, _ in palabras_encontradas]
            }
        
        return None
    
    def obtener_nombre_impuesto(self, id_impuesto: int) -> str:
        """Obtiene el nombre del impuesto por su ID"""
        mapa = {1: 'Exento', 2: 'General', 3: 'Reducida', 4: 'Adicional'}
        return mapa.get(id_impuesto, 'Desconocido')
    
    def obtener_letra_fiscal(self, id_impuesto: int) -> str:
        """Obtiene la letra fiscal por ID de impuesto"""
        mapa = {1: 'E', 2: 'G', 3: 'R', 4: 'A'}
        return mapa.get(id_impuesto, '?')

    def detectar_categoria_venezolana(self, nombre: str) -> int:
        """
        Detecta la categor√≠a venezolana basada en el nombre del producto
        Usando los IDs REALES de la BD:
        1: Electr√≥nicos
        2: Viveres
        3: Bebidas
        4: L√°cteos
        5: Otros
        7: Perecederos
        8: Limpieza
        9: Higiene
        """
        if not nombre:
            return 5  # Otros por defecto
        
        nombre_upper = nombre.upper()
        
        # ELECTR√ìNICOS (ID 1)
        if any(palabra in nombre_upper for palabra in ['LAPTOP', 'COMPUTADORA', 'MOUSE', 'TECLADO', 
                                                        'MONITOR', 'CELULAR', 'TELEFONO', 'IMPRESORA']):
            return 1
        
        # V√çVERES (ID 2)
        if any(palabra in nombre_upper for palabra in ['HARINA', 'ARROZ', 'PASTA', 'GRANO', 'LENTEJA', 
                                                        'CARAOTA', 'QUINCHONCHO', 'AZUCAR', 'SAL', 
                                                        'ATUN', 'SARDINA', 'ENLATADO', 'MAYONESA', 
                                                        'SALSA', 'VINAGRE', 'ACEITE', 'CAFE']):
            return 2
        
        # BEBIDAS (ID 3)
        if any(palabra in nombre_upper for palabra in ['REFRESCO', 'GASEOSA', 'JUGO', 'MALTA', 'AGUA',
                                                        'POLAR', 'COCA', 'PEPSI', 'CHINOTO', 'FRESCOLITA']):
            return 3
        
        # L√ÅCTEOS (ID 4)
        if any(palabra in nombre_upper for palabra in ['LECHE', 'QUESO', 'YOGURT', 'MANTEQUILLA', 
                                                        'MARGARINA', 'KUMIS']):
            return 4
        
        # PERECEDEROS (ID 7)
        if any(palabra in nombre_upper for palabra in ['CARNE', 'POLLO', 'PESCADO', 'RES', 'CERDO',
                                                        'FRUTA', 'VERDURA', 'CEBOLLA', 'TOMATE',
                                                        'PIMENTON', 'Auyama', 'LECHOSA', 'PATILLA',
                                                        'MELON', 'CAMBUR', 'PLATANO']):
            return 7
        
        # LIMPIEZA (ID 8)
        if any(palabra in nombre_upper for palabra in ['JABON', 'DETERGENTE', 'CLORO', 'LIMPIDO',
                                                        'SUAVIZANTE', 'LYSOL', 'FAB', 'ARIEL']):
            return 8
        
        # HIGIENE (ID 9)
        if any(palabra in nombre_upper for palabra in ['SHAMPOO', 'ACONDICIONADOR', 'DESODORANTE',
                                                        'PASTA DENTAL', 'CEPILLO', 'JABON DE BA√ëO',
                                                        'PREND', 'COLGATE', 'AXE']):
            return 9
        
        # OTROS (ID 5) - por defecto
        return 5
