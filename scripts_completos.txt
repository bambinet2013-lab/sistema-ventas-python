-- ======================================================
-- ACTUALIZACI√ìN BASE DE DATOS PARA CUMPLIMIENTO SENIAT
-- ======================================================
USE SistemaVentas;
GO

-- 1. AGREGAR NUEVAS COLUMNAS A TABLA CLIENTE
-- ======================================================
PRINT 'Agregando columnas a tabla cliente...';

IF NOT EXISTS (SELECT * FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'cliente' AND COLUMN_NAME = 'tipo_persona')
BEGIN
    ALTER TABLE cliente ADD tipo_persona VARCHAR(2) DEFAULT 'V';
    PRINT '‚úÖ Columna tipo_persona agregada';
END
ELSE
    PRINT '‚ö†Ô∏è Columna tipo_persona ya existe';

IF NOT EXISTS (SELECT * FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'cliente' AND COLUMN_NAME = 'contribuyente_iva')
BEGIN
    ALTER TABLE cliente ADD contribuyente_iva BIT DEFAULT 1;
    PRINT '‚úÖ Columna contribuyente_iva agregada';
END
ELSE
    PRINT '‚ö†Ô∏è Columna contribuyente_iva ya existe';

IF NOT EXISTS (SELECT * FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'cliente' AND COLUMN_NAME = 'excento_iva')
BEGIN
    ALTER TABLE cliente ADD excento_iva BIT DEFAULT 0;
    PRINT '‚úÖ Columna excento_iva agregada';
END
ELSE
    PRINT '‚ö†Ô∏è Columna excento_iva ya existe';

IF NOT EXISTS (SELECT * FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'cliente' AND COLUMN_NAME = 'retenedor_iva')
BEGIN
    ALTER TABLE cliente ADD retenedor_iva BIT DEFAULT 0;
    PRINT '‚úÖ Columna retenedor_iva agregada';
END
ELSE
    PRINT '‚ö†Ô∏è Columna retenedor_iva ya existe';

IF NOT EXISTS (SELECT * FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_NAME = 'cliente' AND COLUMN_NAME = 'bloqueado')
BEGIN
    ALTER TABLE cliente ADD bloqueado BIT DEFAULT 0;
    PRINT '‚úÖ Columna bloqueado agregada';
END
ELSE
    PRINT '‚ö†Ô∏è Columna bloqueado ya existe';

-- 2. INSERTAR CLIENTE CONSUMIDOR FINAL
-- ======================================================
PRINT '';
PRINT 'Verificando cliente CONSUMIDOR FINAL...';

IF NOT EXISTS (SELECT 1 FROM cliente WHERE tipo_documento = 'CF' AND num_documento = '')
BEGIN
    INSERT INTO cliente (
        nombre, 
        apellidos, 
        tipo_documento, 
        num_documento,
        tipo_persona, 
        contribuyente_iva, 
        excento_iva, 
        retenedor_iva, 
        bloqueado
    ) VALUES (
        'CONSUMIDOR', 
        'FINAL', 
        'CF', 
        '',
        'CF', 
        1,  -- Contribuyente IVA (SIEMPRE paga IVA)
        0,  -- No excento
        0,  -- No retenedor
        1   -- Bloqueado (no editable)
    );
    PRINT '‚úÖ Cliente CONSUMIDOR FINAL creado';
END
ELSE
BEGIN
    PRINT '‚ö†Ô∏è Cliente CONSUMIDOR FINAL ya existe';
    
    -- Actualizar si existe pero no tiene los campos nuevos
    UPDATE cliente 
    SET tipo_persona = 'CF',
        contribuyente_iva = 1,
        excento_iva = 0,
        retenedor_iva = 0,
        bloqueado = 1
    WHERE tipo_documento = 'CF' AND num_documento = '';
    
    PRINT '‚úÖ Cliente CONSUMIDOR FINAL actualizado';
END

-- 3. CREAR TABLA DE LOG DE AUDITOR√çA
-- ======================================================
PRINT '';
PRINT 'Creando tabla de log de auditor√≠a...';

IF NOT EXISTS (SELECT * FROM sysobjects WHERE name = 'log_auditoria' AND xtype = 'U')
BEGIN
    CREATE TABLE log_auditoria (
        id INT IDENTITY(1,1) PRIMARY KEY,
        usuario VARCHAR(100) NOT NULL,
        accion VARCHAR(50) NOT NULL,
        tabla_afectada VARCHAR(50) NOT NULL,
        registro_id INT,
        datos_anteriores TEXT,
        datos_nuevos TEXT,
        ip_address VARCHAR(45),
        fecha_hora DATETIME DEFAULT GETDATE()
    );
    
    -- Crear √≠ndices para b√∫squedas r√°pidas
    CREATE INDEX IX_log_auditoria_fecha ON log_auditoria(fecha_hora);
    CREATE INDEX IX_log_auditoria_usuario ON log_auditoria(usuario);
    CREATE INDEX IX_log_auditoria_tabla ON log_auditoria(tabla_afectada);
    
    PRINT '‚úÖ Tabla log_auditoria creada';
END
ELSE
BEGIN
    PRINT '‚ö†Ô∏è Tabla log_auditoria ya existe';
END

-- 4. CREAR TABLA DE CONTINGENCIA (PARA CUANDO FALLE INTERNET)
-- ======================================================
PRINT '';
PRINT 'Creando tabla de facturas_contingencia...';

IF NOT EXISTS (SELECT * FROM sysobjects WHERE name = 'facturas_contingencia' AND xtype = 'U')
BEGIN
    CREATE TABLE facturas_contingencia (
        id INT IDENTITY(1,1) PRIMARY KEY,
        factura_json TEXT NOT NULL,
        fecha_creacion DATETIME DEFAULT GETDATE(),
        sincronizada BIT DEFAULT 0,
        fecha_sincronizacion DATETIME,
        numero_intento INT DEFAULT 0,
        error_mensaje TEXT
    );
    
    CREATE INDEX IX_contingencia_sincronizada ON facturas_contingencia(sincronizada);
    PRINT '‚úÖ Tabla facturas_contingencia creada';
END
ELSE
BEGIN
    PRINT '‚ö†Ô∏è Tabla facturas_contingencia ya existe';
END

-- 5. MOSTRAR ESTRUCTURA FINAL
-- ======================================================
PRINT '';
PRINT '=== VERIFICACI√ìN FINAL ===';
PRINT '';
PRINT 'Columnas en tabla cliente:';
SELECT 
    COLUMN_NAME, 
    DATA_TYPE, 
    IS_NULLABLE 
FROM INFORMATION_SCHEMA.COLUMNS 
WHERE TABLE_NAME = 'cliente'
ORDER BY ORDINAL_POSITION;

PRINT '';
PRINT 'Cliente CONSUMIDOR FINAL:';
SELECT 
    idcliente, 
    nombre, 
    apellidos, 
    tipo_documento, 
    num_documento, 
    tipo_persona,
    bloqueado
FROM cliente 
WHERE tipo_documento = 'CF';

PRINT '';
PRINT 'Tablas creadas:';
SELECT 
    name AS tabla,
    create_date AS fecha_creacion
FROM sys.tables 
WHERE name IN ('log_auditoria', 'facturas_contingencia');

PRINT '';
PRINT '======================================================';
PRINT '‚úÖ ACTUALIZACI√ìN COMPLETADA EXITOSAMENTE';
PRINT '======================================================';
GO
-- ======================================================
-- CREAR TABLA KARDEX PARA CONTROL DE INVENTARIO
-- ======================================================
USE SistemaVentas;

-- 1. Crear tabla kardex si no existe
IF NOT EXISTS (SELECT * FROM sysobjects WHERE name = 'kardex' AND xtype = 'U')
BEGIN
    CREATE TABLE kardex (
        idkardex INT IDENTITY(1,1) PRIMARY KEY,
        idarticulo INT NOT NULL,
        tipo_movimiento VARCHAR(20) NOT NULL CHECK (tipo_movimiento IN ('INGRESO', 'VENTA', 'AJUSTE', 'DEVOLUCION')),
        documento_referencia VARCHAR(50) NOT NULL,
        cantidad INT NOT NULL,
        stock_anterior INT NOT NULL,
        stock_nuevo INT NOT NULL,
        fecha_movimiento DATETIME DEFAULT GETDATE(),
        CONSTRAINT FK_kardex_articulo FOREIGN KEY (idarticulo) REFERENCES articulo(idarticulo)
    );
    
    -- Crear √≠ndices para b√∫squedas r√°pidas
    CREATE INDEX IX_kardex_articulo ON kardex(idarticulo);
    CREATE INDEX IX_kardex_fecha ON kardex(fecha_movimiento);
    
    PRINT '‚úÖ Tabla kardex creada exitosamente';
END
ELSE
BEGIN
    PRINT '‚ö†Ô∏è La tabla kardex ya existe';
END

-- 2. Verificar estructura
SELECT 'üìä ESTRUCTURA DE KARDEX:' as ' ';
SELECT COLUMN_NAME, DATA_TYPE, IS_NULLABLE 
FROM INFORMATION_SCHEMA.COLUMNS 
WHERE TABLE_NAME = 'kardex'
ORDER BY ORDINAL_POSITION;

